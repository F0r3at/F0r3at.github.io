<!DOCTYPE html>
<html lang="en">

<head>
    
<meta charset="utf-8">

<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">


<title>Thinkphp框架 &lt; 5.0.16 sql注入漏洞分析(每日一洞) - F0rmat的博客 | 专注于网络攻防和信息安全</title>

<meta name="description" content="0x01 前言 前天在公众号看到石大神发的一篇审计thinkphp的文章,就想写一个分析流程，delay到了今天。昨天在先知也看到了chybeta发的一篇分析文章感觉也不错。分析过程，我也会做thinkphp部分功能的解析。 废话不多说，开始吧！
0x02 环境搭建和漏洞复现 程序下载地址：http://www.thinkphp.cn/down/1126.html PHPstudy：Apache&#43;php5.6&#43;MySQL 工具：PHPstorm
 首先建立一个数据库名为：thinkphp 建立一个表名为：user 添加三个字段：id,name,password   在thinkphp的数据库文件填上刚才我们建立的数据库信息： 文件位置：\thinkphp\application\database.php  打开thinkphp的调试模式： 文件位置：\thinkphp\application\config.php  简单写一个update功能，石大神用到了模型，这里就简单写一个例子就行了。 文件位置：\thinkphp\application\index\controller\Index.php  &amp;lt;?php namespace app\index\controller; class Index { public function index() { $password = input(&amp;#39;get.password/a&amp;#39;); db(&amp;#39;user&amp;#39;)-&amp;gt;where([&amp;#39;id&amp;#39;=&amp;gt; 1])-&amp;gt;update([&amp;#39;password&amp;#39;=&amp;gt;$password]); } } 这里用到了thinkphp的助手函数input()，是专用来接收get，post等的值。具体可以看：https://www.kancloud.cn/manual/thinkphp5/118044 还有就是thinkphp的数据库操作，框架本身写好了我们调用就比较方便。所以为什么那么多人用框架去开发程序，快捷而且安全，不过也会有安全问题，就像今天这个sql漏洞，不过如果是新手的话总比自己写的好对吧哈。 具体可以看链接：https://www.kancloud.cn/manual/thinkphp5/135178 7. 现在就可以访问我们的payload了：
http://thinkphp.test/thinkphp/public/index.php?password[0]=inc&amp;amp;password[1]=updatexml(2,concat(0x7e,user()),0)&amp;amp;password[2]=1 0x03 漏洞分析  这里用phpstorm&#43;debug来动态分析，有不懂配置的可以访问我写一篇配置文章：利用phpstorm&#43;xdebug进行断点调试 我们在主函数下一断点：   然后访问我们payload，它会跳到入口文件，我们只要分析的是sql执行的地方，所以我们直接F8跳到执行sql地方： 2. 我们继续跟进到loader.php它会包含thinkphp的Db.php文件， 接下还会包\thinkphp\library\think\db\connector\Mysql.php文件，主要是连接数据库的操作，这里就直接跳过了。别分析分析把自己绕进去了，我只是在这里讲诉下过程，我们还是直接分析sql执行的部分吧。 3. 我们跳到update执行的部分，文件位置：\thinkphp\library\think\db\Query.php 继续往下看，这句是执行我们sql的地方： 4. 我们F7跟进去，跳到文件位置\thinkphp\library\think\db\Builder.php parseTable函数直接F8往下执行了，这函数是处理table分析的，主要还是parseData函数,我们继续F7跟进 5. 我们继续往下跟进 我们看到了这里如果传入的值为数组形式的话，并且第一个参数为inc就执行switch所对应的的语句。 可以看到这里函数对我们传入的值没有做任何处理，返回内容仍然是我们的语句： 跟到后面返回的执行sql语句：
执行完，我们跟进到报错的地方，说明我的语句执行成功： 6." /><meta name="keywords"
  content="F0rmat, 信息安全, 网络安全, 红蓝攻防, 渗透测试, bypass, waf, 注入, 黑客" />
  <meta name="referrer" content="no-referrer" />


<link rel="stylesheet" href="https://getshe11.com/css/main.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.12/src/css/lightgallery.css">



<meta property="og:title" content="Thinkphp框架 &lt; 5.0.16 sql注入漏洞分析(每日一洞)" />
<meta property="og:description" content="0x01 前言 前天在公众号看到石大神发的一篇审计thinkphp的文章,就想写一个分析流程，delay到了今天。昨天在先知也看到了chybeta发的一篇分析文章感觉也不错。分析过程，我也会做thinkphp部分功能的解析。 废话不多说，开始吧！
0x02 环境搭建和漏洞复现 程序下载地址：http://www.thinkphp.cn/down/1126.html PHPstudy：Apache&#43;php5.6&#43;MySQL 工具：PHPstorm
 首先建立一个数据库名为：thinkphp 建立一个表名为：user 添加三个字段：id,name,password   在thinkphp的数据库文件填上刚才我们建立的数据库信息： 文件位置：\thinkphp\application\database.php  打开thinkphp的调试模式： 文件位置：\thinkphp\application\config.php  简单写一个update功能，石大神用到了模型，这里就简单写一个例子就行了。 文件位置：\thinkphp\application\index\controller\Index.php  &lt;?php namespace app\index\controller; class Index { public function index() { $password = input(&#39;get.password/a&#39;); db(&#39;user&#39;)-&gt;where([&#39;id&#39;=&gt; 1])-&gt;update([&#39;password&#39;=&gt;$password]); } } 这里用到了thinkphp的助手函数input()，是专用来接收get，post等的值。具体可以看：https://www.kancloud.cn/manual/thinkphp5/118044 还有就是thinkphp的数据库操作，框架本身写好了我们调用就比较方便。所以为什么那么多人用框架去开发程序，快捷而且安全，不过也会有安全问题，就像今天这个sql漏洞，不过如果是新手的话总比自己写的好对吧哈。 具体可以看链接：https://www.kancloud.cn/manual/thinkphp5/135178 7. 现在就可以访问我们的payload了：
http://thinkphp.test/thinkphp/public/index.php?password[0]=inc&amp;password[1]=updatexml(2,concat(0x7e,user()),0)&amp;password[2]=1 0x03 漏洞分析  这里用phpstorm&#43;debug来动态分析，有不懂配置的可以访问我写一篇配置文章：利用phpstorm&#43;xdebug进行断点调试 我们在主函数下一断点：   然后访问我们payload，它会跳到入口文件，我们只要分析的是sql执行的地方，所以我们直接F8跳到执行sql地方： 2. 我们继续跟进到loader.php它会包含thinkphp的Db.php文件， 接下还会包\thinkphp\library\think\db\connector\Mysql.php文件，主要是连接数据库的操作，这里就直接跳过了。别分析分析把自己绕进去了，我只是在这里讲诉下过程，我们还是直接分析sql执行的部分吧。 3. 我们跳到update执行的部分，文件位置：\thinkphp\library\think\db\Query.php 继续往下看，这句是执行我们sql的地方： 4. 我们F7跟进去，跳到文件位置\thinkphp\library\think\db\Builder.php parseTable函数直接F8往下执行了，这函数是处理table分析的，主要还是parseData函数,我们继续F7跟进 5. 我们继续往下跟进 我们看到了这里如果传入的值为数组形式的话，并且第一个参数为inc就执行switch所对应的的语句。 可以看到这里函数对我们传入的值没有做任何处理，返回内容仍然是我们的语句： 跟到后面返回的执行sql语句：
执行完，我们跟进到报错的地方，说明我的语句执行成功： 6." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://getshe11.com/post/thinkphp-framework-_-5.0.16-sql-injection-vulnerability-analysis/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2018-04-11T09:34:29&#43;00:00" />
<meta property="article:modified_time" content="2018-04-11T09:34:29&#43;00:00" />

<meta itemprop="name" content="Thinkphp框架 &lt; 5.0.16 sql注入漏洞分析(每日一洞)">
<meta itemprop="description" content="0x01 前言 前天在公众号看到石大神发的一篇审计thinkphp的文章,就想写一个分析流程，delay到了今天。昨天在先知也看到了chybeta发的一篇分析文章感觉也不错。分析过程，我也会做thinkphp部分功能的解析。 废话不多说，开始吧！
0x02 环境搭建和漏洞复现 程序下载地址：http://www.thinkphp.cn/down/1126.html PHPstudy：Apache&#43;php5.6&#43;MySQL 工具：PHPstorm
 首先建立一个数据库名为：thinkphp 建立一个表名为：user 添加三个字段：id,name,password   在thinkphp的数据库文件填上刚才我们建立的数据库信息： 文件位置：\thinkphp\application\database.php  打开thinkphp的调试模式： 文件位置：\thinkphp\application\config.php  简单写一个update功能，石大神用到了模型，这里就简单写一个例子就行了。 文件位置：\thinkphp\application\index\controller\Index.php  &lt;?php namespace app\index\controller; class Index { public function index() { $password = input(&#39;get.password/a&#39;); db(&#39;user&#39;)-&gt;where([&#39;id&#39;=&gt; 1])-&gt;update([&#39;password&#39;=&gt;$password]); } } 这里用到了thinkphp的助手函数input()，是专用来接收get，post等的值。具体可以看：https://www.kancloud.cn/manual/thinkphp5/118044 还有就是thinkphp的数据库操作，框架本身写好了我们调用就比较方便。所以为什么那么多人用框架去开发程序，快捷而且安全，不过也会有安全问题，就像今天这个sql漏洞，不过如果是新手的话总比自己写的好对吧哈。 具体可以看链接：https://www.kancloud.cn/manual/thinkphp5/135178 7. 现在就可以访问我们的payload了：
http://thinkphp.test/thinkphp/public/index.php?password[0]=inc&amp;password[1]=updatexml(2,concat(0x7e,user()),0)&amp;password[2]=1 0x03 漏洞分析  这里用phpstorm&#43;debug来动态分析，有不懂配置的可以访问我写一篇配置文章：利用phpstorm&#43;xdebug进行断点调试 我们在主函数下一断点：   然后访问我们payload，它会跳到入口文件，我们只要分析的是sql执行的地方，所以我们直接F8跳到执行sql地方： 2. 我们继续跟进到loader.php它会包含thinkphp的Db.php文件， 接下还会包\thinkphp\library\think\db\connector\Mysql.php文件，主要是连接数据库的操作，这里就直接跳过了。别分析分析把自己绕进去了，我只是在这里讲诉下过程，我们还是直接分析sql执行的部分吧。 3. 我们跳到update执行的部分，文件位置：\thinkphp\library\think\db\Query.php 继续往下看，这句是执行我们sql的地方： 4. 我们F7跟进去，跳到文件位置\thinkphp\library\think\db\Builder.php parseTable函数直接F8往下执行了，这函数是处理table分析的，主要还是parseData函数,我们继续F7跟进 5. 我们继续往下跟进 我们看到了这里如果传入的值为数组形式的话，并且第一个参数为inc就执行switch所对应的的语句。 可以看到这里函数对我们传入的值没有做任何处理，返回内容仍然是我们的语句： 跟到后面返回的执行sql语句：
执行完，我们跟进到报错的地方，说明我的语句执行成功： 6."><meta itemprop="datePublished" content="2018-04-11T09:34:29&#43;00:00" />
<meta itemprop="dateModified" content="2018-04-11T09:34:29&#43;00:00" />
<meta itemprop="wordCount" content="242">
<meta itemprop="keywords" content="Thinkphp,sql注入,每日一洞," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Thinkphp框架 &lt; 5.0.16 sql注入漏洞分析(每日一洞)"/>
<meta name="twitter:description" content="0x01 前言 前天在公众号看到石大神发的一篇审计thinkphp的文章,就想写一个分析流程，delay到了今天。昨天在先知也看到了chybeta发的一篇分析文章感觉也不错。分析过程，我也会做thinkphp部分功能的解析。 废话不多说，开始吧！
0x02 环境搭建和漏洞复现 程序下载地址：http://www.thinkphp.cn/down/1126.html PHPstudy：Apache&#43;php5.6&#43;MySQL 工具：PHPstorm
 首先建立一个数据库名为：thinkphp 建立一个表名为：user 添加三个字段：id,name,password   在thinkphp的数据库文件填上刚才我们建立的数据库信息： 文件位置：\thinkphp\application\database.php  打开thinkphp的调试模式： 文件位置：\thinkphp\application\config.php  简单写一个update功能，石大神用到了模型，这里就简单写一个例子就行了。 文件位置：\thinkphp\application\index\controller\Index.php  &lt;?php namespace app\index\controller; class Index { public function index() { $password = input(&#39;get.password/a&#39;); db(&#39;user&#39;)-&gt;where([&#39;id&#39;=&gt; 1])-&gt;update([&#39;password&#39;=&gt;$password]); } } 这里用到了thinkphp的助手函数input()，是专用来接收get，post等的值。具体可以看：https://www.kancloud.cn/manual/thinkphp5/118044 还有就是thinkphp的数据库操作，框架本身写好了我们调用就比较方便。所以为什么那么多人用框架去开发程序，快捷而且安全，不过也会有安全问题，就像今天这个sql漏洞，不过如果是新手的话总比自己写的好对吧哈。 具体可以看链接：https://www.kancloud.cn/manual/thinkphp5/135178 7. 现在就可以访问我们的payload了：
http://thinkphp.test/thinkphp/public/index.php?password[0]=inc&amp;password[1]=updatexml(2,concat(0x7e,user()),0)&amp;password[2]=1 0x03 漏洞分析  这里用phpstorm&#43;debug来动态分析，有不懂配置的可以访问我写一篇配置文章：利用phpstorm&#43;xdebug进行断点调试 我们在主函数下一断点：   然后访问我们payload，它会跳到入口文件，我们只要分析的是sql执行的地方，所以我们直接F8跳到执行sql地方： 2. 我们继续跟进到loader.php它会包含thinkphp的Db.php文件， 接下还会包\thinkphp\library\think\db\connector\Mysql.php文件，主要是连接数据库的操作，这里就直接跳过了。别分析分析把自己绕进去了，我只是在这里讲诉下过程，我们还是直接分析sql执行的部分吧。 3. 我们跳到update执行的部分，文件位置：\thinkphp\library\think\db\Query.php 继续往下看，这句是执行我们sql的地方： 4. 我们F7跟进去，跳到文件位置\thinkphp\library\think\db\Builder.php parseTable函数直接F8往下执行了，这函数是处理table分析的，主要还是parseData函数,我们继续F7跟进 5. 我们继续往下跟进 我们看到了这里如果传入的值为数组形式的话，并且第一个参数为inc就执行switch所对应的的语句。 可以看到这里函数对我们传入的值没有做任何处理，返回内容仍然是我们的语句： 跟到后面返回的执行sql语句：
执行完，我们跟进到报错的地方，说明我的语句执行成功： 6."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->
</head>

<body>
    <div class="header-placeholder"></div>
    
    <header class="header">
        <div class="wrapper">
    <div id="sidebar-toggle">TOC</div>
    
    <a class="site-title" href="https://getshe11.com/">F0rmat</a>
    
    <nav class="site-nav">
        <a class="page-link" href="/">Home</a><a class="page-link" href="/post/">Category</a>
    </nav>
</div>

    </header>

    
    <div class="page-content">
        <div class="wrapper">
            
            <div class="col-main">
                <div class="post">
    
    <header class="post-header">
        <h1 class="post-title">Thinkphp框架 &lt; 5.0.16 Sql注入漏洞分析(每日一洞)</h1>
        <p class="post-meta">Apr 11, 2018</p>
    </header>
    <article class="post-content">
        
        
        
        
        
        
        <h2 id="0x01-前言">0x01 前言</h2>
<p>前天在公众号看到石大神发的一篇审计thinkphp的文章,就想写一个分析流程，delay到了今天。昨天在先知也看到了chybeta发的一篇分析文章感觉也不错。分析过程，我也会做thinkphp部分功能的解析。
废话不多说，开始吧！</p>
<h2 id="0x02-环境搭建和漏洞复现">0x02 环境搭建和漏洞复现</h2>
<p>程序下载地址：http://www.thinkphp.cn/down/1126.html
PHPstudy：Apache+php5.6+MySQL
工具：PHPstorm</p>
<ol>
<li>首先建立一个数据库名为：thinkphp</li>
<li>建立一个表名为：user</li>
<li>添加三个字段：id,name,password
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/thinkphp_sql/1.png" alt=""></li>
</ol>
<!-- raw HTML omitted -->
<ol start="4">
<li>在thinkphp的数据库文件填上刚才我们建立的数据库信息：
文件位置：<code>\thinkphp\application\database.php</code>
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/thinkphp_sql/2.png" alt=""></li>
<li>打开thinkphp的调试模式：
文件位置：<code>\thinkphp\application\config.php</code>
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/thinkphp_sql/3.png" alt=""></li>
<li>简单写一个update功能，石大神用到了模型，这里就简单写一个例子就行了。
文件位置：<code>\thinkphp\application\index\controller\Index.php</code></li>
</ol>
<div class="highlight"><pre class="chroma"><code class="language-php" data-lang="php"><span class="o">&lt;?</span><span class="nx">php</span>
<span class="k">namespace</span> <span class="nx">app\index\controller</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">Index</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">index</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$password</span> <span class="o">=</span> <span class="nx">input</span><span class="p">(</span><span class="s1">&#39;get.password/a&#39;</span><span class="p">);</span>
        <span class="nx">db</span><span class="p">(</span><span class="s1">&#39;user&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">where</span><span class="p">([</span><span class="s1">&#39;id&#39;</span><span class="o">=&gt;</span> <span class="mi">1</span><span class="p">])</span><span class="o">-&gt;</span><span class="na">update</span><span class="p">([</span><span class="s1">&#39;password&#39;</span><span class="o">=&gt;</span><span class="nv">$password</span><span class="p">]);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div><p>这里用到了thinkphp的助手函数input()，是专用来接收get，post等的值。具体可以看：https://www.kancloud.cn/manual/thinkphp5/118044
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/thinkphp_sql/4.png" alt=""></p>
<p>还有就是thinkphp的数据库操作，框架本身写好了我们调用就比较方便。所以为什么那么多人用框架去开发程序，快捷而且安全，不过也会有安全问题，就像今天这个sql漏洞，不过如果是新手的话总比自己写的好对吧哈。
具体可以看链接：https://www.kancloud.cn/manual/thinkphp5/135178
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/thinkphp_sql/5.png" alt="">
7. 现在就可以访问我们的payload了：</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">http://thinkphp.test/thinkphp/public/index.php?password[0]=inc&amp;password[1]=updatexml(2,concat(0x7e,user()),0)&amp;password[2]=1
</code></pre></div><p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/thinkphp_sql/6.png" alt=""></p>
<h2 id="0x03-漏洞分析">0x03 漏洞分析</h2>
<ol>
<li>这里用phpstorm+debug来动态分析，有不懂配置的可以访问我写一篇配置文章：<a href="http://getpass.cn/2018/04/10/Breakpoint%20debugging%20with%20phpstorm+xdebug/">利用phpstorm+xdebug进行断点调试</a>
我们在主函数下一断点：
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/thinkphp_sql/8.png" alt=""></li>
</ol>
<p>然后访问我们payload，它会跳到入口文件，我们只要分析的是sql执行的地方，所以我们直接F8跳到执行sql地方：
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/thinkphp_sql/9.png" alt=""></p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/thinkphp_sql/7.png" alt="">
2. 我们继续跟进到<code>loader.php</code>它会包含thinkphp的Db.php文件，
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/thinkphp_sql/10.png" alt="">
接下还会包<code>\thinkphp\library\think\db\connector\Mysql.php</code>文件，主要是连接数据库的操作，这里就直接跳过了。别分析分析把自己绕进去了，我只是在这里讲诉下过程，我们还是直接分析sql执行的部分吧。
3. 我们跳到update执行的部分，文件位置：<code>\thinkphp\library\think\db\Query.php</code>
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/thinkphp_sql/11.png" alt="">
继续往下看，这句是执行我们sql的地方：
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/thinkphp_sql/12.png" alt="">
4. 我们F7跟进去，跳到文件位置<code>\thinkphp\library\think\db\Builder.php</code>
<code>parseTable</code>函数直接F8往下执行了，这函数是处理table分析的，主要还是<code>parseData函数</code>,我们继续F7跟进
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/thinkphp_sql/13.png" alt="">
5. 我们继续往下跟进
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/thinkphp_sql/14.png" alt="">
我们看到了这里如果传入的值为数组形式的话，并且第一个参数为<code>inc</code>就执行switch所对应的的语句。
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/thinkphp_sql/15.png" alt=""></p>
<p>可以看到这里函数对我们传入的值没有做任何处理，返回内容仍然是我们的语句：
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/thinkphp_sql/16.png" alt=""></p>
<p>跟到后面返回的执行sql语句：</p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/thinkphp_sql/17.png" alt=""></p>
<p>执行完，我们跟进到报错的地方，说明我的语句执行成功：
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/thinkphp_sql/20.png" alt="">
6.到这里就差不多结束了，有人问，为什么要这样给数组三个字段？
我们可以看到我们刚才传入数组的地方，分别有三个数组
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/thinkphp_sql/18.png" alt="">
到后面返回<code>$result</code>的时候就组合在一起了：
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/thinkphp_sql/19.png" alt=""></p>
<p>下面是<code>parseData</code>的代码：</p>
<div class="highlight"><pre class="chroma"><code class="language-php" data-lang="php"> <span class="k">protected</span> <span class="k">function</span> <span class="nf">parseData</span><span class="p">(</span><span class="nv">$data</span><span class="p">,</span> <span class="nv">$options</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$data</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span> <span class="p">[];</span>
        <span class="p">}</span>

        <span class="c1">// 获取绑定信息
</span><span class="c1"></span>        <span class="nv">$bind</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">query</span><span class="o">-&gt;</span><span class="na">getFieldsBind</span><span class="p">(</span><span class="nv">$options</span><span class="p">[</span><span class="s1">&#39;table&#39;</span><span class="p">]);</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;*&#39;</span> <span class="o">==</span> <span class="nv">$options</span><span class="p">[</span><span class="s1">&#39;field&#39;</span><span class="p">])</span> <span class="p">{</span>
            <span class="nv">$fields</span> <span class="o">=</span> <span class="nx">array_keys</span><span class="p">(</span><span class="nv">$bind</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nv">$fields</span> <span class="o">=</span> <span class="nv">$options</span><span class="p">[</span><span class="s1">&#39;field&#39;</span><span class="p">];</span>
        <span class="p">}</span>

        <span class="nv">$result</span> <span class="o">=</span> <span class="p">[];</span>
        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$data</span> <span class="k">as</span> <span class="nv">$key</span> <span class="o">=&gt;</span> <span class="nv">$val</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$item</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">parseKey</span><span class="p">(</span><span class="nv">$key</span><span class="p">,</span> <span class="nv">$options</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">is_object</span><span class="p">(</span><span class="nv">$val</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">method_exists</span><span class="p">(</span><span class="nv">$val</span><span class="p">,</span> <span class="s1">&#39;__toString&#39;</span><span class="p">))</span> <span class="p">{</span>
                <span class="c1">// 对象数据写入
</span><span class="c1"></span>                <span class="nv">$val</span> <span class="o">=</span> <span class="nv">$val</span><span class="o">-&gt;</span><span class="na">__toString</span><span class="p">();</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span><span class="k">false</span> <span class="o">===</span> <span class="nx">strpos</span><span class="p">(</span><span class="nv">$key</span><span class="p">,</span> <span class="s1">&#39;.&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">in_array</span><span class="p">(</span><span class="nv">$key</span><span class="p">,</span> <span class="nv">$fields</span><span class="p">,</span> <span class="k">true</span><span class="p">))</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nv">$options</span><span class="p">[</span><span class="s1">&#39;strict&#39;</span><span class="p">])</span> <span class="p">{</span>
                    <span class="k">throw</span> <span class="k">new</span> <span class="nx">Exception</span><span class="p">(</span><span class="s1">&#39;fields not exists:[&#39;</span> <span class="o">.</span> <span class="nv">$key</span> <span class="o">.</span> <span class="s1">&#39;]&#39;</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span> <span class="k">elseif</span> <span class="p">(</span><span class="nx">is_null</span><span class="p">(</span><span class="nv">$val</span><span class="p">))</span> <span class="p">{</span>
                <span class="nv">$result</span><span class="p">[</span><span class="nv">$item</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;NULL&#39;</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">elseif</span> <span class="p">(</span><span class="nx">is_array</span><span class="p">(</span><span class="nv">$val</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$val</span><span class="p">))</span> <span class="p">{</span>
                <span class="k">switch</span> <span class="p">(</span><span class="nv">$val</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
                    <span class="k">case</span> <span class="s1">&#39;exp&#39;</span><span class="o">:</span>
                        <span class="nv">$result</span><span class="p">[</span><span class="nv">$item</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$val</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
                        <span class="k">break</span><span class="p">;</span>
                    <span class="k">case</span> <span class="s1">&#39;inc&#39;</span><span class="o">:</span>
                        <span class="nv">$result</span><span class="p">[</span><span class="nv">$item</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">parseKey</span><span class="p">(</span><span class="nv">$val</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">.</span> <span class="s1">&#39;+&#39;</span> <span class="o">.</span> <span class="nx">floatval</span><span class="p">(</span><span class="nv">$val</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
                        <span class="k">break</span><span class="p">;</span>
                    <span class="k">case</span> <span class="s1">&#39;dec&#39;</span><span class="o">:</span>
                        <span class="nv">$result</span><span class="p">[</span><span class="nv">$item</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">parseKey</span><span class="p">(</span><span class="nv">$val</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">.</span> <span class="s1">&#39;-&#39;</span> <span class="o">.</span> <span class="nx">floatval</span><span class="p">(</span><span class="nv">$val</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
                        <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span> <span class="k">elseif</span> <span class="p">(</span><span class="nx">is_scalar</span><span class="p">(</span><span class="nv">$val</span><span class="p">))</span> <span class="p">{</span>
                <span class="c1">// 过滤非标量数据
</span><span class="c1"></span>                <span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">===</span> <span class="nx">strpos</span><span class="p">(</span><span class="nv">$val</span><span class="p">,</span> <span class="s1">&#39;:&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">query</span><span class="o">-&gt;</span><span class="na">isBind</span><span class="p">(</span><span class="nx">substr</span><span class="p">(</span><span class="nv">$val</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span> <span class="p">{</span>
                    <span class="nv">$result</span><span class="p">[</span><span class="nv">$item</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$val</span><span class="p">;</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="nv">$key</span> <span class="o">=</span> <span class="nx">str_replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="nv">$key</span><span class="p">);</span>
                    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">query</span><span class="o">-&gt;</span><span class="na">bind</span><span class="p">(</span><span class="s1">&#39;data__&#39;</span> <span class="o">.</span> <span class="nv">$key</span><span class="p">,</span> <span class="nv">$val</span><span class="p">,</span> <span class="nx">isset</span><span class="p">(</span><span class="nv">$bind</span><span class="p">[</span><span class="nv">$key</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$bind</span><span class="p">[</span><span class="nv">$key</span><span class="p">]</span> <span class="o">:</span> <span class="nx">PDO</span><span class="o">::</span><span class="na">PARAM_STR</span><span class="p">);</span>
                    <span class="nv">$result</span><span class="p">[</span><span class="nv">$item</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;:data__&#39;</span> <span class="o">.</span> <span class="nv">$key</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nv">$result</span><span class="p">;</span>
    <span class="p">}</span>
</code></pre></div><h2 id="0x04-结束">0x04 结束</h2>
<p>如果看不懂的，可以先去了解一下thinkphp这个框架，其他框架大同小异。如果里面一些PHP代码看不懂的话，可以去复习下PHP。</p>
<h2 id="0x05-参考">0x05 参考</h2>
<p><a href="https://www.kancloud.cn/manual/thinkphp5/">https://www.kancloud.cn/manual/thinkphp5/</a></p>
<p><a href="https://mp.weixin.qq.com/s?__biz=MzU2NzE3MTU0Mw==&amp;mid=2247483720&amp;idx=1&amp;sn=973bd7daa287a9e9c0171e852db6cb6b&amp;chksm=fca001f0cbd788e6ed3119de5d3c4bfc3325205c5dd7f296e55a2ba313f73b3808525d1022e6&amp;mpshare=1&amp;scene=23&amp;srcid=04104vXPMKRNVfrVzzzg7HXg#rd">https://mp.weixin.qq.com/s?__biz=MzU2NzE3MTU0Mw==&amp;mid=2247483720&amp;idx=1&amp;sn=973bd7daa287a9e9c0171e852db6cb6b&amp;chksm=fca001f0cbd788e6ed3119de5d3c4bfc3325205c5dd7f296e55a2ba313f73b3808525d1022e6&amp;mpshare=1&amp;scene=23&amp;srcid=04104vXPMKRNVfrVzzzg7HXg#rd</a></p>
<p><a href="https://chybeta.github.io/2018/04/10/Thinkphp%E6%A1%86%E6%9E%B6-5-0-16-sql%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/">https://chybeta.github.io/2018/04/10/Thinkphp%E6%A1%86%E6%9E%B6-5-0-16-sql%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/</a></p>

    </article>

    
    <div class="prevnext">
        



<ul class="prevnext">
    
    <li>上一篇：
        <a href="https://getshe11.com/post/breakpoint-debugging-with-phpstorm&#43;xdebug/">
            利用phpstorm&#43;xdebug进行断点调试
        </a>
    </li>
    
    
    <li>下一篇：
        <a href="https://getshe11.com/post/hello-world/">
            再一次Hello-World，迁移博客到coding.net
        </a>
    </li>
    
</ul>

    </div>
    
    <div class="post-comments">
        
  
  

  
    <script src="https://utteranc.es/client.js"
            repo="F0r3at/Getshe11.com"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://github.com/utterance">comments powered by utterances.</a></noscript>

    </div>
</div>
            </div>
            
            <div class="col-second">
                <div class="col-box col-box-author">
    <img class="avatar" src="../../images/avatar.jpg" alt="F0rmat">
    <div class="col-box-title name">F0rmat</div>
    <p>Stay Hungry, Stay Foolish.</p>
    <p class="contact">
        <a href="http://github.com/F0r3at">Github</a>
    </p>
</div>

<div class="col-box">
    <div class="col-box-title">Newest Posts</div>
    <ul class="post-list">
        
        <li>
            <a href="https://getshe11.com/post/research-on-php-deserialization/" class="post-link">PHP反序列化研究</a>
        </li>
        
        <li>
            <a href="https://getshe11.com/post/research-on-gitlab-cookie-deserialization-vulnerability/" class="post-link">Gitlab Cookie 反序列化漏洞研究</a>
        </li>
        
        <li>
            <a href="https://getshe11.com/post/kali-install-clash/" class="post-link">Kali Linux安装Clash</a>
        </li>
        
        <li>
            <a href="https://getshe11.com/post/pd-chrome-3d/" class="post-link">关于Kali2020安装Parallels Tools后Chrome显示空白</a>
        </li>
        
        <li>
            <a href="https://getshe11.com/post/install-parallels-tools-on-kali-linux-2020.4/" class="post-link">Kali Linux 2020.4安装Parallels Tools</a>
        </li>
        
        <li>
            <a href="https://getshe11.com/post/pathfinder/" class="post-link">Hackthebox-Pathfinder</a>
        </li>
        
        <li>
            <a href="https://getshe11.com/post/domain-security/" class="post-link">Windows认证与域渗透</a>
        </li>
        
        <li>
            <a href="https://getshe11.com/post/shield/" class="post-link">Hackthebox-Shield</a>
        </li>
        
        <li>
            <a href="https://getshe11.com/post/archetype/" class="post-link">Hackthebox-Archetype</a>
        </li>
        
        <li>
            <a href="https://getshe11.com/post/oopsie/" class="post-link">Hackthebox-Oopsie</a>
        </li>
        
        <li>
            <a href="https://getshe11.com/post/vaccine/" class="post-link">Hackthebox-Vaccine</a>
        </li>
        
        <li>
            <a href="https://getshe11.com/post/bc-penetration-diary/" class="post-link">Bc站渗透日记</a>
        </li>
        
        <li>
            <a href="https://getshe11.com/post/maccms8-latest-command-execution-vulnerability/" class="post-link">Maccms8最新命令执行漏洞</a>
        </li>
        
        <li>
            <a href="https://getshe11.com/post/seacms9.92-from-variable-override-to-getshell/" class="post-link">Seacms9.92从变量覆盖到getshell</a>
        </li>
        
        <li>
            <a href="https://getshe11.com/post/seacms-front-desk-getshell/" class="post-link">Seacms&lt;=9.92前台Getshell</a>
        </li>
        
    </ul>
</div>

<div class="col-box post-toc hide">
    <div class="col-box-title">TOC</div>
</div>
            </div>
        </div>
    </div>
    
    <footer class="footer">
        <div class="wrapper">
    © 2021    <a href="https://getshe11.com/">F0rmat</a>
</div>
    </footer>
    
    
<script src="https://cdn.jsdelivr.net/npm/jquery@1.11.0/dist/jquery.min.js"></script>

<script src="/js/easybook.js"></script>

<script src="/js/lazysizes.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.12/dist/js/lightgallery-all.min.js"></script>
<script src="/js/figure.js"></script>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-XXXXXXXX-X', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>






</body>

</html>