<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Thinkphp框架 &lt; 5.0.16 sql注入漏洞分析(每日一洞) - F0rmat&#39;Blog</title>
<link rel="stylesheet" type="text/css" href="/css/main.css">
</head>
<body>
<header>
  <div>
    <h1><a href="https://getshe11.com/">F0rmat&#39;Blog</a></h1>
  </div>
  <nav></nav>
</header>
<main>
  <article>
    <div class="title">
  <h1>Thinkphp框架 &lt; 5.0.16 sql注入漏洞分析(每日一洞)</h1>
  </div>
<div style="position: fixed; right:-30px; max-width:300px; overflow:auto; top: 1px; width: 300px; bottom:100px">
<div class="container text-center mt-3">
    <iframe src="https://duckduckgo.com/search.html?site=https://getshe11.com/&prefill=" style="overflow:hidden;margin:0;padding:0;max-width:80%;height:40px;" frameborder="0"></iframe>
</div>
</div>
<div class="meta">
  <div>2018-04-11 09:34</div>
  <div>
    <span><a href="https://getshe11.com/tags/thinkphp/">#Thinkphp</a></span>
      </div>
  </div>
<div class="content">
  <h2 id="0x01-前言">0x01 前言</h2>
<p>前天在公众号看到石大神发的一篇审计thinkphp的文章,就想写一个分析流程，delay到了今天。昨天在先知也看到了chybeta发的一篇分析文章感觉也不错。分析过程，我也会做thinkphp部分功能的解析。
废话不多说，开始吧！</p>
<h2 id="0x02-环境搭建和漏洞复现">0x02 环境搭建和漏洞复现</h2>
<p>程序下载地址：http://www.thinkphp.cn/down/1126.html
PHPstudy：Apache+php5.6+MySQL
工具：PHPstorm</p>
<ol>
<li>首先建立一个数据库名为：thinkphp</li>
<li>建立一个表名为：user</li>
<li>添加三个字段：id,name,password
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/thinkphp_sql/1.png" alt=""></li>
</ol>
<!-- raw HTML omitted -->
<ol start="4">
<li>在thinkphp的数据库文件填上刚才我们建立的数据库信息：
文件位置：<code>\thinkphp\application\database.php</code>
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/thinkphp_sql/2.png" alt=""></li>
<li>打开thinkphp的调试模式：
文件位置：<code>\thinkphp\application\config.php</code>
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/thinkphp_sql/3.png" alt=""></li>
<li>简单写一个update功能，石大神用到了模型，这里就简单写一个例子就行了。
文件位置：<code>\thinkphp\application\index\controller\Index.php</code></li>
</ol>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>
<span style="color:#66d9ef">namespace</span> <span style="color:#a6e22e">app\index\controller</span>;

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Index</span>
{
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">index</span>()
    {
        $password <span style="color:#f92672">=</span> <span style="color:#a6e22e">input</span>(<span style="color:#e6db74">&#39;get.password/a&#39;</span>);
        <span style="color:#a6e22e">db</span>(<span style="color:#e6db74">&#39;user&#39;</span>)<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">where</span>([<span style="color:#e6db74">&#39;id&#39;</span><span style="color:#f92672">=&gt;</span> <span style="color:#ae81ff">1</span>])<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">update</span>([<span style="color:#e6db74">&#39;password&#39;</span><span style="color:#f92672">=&gt;</span>$password]);
    }
}
</code></pre></div><p>这里用到了thinkphp的助手函数input()，是专用来接收get，post等的值。具体可以看：https://www.kancloud.cn/manual/thinkphp5/118044
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/thinkphp_sql/4.png" alt=""></p>
<p>还有就是thinkphp的数据库操作，框架本身写好了我们调用就比较方便。所以为什么那么多人用框架去开发程序，快捷而且安全，不过也会有安全问题，就像今天这个sql漏洞，不过如果是新手的话总比自己写的好对吧哈。
具体可以看链接：https://www.kancloud.cn/manual/thinkphp5/135178
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/thinkphp_sql/5.png" alt="">
7. 现在就可以访问我们的payload了：</p>
<pre><code>http://thinkphp.test/thinkphp/public/index.php?password[0]=inc&amp;password[1]=updatexml(2,concat(0x7e,user()),0)&amp;password[2]=1
</code></pre><p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/thinkphp_sql/6.png" alt=""></p>
<h2 id="0x03-漏洞分析">0x03 漏洞分析</h2>
<ol>
<li>这里用phpstorm+debug来动态分析，有不懂配置的可以访问我写一篇配置文章：<a href="http://getpass.cn/2018/04/10/Breakpoint%20debugging%20with%20phpstorm+xdebug/">利用phpstorm+xdebug进行断点调试</a>
我们在主函数下一断点：
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/thinkphp_sql/8.png" alt=""></li>
</ol>
<p>然后访问我们payload，它会跳到入口文件，我们只要分析的是sql执行的地方，所以我们直接F8跳到执行sql地方：
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/thinkphp_sql/9.png" alt=""></p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/thinkphp_sql/7.png" alt="">
2. 我们继续跟进到<code>loader.php</code>它会包含thinkphp的Db.php文件，
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/thinkphp_sql/10.png" alt="">
接下还会包<code>\thinkphp\library\think\db\connector\Mysql.php</code>文件，主要是连接数据库的操作，这里就直接跳过了。别分析分析把自己绕进去了，我只是在这里讲诉下过程，我们还是直接分析sql执行的部分吧。
3. 我们跳到update执行的部分，文件位置：<code>\thinkphp\library\think\db\Query.php</code>
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/thinkphp_sql/11.png" alt="">
继续往下看，这句是执行我们sql的地方：
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/thinkphp_sql/12.png" alt="">
4. 我们F7跟进去，跳到文件位置<code>\thinkphp\library\think\db\Builder.php</code>
<code>parseTable</code>函数直接F8往下执行了，这函数是处理table分析的，主要还是<code>parseData函数</code>,我们继续F7跟进
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/thinkphp_sql/13.png" alt="">
5. 我们继续往下跟进
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/thinkphp_sql/14.png" alt="">
我们看到了这里如果传入的值为数组形式的话，并且第一个参数为<code>inc</code>就执行switch所对应的的语句。
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/thinkphp_sql/15.png" alt=""></p>
<p>可以看到这里函数对我们传入的值没有做任何处理，返回内容仍然是我们的语句：
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/thinkphp_sql/16.png" alt=""></p>
<p>跟到后面返回的执行sql语句：</p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/thinkphp_sql/17.png" alt=""></p>
<p>执行完，我们跟进到报错的地方，说明我的语句执行成功：
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/thinkphp_sql/20.png" alt="">
6.到这里就差不多结束了，有人问，为什么要这样给数组三个字段？
我们可以看到我们刚才传入数组的地方，分别有三个数组
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/thinkphp_sql/18.png" alt="">
到后面返回<code>$result</code>的时候就组合在一起了：
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/thinkphp_sql/19.png" alt=""></p>
<p>下面是<code>parseData</code>的代码：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"> <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">parseData</span>($data, $options)
    {
        <span style="color:#66d9ef">if</span> (<span style="color:#66d9ef">empty</span>($data)) {
            <span style="color:#66d9ef">return</span> [];
        }

        <span style="color:#75715e">// 获取绑定信息
</span><span style="color:#75715e"></span>        $bind <span style="color:#f92672">=</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">query</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">getFieldsBind</span>($options[<span style="color:#e6db74">&#39;table&#39;</span>]);
        <span style="color:#66d9ef">if</span> (<span style="color:#e6db74">&#39;*&#39;</span> <span style="color:#f92672">==</span> $options[<span style="color:#e6db74">&#39;field&#39;</span>]) {
            $fields <span style="color:#f92672">=</span> <span style="color:#a6e22e">array_keys</span>($bind);
        } <span style="color:#66d9ef">else</span> {
            $fields <span style="color:#f92672">=</span> $options[<span style="color:#e6db74">&#39;field&#39;</span>];
        }

        $result <span style="color:#f92672">=</span> [];
        <span style="color:#66d9ef">foreach</span> ($data <span style="color:#66d9ef">as</span> $key <span style="color:#f92672">=&gt;</span> $val) {
            $item <span style="color:#f92672">=</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">parseKey</span>($key, $options);
            <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">is_object</span>($val) <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">method_exists</span>($val, <span style="color:#e6db74">&#39;__toString&#39;</span>)) {
                <span style="color:#75715e">// 对象数据写入
</span><span style="color:#75715e"></span>                $val <span style="color:#f92672">=</span> $val<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">__toString</span>();
            }
            <span style="color:#66d9ef">if</span> (<span style="color:#66d9ef">false</span> <span style="color:#f92672">===</span> <span style="color:#a6e22e">strpos</span>($key, <span style="color:#e6db74">&#39;.&#39;</span>) <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span><span style="color:#a6e22e">in_array</span>($key, $fields, <span style="color:#66d9ef">true</span>)) {
                <span style="color:#66d9ef">if</span> ($options[<span style="color:#e6db74">&#39;strict&#39;</span>]) {
                    <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Exception</span>(<span style="color:#e6db74">&#39;fields not exists:[&#39;</span> <span style="color:#f92672">.</span> $key <span style="color:#f92672">.</span> <span style="color:#e6db74">&#39;]&#39;</span>);
                }
            } <span style="color:#66d9ef">elseif</span> (<span style="color:#a6e22e">is_null</span>($val)) {
                $result[$item] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;NULL&#39;</span>;
            } <span style="color:#66d9ef">elseif</span> (<span style="color:#a6e22e">is_array</span>($val) <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span><span style="color:#66d9ef">empty</span>($val)) {
                <span style="color:#66d9ef">switch</span> ($val[<span style="color:#ae81ff">0</span>]) {
                    <span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#39;exp&#39;</span><span style="color:#f92672">:</span>
                        $result[$item] <span style="color:#f92672">=</span> $val[<span style="color:#ae81ff">1</span>];
                        <span style="color:#66d9ef">break</span>;
                    <span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#39;inc&#39;</span><span style="color:#f92672">:</span>
                        $result[$item] <span style="color:#f92672">=</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">parseKey</span>($val[<span style="color:#ae81ff">1</span>]) <span style="color:#f92672">.</span> <span style="color:#e6db74">&#39;+&#39;</span> <span style="color:#f92672">.</span> <span style="color:#a6e22e">floatval</span>($val[<span style="color:#ae81ff">2</span>]);
                        <span style="color:#66d9ef">break</span>;
                    <span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#39;dec&#39;</span><span style="color:#f92672">:</span>
                        $result[$item] <span style="color:#f92672">=</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">parseKey</span>($val[<span style="color:#ae81ff">1</span>]) <span style="color:#f92672">.</span> <span style="color:#e6db74">&#39;-&#39;</span> <span style="color:#f92672">.</span> <span style="color:#a6e22e">floatval</span>($val[<span style="color:#ae81ff">2</span>]);
                        <span style="color:#66d9ef">break</span>;
                }
            } <span style="color:#66d9ef">elseif</span> (<span style="color:#a6e22e">is_scalar</span>($val)) {
                <span style="color:#75715e">// 过滤非标量数据
</span><span style="color:#75715e"></span>                <span style="color:#66d9ef">if</span> (<span style="color:#ae81ff">0</span> <span style="color:#f92672">===</span> <span style="color:#a6e22e">strpos</span>($val, <span style="color:#e6db74">&#39;:&#39;</span>) <span style="color:#f92672">&amp;&amp;</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">query</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">isBind</span>(<span style="color:#a6e22e">substr</span>($val, <span style="color:#ae81ff">1</span>))) {
                    $result[$item] <span style="color:#f92672">=</span> $val;
                } <span style="color:#66d9ef">else</span> {
                    $key <span style="color:#f92672">=</span> <span style="color:#a6e22e">str_replace</span>(<span style="color:#e6db74">&#39;.&#39;</span>, <span style="color:#e6db74">&#39;_&#39;</span>, $key);
                    $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">query</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">bind</span>(<span style="color:#e6db74">&#39;data__&#39;</span> <span style="color:#f92672">.</span> $key, $val, <span style="color:#a6e22e">isset</span>($bind[$key]) <span style="color:#f92672">?</span> $bind[$key] <span style="color:#f92672">:</span> <span style="color:#a6e22e">PDO</span><span style="color:#f92672">::</span><span style="color:#a6e22e">PARAM_STR</span>);
                    $result[$item] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;:data__&#39;</span> <span style="color:#f92672">.</span> $key;
                }
            }
        }
        <span style="color:#66d9ef">return</span> $result;
    }
</code></pre></div><h2 id="0x04-结束">0x04 结束</h2>
<p>如果看不懂的，可以先去了解一下thinkphp这个框架，其他框架大同小异。如果里面一些PHP代码看不懂的话，可以去复习下PHP。</p>
<h2 id="0x05-参考">0x05 参考</h2>
<p><a href="https://www.kancloud.cn/manual/thinkphp5/">https://www.kancloud.cn/manual/thinkphp5/</a></p>
<p><a href="https://mp.weixin.qq.com/s?__biz=MzU2NzE3MTU0Mw==&amp;mid=2247483720&amp;idx=1&amp;sn=973bd7daa287a9e9c0171e852db6cb6b&amp;chksm=fca001f0cbd788e6ed3119de5d3c4bfc3325205c5dd7f296e55a2ba313f73b3808525d1022e6&amp;mpshare=1&amp;scene=23&amp;srcid=04104vXPMKRNVfrVzzzg7HXg#rd">https://mp.weixin.qq.com/s?__biz=MzU2NzE3MTU0Mw==&amp;mid=2247483720&amp;idx=1&amp;sn=973bd7daa287a9e9c0171e852db6cb6b&amp;chksm=fca001f0cbd788e6ed3119de5d3c4bfc3325205c5dd7f296e55a2ba313f73b3808525d1022e6&amp;mpshare=1&amp;scene=23&amp;srcid=04104vXPMKRNVfrVzzzg7HXg#rd</a></p>
<p><a href="https://chybeta.github.io/2018/04/10/Thinkphp%E6%A1%86%E6%9E%B6-5-0-16-sql%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/">https://chybeta.github.io/2018/04/10/Thinkphp%E6%A1%86%E6%9E%B6-5-0-16-sql%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/</a></p>
</div>
<div style="position: fixed; right:50px; max-width:255px; overflow:auto; top: 120px; width: 220px; bottom:90px">










<div class="toc">

    <div class="page-header"><strong>目录</strong></div>

    <div id="page-scrollspy" class="toc-nav">

        
        
            
                
                
                    
                    <ul class="nav">
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#0x01-%e5%89%8d%e8%a8%80">
                            0x01 前言
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                    </ul>
                    
                
            
        
        
            
                
                
                    
                    <ul class="nav">
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#0x02-%e7%8e%af%e5%a2%83%e6%90%ad%e5%bb%ba%e5%92%8c%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0">
                            0x02 环境搭建和漏洞复现
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                    </ul>
                    
                
            
        
        
            
                
                
                    
                    <ul class="nav">
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#0x03-%e6%bc%8f%e6%b4%9e%e5%88%86%e6%9e%90">
                            0x03 漏洞分析
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                    </ul>
                    
                
            
        
        
            
                
                
                    
                    <ul class="nav">
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#0x04-%e7%bb%93%e6%9d%9f">
                            0x04 结束
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                    </ul>
                    
                
            
        
        
            
                
                
                    
                    <ul class="nav">
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#0x05-%e5%8f%82%e8%80%83">
                            0x05 参考
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                    </ul>
                    
                
            
        

    </div>

</div>



</div>

  </article>
</main>
<footer>
  <div>
    <div>&copy; 2021 F0rmat. <a href="https://creativecommons.org/licenses/by/4.0/deed.zh">CC-BY-4.0</a></div>
  </div>
</footer>
</body>
</html>
