<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>DedeCMS V5.7后台过滤不当导致Getshell(每周一洞) - F0rmat&#39;Blog</title>
<link rel="stylesheet" type="text/css" href="/css/main.css">
</head>
<body>
<header>
  <div>
    <h1><a href="https://getshe11.com/">F0rmat&#39;Blog</a></h1>
  </div>
  <nav></nav>
</header>
<main>
  <article>
    <div class="title">
  <h1>DedeCMS V5.7后台过滤不当导致Getshell(每周一洞)</h1>
  </div>
<div style="position: fixed; right:-30px; max-width:300px; overflow:auto; top: 1px; width: 300px; bottom:100px">

</div>
<div class="meta">
  <div>2018-07-27 14:14</div>
  <div>
    <span><a href="https://getshe11.com/tags/dedecms/">#DedeCMS</a></span>
      <span><a href="https://getshe11.com/tags/getshell/">#Getshell</a></span>
      </div>
  </div>
<div class="content">
  <h1 id="0x01-前言">0x01 前言</h1>
<p>前两天看到七月火表哥再先知发的一篇审计文章，感觉不错，是dedecms的getshell。就分析了一下，顺便写一篇文章学习。</p>
<h1 id="0x02-环境">0x02 环境</h1>
<p>环境和之前的一篇文章一样可以作为参考：
<a href="https://getpass.cn/2018/03/10/DedeCMS%20V5.7%20SP2%20Background%20Getshell%20Code%20Execution%20Vulnerability/">https://getpass.cn/2018/03/10/DedeCMS%20V5.7%20SP2%20Background%20Getshell%20Code%20Execution%20Vulnerability/</a></p>
<!-- raw HTML omitted -->
<h1 id="0x03-复现漏洞">0x03 复现漏洞</h1>
<ol>
<li>进入后台添加广告的地方：http://sb.com/dede/ad_main.php</li>
<li>在添加页面加上我们的代码：<code>--&gt;&lt;?php phpinfo();?&gt;&lt;!--</code>
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/dedecms/1.png" alt=""></li>
<li>然后点击查看代码
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/dedecms/2.png" alt=""></li>
<li>访问执行代码
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/dedecms/3.png" alt=""></li>
</ol>
<h1 id="0x04-漏洞分析">0x04 漏洞分析</h1>
<p><code>dede\ad_add.php</code>,代码可以读一遍，插入数据库的时候并没有对危险函数进行处理。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#66d9ef">if</span>($dopost<span style="color:#f92672">==</span><span style="color:#e6db74">&#34;save&#34;</span>)
{
    <span style="color:#a6e22e">csrf_check</span>();
    <span style="color:#75715e">//timeset tagname typeid normbody expbody
</span><span style="color:#75715e"></span>    $tagname <span style="color:#f92672">=</span> <span style="color:#a6e22e">trim</span>($tagname);
    $row <span style="color:#f92672">=</span> $dsql<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">GetOne</span>(<span style="color:#e6db74">&#34;SELECT typeid FROM #@__myad WHERE typeid=&#39;</span><span style="color:#e6db74">$typeid</span><span style="color:#e6db74">&#39; AND tagname LIKE &#39;</span><span style="color:#e6db74">$tagname</span><span style="color:#e6db74">&#39;&#34;</span>);
    <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">is_array</span>($row))
    {
        <span style="color:#a6e22e">ShowMsg</span>(<span style="color:#e6db74">&#34;在相同栏目下已经存在同名的标记！&#34;</span>,<span style="color:#e6db74">&#34;-1&#34;</span>);
        <span style="color:#66d9ef">exit</span>();
    }
    $starttime <span style="color:#f92672">=</span> <span style="color:#a6e22e">GetMkTime</span>($starttime);
    $endtime <span style="color:#f92672">=</span> <span style="color:#a6e22e">GetMkTime</span>($endtime);
    $link <span style="color:#f92672">=</span> <span style="color:#a6e22e">addslashes</span>($normbody[<span style="color:#e6db74">&#39;link&#39;</span>]);
    <span style="color:#66d9ef">if</span>($normbody[<span style="color:#e6db74">&#39;style&#39;</span>]<span style="color:#f92672">==</span><span style="color:#e6db74">&#39;code&#39;</span>)
    {
        $normbody <span style="color:#f92672">=</span> <span style="color:#a6e22e">addslashes</span>($normbody[<span style="color:#e6db74">&#39;htmlcode&#39;</span>]);
    }
    <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span>($normbody[<span style="color:#e6db74">&#39;style&#39;</span>]<span style="color:#f92672">==</span><span style="color:#e6db74">&#39;txt&#39;</span>)
    {
        
        $normbody <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&lt;a href=</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">{</span>$link<span style="color:#e6db74">}</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74"> font-size=</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">{</span>$normbody[<span style="color:#e6db74">&#39;size&#39;</span>]<span style="color:#e6db74">}</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74"> color=</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">{</span>$normbody[<span style="color:#e6db74">&#39;color&#39;</span>]<span style="color:#e6db74">}</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">&gt;</span><span style="color:#e6db74">{</span>$normbody[<span style="color:#e6db74">&#39;title&#39;</span>]<span style="color:#e6db74">}</span><span style="color:#e6db74">&lt;/a&gt;&#34;</span>;
    }
    <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span>($normbody[<span style="color:#e6db74">&#39;style&#39;</span>]<span style="color:#f92672">==</span><span style="color:#e6db74">&#39;img&#39;</span>)
    {
        <span style="color:#66d9ef">if</span>(<span style="color:#66d9ef">empty</span>($normbody[<span style="color:#e6db74">&#39;width&#39;</span>]))
        {
            $width <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>;
        }
        <span style="color:#66d9ef">else</span>
        {
            $width <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34; width=</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">{</span>$normbody[<span style="color:#e6db74">&#39;width&#39;</span>]<span style="color:#e6db74">}</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">&#34;</span>;
        }
        <span style="color:#66d9ef">if</span> (<span style="color:#66d9ef">empty</span>($normbody[<span style="color:#e6db74">&#39;height&#39;</span>]))
        {
            $height <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>;
        }
        <span style="color:#66d9ef">else</span>
        {
            $height <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;height=</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">{</span>$normbody[<span style="color:#e6db74">&#39;height&#39;</span>]<span style="color:#e6db74">}</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">&#34;</span>;
        }
        $normbody <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&lt;a href=</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">{</span>$link<span style="color:#e6db74">}</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">&gt;&lt;img src=</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">{</span>$normbody[<span style="color:#e6db74">&#39;url&#39;</span>]<span style="color:#e6db74">}</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">$width</span><span style="color:#e6db74"> </span><span style="color:#e6db74">$height</span><span style="color:#e6db74"> border=</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">0</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74"> /&gt;&lt;/a&gt;&#34;</span>;
    }
    <span style="color:#66d9ef">else</span>
    {
        <span style="color:#66d9ef">if</span>(<span style="color:#66d9ef">empty</span>($normbody[<span style="color:#e6db74">&#39;width&#39;</span>]))
        {
            $width <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>;
        }
        <span style="color:#66d9ef">else</span>
        {
            $width <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34; width=</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">{</span>$normbody[<span style="color:#e6db74">&#39;width&#39;</span>]<span style="color:#e6db74">}</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">&#34;</span>;
        }
        <span style="color:#66d9ef">if</span> (<span style="color:#66d9ef">empty</span>($normbody[<span style="color:#e6db74">&#39;height&#39;</span>]))
        {
            $height <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>;
        }
        <span style="color:#66d9ef">else</span>
        {
            $height <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;height=</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">{</span>$normbody[<span style="color:#e6db74">&#39;height&#39;</span>]<span style="color:#e6db74">}</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">&#34;</span>;
        }
        $normbody <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&lt;object classid=</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">clsid:D27CDB6E-AE6D-11cf-96B8-444553540000</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74"> codebase=</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">http://download.Macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=7,0,19,0</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">$width</span><span style="color:#e6db74"> </span><span style="color:#e6db74">$height</span><span style="color:#e6db74">&gt;&lt;param name=</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">movie</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74"> value=</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">{</span>$link<span style="color:#e6db74">}</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">/&gt;&lt;param name=</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">quality</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74"> value=</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">high</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">/&gt;&lt;/object&gt;&#34;</span>;
    }
    $query <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;
</span><span style="color:#e6db74">     INSERT INTO #@__myad(clsid,typeid,tagname,adname,timeset,starttime,endtime,normbody,expbody)
</span><span style="color:#e6db74">     VALUES(&#39;</span><span style="color:#e6db74">$clsid</span><span style="color:#e6db74">&#39;,&#39;</span><span style="color:#e6db74">$typeid</span><span style="color:#e6db74">&#39;,&#39;</span><span style="color:#e6db74">$tagname</span><span style="color:#e6db74">&#39;,&#39;</span><span style="color:#e6db74">$adname</span><span style="color:#e6db74">&#39;,&#39;</span><span style="color:#e6db74">$timeset</span><span style="color:#e6db74">&#39;,&#39;</span><span style="color:#e6db74">$starttime</span><span style="color:#e6db74">&#39;,&#39;</span><span style="color:#e6db74">$endtime</span><span style="color:#e6db74">&#39;,&#39;</span><span style="color:#e6db74">$normbody</span><span style="color:#e6db74">&#39;,&#39;</span><span style="color:#e6db74">$expbody</span><span style="color:#e6db74">&#39;);
</span><span style="color:#e6db74">    &#34;</span>;
    $dsql<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">ExecuteNoneQuery</span>($query);
    <span style="color:#a6e22e">ShowMsg</span>(<span style="color:#e6db74">&#34;成功增加一个广告！&#34;</span>,<span style="color:#e6db74">&#34;ad_main.php&#34;</span>);
    <span style="color:#66d9ef">exit</span>();
}
</code></pre></div><p><code>plus\ad_js.php</code> 这里开头就检测了文件的存在，然后根据<code>aid</code>查询数据库内容，可以看到把<code>expbody</code>和<code>normbody</code>的内容加入到<code>$adbody</code>的数组里面，但是这里内容是在注释符中间的，我们可以用注释闭合的方式。
最后面的几行是写入文件，然后最后包含文件，这里就成功执行了我们的代码。
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/dedecms/4.png" alt="">
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/dedecms/5.png" alt=""></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#66d9ef">if</span>( <span style="color:#a6e22e">isset</span>($nocache) <span style="color:#f92672">||</span> <span style="color:#f92672">!</span><span style="color:#a6e22e">file_exists</span>($cacheFile) <span style="color:#f92672">||</span> <span style="color:#a6e22e">time</span>() <span style="color:#f92672">-</span> <span style="color:#a6e22e">filemtime</span>($cacheFile) <span style="color:#f92672">&gt;</span> $cfg_puccache_time )
{
    $row <span style="color:#f92672">=</span> $dsql<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">GetOne</span>(<span style="color:#e6db74">&#34;SELECT * FROM `#@__myad` WHERE aid=&#39;</span><span style="color:#e6db74">$aid</span><span style="color:#e6db74">&#39; &#34;</span>);
    $adbody <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span>;
    <span style="color:#66d9ef">if</span>($row[<span style="color:#e6db74">&#39;timeset&#39;</span>]<span style="color:#f92672">==</span><span style="color:#ae81ff">0</span>)
    {
        $adbody <span style="color:#f92672">=</span> $row[<span style="color:#e6db74">&#39;normbody&#39;</span>];
    }
    <span style="color:#66d9ef">else</span>
    {
        $ntime <span style="color:#f92672">=</span> <span style="color:#a6e22e">time</span>();
        <span style="color:#66d9ef">if</span>($ntime <span style="color:#f92672">&gt;</span> $row[<span style="color:#e6db74">&#39;endtime&#39;</span>] <span style="color:#f92672">||</span> $ntime <span style="color:#f92672">&lt;</span> $row[<span style="color:#e6db74">&#39;starttime&#39;</span>]) {
            $adbody <span style="color:#f92672">=</span> $row[<span style="color:#e6db74">&#39;expbody&#39;</span>];
        } <span style="color:#66d9ef">else</span> {
            $adbody <span style="color:#f92672">=</span> $row[<span style="color:#e6db74">&#39;normbody&#39;</span>];
        }
    }
    $adbody <span style="color:#f92672">=</span> <span style="color:#a6e22e">str_replace</span>(<span style="color:#e6db74">&#39;&#34;&#39;</span>, <span style="color:#e6db74">&#39;\&#34;&#39;</span>,$adbody);
    $adbody <span style="color:#f92672">=</span> <span style="color:#a6e22e">str_replace</span>(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\r</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">r&#34;</span>,$adbody);
    $adbody <span style="color:#f92672">=</span> <span style="color:#a6e22e">str_replace</span>(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">n&#34;</span>,$adbody);
    $adbody <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&lt;!--</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">document.write(</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">{</span>$adbody<span style="color:#e6db74">}</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">);</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">--&gt;</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">&#34;</span>;
    $fp <span style="color:#f92672">=</span> <span style="color:#a6e22e">fopen</span>($cacheFile, <span style="color:#e6db74">&#39;w&#39;</span>);
    <span style="color:#a6e22e">fwrite</span>($fp, $adbody);
    <span style="color:#a6e22e">fclose</span>($fp);
}
<span style="color:#66d9ef">include</span> $cacheFile;
</code></pre></div><h1 id="0x05-结束">0x05 结束</h1>
<p>这个漏洞比较简单，不过一般dedecms文件上传功能都会关闭的，所以广告这个功能不一定会关闭，可以利用一波。</p>
<h1 id="0x06-参考">0x06 参考</h1>
<p>源码下载：https://pan.lanzou.com/i0mmfih</p>
<p><a href="https://xz.aliyun.com/t/2470">https://xz.aliyun.com/t/2470</a></p>
</div>
<div style="position: fixed; right:50px; max-width:255px; overflow:auto; top: 120px; width: 220px; bottom:90px">










<div class="toc">

    <div class="page-header"><strong>目录</strong></div>

    <div id="page-scrollspy" class="toc-nav">

        
        
            
                
                
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#0x01-%e5%89%8d%e8%a8%80">
                            0x01 前言
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                
            
        
        
            
                
                
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#0x02-%e7%8e%af%e5%a2%83">
                            0x02 环境
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                
            
        
        
            
                
                
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#0x03-%e5%a4%8d%e7%8e%b0%e6%bc%8f%e6%b4%9e">
                            0x03 复现漏洞
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                
            
        
        
            
                
                
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#0x04-%e6%bc%8f%e6%b4%9e%e5%88%86%e6%9e%90">
                            0x04 漏洞分析
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                
            
        
        
            
                
                
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#0x05-%e7%bb%93%e6%9d%9f">
                            0x05 结束
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                
            
        
        
            
                
                
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#0x06-%e5%8f%82%e8%80%83">
                            0x06 参考
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                
            
        

    </div>

</div>



</div>

  </article>
</main>
<footer>
  <div>
    <div>&copy; 2021 F0rmat. <a href="https://creativecommons.org/licenses/by/4.0/deed.zh">CC-BY-4.0</a></div>
  </div>
</footer>
</body>
</html>
