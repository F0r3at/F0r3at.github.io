<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>phpok4.9后台getshell(每周一洞) - F0rmat&#39;Blog</title>
<link rel="stylesheet" type="text/css" href="/css/main.css">
</head>
<body>
<header>
  <div>
    <h1><a href="https://getshe11.com/">F0rmat&#39;Blog</a></h1>
  </div>
  <nav></nav>
</header>
<main>
  <article>
    <div class="title">
  <h1>phpok4.9后台getshell(每周一洞)</h1>
  </div>
<div style="position: fixed; right:-30px; max-width:300px; overflow:auto; top: 1px; width: 300px; bottom:100px">

</div>
<div class="meta">
  <div>2018-08-06 08:19</div>
  <div>
    <span><a href="https://getshe11.com/tags/php/">#php</a></span>
      <span><a href="https://getshe11.com/tags/phpok/">#phpok</a></span>
      </div>
  </div>
<div class="content">
  <h1 id="0x01-前言">0x01 前言</h1>
<p>昨天看到phpok可以申请cve就去审计了一下，存在漏洞的地方还是挺多的，时间不多找了个简单的任意文件上传漏洞。</p>
<h1 id="0x02-环境">0x02 环境</h1>
<ol>
<li>程序下载：https://www.lanzous.com/i1ksjkd</li>
<li>集成环境是PHPstudy,PHP5.6。</li>
<li>安装程序
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/phpok/1-1.png" alt=""></li>
</ol>
<!-- raw HTML omitted -->
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/phpok/1-2.png" alt="">
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/phpok/1-3.png" alt="">
4. 先创建一个数据库phpok
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/phpok/1-4.png" alt="">
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/phpok/1-5.png" alt="">
5. 设置管理员账号密码
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/phpok/1-6.png" alt="">
6. 安装成功
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/phpok/1-7.png" alt=""></p>
<h1 id="0x03-漏洞挖掘过程">0x03 漏洞挖掘过程</h1>
<ol>
<li>
<p>打开打开FolderChangesView记录程序的文件变动。
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/phpok/1-8.png" alt=""></p>
</li>
<li>
<p>登录后台
程序升级-&gt;压缩包升级
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/phpok/1-9.png" alt=""></p>
</li>
<li>
<p>编辑一个测试文件phpinfo.php,压缩为phpinfo.zip上传。
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/phpok/11.png" alt=""></p>
</li>
<li>
<p>点击上传，压缩包里面的文件会被压缩到网站根目录
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/phpok/1-11.png" alt=""></p>
</li>
<li>
<p>访问根目录下新生成的文件
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/phpok/12.png" alt=""></p>
</li>
</ol>
<h1 id="0x04-漏洞分析">0x04 漏洞分析</h1>
<p>漏洞代码出现在<code>framework/admin/update_control.php</code>文件的<code>unzip_f</code>函数,可以看到用到<code>lib</code>里面的<code>phpzip</code>类，有兴趣可以去读下源码<code>framework/libs/phpzip.php</code>
大家可能疑问你怎么知道漏洞文件是这个，可以抓包来查看整过利用的过程，然后再去源码分析。
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/phpok/1-12.png" alt="">
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/phpok/1-13.png" alt=""></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php">	<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">unzip_f</span>()
	{
		$zipfile <span style="color:#f92672">=</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">get</span>(<span style="color:#e6db74">&#39;zipfile&#39;</span>);
		<span style="color:#66d9ef">if</span>(<span style="color:#f92672">!</span>$zipfile){
			$this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">error</span>(<span style="color:#a6e22e">P_Lang</span>(<span style="color:#e6db74">&#39;未指定附件文件&#39;</span>));
		}
		<span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">strpos</span>($zipfile,<span style="color:#e6db74">&#39;..&#39;</span>) <span style="color:#f92672">!==</span> <span style="color:#66d9ef">false</span>){
			$this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">error</span>(<span style="color:#a6e22e">P_Lang</span>(<span style="color:#e6db74">&#39;不支持带..上级路径&#39;</span>));
		}
		<span style="color:#66d9ef">if</span>(<span style="color:#f92672">!</span><span style="color:#a6e22e">file_exists</span>($this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">dir_root</span><span style="color:#f92672">.</span>$zipfile)){
			$this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">error</span>(<span style="color:#a6e22e">P_Lang</span>(<span style="color:#e6db74">&#39;ZIP文件不存在&#39;</span>));
		}
		$this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">lib</span>(<span style="color:#e6db74">&#39;phpzip&#39;</span>)<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">unzip</span>($this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">dir_root</span><span style="color:#f92672">.</span>$zipfile,<span style="color:#e6db74">&#39;data/update/&#39;</span>);
		$info <span style="color:#f92672">=</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">update_load</span>();
		<span style="color:#66d9ef">if</span>(<span style="color:#f92672">!</span>$info <span style="color:#f92672">||</span> (<span style="color:#a6e22e">is_array</span>($info) <span style="color:#f92672">&amp;&amp;</span> $info[<span style="color:#e6db74">&#39;status&#39;</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;error&#39;</span>)){
			$this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">error</span>($info[<span style="color:#e6db74">&#39;content&#39;</span>]);
		}
		$this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">success</span>();
	}
</code></pre></div><p>可以看到用到lib里面的phpzip类，有兴趣可以去读下源码framework/libs/phpzip.php
<img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/phpok/1-14.png" alt=""></p>
<h1 id="0x05-结束">0x05 结束</h1>
<p>这个程序也不难，可以大概浏览下后台有什么功能再去测试，如果还是没能发现什么，就从入口文件一步步去分析。</p>
<h1 id="0x06-参考">0x06 参考</h1>
<p>程序下载：https://www.lanzous.com/i1ksjkd</p>
</div>
<div style="position: fixed; right:50px; max-width:255px; overflow:auto; top: 120px; width: 220px; bottom:90px">










<div class="toc">

    <div class="page-header"><strong>目录</strong></div>

    <div id="page-scrollspy" class="toc-nav">

        
        
            
                
                
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#0x01-%e5%89%8d%e8%a8%80">
                            0x01 前言
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                
            
        
        
            
                
                
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#0x02-%e7%8e%af%e5%a2%83">
                            0x02 环境
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                
            
        
        
            
                
                
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#0x03-%e6%bc%8f%e6%b4%9e%e6%8c%96%e6%8e%98%e8%bf%87%e7%a8%8b">
                            0x03 漏洞挖掘过程
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                
            
        
        
            
                
                
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#0x04-%e6%bc%8f%e6%b4%9e%e5%88%86%e6%9e%90">
                            0x04 漏洞分析
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                
            
        
        
            
                
                
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#0x05-%e7%bb%93%e6%9d%9f">
                            0x05 结束
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                
            
        
        
            
                
                
                    
                    <ul class="nav">
                    
                    
                        <li class="nav-item">
                            <a class="nav-link text-left" href="#0x06-%e5%8f%82%e8%80%83">
                            0x06 参考
                            </a>
                        </li>
                    
                    
                    </ul>
                    
                
            
        

    </div>

</div>



</div>

  </article>
</main>
<footer>
  <div>
    <div>&copy; 2021 F0rmat. <a href="https://creativecommons.org/licenses/by/4.0/deed.zh">CC-BY-4.0</a></div>
  </div>
</footer>
</body>
</html>
